unit MainFRMunit;

interface

uses
  SysUtils, Windows, Messages, Classes, Graphics, Controls, ActiveX,
  Forms, Dialogs, StdCtrls, Buttons, ExtCtrls, Menus, Grids, DBGrids,
  ComCtrls, DBCtrls, Mask, OleCtrls,
  ExtDlgs, AcquireImage, clipbrd, ActnList, ActnMan, ImgList,
  Printers,
  Janfx, Jpeg, variants, DLLsucdapi, Math, XPStyleActnCtrls, Spin, DateUtils,
  shellapi, BaseGrid, paramtreeview, MMSystem, pngimage, strutils,
  ComObj, OleCtnrs, HTTPapp, xmldom, XMLIntf, msxmldom, XMLDoc,
  ActnCtrls, ToolWin, PlatformDefaultStyleActnCtrls,

  AdvGrid, AdvPageControl, AdvAlertWindow, AdvPanel, AdvMemo, AdvmWS, DBAdvMemo,

  RpBase,
  RpSystem, RpRave,
  RpDefine,

  cxGridCustomView, cxDBEdit, cxContainer, cxLookAndFeels, cxTextEdit,
  cxMaskEdit, cxDropDownEdit, cxLookupEdit,
  cxDBLookupEdit, cxDBLookupComboBox, cxCheckBox,
  cxCurrencyEdit, cxControls, cxCalendar, cxMemo, cxStyles,
  cxEdit, cxGrid, cxGridTableView,
  cxGridCustomTableView, cxGridDBTableView, cxGridLevel, cxClasses,
  cxProgressBar,

  dxBar, dxStatusBar,
  dxRibbon, dxBarExtItems, dxBarDBNav,

  IdTCPClient, IdFTP, IdFTPList,
  IdFTPCommon,
  IdBaseComponent, IdFTPListParseUnix,

  SQlExpr, DB, DBClient, DBTables, DBCGrids,
  Qexport4Dialog,
  ThreadsUnit, RentProcessFRMUnit, CustomerDisplayFRMUnit,
  Phidget21COM_TLB, COPTRLib_TLB, WinbooksExport, EIDNative, EIDCard,

  JvExComCtrls, JvToolBar,
  JvLookOut, JvExControls, JvExExtCtrls, JvExtComponent, JvPanel,
  JvDBLookupTreeView, cxButtons, catalog,
  dxBarApplicationMenu, AdvObj, SHDocVw_EWB, EwbCore, EmbeddedWB,
  System.Actions, cxGraphics, cxLookAndFeelPainters, cxCustomData, cxFilter,
  cxData, cxDataStorage, cxNavigator, cxDBData, cxImage, dxRibbonSkins,
  dxRibbonCustomizationForm, dxGDIPlusClasses;

type

  TStringArray = array of string;

  TMainForm = class(TForm)
    PageControlMainForm: TPageControl;
    TabSheetProducts: TTabSheet;
    TabSheetCustomers: TTabSheet;
    TabsheetSales: TTabSheet;
    PanelSalesAddToGrid: TPanel;
    EditSalesModel: TEdit;
    EditSalesName: TEdit;
    ComboBoxSalesOwner: TComboBox;
    PopupStringGrid: TPopupMenu;
    Delete1: TMenuItem;
    PanelSalesCaddy: TPanel;
    LabelSalesModel: TLabel;
    LabelsalesOwner: TLabel;
    LabelSalesDescription: TLabel;
    LabelSalesPrice: TLabel;
    LabelSalesAvailable: TLabel;
    PrintDialog1: TPrintDialog;
    OpenPictureDialog: TOpenPictureDialog;
    TimerDBupdate: TTimer;
    TabSheetTransfer: TTabSheet;
    BitBtnTransferProcess: TBitBtn;
    BitBtnTransferClear: TBitBtn;
    PanelTransferOrigin: TPanel;
    PanelTransferDestination: TPanel;
    ComboBoxDestShop: TComboBox;
    Paneltransfermidentry: TPanel;
    TabSheetAdmin: TTabSheet;
    TimerUpdateConnectionLeds: TTimer;
    GroupBoxProductsEdits: TGroupBox;
    GroupBoxButtons: TGroupBox;
    BitBtnProductsStockCheck: TBitBtn;
    BitBtnProductsPrintLabel: TBitBtn;
    TabSheetInventory: TTabSheet;
    Panel_inventory: TPanel;
    ImageListOutlookbar: TImageList;
    PanelProducts: TPanel;
    PanelProductsRight: TPanel;
    GroupBoxProductImage: TGroupBox;
    Shape1: TShape;
    ThumbImg: TImage;
    SButtonProductImageOpen: TSpeedButton;
    SbuttonProductImageSave: TSpeedButton;
    SButtonproductimagerotate: TSpeedButton;
    SButtonProductImageScan: TSpeedButton;
    SbuttonProductPictureUpload: TSpeedButton;
    PanelTransferTopLeft: TPanel;
    ActionManagerChangeTabsheets: TActionManager;
    Vente: TAction;
    Clients: TAction;
    Produits: TAction;
    Transfert: TAction;
    Entree: TAction;
    Config: TAction;
    Admin: TAction;
    Inventory: TAction;
    PanelTransferButtons: TPanel;
    PanelTransferKind: TPanel;
    RadioButtonReceive: TRadioButton;
    RadioButtonSend: TRadioButton;
    PanelInventoryButtons: TPanel;
    BitBtnInventoryClear: TBitBtn;
    BitBtnInventoryProcess: TBitBtn;
    PanelSalesCustomer: TPanel;
    ImageListSmallImages: TImageList;
    PanelTransferGrid: TPanel;
    PanelInventoryClient: TPanel;
    OccDeposit: TAction;
    OccBuy: TAction;
    ActionCustomerDepositAll: TAction;
    ActionCustomerDepositnonrefunded: TAction;
    ActionCustomerDepositRefunded: TAction;
    EditSalesDateIn: TEdit;
    LabelSalesBarDateIn: TLabel;
    ActionCustomerRepairAll: TAction;
    ActionCustomerRepairProcessed: TAction;
    ActionCustomerRepairReturned: TAction;
    dxBarManager1: TdxBarManager;
    DBNavigatorMain: TdxBarDBNavigator;
    dxBarGroupSearch: TdxBarGroup;
    SButtonSearch: TdxBarButton;
    searchstring: TdxBarEdit;
    DBNavigatorFirst1: TdxBarDBNavButton;
    DBNavigatorPrev1: TdxBarDBNavButton;
    DBNavigatorNext1: TdxBarDBNavButton;
    DBNavigatorLast1: TdxBarDBNavButton;
    DBNavigatorDelete1: TdxBarDBNavButton;
    DBNavigatorInsert1: TdxBarDBNavButton;
    DBNavigatorEdit1: TdxBarDBNavButton;
    DBNavigatorPost1: TdxBarDBNavButton;
    DBNavigatorCancel1: TdxBarDBNavButton;
    PanelFormCentral: TPanel;
    PopupCustomersGrid: TPopupMenu;
    ChangeOrice1: TMenuItem;
    PrintLabel1: TMenuItem;
    Copiermodle1: TMenuItem;
    NAVIGATION: TdxBarSubItem;
    JvPanelTitleCustomers: TJvPanel;
    JvPanelTitleAdmin: TJvPanel;
    PanelAdminTopMargin: TPanel;
    JvPanelTitleInventory: TJvPanel;
    JvPanelTitleTransfer: TJvPanel;
    JvPanelTitleSales: TJvPanel;
    JvPanelTitleProducts: TJvPanel;
    PanelTopMarginTransfer: TPanel;
    PanelTopMarginSales: TPanel;
    PanelInventoryTopMargin: TPanel;
    PanelInventoryTopLeft: TPanel;
    Label_inventaryquantity: TLabel;
    Label_InventaryModel: TLabel;
    DBText_InventoryProductname: TDBText;
    DBText_InventoryPrice: TDBText;
    DBText_InventoryDatein: TDBText;
    Image1: TImage;
    dxBarButtonSyncDB: TdxBarButton;
    ActionDBSync: TAction;
    ActionDBCheckCat: TAction;
    dxBarButtonCheckCat: TdxBarButton;
    dxBarButtonChackEan: TdxBarButton;
    ActionDBCheckEan: TAction;
    ActionDBBuildId: TAction;
    dxBarButtonDBIdGen: TdxBarButton;
    AdminImageBorder: TImage;
    ImageTransferHeaderBorder: TImage;
    ImageSalesTitleBorder: TImage;
    Image7: TImage;
    Image8: TImage;
    ActionRaportDayCashier: TAction;
    ActionDBProductsVisibility: TAction;
    dxBarButtonProductVisible: TdxBarButton;
    Rent: TAction;
    ActionCustomerRentAll: TAction;
    ActionCustomerRentPending: TAction;
    ActionCustomerRentClosed: TAction;
    PopupMenuGridAdmin: TPopupMenu;
    Corriger1: TMenuItem;
    cxEditStyleController1: TcxEditStyleController;
    dxBarButtonTVARates: TdxBarButton;
    dxBarButtonBatchPrint: TdxBarButton;
    cxLookAndFeelController: TcxLookAndFeelController;
    SpeedButtonProductSortModel: TSpeedButton;
    SpeedButtonProductsSortDate: TSpeedButton;
    netshop_expenses: TAction;
    TabSheetExpenses: TTabSheet;
    JvPaneltitleExpenses: TJvPanel;
    Image9: TImage;
    PanelExpenses: TPanel;
    cxGridExpensesDBTableViewexpenses: TcxGridDBTableView;
    cxGridExpensesLevel1: TcxGridLevel;
    cxGridExpenses: TcxGrid;
    cxGridExpensesDBTableViewexpensesexpenses_date_time: TcxGridDBColumn;
    cxGridExpensesDBTableViewexpensesexpenses_amount: TcxGridDBColumn;
    cxGridExpensesDBTableViewexpensesexpenses_description: TcxGridDBColumn;
    cxGridViewRepository: TcxGridViewRepository;
    cxGridViewRepositoryDBTableViewSales: TcxGridDBTableView;
    AdvPanelStyler: TAdvPanelStyler;
    cxGridViewRepositoryDBTableViewSalesItems: TcxGridDBTableView;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_model: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_name: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_quantity: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_price_stock: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_owner_id: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_date_in: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_price_ht: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewStockDeposit: TcxGridDBTableView;
    cxGridViewRepositoryDBTableViewStockDepositproduct_model: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewStockDepositproduct_name: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewStockDepositproduct_price_stock: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewStockDepositproduct_quantity: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewStockDepositproduct_date_in_display: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesItemsitems_refunded: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesDeposit: TcxGridDBTableView;
    cxGridViewRepositoryDBTableViewSalesDeposititems_sold_model: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesDeposititems_sold_name: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesDeposititems_sold_quantity: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesDeposititems_sold_price_stock: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalesDepositDBColumnDateIn: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewRefunds: TcxGridDBTableView;
    cxGridViewRepositoryDBTableViewRefundsrefunds_id: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewRefundsrefunds_amount: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewRefundsrefunds_nature: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewRefundsrefunds_date_time_display: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRepair: TcxGridDBTableView;
    cxGridViewRepositoryDBTableViewCustRepairrepair_products_name: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRepairrepair_products_serial: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRepairrepair_products_problem: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRepairrepair_date_in_display: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRepairrepair_date_out_display: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRent: TcxGridDBTableView;
    cxGridViewRepositoryDBTableViewCustRentrent_transaction_id: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRentrent_transaction_product_name: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRentrent_transaction_start_display: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRentrent_transaction_due_display: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewCustRentrent_transaction_returned: TcxGridDBColumn;
    AdvPanelTransferGrid: TAdvPanel;
    StringGridTransfer: TAdvStringGrid;
    PanelAdminGrid: TAdvPanel;
    PanelInventoryGrids: TPanel;
    AdvPanelInventoryGrid: TAdvPanel;
    AdvPanelInventoryErrGrid: TAdvPanel;
    Splitter3: TSplitter;
    TabSheetConfiguration: TTabSheet;
    JvPanelConfigTitle: TJvPanel;
    Image3: TImage;
    JvPanelConfigTree: TAdvPanel;
    ParamTree: TParamTreeview;
    dxBarSubItem2: TdxBarSubItem;
    dxBarButton2: TdxBarButton;
    ActionExportContacts: TAction;
    dxBarButton3: TdxBarButton;
    ActionExportInvoice: TAction;
    DBCheckCustCountry: TdxBarButton;
    Edit1: TMenuItem;
    PageControlSalesCaddy: TAdvPageControl;
    Mailing: TAction;
    StatusLine: TdxStatusBar;
    PopupProductsCategories: TPopupMenu;
    Ajouteraufiltre1: TMenuItem;
    Retirerdufiltre1: TMenuItem;
    Supprimerfiltre1: TMenuItem;
    PopupProductsManufacturer: TPopupMenu;
    MenuItem1: TMenuItem;
    MenuItem2: TMenuItem;
    MenuItem3: TMenuItem;
    cxGridViewRepositoryDBTableViewSalessales_id: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_date_time_value: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_cash: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_bct: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_proton: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_visa: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_voucher: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_total: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_htva: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewSalessales_paid_tva: TcxGridDBColumn;
    dxBarButtonCheckDacal: TdxBarButton;
    StatusLineContainer3: TdxStatusBarContainerControl;
    ProgressBar: TcxProgressBar;
    BitBtnPurchaseHistory: TBitBtn;
    DBDebug: TAction;
    dxBarButtonDebug: TdxBarButton;
    PanelConfigRight: TPanel;
    GroupBoxTicketTip: TGroupBox;
    CheckBoxEnableTicketTip: TCheckBox;
    DBCtrlGrid1: TDBCtrlGrid;
    DBMemoTips: TDBMemo;
    GroupBoxTicketData: TGroupBox;
    ImageTicketLogo: TImage;
    ShopData1: TEdit;
    ShopData2: TEdit;
    ShopData3: TEdit;
    ShopData4: TEdit;
    ShopData5: TEdit;
    SpeedButtonTipsAdd: TSpeedButton;
    SpeedButtonTipsDelete: TSpeedButton;
    GroupBoxCDLibrary: TGroupBox;
    StringGridDacal: TAdvStringGrid;
    dxBarButtonReportAlerts: TdxBarButton;
    dxBarSubItem5: TdxBarSubItem;
    EntrerCaroussel1: TMenuItem;
    dxBarButtonExportMarketplace: TdxBarButton;
    dxBarButton6: TdxBarButton;
    dxBarButton8: TdxBarButton;
    SBReadEID: TSpeedButton;
    SBCustomersSalesShortcut: TSpeedButton;
    ActionNewRentCaddy: TAction;
    TabSheetRent: TTabSheet;
    PanelTopMarginRent: TPanel;
    JvPanelTitleRent: TJvPanel;
    ImageRentTitleBorder: TImage;
    PanelRentCustomer: TPanel;
    SBNewRentCaddyOut: TSpeedButton;
    BitBtnRentClear: TBitBtn;
    BitBtnRentProcess: TBitBtn;
    EditRentCustomerFirstName: TcxDBTextEdit;
    EditRentCustomerLastName: TcxDBTextEdit;
    EditRentCustomerId: TcxTextEdit;
    PanelRentCaddy: TPanel;
    PageControlRentCaddy: TAdvPageControl;
    PanelRentAddToGrid: TPanel;
    LabelRentModel: TLabel;
    LabelRentScheme: TLabel;
    LabelRentDescription: TLabel;
    LabelRentPrice: TLabel;
    LabelRentAvailable: TLabel;
    LabelRentDateIn: TLabel;
    EditRentModel: TEdit;
    EditRentName: TEdit;
    ComboBoxRent: TComboBox;
    EditRentDateIn: TEdit;
    dxBarButtonCoda: TdxBarButton;
    OpenDialog: TOpenDialog;
    SBNewRentCaddyIn: TSpeedButton;
    EditSalesAvailable: TcxMaskEdit;
    EditRentAvailable: TcxMaskEdit;
    EditRentPrice: TcxMaskEdit;
    EditInventoryQuantity: TcxMaskEdit;
    EditInventoryModel: TcxMaskEdit;
    BitBtnProductsPrintBarCode: TBitBtn;
    EditSalesPrice: TcxCurrencyEdit;
    EditTransferPrice: TcxCurrencyEdit;
    EditTransferDateIn: TEdit;
    Label3: TLabel;
    EditTransferName: TEdit;
    Label8: TLabel;
    EditTransferAvailable: TcxMaskEdit;
    Label9: TLabel;
    EditTransferQuantity: TcxMaskEdit;
    Label10: TLabel;
    ComboBoxTransferOwner: TComboBox;
    Label11: TLabel;
    EditTransferModel: TEdit;
    Label12: TLabel;
    Label13: TLabel;
    dxBarButtonRapportStockNew: TdxBarButton;
    dxBarButtonReportsStockSH: TdxBarButton;
    TabSheetWebInfo: TTabSheet;
    JvPanelWebInfoHeader: TJvPanel;
    ImageWebInfoHeaderBorder: TImage;
    PanelWebInfoHeaderMargin: TPanel;
    PanelWebInfoCentral: TPanel;
    AdvPageControlBrowser: TAdvPageControl;
    AdvTabSheetBrowserCLD: TAdvTabSheet;
    ActionWebInfo: TAction;
    EditSalesQuantity: TcxMaskEdit;
    Label15: TLabel;
    Sauver1: TMenuItem;
    dxBarButtonCleanStock: TdxBarButton;
    BitBtnOrders: TBitBtn;
    cxGridViewRepositoryDBTableViewStockDepositproduct_isdefect: TcxGridDBColumn;
    SBCustomerRentInShortcut: TSpeedButton;
    SBCustomerRentOutShortcut: TSpeedButton;
    dxBarButtonApplyUpdates: TdxBarButton;
    Panel9: TPanel;
    SBTransferSuggestIn: TSpeedButton;
    SBTransferSuggetsOut: TSpeedButton;
    ComboBoxSuggest: TComboBox;
    TabSheetMailing: TTabSheet;
    PanelMailingButtons: TPanel;
    JvExpressButton1: TJvExpressButton;
    JvExpressButton3: TJvExpressButton;
    JvExpressButton5: TJvExpressButton;
    JvExpressButton6: TJvExpressButton;
    JvExpressButton10: TJvExpressButton;
    JvExpressButton11: TJvExpressButton;
    RichEditMail: TRichEdit;
    CheckBoxEmptyStock: TCheckBox;
    dxBarSubItem11: TdxBarSubItem;
    dxBarButton1: TdxBarButton;
    dxBarButtonStock0valCompute: TdxBarButton;
    AdvPanel1: TAdvPanel;
    PanelCreateBasket: TPanel;
    EditSalesCustomerNbr: TcxTextEdit;
    SBNewSalesCaddy: TSpeedButton;
    EditSalesCustomerFirstName: TcxDBTextEdit;
    EditSalesCustomerLastName: TcxDBTextEdit;
    PanelProcessButtons: TPanel;
    BitBtnSalesProcess: TBitBtn;
    BitBtnSalesClear: TBitBtn;
    Panel11: TPanel;
    TabSheetStockin: TTabSheet;
    JvPanelStockinHeader: TJvPanel;
    PanelStockinMargin: TPanel;
    PanelStockinController: TPanel;
    Panel15: TPanel;
    SBNewStockinCaddy: TSpeedButton;
    EditStockinCustomerNbr: TcxTextEdit;
    cxDBTextEdit1: TcxDBTextEdit;
    cxDBTextEdit2: TcxDBTextEdit;
    Panel18: TPanel;
    BitBtnStockinProcessClick: TBitBtn;
    BitBtnStockinClearClick: TBitBtn;
    Panel19: TPanel;
    PanelStockinAdd: TPanel;
    PanelStockinCaddy: TPanel;
    PageControlStockinCaddy: TAdvPageControl;
    ImageStockinHeaderBorder: TImage;
    ComboBoxSupplier: TComboBox;
    SBNewStockinDepositCaddy: TSpeedButton;
    SBNewStockinBoughtCaddy: TSpeedButton;
    SBCustomerCreateCaddyBought: TSpeedButton;
    SBCustomerCreateCaddyDeposit: TSpeedButton;
    XMLDocumentiNVENTORY: TXMLDocument;
    Chargertable1: TMenuItem;
    dxBarButton5: TdxBarButton;
    dxBarButtonStockClearValue: TdxBarButton;
    dxBarButtonShowGrid: TdxBarButton;
    ActionMarketPlaceUpdate: TAction;
    JvToolBarInventoryErrors: TJvToolBar;
    ToolBarPrint: TToolBar;
    ToolButtonSave: TToolButton;
    ToolButtonOpen: TToolButton;
    ToolButton3: TToolButton;
    ImageListMenubar: TImageList;
    ToolButtonView: TToolButton;
    ToolButtonExport: TToolButton;
    ToolButtonInvErrSave: TToolButton;
    ToolButtonInvErrOpen: TToolButton;
    ToolButtonInvErrPrint: TToolButton;
    ToolButtonInvErrView: TToolButton;
    ActionWebOrders: TAction;
    TabSheetWebOrders: TTabSheet;
    JvPanelWebOrdersHeader: TJvPanel;
    ImageWebOrdersHeaderBorder: TImage;
    PanelWebOrdersHeaderMargin: TPanel;
    PanelWebOrdersCentral: TPanel;
    Panel5: TPanel;
    JvExpressButtonWebOrdersErase: TJvExpressButton;
    cxGridWebOrders: TcxGrid;
    cxGridWebOrdersDBTableView1: TcxGridDBTableView;
    cxGridWebOrdersLevel1: TcxGridLevel;
    cxGridWebOrdersDBTableView1products_quantity: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1products_model: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1products_root_category_name: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1products_name: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_city: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_id: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_telephone: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_email_address: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1date_purchased: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_fax: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_firstname: TcxGridDBColumn;
    cxGridWebOrdersDBTableView1customers_lastname: TcxGridDBColumn;
    JvExpressButtonWebOrdersProcess: TJvExpressButton;
    cxGridViewRepositoryDBTableViewSalessales_invoiced: TcxGridDBColumn;
    dxBarButton11: TdxBarButton;
    dxBarApplicationMenu1: TdxBarApplicationMenu;
    dxRibbon1Tab1: TdxRibbonTab;
    dxRibbon: TdxRibbon;
    dxBarManager1BarMainTabsGeneral: TdxBar;
    dxBarLargeButtonDBAdd: TdxBarLargeButton;
    dxBarLargeButtonDBEdit: TdxBarLargeButton;
    dxBarLargeButtonAdmin: TdxBarLargeButton;
    dxRibbon1TabAdmin: TdxRibbonTab;
    dxBarManager1BarMainTabsAdmin: TdxBar;
    dxBarLargeButtonVentes: TdxBarLargeButton;
    dxBarLargeButtonStockin: TdxBarLargeButton;
    dxBarLargeButtonTransfer: TdxBarLargeButton;
    dxBarButtonSearchLocal: TdxBarButton;
    dxBarButtonSearchCLD: TdxBarButton;
    dxBarPopupMenuSearch: TdxBarPopupMenu;
    dxBarButtonSmart: TdxBarButton;
    dxBarButtonClients: TdxBarButton;
    dxBarButtonProducts: TdxBarButton;
    ImageWebInfoHeaderBorderLogo: TImage;
    ImageStockinHeaderLogo: TImage;
    dxBarLargeButtonWebInfo: TdxBarLargeButton;
    ImageTransferHeaderLogo: TImage;
    ImageSalesTitleLogo: TImage;
    PanelTransferOptions: TPanel;
    Panel6: TPanel;
    cxEditStockinModel: TcxTextEdit;
    cxEditStockinPrice: TcxCurrencyEdit;
    cxEditStockinPriceGross: TcxCurrencyEdit;
    CxEditStockinQuantity: TcxMaskEdit;
    Label20: TLabel;
    Label21: TLabel;
    Label25: TLabel;
    Label29: TLabel;
    ImageWebOrdersHeaderLogo: TImage;
    dxBarLargeButtonWebOrder: TdxBarLargeButton;
    dxBarLargeButtonProducts: TdxBarLargeButton;
    Image2: TImage;
    Image4: TImage;
    dxBarManager1BarSync: TdxBar;
    dxBarLargeButtonFullSync: TdxBarLargeButton;
    dxBarLargeButtonSyncPartial: TdxBarLargeButton;
    StringGridAdmin: TAdvStringGrid;
    PanelAdminLeft: TPanel;
    PanelAdminCalendar: TPanel;
    PanelCalendarButtons: TPanel;
    StartValue: TcxCurrencyEdit;
    MonthCalendarAdminSales: TDateTimePicker;
    MonthCalendarAdminSalesEnd: TDateTimePicker;
    PanelAdminButtons: TPanel;
    JvLookOutButton1: TJvLookOutButton;
    JvLookOutButton2: TJvLookOutButton;
    JvLookOutButton3: TJvLookOutButton;
    JvLookOutButtonPayAnalysis: TJvLookOutButton;
    JvLookOutButton6: TJvLookOutButton;
    JvLookOutButtonReorderTopSellers: TJvLookOutButton;
    JvLookOutButtonReassort: TJvLookOutButton;
    JvLookOutButtonCloseCash: TJvLookOutButton;
    JvLookOutButtonCLDPush: TJvLookOutButton;
    PanelAdminSalesFigureGrid: TPanel;
    StringGridFigures: TAdvStringGrid;
    Image5: TImage;
    dxBarLargeButtonConfig: TdxBarLargeButton;
    Image6: TImage;
    dxBarLargeButtonExpenses: TdxBarLargeButton;
    dxBarLargeButton1: TdxBarLargeButton;
    Image10: TImage;
    ToolButtonInventoryErrorsExport: TToolButton;
    Inv: TJvExpressButton;
    InvEraseGrossPrice: TJvExpressButton;
    InvComputeFromSalesPrice: TJvExpressButton;
    InvCheckPrices: TJvExpressButton;
    cxGridInventory: TcxGrid;
    cxGridInventoryDBTableView1: TcxGridDBTableView;
    cxGridInventoryLevel1: TcxGridLevel;
    cxGridInventoryDBTableView1product_model: TcxGridDBColumn;
    cxGridInventoryDBTableView1product_price_stock: TcxGridDBColumn;
    cxGridInventoryDBTableView1product_quantity: TcxGridDBColumn;
    cxGridInventoryDBTableView1product_date_in: TcxGridDBColumn;
    cxGridInventoryDBTableView1product_price_gross: TcxGridDBColumn;
    cxGridInventoryDBTableView1product_name: TcxGridDBColumn;
    cxGridInventoryDBTableView1product_price_gross_total: TcxGridDBColumn;
    cxGrid1: TcxGrid;
    cxGridDBTableView7: TcxGridDBTableView;
    cxGridDBColumn1: TcxGridDBColumn;
    cxGridDBColumn2: TcxGridDBColumn;
    cxGridDBColumn3: TcxGridDBColumn;
    cxGridDBColumn4: TcxGridDBColumn;
    cxGridDBColumn5: TcxGridDBColumn;
    cxGridDBColumn6: TcxGridDBColumn;
    cxGridDBColumn7: TcxGridDBColumn;
    cxGridLevel8: TcxGridLevel;
    Image11: TImage;
    dxBarManager1BarMaintenance: TdxBar;
    dxBarSubItemDacal: TdxBarSubItem;
    dxBarButtonDacalSearch: TdxBarButton;
    dxBarSubItem1: TdxBarSubItem;
    dxBarButton4: TdxBarButton;
    dxBarButton7: TdxBarButton;
    dxBarButtonReportCustomerCredit: TdxBarButton;
    dxBarButtonReportDepositNonRefunded: TdxBarButton;
    dxBarButtonReportRepair: TdxBarButton;
    dxBarMRULargeButtonClient: TdxBarMRUListItem;
    dxBarButton9: TdxBarButton;
    dxBarSubItem3: TdxBarSubItem;
    dxBarSubItemCustomers: TdxBarSubItem;
    dxBarButtonCustomersShopAccount: TdxBarButton;
    dxBarSubItem6: TdxBarSubItem;
    dxBarMRUListItemCustomers: TdxBarMRUListItem;
    model_comy: TMenuItem;
    dxBarButtonReportInvoiceBatch: TdxBarButton;
    AdvAlertWindow: TAdvAlertWindow;
    dxBarButtonRebuildRootCat: TdxBarButton;
    dxBarLargeButtonLog: TdxBarLargeButton;
    TabSheetLog: TTabSheet;
    PanelLogCentral: TPanel;
    PanelLogHeaderMargin: TPanel;
    JvPanelLogHeader: TJvPanel;
    Image12: TImage;
    Image13: TImage;
    ActionLog: TAction;
    MemoLog: TMemo;
    DBEditProductsImage: TDBEdit;
    SpeedButtonToLive: TSpeedButton;
    SpeedButtonToArchives: TSpeedButton;
    AdvHTMLMemoStyler1: TAdvHTMLMemoStyler;
    SBProductsOrderStatus: TSpeedButton;
    LabelStockinWarning: TLabel;
    cxButtonAdminDateRangeMonth: TcxButton;
    cxButtonAdminDateRangeWeek: TcxButton;
    cxButtonAdminDateRangeDay: TcxButton;
    Action1: TAction;
    cxCurrencyEditLower: TcxCurrencyEdit;
    dxBarButtonEmptyUnsellable: TdxBarButton;
    Action2: TAction;
    ToolButtonMerge: TToolButton;
    EditTransferReserved: TcxMaskEdit;
    Label33: TLabel;
    EditSalesReserved: TcxMaskEdit;
    Label34: TLabel;
    BitBtnSalesReserve: TBitBtn;
    dxBarSubItem4: TdxBarSubItem;
    dxBarButtonDPOverpriced: TdxBarButton;
    dxBarButtonInvendus: TdxBarButton;
    SpeedButton1: TSpeedButton;
    dxBarButtonDacalFast: TdxBarButton;
    PageControlCustomersDetails: TPageControl;
    TabSheetDetails: TTabSheet;
    TabSheetList: TTabSheet;
    GroupBoxCustomersData: TGroupBox;
    LabelCustomerOrigValue: TLabel;
    LabelCustomerVoucher: TLabel;
    LabelCustomerFax: TLabel;
    LabelCustomerPhone: TLabel;
    LabelCustomerPcode: TLabel;
    LabelCustomerStreet: TLabel;
    LabelCustomerEmail: TLabel;
    LabelCustomerFirstname: TLabel;
    LabelCustomerLastname: TLabel;
    LabelCustomerCity: TLabel;
    LabelCustomerNbr: TLabel;
    Label5: TLabel;
    Label4: TLabel;
    LabelCustomerCountry: TLabel;
    LabelCustomerLoyalty: TLabel;
    Label6: TLabel;
    Label30: TLabel;
    Label2: TLabel;
    SBCustomersErase: TSpeedButton;
    DBEditCustomerNbr: TcxDBTextEdit;
    DBEditCustomerName: TcxDBTextEdit;
    DBEditCustomerFirstName: TcxDBTextEdit;
    DBEditCustomerEmail: TcxDBTextEdit;
    DBEditCustomerAdress: TcxDBTextEdit;
    DBEditCustomerPhone: TcxDBTextEdit;
    DBEditCustomerGsm: TcxDBTextEdit;
    DBEditCustomerPass: TcxDBTextEdit;
    DBEditCustomerVoucher: TcxDBTextEdit;
    DBEditCustomerPoints: TcxDBTextEdit;
    DBEditCustomerId: TcxDBTextEdit;
    DBEditCustomerPCode: TcxDBTextEdit;
    DBComboCustomerCountry: TcxDBLookupComboBox;
    DBComboCustomerCity: TcxDBComboBox;
    DBEditCustomerVAT: TcxDBMaskEdit;
    DBEditCustomersLoyalty: TcxDBTextEdit;
    cxDBLookupComboBox1: TcxDBLookupComboBox;
    cxDBCheckBoxCustIsTVA: TcxDBCheckBox;
    cxDBCheckBox1: TcxDBCheckBox;
    cxDBDateEditCustomer: TcxDBDateEdit;
    cxDBTextEdit3: TcxDBTextEdit;
    PanelCustomersTab: TPanel;
    PanelCustomersTabs: TPanel;
    PageControlCustomers: TPageControl;
    TabSheetCustomersSales: TTabSheet;
    PanelCustomerPurchaseButtons: TPanel;
    BitBtnCustomerBuyTicket: TBitBtn;
    BitBtnCustomerBuyCancel: TBitBtn;
    BitBtnCustomerBuyInvoice: TBitBtn;
    PanelcustSalesGrid: TPanel;
    Splitter1: TSplitter;
    AdvPanelCustSales: TAdvPanel;
    cxGridCustSales: TcxGrid;
    cxGridDBTableView1: TcxGridDBTableView;
    cxGridLevel1: TcxGridLevel;
    AdvPanelCustSalesItems: TAdvPanel;
    cxGridCustSalesItems: TcxGrid;
    cxGridDBTableView2: TcxGridDBTableView;
    cxGridLevel2: TcxGridLevel;
    TabSheetCustomersDeposit: TTabSheet;
    PanelCustomersDeposidGrids: TPanel;
    Splitter2: TSplitter;
    AdvPanelCustDepositStock: TAdvPanel;
    cxGrid3: TcxGrid;
    cxGridDBTableView3: TcxGridDBTableView;
    cxGridLevel3: TcxGridLevel;
    AdvPanel5: TAdvPanel;
    PanelCustomersRadioButtons: TPanel;
    RadioButtonCustomerDepositRefunded: TRadioButton;
    RadioButtonCustomerDepositNonRefunded: TRadioButton;
    RadioButtonCustomerDepositAll: TRadioButton;
    cxGrid2: TcxGrid;
    cxGridDBTableView4: TcxGridDBTableView;
    cxGridLevel4: TcxGridLevel;
    PanelCustomerDepositButtons: TPanel;
    BitBtnCustomerDepositStatus: TBitBtn;
    BitBtnCustomerDepositToVoucher: TBitBtn;
    BitBtnCustomerDepositRefund: TBitBtn;
    BitBtnCustomerDepositAddFund: TBitBtn;
    BitBtnCustomerDepositReturn: TBitBtn;
    BitBtnCustomerDepositDefect: TBitBtn;
    TabSheetCustomersRefund: TTabSheet;
    Panel3: TPanel;
    PanelCustomersRefundsButtons: TPanel;
    PanelCustRefundGrid: TPanel;
    AdvPanelCustRefunds: TAdvPanel;
    TabSheetCustomersInvoice: TTabSheet;
    Panel1: TPanel;
    BitBtnCustomerInvoiceClose: TBitBtn;
    BitBtnCustomerInvoiceSticker: TBitBtn;
    BitBtnCustomerInvoiceView: TBitBtn;
    BitBtnCustomerInvoicePrint: TBitBtn;
    BitBtnCustomerInvoiceMail: TBitBtn;
    PanelCustInvoicesGrid: TPanel;
    AdvPanelCustomerInvoices: TAdvPanel;
    cxGridCustInvoices: TcxGrid;
    cxGridCustInvoicesDBTableViewCustInvoices: TcxGridDBTableView;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn2: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn1: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn3: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn4: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn5: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn6: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn7: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesDBColumn8: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesItems: TcxGridDBTableView;
    cxGridCustInvoicesDBTableViewCustInvoicesItemsDBColumn1: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesItemsDBColumn2: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesItemsDBColumn3: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesItemsDBColumn4: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesItemsDBColumn5: TcxGridDBColumn;
    cxGridCustInvoicesDBTableViewCustInvoicesItemsDBColumn6: TcxGridDBColumn;
    cxGridCustInvoicesLevel1: TcxGridLevel;
    cxGridCustInvoicesLevel2: TcxGridLevel;
    TabSheetCustomersOrders: TTabSheet;
    PanelCustomersAlertsTop: TPanel;
    Label18: TLabel;
    Label19: TLabel;
    Edsearch: TcxTextEdit;
    DBGridOrders: TDBGrid;
    CustomerAlertMaxPrice: TcxTextEdit;
    RadioButtonAlertsProductFilterPreOrder: TRadioButton;
    RadioButtonAlertsProductFilterBackCatalogue: TRadioButton;
    RadioButtonAlertsProductFilterAll: TRadioButton;
    Panel7: TPanel;
    PanelCustomersAlertsFilter: TPanel;
    RadioButtonAlertsreserved: TRadioButton;
    RadioButtonAlertsArrived: TRadioButton;
    RadioButtonAlertsNotified: TRadioButton;
    RadioButtonAlertsBought: TRadioButton;
    ButtonCustomerAlertsResetAttempts: TButton;
    cxGridCustomersAlert: TcxGrid;
    cxGridDBTableViewCustomersOrders: TcxGridDBTableView;
    cxGridDBTableViewCustomersOrderscustomers_alerts_products_model: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_products_name: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_products_cat: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_used: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_date_disp: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrdersColumnDateNotified: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_quantity: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_attempts: TcxGridDBColumn;
    cxGridDBTableViewCustomersOrderscustomers_alerts_comment: TcxGridDBColumn;
    cxGridLevel7: TcxGridLevel;
    TabSheetCustomersRepair: TTabSheet;
    PanelCustomersRepairSurface: TPanel;
    PanelCustomersRepairButtons: TPanel;
    BitBtnCustomerRepairCreate: TBitBtn;
    BitBtnCustomerRepairStatus: TBitBtn;
    BitBtnCustomerRepairReturn: TBitBtn;
    BitBtnCustomerRepairExecute: TBitBtn;
    PanelCustRepair: TPanel;
    AdvPanel2: TAdvPanel;
    Panel8: TPanel;
    RadioButtonCustomerRepairReturned: TRadioButton;
    RadioButtonCustomerRepairProcessed: TRadioButton;
    RadioButtonCustomerRepairAll: TRadioButton;
    cxGridCustRepair: TcxGrid;
    cxGridCustRepairDBTableView1: TcxGridDBTableView;
    cxGridCustRepairLevel1: TcxGridLevel;
    TabSheetCustomersRent: TTabSheet;
    Panel10: TPanel;
    Panel13: TPanel;
    PanelCustRent: TPanel;
    AdvPanel3: TAdvPanel;
    PanelCustomerRentTop: TPanel;
    RadioButtonCustomerRentClosed: TRadioButton;
    RadioButtonCustomerRentPending: TRadioButton;
    RadioButtonCustomerRentAll: TRadioButton;
    cxDBCheckBoxRent_Enabled: TcxDBCheckBox;
    cxGridCustRent: TcxGrid;
    cxGridDBTableView6: TcxGridDBTableView;
    cxGridLevel6: TcxGridLevel;
    TabSheetCustContact: TTabSheet;
    Panel2: TPanel;
    BitBtnCustomereMail: TBitBtn;
    BitBtnCustomerSMS: TBitBtn;
    PanelCustContact: TPanel;
    AdvPanel4: TAdvPanel;
    Panel4: TPanel;
    LabelCustomerContactSubject: TLabel;
    labelcustomercontactBody: TLabel;
    MessageSubject: TcxTextEdit;
    MessageBody: TcxMemo;
    TabSheetCustomersMemo: TTabSheet;
    DBMemoCustomersMemo: TDBMemo;
    TabSheetReturns: TTabSheet;
    cxGridStockReturned: TcxGrid;
    cxGridStockReturnedDBTableView1: TcxGridDBTableView;
    cxGridStockReturnedDBTableView1product_model: TcxGridDBColumn;
    cxGridStockReturnedDBTableView1product_name: TcxGridDBColumn;
    cxGridStockReturnedDBTableView1product_price_stock: TcxGridDBColumn;
    cxGridStockReturnedDBTableView1product_quantity: TcxGridDBColumn;
    cxGridStockReturnedDBTableView1product_isdefect: TcxGridDBColumn;
    cxGridStockReturnedDBTableView1product_date_in_display: TcxGridDBColumn;
    cxGridStockReturnedDBTableView1date_returned_display: TcxGridDBColumn;
    cxGridStockReturnedLevel1: TcxGridLevel;
    Paneltopmargin: TPanel;
    cxGridCustomerList: TcxGrid;
    cxGridCustomerListDBTableViewCustomers: TcxGridDBTableView;
    cxGridCustomerListDBTableViewCustomerscustomers_firstname: TcxGridDBColumn;
    cxGridCustomerListDBTableViewCustomerscustomers_lastname: TcxGridDBColumn;
    cxGridCustomerListDBTableViewCustomerscustomers_points: TcxGridDBColumn;
    cxGridCustomerListDBTableViewCustomerscustomers_nbr: TcxGridDBColumn;
    cxGridCustomerListLevel1: TcxGridLevel;
    cxGridCustomerListDBTableViewCustomerscustomers_credit: TcxGridDBColumn;
    PageControlProducts: TPageControl;
    TabSheetProductsDetails: TTabSheet;
    PanelProductsEdits: TPanel;
    PanelProductsEditsLeftMarfin: TPanel;
    PanelProductsEditsCenter: TPanel;
    LabelProductsTax: TLabel;
    LabelProductsDateIn: TLabel;
    LabelProductsPrice: TLabel;
    LabelProductModel: TLabel;
    LabelProductCategorie: TLabel;
    LabelProductManufacturer: TLabel;
    LabelProductId: TLabel;
    LabelProductsPriceAllIn: TLabel;
    Label16: TLabel;
    LabelProductRoot: TLabel;
    Label22: TLabel;
    Label23: TLabel;
    LabelProductWeight: TLabel;
    SpeedButtonChangeEAN: TSpeedButton;
    LabelProductStatus: TLabel;
    LabelProductInternalName: TLabel;
    LabelProductsCLDID: TLabel;
    DBLookupComboBoxProductsManufacturer: TDBLookupComboBox;
    DBEditProductsID: TDBEdit;
    DBLookupComboBoxProductsTax: TDBLookupComboBox;
    DBEditProductsModel: TDBEdit;
    ButtonProductsSetPrice: TButton;
    ProductsOptions: TGroupBox;
    DBCheckProductStock: TDBCheckBox;
    DBCheckProductLoyalty: TDBCheckBox;
    DBCheckProductPreview: TDBCheckBox;
    DBCheckProductDiscontinued: TDBCheckBox;
    DBCheckProductStreetBlock: TDBCheckBox;
    DBEditProductsRootName: TDBEdit;
    cxDBProductsDateAvailable: TcxDBDateEdit;
    cxDBProductsDateIn: TcxDBDateEdit;
    DBLookupComboBoxProductsWarranty: TDBLookupComboBox;
    DBEditProductWeight: TDBEdit;
    EditProductNewPrice: TcxCurrencyEdit;
    DBEditProductPriceHT: TcxDBCurrencyEdit;
    DBEditProductPriceAllIn: TcxDBCurrencyEdit;
    JvDBLookupTreeViewCombo: TJvDBLookupTreeViewCombo;
    DBEditProductActif: TDBEdit;
    PageControlProductsDescription: TPageControl;
    TabSheetProDescFR: TTabSheet;
    LabelProdcutsName: TLabel;
    LabelProductTitleExtend: TLabel;
    LabelProductsBonus: TLabel;
    SBDeleteProDescFR: TSpeedButton;
    DBEditProductsName: TDBEdit;
    DBEditProductNameExt: TDBEdit;
    DBMemoBonus: TDBMemo;
    TabSheetProDescNL: TTabSheet;
    Label7: TLabel;
    Label17: TLabel;
    Label31: TLabel;
    Label32: TLabel;
    SBDeleteProDescNL: TSpeedButton;
    DBMemo1: TDBMemo;
    DBAdvMemo1: TDBAdvMemo;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEditProductDisplayName: TDBEdit;
    DBEditProductsCLDID: TDBEdit;
    PanelProductsEditsRightMargin: TPanel;
    PanelProductsBottom: TPanel;
    DBEditCustomerNationalID: TcxDBTextEdit;
    Label36: TLabel;
    cxDBTextEdit4: TcxDBTextEdit;
    DBCheckBoxProductESD: TDBCheckBox;
    PanelCashClose: TPanel;
    cxGrid4: TcxGrid;
    cxGridDBTableView8: TcxGridDBTableView;
    cxGridLevel9: TcxGridLevel;
    cxGridDBTableView8cashclose_amountout: TcxGridDBColumn;
    cxGridDBTableView8cashclose_operator: TcxGridDBColumn;
    cxGridDBTableView8cashclose_daytasks: TcxGridDBColumn;
    cxGridDBTableView8cashclose_datedisp: TcxGridDBColumn;
    SpeedButtonPause: TSpeedButton;
    dxBarButtonStockByPlatform: TdxBarButton;
    WebBrowserCLD: TEmbeddedWB;
    dxBarButtonScanDacal: TdxBarButton;
    cxGridViewRepositoryDBTableViewSalesItemsitems_sold_loyalty: TcxGridDBColumn;
    cxGridViewRepositoryDBTableViewRefundsrefunds_signature: TcxGridDBColumn;
    DBCheckBoxProductsPOSA: TDBCheckBox;
    dxbrbtnAlertsMarkAsSent: TdxBarButton;
    btnRefreshESD: TBitBtn;
    cxtxtdtEan: TcxTextEdit;
    dbdvmproducts_msgticketNL: TDBAdvMemo;
    lbl1: TLabel;
    lbl2: TLabel;
    dbdvmproducts_descriptionFR: TDBAdvMemo;
    lbl3: TLabel;
    dbdvmproducts_msgticketFR: TDBAdvMemo;
    cxgrdbclmnGridDBTableViewCustomersOrderscustomers_alerts_dwnpay: TcxGridDBColumn;
    splReturns: TSplitter;
    advpnlItemsRefunded1: TAdvPanel;
    cxgrd1: TcxGrid;
    cxgrdbtblvw1: TcxGridDBTableView;
    cxgrdlvl1: TcxGridLevel;
    cxgrd2: TcxGrid;
    cxgrdbtblvw2: TcxGridDBTableView;
    cxgrdlvl2: TcxGridLevel;
    cxgrd3: TcxGrid;
    cxgrdbtblvw3: TcxGridDBTableView;
    cxgrdlvl3: TcxGridLevel;
    cxgrdbtblvwGrid5DBTableView1: TcxGridDBTableView;
    cxgrdlvlGrid5Level1: TcxGridLevel;
    cxgrditemsrefunded: TcxGrid;
    cxgrdbclmnGrid5DBTableView1items_refunded_model: TcxGridDBColumn;
    cxgrdbclmnGrid5DBTableView1items_refunded_name: TcxGridDBColumn;
    cxgrdbclmnGrid5DBTableView1items_refunded_quantity: TcxGridDBColumn;
    cxgrdbclmnGrid5DBTableView1items_refunded_price_stock: TcxGridDBColumn;
    cxgrdbclmnGrid5DBTableView1items_refunded_owner_id: TcxGridDBColumn;
    cxgrdbclmnGrid5DBTableView1items_refunded_supplier_id: TcxGridDBColumn;
    cxgrdbclmnGrid5DBTableView1items_refunded_date_in: TcxGridDBColumn;
    dxBarSubItem7: TdxBarSubItem;
    ReportCoupons: TdxBarSubItem;
    RaportCoupons: TdxBarButton;
    tsVouchers: TTabSheet;
    cxgrdCoupons: TcxGrid;
    cxgrdbtblvwVouchers: TcxGridDBTableView;
    cxgrdlvl4: TcxGridLevel;
    cxgrdbclmnVoucherscoupon_code: TcxGridDBColumn;
    cxgrdbclmnVoucherscoupon_amount: TcxGridDBColumn;
    cxgrdbclmnVoucherscoupon_minimum_order: TcxGridDBColumn;
    cxgrdbclmnVoucherscoupon_active: TcxGridDBColumn;
    cxgrdbclmnVoucherscoupon_start_date: TcxGridDBColumn;
    cxgrdbclmnVoucherscoupon_expire_date: TcxGridDBColumn;
    cxgrdbclmnVoucherscoupon_description: TcxGridDBColumn;
    PopupMenuCoupons: TPopupMenu;
    CopierBon: TMenuItem;
    act1: TAction;

    procedure MailingExecute(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure dxBarButton14Click(Sender: TObject);
    procedure WebBrowserCLDDocumentComplete(ASender: TObject; const pDisp: IDispatch; var URL: OleVariant);
    procedure JvLookOutButtonReassortClick(Sender: TObject);
    procedure SBTransferSuggestInClick(Sender: TObject);
    procedure SBTransferSuggetsOutClick(Sender: TObject);
    procedure InvCheckPricesClick(Sender: TObject);
    procedure InvEraseGrossPriceClick(Sender: TObject);
    procedure dxBarButtonApplyUpdatesClick(Sender: TObject);
    procedure SBCustomerRentOutShortcutClick(Sender: TObject);
    procedure SBCustomerRentInShortcutClick(Sender: TObject);
    procedure BitBtnTransferSuggestClick(Sender: TObject);
    procedure BitBtnOrdersClick(Sender: TObject);
    procedure CustomerAlertMaxPriceKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure CustomerAlertMaxPriceEnter(Sender: TObject);
    procedure dxBarButtonCleanStockClick(Sender: TObject);
    procedure Sauver1Click(Sender: TObject);
    procedure ActionWebInfoExecute(Sender: TObject);
    procedure EditSalesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EditStockinNewKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EditTransferKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EditInventoryKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure BitBtnProductsPrintBarCodeClick(Sender: TObject);
    procedure dxBarButtonReportsStockSHClick(Sender: TObject);
    procedure dxBarButtonRapportStockNewClick(Sender: TObject);
    procedure EditInventoryModelExit(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure ShowHint(Sender: TObject);
    procedure ButtonInventoryRebuildGrossPriceClick(Sender: TObject);
    procedure EditSalesModelExit(Sender: TObject);
    procedure ComboBoxSalesOwnerChange(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure EditSalesCustomerNbrEnter(Sender: TObject);
    procedure DBEdit4Change(Sender: TObject);
    procedure TimerDBupdateTimer(Sender: TObject);
    procedure BitBtnTransferProcessClick(Sender: TObject);
    procedure Delete1Click(Sender: TObject);
    procedure RadioButtonSendClick(Sender: TObject);
    procedure RadioButtonReceiveClick(Sender: TObject);
    procedure NeditTransferQuantityKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EditTransferModelExit(Sender: TObject);
    procedure ComboBoxTransferOwnerChange(Sender: TObject);
    procedure BitBtnSalesProcessClick(Sender: TObject);
    procedure BitBtnTransferClearClick(Sender: TObject);
    procedure BitBtnSalesClearClick(Sender: TObject);
    procedure ComboBoxOriginShopChange(Sender: TObject);
    procedure StockCheckClick(Sender: TObject);
    procedure SbuttonProductImageSaveClick(Sender: TObject);
    procedure SButtonproductimagerotateClick(Sender: TObject);
    procedure SButtonProductImageOpenClick(Sender: TObject);
    procedure SButtonProductImageScanClick(Sender: TObject);
    procedure SbuttonProductPictureUploadClick(Sender: TObject);
    procedure BitBtnProductsStockCheckClick(Sender: TObject);
    procedure BitBtnProductsPrintLabelClick(Sender: TObject);
    procedure ButtonFactureClick(Sender: TObject);
    procedure PrintLabel1Click(Sender: TObject);
    procedure BitBtn_InventoryClearClick(Sender: TObject);
    procedure BitBtn_inventorycloseClick(Sender: TObject);
    procedure ChangeOrice1Click(Sender: TObject);
    procedure TransfertExecute(Sender: TObject);
    procedure inventoryExecute(Sender: TObject);
    procedure ConfigExecute(Sender: TObject);
    procedure AdminExecute(Sender: TObject);
    procedure VenteExecute(Sender: TObject);
    procedure ClientsExecute(Sender: TObject);
    procedure ProduitsExecute(Sender: TObject);
    procedure EntreeExecute(Sender: TObject);
    procedure PageControlCustomersChange(Sender: TObject);
    procedure Copiermodle1Click(Sender: TObject);
    procedure ButtonInventoryShowClick(Sender: TObject);
    procedure TimerUpdateConnectionLedsTimer(Sender: TObject);
    procedure ButtonStockinNewCustomerClick(Sender: TObject);
    procedure ActionCustomerDepositnonrefundedExecute(Sender: TObject);
    procedure ActionCustomerDepositRefundedExecute(Sender: TObject);
    procedure ActionCustomerDepositAllExecute(Sender: TObject);
    procedure JvExpressButton13Click(Sender: TObject);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure ActionCustomerRepairAllExecute(Sender: TObject);
    procedure ActionCustomerRepairProcessedExecute(Sender: TObject);
    procedure ActionCustomerRepairReturnedExecute(Sender: TObject);
    procedure DBLookupTreeViewProductsCategoriesDropDown(Sender: TObject);
    procedure ButtonAddProductsPathClick(Sender: TObject);
    procedure StringGridSalesEditingDone(Sender: TObject);
    procedure StringGridStockinEditingDone(Sender: TObject);
    procedure ActionDBSyncExecute(Sender: TObject);
    procedure ActionDBCheckCatExecute(Sender: TObject);
    procedure ActionDBCheckEanExecute(Sender: TObject);
    procedure ActionDBBuildIdExecute(Sender: TObject);
    procedure ActionRaportDayCashierExecute(Sender: TObject);
    procedure JvLookOutButton2Click(Sender: TObject);
    procedure JvLookOutButton3Click(Sender: TObject);
    procedure JvLookOutButtonPaymentAnalysis(Sender: TObject);
    procedure ActionDBProductsVisibilityExecute(Sender: TObject);
    procedure SpeedButtonToArchivesClick(Sender: TObject);
    procedure SpeedButtonToLiveClick(Sender: TObject);
    procedure RentExecute(Sender: TObject);
    procedure dxBarButtonUkClick(Sender: TObject);
    procedure dxBarButtonNLClick(Sender: TObject);
    procedure ActionCustomerRentAllExecute(Sender: TObject);
    procedure ActionCustomerRentPendingExecute(Sender: TObject);
    procedure ActionCustomerRentClosedExecute(Sender: TObject);
    procedure InvClick(Sender: TObject);
    procedure Corriger1Click(Sender: TObject);
    procedure ButtonProductsSetPriceClick(Sender: TObject);
    procedure DBEditCustomerPCodeExit(Sender: TObject);
    procedure dxBarButtonBatchPrintClick(Sender: TObject);
    procedure CustomersInvoiceMailClick(Sender: TObject);
    procedure edsearchKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edsearchChange(Sender: TObject);
    procedure CustomersInvoicePreviewClick(Sender: TObject);
    procedure SpeedButtonProductsSortDateClick(Sender: TObject);
    procedure SpeedButtonProductSortModelClick(Sender: TObject);
    procedure CustomersInvoiceCancelClick(Sender: TObject);
    procedure dxBarButtonFrenchClick(Sender: TObject);
    procedure JvLookOutButton6Click(Sender: TObject);
    procedure netshop_expensesExecute(Sender: TObject);
    procedure JvLookOutButtonAdminDayCashClick(Sender: TObject);
    procedure PageControlAdminSalesResize(Sender: TObject);
    procedure ParamTreeParamList(Sender: TObject; ANode: TTreeNode; href: string; values: TStringList; var DoPopup: Boolean);
    procedure ActionExportInvoiceExecute(Sender: TObject);
    procedure DBComboCustomerCountryExit(Sender: TObject);
    procedure DBCheckCustCountryClick(Sender: TObject);
    procedure Edit1Click(Sender: TObject);
    procedure ParamTreeParamChanged(Sender: TObject; ANode: TTreeNode; href, oldvalue, newvalue: string);
    procedure Ajouteraufiltre1Click(Sender: TObject);
    procedure Supprimerfiltre1Click(Sender: TObject);
    procedure MenuItem1Click(Sender: TObject);
    procedure WebBrowserDownloadComplete(Sender: TObject);
    procedure EdsearchEditing(Sender: TObject; var CanEdit: Boolean);
    procedure EdsearchKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBGridOrdersCellClick(Column: TColumn);
    procedure dxBarButtonCheckDacalClick(Sender: TObject);
    procedure CustomersInvoicesPrintStickerClick(Sender: TObject);
    procedure EditStockinCustomerIdKeyPress(Sender: TObject; var Key: Char);
    procedure EditStockinCustomerIdKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EditSalesCustomerNbrKeyPress(Sender: TObject; var Key: Char);
    procedure EditSalesCustomerNbrKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure BitBtnPurchaseHistoryClick(Sender: TObject);
    procedure DBDebugExecute(Sender: TObject);
    procedure SpeedButtonTipsAddClick(Sender: TObject);
    procedure SpeedButtonTipsDeleteClick(Sender: TObject);
    procedure DBGridOrdersDblClick(Sender: TObject);
    procedure dxBarButtonReportAlertsClick(Sender: TObject);
    procedure EntrerCaroussel1Click(Sender: TObject);
    procedure EditRentCustomerIdOldEnter(Sender: TObject);
    procedure EditRentCustomerIdOldKeyPress(Sender: TObject; var Key: Char);
    procedure EditRentCustomerIdOldKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure JVButtonCustomerRentActivateClick(Sender: TObject);
    procedure dxBarButton6Click(Sender: TObject);
    procedure dxBarButton8Click(Sender: TObject);
    procedure SBReadEIDClick(Sender: TObject);
    procedure SBCustomersSalesShortcutClick(Sender: TObject);
    procedure BitBtnRentClearClick(Sender: TObject);
    procedure BitBtnRentProcessClick(Sender: TObject);
    procedure EditRentCustomerIdEnter(Sender: TObject);
    procedure EditRentCustomerIdKeyPress(Sender: TObject; var Key: Char);
    procedure EditRentCustomerIdKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure NewRentCaddyClick(Sender: TObject; TransactionType: TRentOperation);
    procedure SBNewSalesCaddyClick(Sender: TObject);
    procedure EditRentModelExit(Sender: TObject);
    procedure SBNewRentCaddyOutClick(Sender: TObject);
    procedure dxBarButtonCodaClick(Sender: TObject);
    procedure JvButtonCustomerRentStatusClick(Sender: TObject);
    procedure JvButtonCustomerRentExtendClick(Sender: TObject);
    procedure SBNewRentCaddyInClick(Sender: TObject);
    procedure PageControlRentCaddyChange(Sender: TObject);
    procedure NEditRentAvailableKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    function GetRentCaddyType: TRentOperation;
    function GetRentCaddyCustomerNbr: Integer;
    procedure dxBarButton1Click(Sender: TObject);
    procedure dxBarButtonStock0valComputeClick(Sender: TObject);
    procedure searchstringKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure SBNewStockinCaddyClick(Sender: TObject);
    procedure BitBtnStockinClearClickClick(Sender: TObject);
    procedure SBNewStockinDepositCaddyClick(Sender: TObject);
    procedure SBNewStockinBoughtCaddyClick(Sender: TObject);
    procedure cxEditStockinModelExit(Sender: TObject);
    procedure EditStockinCustomerNbrKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EditStockinCustomerNbrKeyPress(Sender: TObject; var Key: Char);
    procedure BitBtnStockinProcessClickClick(Sender: TObject);
    procedure SBCustomerCreateCaddyDepositClick(Sender: TObject);
    procedure SBCustomerCreateCaddyBoughtClick(Sender: TObject);
    procedure Chargertable1Click(Sender: TObject);
    procedure dxBarButtonStockClearValueClick(Sender: TObject);
    procedure ActionMarketPlaceUpdateExecute(Sender: TObject);
    procedure DBEditCustomerVATEditing(Sender: TObject; var CanEdit: Boolean);
    procedure JvLookOutButtonCloseCashClick(Sender: TObject);
    procedure JvLookOutButtonCLDPushClick(Sender: TObject);
    procedure ToolButtonSaveClick(Sender: TObject);
    procedure ToolButtonOpenClick(Sender: TObject);
    procedure ToolButtonViewClick(Sender: TObject);
    procedure InvExportXlsClick(Sender: TObject);
    procedure ToolButtonExportClick(Sender: TObject);
    procedure ToolButtonInvErrSaveClick(Sender: TObject);
    procedure ToolButtonInvErrOpenClick(Sender: TObject);
    procedure SpeedButtonChangeEANClick(Sender: TObject);
    procedure ActionWebOrdersExecute(Sender: TObject);
    procedure JvExpressButtonWebOrdersEraseClick(Sender: TObject);
    procedure JvExpressButtonWebOrdersProcessClick(Sender: TObject);
    procedure cxGridDBTableViewCustomersOrdersDblClick(Sender: TObject);
    procedure dxBarButton11Click(Sender: TObject);
    procedure dxBarButtonSearchLocalClick(Sender: TObject);
    procedure dxBarButtonClientsClick(Sender: TObject);
    procedure dxBarButtonProductsClick(Sender: TObject);
    procedure dxBarButtonSearchCLDClick(Sender: TObject);
    procedure dxBarLargeButtonSyncPartialClick(Sender: TObject);
    procedure ToolButtonInventoryErrorsExportClick(Sender: TObject);
    procedure ToolButton3Click(Sender: TObject);
    procedure ToolButtonInvErrPrintClick(Sender: TObject);
    procedure ToolButtonInvErrViewClick(Sender: TObject);
    procedure dxBarButtonDacalSearchClick(Sender: TObject);
    procedure MonthCalendarAdminSalesCloseUp(Sender: TObject);
    procedure dxBarButtonReportCustomerCreditClick(Sender: TObject);
    procedure dxBarButtonReportDepositNonRefundedClick(Sender: TObject);
    procedure dxBarButtonReportRepairClick(Sender: TObject);
    procedure PhidgetRFIDOutputChange(ASender: TObject; Index: Integer; NewState: WordBool);
    procedure PhidgetRFIDTag(ASender: TObject; const TagNumber: WideString);
    procedure PhidgetRFIDAttach(Sender: TObject);
    procedure PhidgetRFIDTagLost(ASender: TObject; const TagNumber: WideString);
    procedure BitBtnCustomerBuyInvoiceClick(Sender: TObject);
    procedure BitBtnCustomerBuyTicketClick(Sender: TObject);
    procedure BitBtnCustomerBuyCancelClick(Sender: TObject);
    procedure BitBtnCustomerDepositStatusClick(Sender: TObject);
    procedure BitBtnCustomerDepositToVoucherClick(Sender: TObject);
    procedure BitBtnCustomerDepositRefundClick(Sender: TObject);
    procedure BitBtnCustomerDepositAddFundClick(Sender: TObject);
    procedure BitBtnCustomerDepositDefectClick(Sender: TObject);
    procedure BitBtnCustomerDepositReturnClick(Sender: TObject);
    procedure dxBarMRUListItemCustomersClick(Sender: TObject);
    procedure BitBtnCustomerInvoiceCloseClick(Sender: TObject);
    procedure Image5Click(Sender: TObject);
    procedure BitBtnCustomerRepairExecuteClick(Sender: TObject);
    procedure BitBtnCustomerRepairStatusClick(Sender: TObject);
    procedure BitBtnCustomerRepairCreateClick(Sender: TObject);
    procedure BitBtnCustomerRepairReturnClick(Sender: TObject);
    procedure model_comyClick(Sender: TObject);
    procedure dxBarButtonReportInvoiceBatchClick(Sender: TObject);
    procedure BitBtnCustomerInvoicePrintClick(Sender: TObject);
    procedure dxBarLargeButtonFullSyncClick(Sender: TObject);
    procedure RadioButtonAlertsreservedClick(Sender: TObject);
    procedure RadioButtonAlertsArrivedClick(Sender: TObject);
    procedure RadioButtonAlertsNotifiedClick(Sender: TObject);
    procedure RadioButtonAlertsBoughtClick(Sender: TObject);
    procedure ButtonCustomerAlertsResetAttemptsClick(Sender: TObject);
    procedure RadioButtonAlertsProductFilterPreOrderClick(Sender: TObject);
    procedure RadioButtonAlertsProductFilterBackCatalogueClick(Sender: TObject);
    procedure RadioButtonAlertsProductFilterAllClick(Sender: TObject);
    procedure PageControlCustomersExit(Sender: TObject);
    procedure dxBarButtonRebuildRootCatClick(Sender: TObject);
    procedure ActionLogExecute(Sender: TObject);
    procedure SBDeleteProDescFRClick(Sender: TObject);
    procedure SBDeleteProDescNLClick(Sender: TObject);
    procedure BitBtnCustomereMailClick(Sender: TObject);
    procedure BitBtnCustomerSMSClick(Sender: TObject);
    procedure SBProductsOrderStatusClick(Sender: TObject);
    procedure SBCustomersEraseClick(Sender: TObject);
    procedure cxButtonAdminDateRangeMonthClick(Sender: TObject);
    procedure cxButtonAdminDateRangeWeekClick(Sender: TObject);
    procedure cxButtonAdminDateRangeDayClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure dxBarButtonEmptyUnsellableClick(Sender: TObject);
    procedure ToolButtonMergeClick(Sender: TObject);
    procedure dxBarSubItemCustomersPopup(Sender: TObject);
    procedure dxBarSubItemCustomersCloseUp(Sender: TObject);
    procedure BitBtnSalesReserveClick(Sender: TObject);
    procedure dxBarButtonInvendusClick(Sender: TObject);
    procedure dxBarButtonDPOverpricedClick(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure DBMemoCustomersMemoChange(Sender: TObject);
    procedure SpeedButtonPauseClick(Sender: TObject);
    procedure dxBarButtonStockByPlatformClick(Sender: TObject);
    procedure JvLookOutButtonReorderTopSellersClick(Sender: TObject);
    procedure cxGridViewRepositoryDBTableViewSalesDepositStylesGetContentStyle(
      Sender: TcxCustomGridTableView; ARecord: TcxCustomGridRecord;
      AItem: TcxCustomGridTableItem; var AStyle: TcxStyle);
    procedure cxGridViewRepositoryDBTableViewSalesDepositStylesGetContentStyl(
      Sender: TcxCustomGridTableView; ARecord: TcxCustomGridRecord;
      AItem: TcxCustomGridTableItem; var AStyle: TcxStyle);
    procedure dxBarButtonScanDacalClick(Sender: TObject);
    procedure dxbrbtnAlertsMarkAsSentClick(Sender: TObject);
    procedure cxtxtdtEanKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btnRefreshESDClick(Sender: TObject);
    procedure ParamTreeParamPopup(Sender: TObject; ANode: TTreeNode;
      href: string; values: TStringList; var DoPopup: Boolean);
    procedure RaportCouponsClick(Sender: TObject);
    procedure CopierBonClick(Sender: TObject);

  private
    Data : TManagerData;
    procedure SalesCaddyClose(Sender: TObject);
    procedure RentCaddyClose(Sender: TObject);
    function GetParameter(Name: string): string;
    procedure SetParameter(Name: string; const Value: string);
    procedure AutoColWidth(TheGrid: TAdvStringGrid);
    procedure StockinClearEdit;
    procedure StringGridFiguresClear;
    procedure SalesClearEdit;
    procedure RentClearEdit;
    procedure TransferClearEdit;
    procedure TransferClearStringGrid;
    procedure TransferClearSummary;
    procedure SuperWebSearch(product: string);
    procedure OnUSBCDDeviceChange;
    procedure OnUSBCDDeviceChangeNotify(var msg: TMessage); message WM_USER + 1;
    procedure ImageUpSave(Upload: Boolean);
    procedure StockinCaddyClose(Sender: TObject);
    procedure StockinCaddyShow(Sender: TObject);
    procedure NewStockinCaddy(OwnerId, SupplierId: Integer);
    function ValidateCoupon(coupon: string): Boolean;
    procedure ClearCoupons;
    procedure ProcessAlert(product_model, product_price_stock, product_owner_id, product_supplier_id, product_quantity: string);
    procedure PrintPriceTag(quantity, description, price, owner, supplier: string);
    procedure JvLookOutButtonReassortBestsellers(Sender: TObject);
    procedure JvLookOutButtonReassortBestsellersClick(Sender: TObject);
    procedure TryApplyChangesToDB;


  public
    PhidgetRFID: TPhidgetRFID;
    procedure SalesClearSummary;
    property Parameter[name: string]: string read GetParameter write SetParameter; default;
    procedure WebbrowserCLDAddItem(productmodel: string);
    procedure WebbrowserCLDAddItems(QueryString: WideString);
    procedure WebbrowserCLDAddReturnItems(QueryString: WideString);
    procedure Notilog(Mssg: string);

  end;

var
  MainForm: TMainForm;
  PosPrinter: TOPOSPosPrinter;
  DefaultSupplierId, LastSearchString: string;
  RateTva: Real;
  ProductAvailableQuantity: Integer;
  TmpBmp: TBitmap;
  ProductImage: TBitmap;
  SupplierList, Shoplist, AllShopList, ShopdataList, RentSchemeList: Tstrings;
  RegisterColHeaders: TStringList;
  PrintLogo,SHLogo: TBitmap;
  ApplyTotalErrors: Integer;
  FtpImgUp: TFtpUp;
  Issucking: Boolean;
  StringGridAdminProductsUpdating, edfromcode, AllowMRUClientAccess: Boolean;
  StyleError: TcxStyle;
  OkSnd: Pointer;
  ErrorSnd: Pointer;
  WebBrowserCLDReady: Boolean;
  ACustomerDisplay: TFormCustomerDisplay;
  aSendSms: TSendSms;

implementation

uses ReportModuleUnit, NewProdFRMunit, SaleExecFRMunit, StockCheckFrmUnit,
  debugFrmUnit, UnitFrmDacalSearch,
  ChangePriceFrmUnit, RepairNewFrmUnit, RepairReturnFrmUnit,
  WinbooksOfficeApi_TLB, ExportWinbooksFRMUnit, InvoiceBatchPrintFRMUnit,
  RepairFixFRMUnit, DialogRefundFrmUnit, DialogChangeEANFRMUnit,
  DialogAddFundFRMUnit, DialogCancelSalesFRMUnit, EnterLibFrmUnit,
  ExitLibFrmUnit, DacalEmptyUnsoldFRMUnit,
  SalesCorrectFRMUnit, SMS_COMAPILib_TLB, CancelInvoiceItemFRMUnit,
  CashRegistryFRMUnit, Registry, GlobalsUnit, DavidUtilsUnit,
  ProductSalesHistoryUnit, DialogSearchCustFRMUnit,
  CashFRMUnit, ClientDMunit, DialogRentExtend, CheckLibFRMUnit,
  OrderCheckFRMUnit, TransferSuggestFRMUnit, TransferRequestFRMUnit,
  ReorderFRMUnit, DialogSmsSendFRMUnit, ReportSQLForm,
   wgssSTU_TLB, SignatureForm,esd;


{$R *.DFM}

procedure OnUSBCDDeviceChangeCallBack(DeviceCount: Integer); stdcall;
begin
  PostMessage(Application.MainForm.Handle, WM_USER + 1, 0, DeviceCount);
end;

// Card is inserted
procedure CardInserted; stdcall;
begin
  if Assigned(MainForm) then
    begin
                  with MainForm.AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Smartcard insre dans le lecteur';
                    MainForm.AdvAlertWindow.Show;
                  end;
                  MainForm.SBReadEID.Enabled:=True;
    end;
end;

// Card was activated
procedure CardActive; stdcall;
begin
  if Assigned(MainForm) then
    begin
                  with MainForm.AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Smartcard active';
                    MainForm.AdvAlertWindow.Show;
                  end;
    end;
end;

// Card was removed from the reader
procedure CardRemoved; stdcall;
begin
  if Assigned(MainForm) then
    begin
                  with MainForm.AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Smartcard enleve du lecteur';
                    MainForm.AdvAlertWindow.Show;
                  end;
                  MainForm.SBReadEID.Enabled:=False;
    end;
end;

// Invalid card was inserted into the reader
procedure CardInvalid; stdcall;
begin
  if Assigned(MainForm) then
    begin
                  with MainForm.AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Smartcard non valide';
                    MainForm.AdvAlertWindow.Show;
                  end;    end;
end;

// Waiting for card response
procedure ReaderWaiting; stdcall;
begin
  if Assigned(MainForm) then
    begin
                  with MainForm.AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Le lecteur de smartcard est prt';
                    MainForm.AdvAlertWindow.Show;
                  end;
    end;
end;

// Card operation error
procedure CardError(ErrorCode : cardinal); stdcall;
begin
  if Assigned(MainForm) then
    begin
                      with MainForm.AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Erreur durant une opration smartcard '+SysErrorMessage(ErrorCode) + ' Error code: 0x' + IntToHex(ErrorCode, 10);
                    MainForm.AdvAlertWindow.Show;
                  end;
    end;
end;



procedure TMainForm.FormCreate(Sender: TObject);
var
  Count, StdGridWidth, i: Integer;
  ParamReg: TRegistry;
  ParamErr: string;
  adouble : double;
begin

  Self.Caption := 'Gomedia ' + GlobalsUnit.Version;
  RemoteDB.CDSActions.Append;
  RemoteDB.CDSActions.FieldByName('action').AsString := 'Action dmarrage';
  RemoteDB.CDSActions.Post;

  // Here we use some castings to avoid using another variable
  OkSnd := Pointer(FindResource(hInstance, 'OkSnd', RT_RCDATA));
  if OkSnd <> nil then
  begin
    OkSnd := Pointer(LoadResource(hInstance, HRSRC(OkSnd)));
    if OkSnd <> nil then
      OkSnd := LockResource(HGLOBAL(OkSnd));
  end;

  // Here we use some castings to avoid using another variable
  ErrorSnd := Pointer(FindResource(hInstance, 'ErrorSnd', RT_RCDATA));
  if ErrorSnd <> nil then
  begin
    ErrorSnd := Pointer(LoadResource(hInstance, HRSRC(ErrorSnd)));
    if ErrorSnd <> nil then
      ErrorSnd := LockResource(HGLOBAL(ErrorSnd));
  end;

  { //Initialising OposPrinter
    try
    PosPrinter:=TOPOSPosPrinter.Create(Self);
    PosPrinter.Open(widestring('ticket'));
    PosPrinter.Claim(200);
    PosPrinter.DeviceEnabled:=True;
    PosPrinter.RecLetterQuality:=True;
    PosPrinter.AsyncMode:=True;
    except
    ShowMessage('Drivers Opos non prsents');
    end;
  }
  GroupBoxProductImage.Visible := True;
  RemoteDB.Products.ReadOnly   := False;
  ActionDBCheckCat.Enabled     := True;

  //
  // AdminLevels
  //
  if UserLevel = 0 then
  begin
    // if False then begin
    MainForm.DBEditProductsID.ReadOnly                     := True;
    MainForm.DBEditProductsImage.ReadOnly                  := True;
    MainForm.DBEditProductsModel.ReadOnly                  := True;
    MainForm.DBEditProductsName.ReadOnly                   := True;
    MainForm.DBEditProductsRootName.ReadOnly               := True;
    MainForm.DBEditProductWeight.ReadOnly                  := True;
    MainForm.DBEditProductNameExt.ReadOnly                 := True;
    MainForm.dbdvmproducts_descriptionFR.ReadOnly             := True;
    dbdvmproducts_msgticketNL.ReadOnly                      :=True;
    dbdvmproducts_msgticketFR.ReadOnly                      := True;
    MainForm.DBLookupComboBoxProductsManufacturer.ReadOnly := True;
    MainForm.DBLookupComboBoxProductsTax.ReadOnly          := True;
    MainForm.DBLookupComboBoxProductsWarranty.ReadOnly     := True;
    MainForm.DBCheckProductStock.ReadOnly                  := True;
    MainForm.DBCheckProductLoyalty.ReadOnly                := True;
    MainForm.DBCheckProductPreview.ReadOnly                := True;
    MainForm.DBCheckProductDiscontinued.ReadOnly           := True;
    MainForm.DBCheckProductStreetBlock.ReadOnly            := True;
    MainForm.SpeedButtonToArchives.Enabled                 := False;
    MainForm.SpeedButtonToLive.Enabled                     := False;
    MainForm.SpeedButtonChangeEAN.Enabled                  := False;
    MainForm.cxDBProductsDateAvailable.Properties.ReadOnly := True;
    MainForm.cxDBProductsDateIn.Properties.ReadOnly        := True;
    MainForm.JvDBLookupTreeViewCombo.ReadOnly              := True;
    MainForm.DBMemoBonus.ReadOnly                          := True;
    MainForm.DBEditProductPriceHT.Properties.ReadOnly      := True;
    MainForm.DBEditProductPriceAllIn.Properties.ReadOnly   := True;
    MainForm.ButtonProductsSetPrice.Enabled                := False;
    MainForm.dxBarButtonCheckCat.Visible                   := ivNever;
    MainForm.dxBarButtonChackEan.Visible                   := ivNever;
    MainForm.dxBarButtonDBIdGen.Visible                    := ivNever;
    MainForm.dxBarButtonProductVisible.Visible             := ivNever;
    MainForm.dxBarButtonTVARates.Visible                   := ivNever;
    MainForm.dxBarButtonDebug.Visible                      := ivNever;
  end;

  ParamErr         := '';
  ParamReg         := TRegistry.Create;
  ParamReg.RootKey := HKEY_CURRENT_USER;
  ParamReg.OpenKey(ParamRegPath, True);
  for i := 0 to ParamTree.ParamRefCount - 1 do
  begin
    if not ParamReg.ValueExists(ParamTree.ParamRefs[i]) then
    begin
      if ParamErr = '' then
        ParamErr := ParamTree.ParamRefs[i] + ', '
      else
        ParamErr := ParamErr + ParamTree.ParamRefs[i] + ', ';
    end;
    if ParamReg.ReadString(ParamTree.ParamRefs[i]) <> '' then
    begin
      ParamTree.Parameter[ParamTree.ParamRefs[i]] := ParamReg.ReadString(ParamTree.ParamRefs[i]);
    end;
  end;
  ParamReg.CloseKey;
  ParamReg.Free;
  if ParamErr <> '' then
  begin
    ParamErr := LeftStr(ParamErr, Length(ParamErr) - 2);
    ShowMessage('Donnees de configuration non coherentes veuillez aller dans la partie configuration du programme. Erreurs : ' + ParamErr);
  end;

  Application.OnHint   := ShowHint;
  AllowMRUClientAccess := True;

  ChDir(ExtractFilePath(ParamStr(0)));

  { needed for the product picture scanning }
  TmpBmp       := TBitmap.Create;
  ProductImage := TBitmap.Create;
  // ProductImage.TransparentColor:=clFuchsia;
  // ProductImage.Transparent:=True;
  // ProductImage.TransparentMode:=tmFixed;
  ThumbImg.Width  := 0;
  ThumbImg.Height := 0;
  ThumbImg.Width  := 100;
  ThumbImg.Height := 100;

  StyleError       := TcxStyle.Create(self);
  StyleError.Color := ClRed;

  DefaultSupplierId := '6';
  RateTva           := 1.21;

  { Initialisation des composantses visuelles }
  self.Width  := 1020;
  self.Height := 720;

  PanelAdminGrid.Height    := 250; // TabsheetAdminSales.ClientHeight-235;
  PanelTransferGrid.Height := 250; // TabsheetAdmin.ClientHeight-235-65;
  // PanelInventoryGrids.Height:=250+65;//TabsheetInventory.ClientHeight-235;

  StringGridFiguresClear;

  StringGridFigures.Cells[0, 0] := 'Neuf';
  StringGridFigures.Cells[0, 1] := 'Occasion';
  StringGridFigures.Cells[0, 2] := 'Low Margin';
  StringGridFigures.Cells[0, 3] := 'Services';
  StringGridFigures.Cells[0, 4] := 'Side';
  StringGridFigures.Cells[0, 5] := 'Total';
  StringGridFigures.Cells[2, 0] := 'Liquide';
  StringGridFigures.Cells[2, 1] := 'Cartes';
  StringGridFigures.Cells[2, 2] := 'Banque';
  StringGridFigures.Cells[2, 3] := 'Crdit';
  StringGridFigures.Cells[2, 4] := 'Bon';
  StringGridFigures.Cells[2, 5] := 'Total';

  RegisterColHeaders := TStringList.Create;
  RegisterColHeaders.Add('Date');
  RegisterColHeaders.Add('Neuf');
  RegisterColHeaders.Add('Occasion');
  RegisterColHeaders.Add('Service');
  RegisterColHeaders.Add('Retour');
  RegisterColHeaders.Add('Total');
  RegisterColHeaders.Add('Cash');
  RegisterColHeaders.Add('BCT');
  RegisterColHeaders.Add('Visa');
  RegisterColHeaders.Add('Banque');
  RegisterColHeaders.Add('Bon');
  RegisterColHeaders.Add('Rembours');
  RegisterColHeaders.Add('Tot');
  RegisterColHeaders.Add('Fourn.');
  RegisterColHeaders.Add('Nom');
  RegisterColHeaders.Add('Banque');
  RegisterColHeaders.Add('Caisse');

  { Creation des StringGrid }

  /// TRANSFER
  StdGridWidth := 85;
  with StringGridTransfer do
  begin
    RowCount    := 2;
    ColCount    := 10;
    Cells[0, 0] := 'Modle';
    Cells[1, 0] := 'Description';
    Cells[2, 0] := 'Quantit';
    Cells[3, 0] := 'P. catalogue';
    Cells[4, 0] := 'P. stock';
    Cells[5, 0] := 'P. achat';
    Cells[6, 0] := 'Date entre';
    Cells[7, 0] := 'Propritaire';
    Cells[8, 0] := 'Fournisseur';
    Cells[9, 0] := 'Magasin';
    for Count   := 0 to ColCount - 1 do
    begin
      ColWidths[Count] := StdGridWidth;
    end;
    ColWidths[1] := ClientWidth - StdGridWidth * (ColCount - 1);

  end;

  /// ADMIN
  StdGridWidth := 75;
  with StringGridAdmin do
  begin
    RowCount    := 2;
    ColCount    := 10;
    Cells[0, 0] := 'Modle';
    Cells[1, 0] := 'Description';
    Cells[2, 0] := 'Quantit';
    Cells[3, 0] := 'P. catalogue';
    Cells[4, 0] := 'P. stock';
    Cells[5, 0] := 'P. achat';
    Cells[6, 0] := 'Date entre';
    Cells[7, 0] := 'Propritaire';
    Cells[8, 0] := 'Fournisseur';
    Cells[9, 0] := 'Identifiant';
    for Count   := 0 to ColCount - 1 do
    begin
      ColWidths[Count] := StdGridWidth;
    end;
    ColWidths[0] := 85;
    ColWidths[1] := ClientWidth - 85 - StdGridWidth * (ColCount - 2);
  end;

  { /// ADMINPRODUCTS
    StdGridWidth:=50;
    with StringGridAdminProducts do begin
    RowCount:=2;
    ColCount:=3;
    Cells[0,0]:='Modle';
    Cells[1,0]:='Nom';
    Cells[2,0]:='Tot.';
    Cells[0,1]:='0';
    Cells[1,1]:='0';
    Cells[2,1]:='0';
    ColWidths[1]:=Max(ClientWidth-95-(ColCount-2)*StdGridWidth,150);
    ColWidths[0]:=85;
    for count :=2 to ColCount-1 do ColWidths[count]:=StdGridWidth;
    end;
  }


  PrintLogo := TBitmap.Create;
  if FileExists('printLogo.bmp') then
    PrintLogo.LoadfromFile('PrintLogo.bmp')
  else
    PrintLogo                           := TBitmap.Create;

  SHLogo := TBitmap.Create;
  if FileExists('logorecycle.bmp') then
    SHLogo.LoadfromFile('logorecycle.bmp')
  else
    SHLogo                           := TBitmap.Create;

  ImageTicketLogo.Picture.Bitmap        := TBitmap.Create;
  ImageTicketLogo.Picture.Bitmap.Height := ImageTicketLogo.Height;
  ImageTicketLogo.Picture.Bitmap.Width  := ImageTicketLogo.Width;
  ImageTicketLogo.Picture.Bitmap.Canvas.StretchDraw(rect(0, 0, ImageTicketLogo.Width, ImageTicketLogo.Height), PrintLogo);



  { Chargement des Paramtres magasins }
  if RemoteDB.Shops.Active then
  begin
    if RemoteDB.Shops.Locate('Shops_id', ConnectedShop, []) then
    begin
      ShopdataList := TStringList.Create;
      ShopdataList.Add(RemoteDB.Shops.FieldByName('shops_name').AsString);
      ShopdataList.Add(RemoteDB.Shops.FieldByName('shops_adress_one').AsString);
      ShopdataList.Add(RemoteDB.Shops.FieldByName('shops_postcode').AsString + ' ' +RemoteDB.Shops.FieldByName('shops_city').AsString);
      ShopdataList.Add(RemoteDB.Shops.FieldByName('shops_phone').AsString);
      ShopdataList.Add(RemoteDB.Shops.FieldByName('shops_manager_email').AsString);
      ShopData1.Text := RemoteDB.Shops.FieldByName('shops_title').AsString;
      ShopData2.Text := RemoteDB.Shops.FieldByName('shops_adress_one').AsString;
      ShopData3.Text := (RemoteDB.Shops.FieldByName('shops_postcode').AsString + ' ' +RemoteDB.Shops.FieldByName('shops_city').AsString);
      ShopData4.Text := RemoteDB.Shops.FieldByName('shops_phone').AsString;
      ShopData5.Text := RemoteDB.Shops.FieldByName('shops_manager_email').AsString;
    end else begin
      ShowMessage('Impossible de localiser le magasin '+inttostr(ConnectedShop)+' dans la base de donnes');
    end;
  end;

  { Crtation de la Stringlist des Fournisseurs }
  if RemoteDB.netshop_suppliers.Active then
  begin
    SupplierList := TStringList.Create;
    RemoteDB.netshop_suppliers.First;
    while not RemoteDB.netshop_suppliers.Eof do
    begin
      SupplierList.Add(RemoteDB.netshop_suppliers.FieldByName('Suppliers_Name').Text);
      RemoteDB.netshop_suppliers.Next;
    end;
    ComboBoxSupplier.items     := SupplierList;
    ComboBoxSupplier.ItemIndex := ComboBoxSupplier.items.IndexOf('Cld');
  end;

  { Crtation de la Stringlist des Magasins }
  if RemoteDB.Shops.Active then
  begin
    Shoplist := TStringList.Create;
    RemoteDB.Shops.First;
    while not RemoteDB.Shops.Eof do
    begin
      if RemoteDB.Shops.FieldByName('shops_id').AsInteger <> ConnectedShop then
        Shoplist.Add(RemoteDB.Shops.FieldByName('shops_name').Text);
      RemoteDB.Shops.Next;
    end;
  end;

  { Crtation de la Stringlist de tous les Magasins }
  if RemoteDB.AllShops.Active then
  begin
    AllShopList := TStringList.Create;
    RemoteDB.AllShops.First;
    while not RemoteDB.AllShops.Eof do
    begin
      if RemoteDB.AllShops.FieldByName('shops_id').AsInteger <> ConnectedShop then
        AllShopList.Add(RemoteDB.AllShops.FieldByName('Shops_Name').Text);
      RemoteDB.AllShops.Next;
    end;
  end;

  { Crtation de la Stringlist des forfaits location }
  if RemoteDB.netshop_rent_schemes.Active then
  begin
    RentSchemeList := TStringList.Create;
    RemoteDB.netshop_rent_schemes.First;
    while not RemoteDB.netshop_rent_schemes.Eof do
    begin
      RentSchemeList.Add(RemoteDB.netshop_rent_schemes.FieldByName('rent_scheme_name').Text);
      RemoteDB.netshop_rent_schemes.Next;
    end;
  end;

  ComboBoxDestShop.items := Shoplist;
  // ComboBoxOriginShop.items := Shoplist;
  ComboBoxRent.items    := RentSchemeList;
  ComboBoxSuggest.items := AllShopList;

  { Initialisation des panels }
  BitBtnTransferClearClick(nil);
  TransferClearSummary;
  SBNewSalesCaddyClick(self);

  AdvPanelCustDepositStock.Height := Round((PanelCustomersDeposidGrids.Height - PanelCustomersRadioButtons.Height) / 2);
  AdvPanelCustSalesItems.Height   := Round(PanelcustSalesGrid.Height / 2);

  { Activation des Actions }
  Vente.Enabled     := True;
  Entree.Enabled    := True;
  Admin.Enabled     := True;
  Config.Enabled    := True;
  Clients.Enabled   := True;
  Transfert.Enabled := True;
  Produits.Enabled  := True;
  Rent.Enabled      := True;
  Mailing.Enabled   := True;

  { Activation du lecteur smartcard }
   Data.CardInserted := CardInserted;
   Data.CardActive := CardActive;
   Data.CardRemoved := CardRemoved;
   Data.CardInvalid := CardInvalid;
   Data.Error := CardError;
   Data.ReaderWaiting := ReaderWaiting;

   //Initialize reader
   InitReaderEx(@Data);


  { Activation du premier Tabsheet }

  Produits.Execute;
  MonthCalendarAdminSales.Date    := Now;
  MonthCalendarAdminSalesEnd.Date := Now;

  if self.Parameter['SyncAutoEnabled'] = 'TRUE' then
    TimerDBupdate.Enabled := True
  else
    TimerDBupdate.Enabled := False;
  TimerDBupdate.Interval  := Max(StrtoInt(self.Parameter['SyncDelay']) * 60000, (15 * 60000));
  TimerUpdateConnectionLedsTimer(nil);

  if not RemoteDB.countries.Locate('countries_id', '21', []) then
    exit;
  if RemoteDB.Countries_To_Vat.Locate('countries_to_vat_iso', RemoteDB.countries.FieldByName('countries_iso_code_2').AsString, []) then
  begin
    DBEditCustomerVAT.Properties.EditMask := RemoteDB.Countries_To_Vat.FieldByName('countries_to_vat_mask').AsString;
  end else begin
    DBEditCustomerVAT.Properties.EditMask := '';
  end;

end;

procedure TMainForm.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
var
  ParamReg: TRegistry;
  i: Integer;
begin
  RemoteDB.CDSActions.Append;
  RemoteDB.CDSActions.FieldByName('action').AsString := 'Action fermeture';
  RemoteDB.CDSActions.Post;

  ChDir(ExtractFilePath(ParamStr(0)));
  ParamReg := TRegistry.Create;
  try
    ParamReg.RootKey := HKEY_CURRENT_USER;
    ParamReg.OpenKey(ParamRegPath, True);
    for i := 0 to ParamTree.ParamRefCount - 1 do
    begin
      ParamReg.WriteString(ParamTree.ParamRefs[i], ParamTree.Parameter[ParamTree.ParamRefs[i]]);
    end;
  finally
    ParamReg.CloseKey;
    ParamReg.Free;
  end;
  CloseUSBCDLibrary();
  RemoteDB.ProgressSave.Execute;
end;

procedure TMainForm.FormDestroy(Sender: TObject);
begin
  if PosPrinter <> nil then
  begin
    PosPrinter.ReleaseDevice;
    PosPrinter.Close;
    PosPrinter.Free;
  end;
  PrintLogo.Free;
  SHLogo.Free;
  SupplierList.Free;
  Shoplist.Free;
  RegisterColHeaders.Free;
  TmpBmp.Free;
  ProductImage.Free;
  CloseUSBCDLibrary;
  DoneReaderEx;
end;

procedure TMainForm.FormShow(Sender: TObject);
var
  DirList: TIdFTPListItems;
  DirItem: TIdFTPListItem;
  TempItem: TTreeNode;
  LS: TStringList;
  AFTP: TidFTP;
  i, r, nFileCount, Index, Retval: Integer;
  DirInfo: TSearchRec;
  Dest, DestExt, SearchDir: string;
  source: string;
  aJpegImage: TJpegImage;
  FileNames: TStringArray;
  adouble : double;

  function InvertiBarre(sSource: string): string;
  begin
    Result := StringReplace(sSource, '/', '\', [rfReplaceAll])
  end;

  function IndexOfArray(const Value: string; items: array of string): Integer;
  var
    i: Integer;
  begin
    Result := -1;
    for i  := low(items) to high(items) do
    begin
      if AnsiSameText(Value, items[i]) then
      begin
        Result := i;
        Break;
      end; // if
    end; // for
  end; // IndexOfArray

  procedure DeleteFromArray(const Index: Cardinal; var items: TStringArray);
  var
    ALength: Cardinal;
    i: Cardinal;
  begin
    ALength := Length(items);
    Assert(ALength > 0);
    Assert(index < ALength);
    for i          := index + 1 to ALength - 1 do
      items[i - 1] := items[i];
    SetLength(items, ALength - 1);
  end; // DeletefromArray

begin

  if (self.Parameter['MiscCDLibUse'] = 'TRUE') then
  begin
    try
      InitUSBCDLibrary;
      OnUSBCDDeviceChange;
      // SetCDCallbackProc(@OnUSBCDDeviceChangeCallBack);
    except
      ShowMessage('Erreur Initialisation Dacal');
    end;
  end;

  POSBANK := False;
  if (UserType = 1) and (self.Parameter['MISCPOSBANKUse'] = 'TRUE') then
  begin

    try
      PhidgetRFID                := TPhidgetRFID.Create(self);
      PhidgetRFID.OnAttach       := PhidgetRFIDAttach;
      PhidgetRFID.OnOutputChange := PhidgetRFIDOutputChange;
      PhidgetRFID.OnTag          := PhidgetRFIDTag;
      PhidgetRFID.OnTagLost      := PhidgetRFIDTagLost;
      PhidgetRFID.Open(-1);
    except
      ShowMessage('Erreur initialisation module RFID');
    end;

    POSBANK               := True;
    ACustomerDisplay      := TFormCustomerDisplay.Create(self);
    ACustomerDisplay.Left := 1024;
    ACustomerDisplay.Top  := 0;
    if ((self.Parameter['MISCPOSBANKModel'] = '2')) then
    begin
      ACustomerDisplay.Width  := 1024;
      ACustomerDisplay.Height := 768;
    end;

    if ((self.Parameter['MISCPOSBANKModel'] = '3')) then
    begin
      ACustomerDisplay.Left := 1280;
      ACustomerDisplay.Width  := 1280;
      ACustomerDisplay.Height := 800;
    end;

    ACustomerDisplay.Show;

    if RemoteDB.IsConnected then
    begin

      SearchDir  := (ExtractFilePath(ParamStr(0))) + 'posbank\*.jpg';
      nFileCount := 0;
      if FindFirst(SearchDir, faAnyFile, DirInfo) = 0 then
      begin
        repeat
          // Exclude directories from the list of files.
          if ((DirInfo.Attr and faDirectory) <> faDirectory) then
          begin
            Inc(nFileCount);
          end;
        until FindNext(DirInfo) <> 0;
        // FindClose(DirInfo);

        SetLength(FileNames, nFileCount);
      end;
      /// ///
      nFileCount := 0;
      if FindFirst(SearchDir, faAnyFile, DirInfo) = 0 then
      begin
        repeat
          // Exclude directories from the list of files.
          if ((DirInfo.Attr and faDirectory) <> faDirectory) then
          begin
            Inc(nFileCount);
            FileNames[nFileCount - 1] := (DirInfo.Name);
          end;
        until FindNext(DirInfo) <> 0;
      end;

      AFTP              := TidFTP.Create(self);
      AFTP.Passive      := True;
      AFTP.Host         := FTPHost;
      AFTP.TransferType := ftBinary;
      AFTP.Username     := FTPUSER;
      AFTP.Password     := FTPPWD;
      source            := FTPDIR + 'posbank/';
      LS                := TStringList.Create;
      try
        LS.Sorted := True;
        AFTP.connect;

        if (source <> '') then
          AFTP.ChangeDir(source);

        AFTP.List;

        DirList := AFTP.DirectoryListing;
        for i   := 0 to DirList.Count - 1 do
        begin
          try
            DirItem := DirList.items[i];
            if (DirItem.ItemType = ditDirectory) then
            begin
              LS.Add(Trim(DirItem.FileName) + '/');
            end else begin
              index := IndexOfArray(DirItem.FileName, FileNames);
              if index = -1 then
              begin
                // Dowload the file and remove from the array
                Dest := (ExtractFilePath(ParamStr(0))) + 'posbank\' + DirItem.FileName;
                AFTP.get(DirItem.FileName, Dest);
              end else begin
                DeleteFromArray(index, FileNames);
              end;
            end;
          except
          end; // try
        end; // for
      finally
        LS.Free;
        AFTP.Free;
      end;

      // Delete removed images
      for i := 0 to high(FileNames) do
      begin
        if DeleteFile(pChar((ExtractFilePath(ParamStr(0))) + 'posbank\' + FileNames[i])) = False then
          ShowMessage('Unable to delete : ' + (ExtractFilePath(ParamStr(0))) + 'posbank\' + DirInfo.Name);
      end;

    end; // End if DB Connected
    ACustomerDisplay.RefreshContent;
    ACustomerDisplay.PanelAdvert.Visible       := True;
    ACustomerDisplay.PanelCustomerData.Visible := False;
    ACustomerDisplay.PanelCustomerSale.Visible := False;
  end;

  ActionWebInfo.Execute;
  RemoteDB.SetDescToProducts;

  self.WebBrowserCLD.Navigate('http://www.cld.be/GM_callishop.aspx?ishopmethod=loginCustomer2&C_ID=' + GlobalsUnit.CLDLogin + '&C_PW=' +
    GlobalsUnit.CLDPass );
  // while WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE do application.ProcessMessages ;
  if not TryStrToFloat(Self.Parameter['LoyaltyAccPoints'],adouble) then  begin
     Self.Parameter['LoyaltyAccPoints']:='0';
  end;


  // Launch Sms Thread
  if self.Parameter['SmsProvider'] = 'Clickatel' then
    aSendSms := TSendSms.Create(self.Parameter['SmsLogin'], self.Parameter['SmsPassword'], self.Parameter['SmsURL'], self.Parameter['SmsID'],
      self.Parameter['SmsProvider'], RemoteDB.CleanPhoneNumber(ShopData4.Text));
  if self.Parameter['SmsProvider'] = 'Betamax' then
    aSendSms := TSendSms.Create(self.Parameter['SmsLoginBm'], self.Parameter['SmsPasswordBm'], self.Parameter['SmsURL'], self.Parameter['SmsID'],
      self.Parameter['SmsProvider'], RemoteDB.CleanPhoneNumber(ShopData4.Text));
  if self.Parameter['SmsProvider'] = 'OVH' then
    aSendSms := TSendSms.Create(GlobalsUnit.SmsLoginOVH, GlobalsUnit.SmsPasswordOVH, '', GlobalsUnit.SmsAccountOVH,
      self.Parameter['SmsProvider'], SmsSenderOVH );   // Ovh needs sender defined in the admin
end;

procedure TMainForm.ShowHint(Sender: TObject);
begin
  StatusLine.Panels.items[2].Text := Application.Hint;
end;

procedure TMainForm.ButtonInventoryRebuildGrossPriceClick(Sender: TObject);
begin
  RemoteDB.Inventory.DisableControls;
  RemoteDB.Inventory.First;
  try
    while not RemoteDB.Inventory.Eof do
    begin
      if RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat = 0 then
      begin
        RemoteDB.Inventory.Edit;
        RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat :=
          Round(RemoteDB.Inventory.FieldByName('product_price_stock').AsFloat / (1 + (StrtoInt(self.Parameter['MarginProfit']) / 100)) * 100) / 100;
        RemoteDB.Inventory.Post;
      end;
      RemoteDB.Inventory.Next;
    end;
  finally
    RemoteDB.Inventory.EnableControls;
  end;

end;

/// //
/// //
/// //  Stockin Procedures
/// //
/// //

procedure TMainForm.StockinClearEdit;
begin
  cxEditStockinModel.Text       := '';
  cxEditStockinPriceGross.Value := 0;
  CxEditStockinQuantity.Text    := '0';
  cxEditStockinPrice.Value      := 0;
end;

procedure TMainForm.DBEdit4Change(Sender: TObject);
begin
  ThumbImg.Picture.Bitmap.Height := 0;
  ThumbImg.Picture.Bitmap.Width  := 0;
  { RemoteDB.Stock2prod.Filter:='Product_model=gccons';
    RemoteDB.Stock2Prod.Filtered:=True; }
end;

procedure TMainForm.TimerDBupdateTimer(Sender: TObject);
var
  updated: Boolean;
begin
  if not(TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType = sitGreen) then
    exit;
  updated := False;
  if not RemoteDB.IsUpdating then
  begin
    while not updated do
    begin
      if RemoteDB.IsUpdating = True then
        sleep(5000)
      else
      begin
        Produits.Execute;
        ActionDBSync.Execute;
        updated := True;
        Produits.Execute;
      end;
    end;
  end;
end;

procedure TMainForm.BitBtnCustomerBuyCancelClick(Sender: TObject);
var
  aCancelSalesForm: TCancelSalesForm;
  page, i, j, Index, Nowrow: Integer;
begin
  if RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger > RemoteDB.netshop_items_sold.FieldByName('items_refunded').AsInteger then
  begin
    if (RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 100000) and
      (RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger < 100000) then
    begin
      // produit neuf annulation vente
      ///
      /// Restitution Article rpar
      ///
      // Find Customer Caddy
      page  := -1;
      for i := 0 to self.PageControlSalesCaddy.PageCount - 1 do
      begin
        for j := 0 to TAdvTabSheet(self.PageControlSalesCaddy.Pages[i]).ControlCount - 1 do
        begin
          if self.PageControlSalesCaddy.Pages[i].Controls[j].Tag = 100 then
          begin
            if TEdit(self.PageControlSalesCaddy.Pages[i].Controls[j]).Text = RemoteDB.CustomersCustomers_nbr.AsString then
            begin
              page := i;
            end;
          end;
        end;
      end;

      // Create New caddy if not found
      if page = -1 then
      begin
        SBNewSalesCaddyClick(self);
        page := self.PageControlSalesCaddy.ActivePageIndex;
      end;

      for i := 0 to TAdvTabSheet(self.PageControlSalesCaddy.Pages[page]).ControlCount - 1 do
      begin
        if TAdvTabSheet(MainForm.PageControlSalesCaddy.Pages[page]).Controls[i].ClassType = TAdvStringGrid then
        begin
          index := i;
        end;
      end;
      with TAdvStringGrid(TAdvTabSheet(MainForm.PageControlSalesCaddy.Pages[page]).Controls[index]) do
      begin
        Nowrow           := RowCount - 1;
        Cells[0 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString;
        Cells[1 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_name').AsString;
        Cells[2 , Nowrow] := '-' + RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsString;;
        Cells[3 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_price_ht').AsString;
        Cells[4 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsString;
        Cells[5 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_price_gross').AsString;
        Cells[6 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_date_in').AsString;
        Cells[7 , Nowrow] := inttostr(ConnectedShop);
        Cells[8 , Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsString;
        Cells[10, Nowrow] := RemoteDB.netshop_items_sold.FieldByName('items_sold_id').AsString;;
        RowCount         := Nowrow + 2;
      end;
    end else begin
      RemoteDB.IsUpdating := True;
      aCancelSalesForm    := TCancelSalesForm.Create(self);
      try
        aCancelSalesForm.ShowModal;
      finally
        RemoteDB.IsUpdating := False;
        aCancelSalesForm.Free;
      end;
    end;
  end else begin
    messagedlg('Articles dj rembourss', mtwarning, [mbok], 0);
  end;
end;

procedure TMainForm.BitBtnCustomerBuyInvoiceClick(Sender: TObject);
var
  CustNbr: Integer;
  AFormSelectCust: TFormSelectCust;
  ContainSH: Boolean;
begin
  CustNbr := RemoteDB.Customers.FieldByName('Customers_Nbr').AsInteger;
  if CustNbr < 100000 then
  begin
    AFormSelectCust := TFormSelectCust.Create(self);
    CustNbr         := AFormSelectCust.ShowModal;
    AFormSelectCust.Free;
    if CustNbr = -1 then
      exit;
  end;
  if not RemoteDB.CheckField('customers', 'customers_nbr', CustNbr) then
  begin
    messagedlg('Veuillez entrer un N de client valable', mtwarning, [mbok], 0);
    exit;
  end;
  if CustNbr < 100000 then
  begin
    messagedlg('Veuillez entrer un N de client valable', mtwarning, [mbok], 0);
    exit;
  end;

  if RemoteDB.netshop_sales.FieldByName('sales_invoiced').AsInteger = 1 then
  begin
    if messagedlg('Articles dj facturs ! Voulez-vous facturer une deuxime fois ?', mtwarning, [mbyes, mbno], 0) = mrno then
      exit;
  end;

  RemoteDB.netshop_items_sold.First;
  ContainSH := False;
  while not RemoteDB.netshop_items_sold.Eof do
  begin
    if RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger >= 100000 then
      ContainSH := True;
    if RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger >= 100000 then
      ContainSH := True;
    RemoteDB.netshop_items_sold.Next;
  end;

  if ContainSH then
  begin
    messagedlg('Ce ticket contient des occasions : impossible de facturer', mtwarning, [mbok], 0);
    exit;
  end;

  RemoteDB.netshop_invoices.DisableControls;
  RemoteDB.FreeInvoicesToCustomers;
  RemoteDB.netshop_invoices.Filter    := 'invoices_customer_id = ' + inttostr(CustNbr);
  RemoteDB.netshop_invoices.Filtered  := True;
  RemoteDB.netshop_invoices.IndexName := 'InvoicesIXCustomers';
  try
    RemoteDB.netshop_invoices.First;
    if RemoteDB.netshop_invoices.Eof and RemoteDB.netshop_invoices.Bof then
    begin
      RemoteDB.netshop_invoices.Append;
      RemoteDB.netshop_invoices.FieldByName('invoices_customer_id').AsInteger := CustNbr;
      RemoteDB.netshop_invoices.FieldByName('invoices_paid_cash').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat;
      RemoteDB.netshop_invoices.FieldByName('invoices_paid_bct').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat;
      RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat;
      RemoteDB.netshop_invoices.FieldByName('invoices_paid_visa').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat;
      RemoteDB.netshop_invoices.FieldByName('invoices_paid_voucher').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat;
      RemoteDB.netshop_invoices.Post;
    end else begin // SI PAS PREMIERE FACTURE
      if RemoteDB.netshop_invoices.FieldByName('invoices_closed').AsInteger <> 1 then
      begin
        if messagedlg('Deniere facture non cloturee voulez-vous y ajouter ces achats', mtconfirmation, [mbok, mbno], 0) = mrOK then
        begin
          RemoteDB.netshop_invoices.Edit;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_cash').AsFloat :=
            (RemoteDB.netshop_invoices.FieldByName('invoices_paid_cash').AsFloat + RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat);
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_bct').AsFloat := RemoteDB.netshop_invoices.FieldByName('invoices_paid_bct').AsFloat +
            RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat := RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat +
            RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_visa').AsFloat := RemoteDB.netshop_invoices.FieldByName('invoices_paid_visa').AsFloat +
            RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_voucher').AsFloat := RemoteDB.netshop_invoices.FieldByName('invoices_paid_voucher').AsFloat +
            RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat;
          RemoteDB.netshop_invoices.Post;
        end else begin // SI CLOTURE IMMEDIATE
          RemoteDB.netshop_invoices.Edit;
          RemoteDB.netshop_invoices.FieldByName('invoices_closed').AsFloat := 1;
          RemoteDB.netshop_invoices.Post;
          RemoteDB.netshop_invoices.Append;
          RemoteDB.netshop_invoices.FieldByName('invoices_customer_id').AsFloat := CustNbr;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_cash').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_bct').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_visa').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat;
          RemoteDB.netshop_invoices.FieldByName('invoices_paid_voucher').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat;
          RemoteDB.netshop_invoices.Post;
        end
      end else begin // SI DEJA FERMEE
        RemoteDB.netshop_invoices.Append;
        RemoteDB.netshop_invoices.FieldByName('invoices_customer_id').AsFloat := CustNbr;
        RemoteDB.netshop_invoices.FieldByName('invoices_paid_cash').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat;
        RemoteDB.netshop_invoices.FieldByName('invoices_paid_bct').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat;
        RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat;
        RemoteDB.netshop_invoices.FieldByName('invoices_paid_visa').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat;
        RemoteDB.netshop_invoices.FieldByName('invoices_paid_voucher').AsFloat := RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat;
        RemoteDB.netshop_invoices.Post;
      end;
    end;

    // Adding the comment line;
    RemoteDB.netshop_invoices_items.Append;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_model').AsString := '';
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_name').AsString := 'Ticket ' + RemoteDB.netshop_sales.FieldByName('sales_id').AsString + ' du '
      + RemoteDB.netshop_sales.FieldByName('sql_date_time').AsString;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_quantity').AsInteger := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_gross').AsFloat := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_catalog').AsFloat := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_stock').AsFloat := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_tva').AsFloat := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_tva_rate').AsFloat := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_owner_id').AsInteger := 0;
    RemoteDB.netshop_invoices_items.FieldByName('invoices_items_supplier_id').AsInteger := 0;
    RemoteDB.netshop_invoices_items.Post;

    RemoteDB.netshop_items_sold.First;
    while not RemoteDB.netshop_items_sold.Eof do
    begin
      RemoteDB.netshop_invoices_items.Append;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_model').Value := RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_name').Value := RemoteDB.netshop_items_sold.FieldByName('items_sold_name').Value;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_quantity').Value := RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').Value;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_gross').Value :=
        RemoteDB.netshop_items_sold.FieldByName('items_sold_price_gross').Value;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_catalog').Value := RemoteDB.netshop_items_sold.FieldByName('items_sold_price_ht').Value;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_stock').Value :=
        RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_tva').Value := RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_stock')
        .Value - RemoteDB.netshop_invoices_items.FieldByName('invoices_items_price_catalog').Value;
      // RemoteDB.Invoices_itemsinvoices_items_price_tva.AsFloat:=RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock.AsFloat-RemoteDB.Invoices_itemsinvoices_items_price_catalog.AsFloat;
      if RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString]) then
      begin
        if RemoteDB.Products.FieldByName('products_tax_class_id').AsFloat = 2 then
          RemoteDB.netshop_invoices_items.FieldByName('invoices_items_tva_rate').AsFloat := 6;
        if RemoteDB.Products.FieldByName('products_tax_class_id').AsFloat = 1 then
          RemoteDB.netshop_invoices_items.FieldByName('invoices_items_tva_rate').AsFloat := 21;
      end
      else
        RemoteDB.netshop_invoices_items.FieldByName('invoices_items_tva_rate').AsFloat := 21;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_owner_id').AsInteger := RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id')
        .AsInteger;
      RemoteDB.netshop_invoices_items.FieldByName('invoices_items_supplier_id').AsInteger := RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id')
        .AsInteger;
      RemoteDB.netshop_invoices_items.Post;
      RemoteDB.netshop_items_sold.Next;
    end;
    RemoteDB.netshop_sales.Edit;
    RemoteDB.netshop_sales.FieldByName('sales_invoiced').AsInteger := 1;
    RemoteDB.netshop_sales.Post;
  finally
    RemoteDB.netshop_invoices.EnableControls;
    RemoteDB.netshop_invoices.Filter   := '';
    RemoteDB.netshop_invoices.Filtered := False;
    RemoteDB.SetInvoicesToCustomers;
    TryApplyChangesToDB();
  end;

end;

procedure TMainForm.BitBtnCustomerBuyTicketClick(Sender: TObject);
var
  TicketToPrint: TTicketJob;
  Num, i: Integer;
  Data, esdcode: WideString;
  CanPrint, TooMuchLines: Boolean;
  HasEsd: Boolean;
label
  Procend;
begin

  RemoteDB.SetItemstoSales;

  if RemoteDB.netshop_items_sold.RecordCount > 500 then
  begin
    TooMuchLines := True;
  end else begin
    TooMuchLines := False;
  end;

  if not TooMuchLines then
  begin
    CanPrint := True;
    HasEsd   := False;
    RemoteDB.netshop_items_sold.First;
    while not RemoteDB.netshop_items_sold.Eof do
    begin
      if RemoteDB.Products.Locate('products_model', RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString, [locaseinsensitive]) then
      begin
        if RemoteDB.Products.FieldByName('products_street_block').AsString = 'True' then
        begin
          if RemoteDB.Products.FieldByName('products_date_available').AsDateTime > Now then
            CanPrint := False;
        end;
        if RemoteDB.Products.FieldByName('products_esd').AsInteger = 1 then
        begin
          HasEsd := True;
        end;
      end;
      RemoteDB.netshop_items_sold.Next;
    end;

    if not(self.Parameter['PrintersTicketEnabled'] = 'TRUE') and CanPrint then
    begin
      messagedlg('Imrpimante dsactive ou produits bloqus en street date', mtwarning, [mbok], 0);
      goto Procend;
    end;

    TicketToPrint := TTicketJob.Create(self);
    try
      TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
      TicketToPrint.Logo     := PrintLogo;
      TicketToPrint.URL      := WEBURL;
      TicketToPrint.ID       := RemoteDB.netshop_sales.FieldByName('sales_location').AsString + '-' + RemoteDB.netshop_sales.FieldByName('sales_id').AsString;
      if ShopdataList <> nil then begin
      TicketToPrint.ShopData := ShopdataList;
      end else begin
        ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
      end;
      TicketToPrint.DateTime := RemoteDB.netshop_sales.FieldByName('sales_date_time').AsFloat;
      if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
        TicketToPrint.Model := TmContinuous;
      TicketToPrint.AddBox('Vente', True, bsProd);
      RemoteDB.netshop_items_sold.First;
      while not RemoteDB.netshop_items_sold.Eof do
      begin
        TicketToPrint.AddLine(RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsString,
          RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsString, RemoteDB.netshop_items_sold.FieldByName('items_sold_name')
          .AsString, 'Vente');
        if RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString]) then
        begin
          if ((RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 100000) and
            (RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger < 100000)) then
          begin
            // Traiter les ESD
            if RemoteDB.netshop_items_sold.FieldByName('items_sold_esd').AsString <> '' then
            begin
              esdcode := DavidUtilsUnit.DecryptStringDES(RemoteDB.netshop_items_sold.FieldByName('items_sold_esd').AsString);
              TicketToPrint.AddLine('', '', esdcode, 'Vente', True);
            end;
            // Traiter les garanties
            if RemoteDB.netshop_warranty.FindKey([RemoteDB.Productsproducts_warranty_id.Value]) then
            begin
              if RemoteDB.netshop_warranty.FieldByName('warranty_validity').Value > 0 then
              begin
                TicketToPrint.AddLine('', '', RemoteDB.netshop_warranty.FieldByName('warranty_description').Value, 'Vente', True);
              end;
            end;
          end; // if neuf
        end;
        RemoteDB.netshop_items_sold.Next;
      end;

      if RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat > 0 then
      begin
        TicketToPrint.AddFinancialLine('Liquide :', RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat);
      end;
      if RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat > 0 then
      begin
        TicketToPrint.AddFinancialLine('Carte de banque :', RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat);
      end;
      if RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat > 0 then
      begin
        TicketToPrint.AddFinancialLine('Carte de crdit :', RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat);
      end;
      if RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat > 0 then
      begin
        TicketToPrint.AddFinancialLine('Virement banquaire :', RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat);
      end;
      if RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat > 0 then
      begin
        TicketToPrint.AddFinancialLine('Bon achat :', RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat);
      end;

      if RemoteDB.Customers.FieldByName('customers_nbr').AsInteger >= 100000 then
      begin
        TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
        TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);
        TicketToPrint.AddCustomerLine('Crdit :', RemoteDB.CustomersCustomers_credit.Text);
        TicketToPrint.AddCustomerLine('Points :', RemoteDB.Customers.FieldByName('customers_loyalty').Text);
      end;

      RemoteDB.netshop_items_sold.First;
      while not RemoteDB.netshop_items_sold.Eof do
      begin
        // Todo Handle NL based on customer language
        if RemoteDB.Products.Locate('products_model', RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString, [locaseinsensitive]) then

        if RemoteDB.CDSProDescFR.FindKey([RemoteDB.Products.FieldByName('products_id').AsString]) then
        begin
          if RemoteDB.CDSProDescFR.FieldByName('products_msgticket').AsString.Length>0 then begin
             TicketToPrint.Comment :=  RemoteDB.CDSProDescFR.FieldByName('products_msgticket').AsString;
          end;
        end;
        RemoteDB.netshop_items_sold.Next;
      end;

      if (false) then begin

          TicketToPrint.Comment := 'Attention !' + chr(10) + chr(13) +
            ' Votre ticket contient un code digital. Ce code est  usage unique et ne peut tre retourn ou chang. Ce code est sensible  la casse et doit tre saisi tel qu''affich.';
          TicketToPrint.Comment := TicketToPrint.Comment + ' Ce code est fourni par Sony Network Entertainment Europe et est valable jusqu''a 12 mois aprs sa date d''achat. '
            + chr(10) + chr(13);
          TicketToPrint.Comment := TicketToPrint.Comment +
            ' Lisez l''intgralit des conditions d''utilisation sur sonyentertainmentnetwork.com/legal' + chr(10) + chr(13);
      end;

      if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
        TicketToPrint.PrintOpos
      else
        TicketToPrint.Print;
    finally
      TicketToPrint.Free;
    end;
  end;

Procend:
end;

procedure TMainForm.BitBtnOrdersClick(Sender: TObject);
var
  aOrderCheckForm: TOrderCheckForm;
begin
  RemoteDB.netshop_customers_alerts.Filter := '( (customers_alerts_status=0) and (customers_alerts_products_model = ' +
    QuotedStr(RemoteDB.Productsproducts_model.AsString) + ') )';
  RemoteDB.netshop_customers_alerts.Filtered := True;
  aOrderCheckForm                            := TOrderCheckForm.Create(self);
  aOrderCheckForm.Model                      := RemoteDB.Productsproducts_model.AsString;
  try
    aOrderCheckForm.ShowModal;
  finally
    aOrderCheckForm.Free;
    RemoteDB.netshop_customers_alerts.Filtered := False;
    RemoteDB.netshop_customers_alerts.Filter   := '';
  end;

end;

procedure TMainForm.BitBtnProductsPrintBarCodeClick(Sender: TObject);
var
  LabelRent: TLabelRent;
begin
  if (self.Parameter['PrintersLabelEnabled'] = 'TRUE') then
  begin
    LabelRent := TLabelRent.Create;
    try
      LabelRent.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
      LabelRent.Print(RemoteDB.Products.FieldByName('products_model').AsString, RemoteDB.Products.FieldByName('products_intername').Text, 0,
        (StrToBool(self.Parameter['PrintersLabelDialog'])));
    finally
      LabelRent.Free;
    end;
  end
  else
    messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
end;

procedure TMainForm.BitBtnProductsPrintLabelClick(Sender: TObject);
var
  Labelstoprint: Tlabeljob;
begin
  if (self.Parameter['PrintersLabelEnabled'] = 'TRUE') then
  begin
    Labelstoprint := Tlabeljob.Create;
    try
      Labelstoprint.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
      Labelstoprint.Style        := lsNew;
      Labelstoprint.Logo         := PrintLogo;
      Labelstoprint.URL          := WEBURL;
      if (self.Parameter['PrintersLabelContinuous'] = 'TRUE') then
        Labelstoprint.Model := LmContinuous;
      if ((cxCurrencyEditLower.EditValue > 0) and (cxCurrencyEditLower.EditValue < RemoteDB.Products.FieldByName('products_price_allin').AsFloat)) then
      begin
        Labelstoprint.Addlabel(cxCurrencyEditLower.EditValue, RemoteDB.Products.FieldByName('products_intername').Text);
        cxCurrencyEditLower.EditValue := 0;
      end else begin
        Labelstoprint.Addlabel(RemoteDB.Products.FieldByName('products_price_allin').AsFloat, RemoteDB.Products.FieldByName('products_intername').Text);
      end;
      Labelstoprint.Print(StrToBool(self.Parameter['PrintersLabelDialog']));
    finally
      Labelstoprint.Free;
    end;
  end
  else
    messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
end;

procedure TMainForm.BitBtnTransferProcessClick(Sender: TObject);
var
  SalesSavePoint, ItemsSavePoint, TransferSavePoint, StockSavePoint, ORIGINSHOP, DESTSHOP, Nowrow, ToCLDLoop: Integer;
  StockLocated, TransferLocated: Boolean;
  ConfirmTransfer: Boolean;
  MrResult: TModalResult;
  Art, Accu: Double;
  TicketToPrint: TTicketJob;
  Value,TransferPrice: string;
  SupplierId, OwnerId: Integer;
  QueryString: Widestring;
label endoftransfer;
begin
  if RadioButtonSend.Checked then
  begin
    try
      RemoteDB.Shops.Locate('shops_name', ComboBoxDestShop.Text, [locaseinsensitive]);
      DESTSHOP := RemoteDB.Shops.FieldByName('shops_id').AsInteger;

      if (DESTSHOP = ConnectedShop) or (ComboBoxDestShop.ItemIndex = -1) then
      begin
        messagedlg('Destination non valide', mtwarning, [mbok], 0);
        exit;
      end;

      // tft vers cld
      if (DESTSHOP = 100) then begin
        QueryString := '';
        ToCLDLoop           := 1;

        for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
        begin



          if StrToInt(StringGridTransfer.Cells[2, Nowrow]) > 0 then
          begin
            if RemoteDB.Products.locate('products_model',StringGridTransfer.Cells[0, Nowrow],[loCaseInsensitive]) then begin

              QueryString := QueryString + '&id_art' + inttostr(ToCLDLoop) + '=' + RemoteDB.Products.FieldByName('products_CLD_id').AsString;
              QueryString := QueryString + '&q' + inttostr(ToCLDLoop) + '=' + StringGridTransfer.Cells[2, Nowrow];
              ToCLDLoop           := ToCLDLoop + 1;
            end;
          end;
          if ToCLDLoop mod 15 = 0 then begin
            MainForm.WebbrowserCLDAddReturnItems(QueryString);
            QueryString := '';
          end;




        RemoteDB.Transferout.Append;
        RemoteDB.transferOutproduct_model.Text       := StringGridTransfer.Cells[0, Nowrow];
        RemoteDB.transferOutproduct_owner_id.Text    := StringGridTransfer.Cells[7, Nowrow];
        RemoteDB.transferOutproduct_Origin.Text      := inttostr(ConnectedShop);
        RemoteDB.transferOutproduct_Destination.Text := inttostr(DESTSHOP);
        RemoteDB.transferOutproduct_quantity.Text    := StringGridTransfer.Cells[2, Nowrow];
        RemoteDB.transferOutproduct_supplier_id.Text := StringGridTransfer.Cells[8, Nowrow];
        RemoteDB.transferOutproduct_date_in.Text     := StringGridTransfer.Cells[6, Nowrow];
        RemoteDB.transferOutproduct_price_gross.Text := StringGridTransfer.Cells[5, Nowrow];
        RemoteDB.transferOutproduct_price_stock.Text := StringGridTransfer.Cells[4, Nowrow];
        RemoteDB.Transferout.Post;

        end; // Fin des depacements en Transfer
        MainForm.WebbrowserCLDAddReturnItems(QueryString);
      end;



      RemoteDB.netshop_items_sold.Filtered := False;
      RemoteDB.netshop_stock.DisableControls;
      RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';

      SalesSavePoint    := RemoteDB.netshop_sales.SavePoint;
      ItemsSavePoint    := RemoteDB.netshop_items_sold.SavePoint;
      TransferSavePoint := RemoteDB.Transferout.SavePoint;
      StockSavePoint    := RemoteDB.netshop_stock.SavePoint;

      ConfirmTransfer := True;

      // Cration des enregistrements dans la table des transfer
      // Creation des enregistrements occasions en vendu

      for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
      begin // Verifications Preliminaires
        if StrtoInt(StringGridTransfer.Cells[2, Nowrow]) < 1 then
        begin
          raise E_Outloop.Create('Impossible de transferer des quantites nulles');
        end;
      end;

      for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
      begin
        //
        // Jeux En Depot
        //
        if (StrtoInt(StringGridTransfer.Cells[7, Nowrow]) >= 100000) then
        begin
          // Verification

          if not RemoteDB.netshop_stock.Locate('product_model;product_owner_id',
            Vararrayof([StringGridTransfer.Cells[0, Nowrow], StringGridTransfer.Cells[7, Nowrow]]), [locaseinsensitive]) then
          begin
            raise E_Outloop.Create('Impossible de localiser le stock');
          end;
          if (ConfirmTransfer) then
          begin
            MrResult :=
              messagedlg('Vous transferez un produit en depot, ce produit sera irrmdiablement marqu comme vendu pour le client, voulez vous continuer ?',
              mtwarning, [mbyes, mbno, mbyestoall], 0);
            if MrResult = mrno then
            begin
              raise E_Outloop.Create('Impossible de transferer les produits en Depot');
            end;
            if MrResult = mrYestoAll then
              ConfirmTransfer := False;
          end;

          // Vrification de la table sales cohrence items sold
          if not RemoteDB.netshop_sales.Locate('sales_id', 0, []) then
          begin
            RemoteDB.netshop_sales.Append;
            RemoteDB.netshop_sales.FieldByName('sales_id').AsInteger := 0;
            RemoteDB.netshop_sales.FieldByName('sales_customer_id').AsInteger := ConnectedShop;
            RemoteDB.netshop_sales.FieldByName('sales_paid_bct').AsFloat := 0;
            RemoteDB.netshop_sales.FieldByName('sales_date_time').AsFloat := 0;
            RemoteDB.netshop_sales.FieldByName('sales_paid_proton').AsFloat := 0;
            RemoteDB.netshop_sales.FieldByName('sales_paid_visa').AsFloat := 0;
            RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat := 0;
            RemoteDB.netshop_sales.FieldByName('sales_paid_cash').AsFloat := 0;
            RemoteDB.netshop_sales.Post;
          end;

          // Transfer du produit occasion en Items Sold
          RemoteDB.netshop_items_sold.Append;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_name').AsString := RemoteDB.netshop_stock.FieldByName('product_name').AsString;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger := StrToInt(StringGridTransfer.Cells[2, Nowrow]);
          RemoteDB.netshop_items_sold.FieldByName('items_sold_price_catalog').AsFloat := RemoteDB.Products.FieldByName('products_price').AsFloat;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_price_gross').AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
          RemoteDB.netshop_items_sold.FieldByName('items_sold_date_in').AsString := RemoteDB.netshop_stock.FieldByName('product_date_in').AsString;
          RemoteDB.netshop_items_sold.Post;
        end; // Gestion Mise des Occasions en ItemSold

        RemoteDB.Transferout.Append;
        RemoteDB.transferOutproduct_model.Text       := StringGridTransfer.Cells[0, Nowrow];
        RemoteDB.transferOutproduct_owner_id.Text    := StringGridTransfer.Cells[7, Nowrow];
        RemoteDB.transferOutproduct_Origin.Text      := inttostr(ConnectedShop);
        RemoteDB.transferOutproduct_Destination.Text := inttostr(DESTSHOP);
        RemoteDB.transferOutproduct_quantity.Text    := StringGridTransfer.Cells[2, Nowrow];
        RemoteDB.transferOutproduct_supplier_id.Text := StringGridTransfer.Cells[8, Nowrow];
        RemoteDB.transferOutproduct_date_in.Text     := StringGridTransfer.Cells[6, Nowrow];
        RemoteDB.transferOutproduct_price_gross.Text := StringGridTransfer.Cells[5, Nowrow];
        RemoteDB.transferOutproduct_price_stock.Text := StringGridTransfer.Cells[4, Nowrow];
        RemoteDB.Transferout.Post;

      end; // Fin des depacements en Transfer

      // Impression du ticket transfer
      if self.Parameter['MiscPrintTransfer'] = 'TRUE' then
      begin
        TicketToPrint := TTicketJob.Create(self);
        try
          TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
          TicketToPrint.Logo     := PrintLogo;
          TicketToPrint.URL      := WEBURL;
          if ShopdataList <> nil then begin
            TicketToPrint.ShopData := ShopdataList;
          end else begin
            ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
          end;
          TicketToPrint.DateTime := Now;
          if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
            TicketToPrint.Model := TmContinuous;
          TicketToPrint.AddBox('TFT ' + ComboBoxDestShop.Text, True, bsProd);

          Accu := 0;
          Art  := 0;
          with StringGridTransfer do
          begin
            for Nowrow := 1 to RowCount - 2 do
            begin
              Accu := Accu + (StrToFloat(StringGridTransfer.Cells[5, Nowrow]) * StrtoInt(StringGridTransfer.Cells[2, Nowrow]));
              Art  := Art + StrtoInt(StringGridTransfer.Cells[2, Nowrow]);
              TicketToPrint.AddLine(StringGridTransfer.Cells[2, Nowrow], StringGridTransfer.Cells[5, Nowrow], StringGridTransfer.Cells[1, Nowrow],
                'TFT ' + ComboBoxDestShop.Text);
            end;
          end;

          TicketToPrint.AddFinancialLine('Articles :', Art);
          TicketToPrint.AddFinancialLine('Valeur :', Accu);
          TicketToPrint.AddCustomerLine('Destination', ComboBoxDestShop.Text);

          if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
            TicketToPrint.PrintOpos
          else
            TicketToPrint.Print;
        finally
          TicketToPrint.Free;
        end;
      end;

      // Mise  Jour de la Table des Stock
      with StringGridTransfer do
        for Nowrow := 1 to RowCount - 2 do
        begin
          RemoteDB.DeleteFromStock(Cells[0, Nowrow], StrtoInt(Cells[7, Nowrow]), StrtoInt(Cells[8, Nowrow]), StrtoInt(Cells[2, Nowrow]));
        end;

      BitBtnTransferClear.OnClick(BitBtnTransferProcess);
    except
      on e: E_Outloop do
      begin
        RemoteDB.netshop_stock.SavePoint      := StockSavePoint;
        RemoteDB.Transferout.SavePoint        := TransferSavePoint;
        RemoteDB.netshop_items_sold.SavePoint := ItemsSavePoint;
        RemoteDB.netshop_sales.SavePoint      := SalesSavePoint;
        RemoteDB.netshop_stock.EnableControls;
        ShowMessage(e.Message);
      end;
    end;
    RemoteDB.netshop_stock.EnableControls;
  end;

  if RadioButtonReceive.Checked then
  begin
    with StringGridTransfer do
    begin

      // Envoi des Alertes
      for Nowrow := 1 to RowCount - 2 do
      begin
        self.ProcessAlert(Cells[0, Nowrow], Cells[4, Nowrow], Cells[7, Nowrow], Cells[8, Nowrow], Cells[2, Nowrow]);
      end; // for rows loop

      for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
      begin // Suppression de la table transfer insertion en stock

        // Correction du prix nouf ppour les baisses de prix intermdiaires
        TransferPrice := Cells[4, Nowrow];
        // Correction des owner / supplier
        // 1 dpt
        if StrtoInt(Cells[7, Nowrow]) >= 100000 then
        begin
          OwnerId    := ConnectedShop * 100000 + 1;
          SupplierId := 0;
        end;
        // 2 rachat
        if StrtoInt(Cells[8, Nowrow]) >= 100000 then
        begin
          SupplierId := ConnectedShop * 100000 + 1;
          OwnerId    := ConnectedShop;
        end;
        // 3 neuf
        if (StrtoInt(Cells[8, Nowrow]) < 100000) and (StrtoInt(Cells[7, Nowrow]) < 100000) then
        begin
          OwnerId    := ConnectedShop;
          SupplierId := ConnectedShop;
          RemoteDB.Products.FindKey([Cells[0, Nowrow]]);
          TransferPrice :=  RemoteDB.Products.FieldByName('Products_price_allin').AsString;
        end;
        RemoteDB.netshop_stock.Append;
        RemoteDB.netshop_stock.FieldByName('product_location').Text := inttostr(ConnectedShop);
        RemoteDB.netshop_stock.FieldByName('product_model').Text := Cells[0, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_name').Text := Cells[1, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_quantity').Text := Cells[2, Nowrow];
        // RemoteDB.netshop_stock.FieldByName('product_date_in').Text := Cells[6, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_price_gross').Text := Cells[5, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_price_stock').Text := TransferPrice;
        RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger := OwnerId;
        RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger := SupplierId;
        RemoteDB.netshop_stock.Post;

        //
        // Impression Etiquettes
        //
        PrintPriceTag(Cells[2, Nowrow], Cells[1, Nowrow], Cells[4, Nowrow], inttostr(OwnerId), inttostr(SupplierId));
      end; // Fin entre en stock

      // Suppression des donnes de la table tansfer
      for Nowrow := 1 to RowCount - 2 do
      begin
        RemoteDB.DeleteFromTransfer(Cells[0, Nowrow], StrtoInt(Cells[7, Nowrow]), StrtoInt(Cells[8, Nowrow]), StrtoInt(Cells[2, Nowrow]));
      end;

      BitBtnTransferClearClick(self);
    end;
  end; // end RadiobuttonReceive

  endoftransfer:

  TryApplyChangesToDB();
end;

procedure TMainForm.BitBtnTransferSuggestClick(Sender: TObject);
begin
end;

// end procedure

procedure TMainForm.Delete1Click(Sender: TObject);
var
  i, Index: Integer;
begin

  if PageControlMainForm.ActivePage = TabsheetSales then
  begin
    for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
    begin
      if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
      begin
        index := i;
      end;
    end;

    with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]) do
    begin
      if Row < RowCount - 1 then
      begin
        for i := Row to RowCount - 2 do
          Rows[i].Assign(Rows[i + 1]);
        Rows[RowCount - 1].Clear;
        RowCount := RowCount - 1;
      end;
      StringGridSalesEditingDone(nil);
    end;
    ClearCoupons;

  end;

  if PageControlMainForm.ActivePage = TabSheetStockin then
  begin
    for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
    begin
      if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
      begin
        index := i;
      end;
    end;
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]) do
    begin
      if Row < RowCount - 1 then
      begin
        for i := Row to RowCount - 2 do
          Rows[i].Assign(Rows[i + 1]);
        Rows[RowCount - 1].Clear;
        RowCount := RowCount - 1;
      end;
      StringGridStockinEditingDone(nil);
    end;
  end;

  if PageControlMainForm.ActivePage = TabSheetTransfer then
  begin
    if StringGridTransfer.Row < StringGridTransfer.RowCount - 1 then
    begin
      with StringGridTransfer do
      begin
        for i := Row to RowCount - 2 do
          Rows[i].Assign(Rows[i + 1]);
        Rows[RowCount - 1].Clear;
        RowCount := RowCount - 1;
      end;
    end;
  end;
end;

procedure TMainForm.ClearCoupons;
var
  Index, i, Nowrow, delrow: Integer;
begin
  begin
    for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
    begin
      if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
      begin
        index := i;
      end;
    end;

    for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).RowCount - 2 do
    begin
      if ((TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).Cells[0, Nowrow] = 'COUPONBDAY')) then
      begin
        delrow := Nowrow;
      end;
    end;

    with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]) do
    begin
      if delrow < RowCount - 1 then
      begin
        begin
          for i := delrow to RowCount - 2 do
            Rows[i].Assign(Rows[i + 1]);
          Rows[RowCount - 1].Clear;
          RowCount := RowCount - 1;
        end;
        StringGridSalesEditingDone(nil);
        EditSalesName.SetFocus;
      end;
    end;
  end;
end;

procedure TMainForm.Edit1Click(Sender: TObject);
var
  i, Index: Integer;
begin
  if PageControlMainForm.ActivePage = TabsheetSales then
  begin
    for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
    begin
      if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
      begin
        index := i;
      end;
    end;

    with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]) do
    begin
      if Row < RowCount - 1 then
      begin
        begin
          EditSalesModel.Text := Cells[0, Row];
          EditSalesModelExit(nil);
          EditSalesName.Text           := Cells[1, Row];
          EditSalesQuantity.Text       := Cells[2, Row];
          EditSalesPrice.Text          := Cells[4, Row];
          EditSalesDateIn.Text         := Cells[6, Row];
          ComboBoxSalesOwner.Text      := Cells[7, Row];
          ComboBoxSalesOwner.ItemIndex := ComboBoxSalesOwner.items.IndexOf(Cells[7, Row]);
          for i                        := Row to RowCount - 2 do
            Rows[i].Assign(Rows[i + 1]);
          Rows[RowCount - 1].Clear;
          RowCount := RowCount - 1;
        end;
        StringGridSalesEditingDone(nil);
        EditSalesName.SetFocus;
      end;
    end;
    ClearCoupons;
  end;

  if PageControlMainForm.ActivePage = TabSheetTransfer then
  begin
    if StringGridTransfer.Row < StringGridTransfer.RowCount - 1 then
    begin
      with StringGridTransfer do
      begin
        EditTransferModel.Text          := Cells[0, Row];
        EditTransferName.Text           := Cells[1, Row];
        EditTransferQuantity.Text       := Cells[2, Row];
        EditTransferPrice.Value         := StrToFloat(Cells[4, Row]);
        ComboBoxTransferOwner.Text      := Cells[7, Row];
        ComboBoxTransferOwner.ItemIndex := ComboBoxTransferOwner.items.IndexOf(Cells[7, Row]);
        for i                           := Row to RowCount - 2 do
          Rows[i].Assign(Rows[i + 1]);
        Rows[RowCount - 1].Clear;
        RowCount := RowCount - 1;
      end;
    end;
  end;

end;

procedure TMainForm.EditInventoryKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = 13 then
  begin
    if (RemoteDB.Products.Locate('Products_model', EditInventoryModel.Text, [locaseinsensitive])) and (StrtoInt(EditInventoryQuantity.Text) > 0) then
    begin
      sndPlaySound(OkSnd, SND_MEMORY or SND_NODEFAULT or SND_ASYNC);
      if RemoteDB.Inventory.Locate('product_model', EditInventoryModel.Text, [locaseinsensitive]) then
      begin
        RemoteDB.Inventory.Edit;
        RemoteDB.Inventory.FieldByName('product_quantity').AsInteger := RemoteDB.Inventory.FieldByName('product_quantity').AsInteger +
          StrtoInt(EditInventoryQuantity.Text);
        RemoteDB.Inventory.Post;
      end else begin // Product already inventories
        RemoteDB.Inventory.Append;
        RemoteDB.Inventory.FieldByName('product_model').AsString := EditInventoryModel.Text;
        RemoteDB.Inventory.FieldByName('product_owner_id').AsInteger := (ConnectedShop);
        RemoteDB.Inventory.FieldByName('product_location').AsInteger := (ConnectedShop);
        RemoteDB.Inventory.FieldByName('product_price_stock').AsFloat := RemoteDB.Products.FieldByName('products_price').AsFloat;
        RemoteDB.Inventory.FieldByName('product_quantity').AsInteger := StrtoInt(EditInventoryQuantity.Text);
        RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat := RemoteDB.Products.FieldByName('products_cldprice').AsFloat;
        RemoteDB.Inventory.FieldByName('product_name').AsString := RemoteDB.Products.FieldByName('products_intername').AsString;
        RemoteDB.Inventory.Post;
      end; // Product not yet inventoried yet
    end else begin // Endif Product located and Q>0
      sndPlaySound(ErrorSnd, SND_MEMORY or SND_NODEFAULT or SND_ASYNC);
    end;
    EditInventoryModel.Clear;
    EditInventoryModel.SetFocus;
    EditInventoryQuantity.Text := '1';
  end; // Endif Key=13
end;

procedure TMainForm.EditInventoryModelExit(Sender: TObject);
begin
  EditInventoryModel.Text := UpperCase(EditInventoryModel.Text);
  if (not RemoteDB.Products.Locate('Products_model', EditInventoryModel.Text, [locaseinsensitive])) and (EditInventoryModel.Text <> '') then
  begin
    messagedlg('Produit inconnu veuillez l introduire dans la base de donnes', mtwarning, [mbok], 0);
    EditInventoryModel.Clear;
    EditInventoryModel.SetFocus;
    EditInventoryQuantity.Text := '1';
  end;
end;

procedure TMainForm.RadioButtonSendClick(Sender: TObject);
begin
  TransferClearStringGrid;
  TransferClearEdit;
  TransferClearSummary;

  RemoteDB.Shops.Locate('Shops_id', ConnectedShop, []);
  // ComboBoxOriginShop.Enabled := True;
  // ComboBoxOriginShop.ItemIndex := ComboBoxOriginShop.items.IndexOf
  // (RemoteDB.Shops.FieldByName('shops_name').AsString);
  // ComboBoxOriginShop.Enabled := False;
  ComboBoxDestShop.Enabled := True;
  ComboBoxDestShop.SetFocus;
  ComboBoxDestShop.ItemIndex := -1;
  ComboBoxDestShop.Text      := 'Select destination';
end;

procedure TMainForm.RaportCouponsClick(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        try
          ClientsExecute(nil);
          RemoteDB.FreeCouponsToCustomers;

          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportCoupons', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally

        end;
end;

procedure TMainForm.RadioButtonAlertsArrivedClick(Sender: TObject);
begin
  RemoteDB.FilterAlertsArrived;
end;

procedure TMainForm.RadioButtonAlertsBoughtClick(Sender: TObject);
begin
  RemoteDB.FilterAlertsBought;
end;

procedure TMainForm.RadioButtonAlertsNotifiedClick(Sender: TObject);
begin
  RemoteDB.FilterAlertsNotified;
end;

procedure TMainForm.RadioButtonAlertsProductFilterAllClick(Sender: TObject);
begin
  RemoteDB.FilterProductsAll
end;

procedure TMainForm.RadioButtonAlertsProductFilterBackCatalogueClick(Sender: TObject);
begin
  RemoteDB.FilterProductsBackCatalogue
end;

procedure TMainForm.RadioButtonAlertsProductFilterPreOrderClick(Sender: TObject);
begin
  RemoteDB.FilterProductsPreOrder
end;

procedure TMainForm.RadioButtonAlertsreservedClick(Sender: TObject);
begin
  RemoteDB.FilterAlertsReserved;
end;

procedure TMainForm.RadioButtonReceiveClick(Sender: TObject);
begin
  TransferClearStringGrid;
  TransferClearEdit;
  TransferClearSummary;

  RemoteDB.Shops.Locate('Shops_id', ConnectedShop, []);
  ComboBoxDestShop.Enabled   := True;
  ComboBoxDestShop.ItemIndex := ComboBoxDestShop.items.IndexOf(RemoteDB.Shops.FieldByName('shops_name').AsString);
  ComboBoxDestShop.Enabled   := False;

  // ComboBoxOriginShop.Enabled := True;
  // ComboBoxOriginShop.SetFocus;
  // ComboBoxOriginShop.ItemIndex := -1;
  // ComboBoxOriginShop.Text := 'Select origin';
end;

procedure TMainForm.EditTransferKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
var
  Nowrow, rowpresent, quantitypresent: Integer;
  ProductPresent: Boolean;
  TmpStr, supplier, owner: string;
  ExitLib: TFormExitLibrary;
  OwnSup: TStringList;

begin
  quantitypresent := 0;
  if RadioButtonSend.Checked then
  begin
    if Key = 13 then
      try

        TmpStr := '-';
        if Pos(TmpStr, ComboBoxTransferOwner.Text) <> 0 then
        begin
          OwnSup   := StrSplit(ComboBoxTransferOwner.Text, '-');
          owner    := OwnSup[0];
          supplier := OwnSup[1];
        end else begin;
          owner    := ComboBoxTransferOwner.Text;
          supplier := '-1';
        end;

        RemoteDB.netshop_stock.DisableControls;
        RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';

        RemoteDB.Products.DisableControls;
        RemoteDB.Products.IndexName := 'ProductsIXModel';

        if (RemoteDB.Products.Locate('products_model', EditTransferModel.Text, [locaseinsensitive])) then
        begin
          if (ComboBoxTransferOwner.ItemIndex <> -1) then
          begin
            { Rechercher dans le transfer grid pour la meme occurence owner id & product model }
            quantitypresent := 0;
            if supplier = '-1' then
            begin
              for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
              begin
                if (StringGridTransfer.Cells[0, Nowrow] = EditTransferModel.Text) and (StringGridTransfer.Cells[7, Nowrow] = owner) then
                begin
                  quantitypresent := quantitypresent + StrtoInt(StringGridTransfer.Cells[2, Nowrow]);
                end;
              end;
              RemoteDB.netshop_stock.FindKey([EditTransferModel.Text, ComboBoxTransferOwner.Text]);
            end else begin // Supplier Occasion
              for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
              begin
                if (StringGridTransfer.Cells[0, Nowrow] = EditTransferModel.Text) and (StringGridTransfer.Cells[7, Nowrow] = owner) and
                  (StringGridTransfer.Cells[8, Nowrow] = supplier) then
                begin
                  quantitypresent := quantitypresent + StrtoInt(StringGridTransfer.Cells[2, Nowrow]);
                end;
              end;
              RemoteDB.netshop_stock.FindKey([EditTransferModel.Text, owner, supplier]);
            end;

            if ((StrtoInt(EditTransferQuantity.Text) > 0) and (StrtoInt(EditTransferQuantity.Text) <= StrtoInt(EditTransferAvailable.Text))) then
            begin

              if not ProductPresent then
              begin { Ajouter d'une ligne dans le transfer grid }

                { Sortie du Dacal CD Library }
                RemoteDB.Products.Locate('products_model', EditTransferModel.Text, []);
                if ((self.Parameter['MiscCDLibUse'] = 'TRUE') and (RemoteDB.Caroussel.Locate('model;customer_nbr;IsRoot',
                  Vararrayof([RemoteDB.Products.FieldByName('products_model').AsString, StrtoInt(owner), True]), [])) and
                  (((StrtoInt(owner) < 100000) and (StrtoInt(supplier) >= 100000)) or ((StrtoInt(owner) >= 100000)))) then
                begin
                  ExitLib := TFormExitLibrary.Create(self);
                  ExitLib.Enter(owner, EditTransferModel.Text);
                  ExitLib.Free;
                end;
                Nowrow                              := StringGridTransfer.RowCount - 1;
                StringGridTransfer.Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
                StringGridTransfer.Cells[1, Nowrow] := RemoteDB.Products.FieldByName('products_intername').Text;
                StringGridTransfer.Cells[2, Nowrow] := EditTransferQuantity.Text;
                StringGridTransfer.Cells[3, Nowrow] := FloatToStrF(RemoteDB.ProductsProducts_Price.AsFloat, fffixed, 7, 2);
                StringGridTransfer.Cells[4, Nowrow] := FloatToStrF(EditTransferPrice.Value, fffixed, 7, 2);
                StringGridTransfer.Cells[5, Nowrow] := FloatToStrF(RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat, fffixed, 7, 2);
                StringGridTransfer.Cells[6, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_date_in').Text;
                StringGridTransfer.Cells[7, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_owner_id').Text;
                StringGridTransfer.Cells[8, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text;
                StringGridTransfer.Cells[9, Nowrow] := inttostr(ConnectedShop);
                StringGridTransfer.RowCount         := Nowrow + 2;

                { Reinitialisation de la barre de selection }
                TransferClearEdit;
                if EditTransferModel.Visible then
                  EditTransferModel.SetFocus;
              end else begin { Incrmenter une ligne dans le transfer grid }
                if StrtoInt(EditTransferQuantity.Text) <= StrtoInt(EditTransferAvailable.Text) - quantitypresent then
                begin
                  StringGridTransfer.Cells[2, rowpresent] := inttostr(quantitypresent + Round(StrtoInt(EditTransferQuantity.Text)));

                  { Reinitialisation de la barre de selection }
                  TransferClearEdit;
                  if EditTransferModel.Visible then
                    EditTransferModel.SetFocus;
                end else begin { Q insuffisante }
                  if EditTransferQuantity.Visible then
                    EditTransferQuantity.SetFocus;
                end;

              end;
            end else begin { quantit farfelue }
              messagedlg('Unavailable quantity', mtwarning, [mbok], 0);
              if EditTransferQuantity.Visible then
                EditTransferQuantity.SetFocus;
            end
          end else begin { Pas de owner selectionn }
            messagedlg('Select owner', mtwarning, [mbok], 0);
            if ComboBoxTransferOwner.Visible then
              ComboBoxTransferOwner.SetFocus;
          end;
        end else begin { Product model non localis }
          messagedlg('Modle non valide', mtwarning, [mbok], 0);
        end;
      finally
        RemoteDB.netshop_stock.EnableControls;
        RemoteDB.Products.EnableControls;
      end; { endif chr(13) }
  end;

  if RadioButtonReceive.Checked then
  begin

    if Key = 13 then
      if (ComboBoxTransferOwner.ItemIndex <> -1) then
      begin
        if (RemoteDB.Products.Locate('products_model', EditTransferModel.Text, [locaseinsensitive])) then
        begin
          if ((StrtoInt(EditTransferQuantity.Text) > 0) and (StrtoInt(EditTransferQuantity.Text) <= StrtoInt(EditTransferAvailable.Text))) then
          begin
            { Rechercher dans le transfer grid pour la meme occurence de product model }
            TmpStr := '-';
            if Pos(TmpStr, ComboBoxTransferOwner.Text) <> 0 then
            begin
              // Stock Rachat Mag
              OwnSup   := TStringList.Create;
              OwnSup   := StrSplit(ComboBoxTransferOwner.Text, '-');
              owner    := OwnSup[0];
              supplier := OwnSup[1];
            end else begin
              // Stock Dpot ou Neuf
              owner    := ComboBoxTransferOwner.Text;
              supplier := '-1';
            end;

            ProductPresent := False;
            rowpresent     := -1;
            for Nowrow     := 1 to StringGridTransfer.RowCount - 2 do
            begin
              if ((StringGridTransfer.Cells[0, Nowrow] = EditTransferModel.Text) and (StringGridTransfer.Cells[7, Nowrow] = owner)) then
              begin
                if supplier = '-1' then
                begin
                  ProductPresent  := True;
                  rowpresent      := Nowrow;
                  quantitypresent := StrtoInt(StringGridTransfer.Cells[2, Nowrow]);
                end else begin
                  if (StringGridTransfer.Cells[8, Nowrow] = supplier) then
                  begin
                    ProductPresent  := True;
                    rowpresent      := Nowrow;
                    quantitypresent := StrtoInt(StringGridTransfer.Cells[2, Nowrow]);
                  end;
                end;
              end;
            end;
            if not ProductPresent then
            begin { Ajouter d'une ligne dans le transfer grid }
              Nowrow                              := StringGridTransfer.RowCount - 1;
              StringGridTransfer.Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
              StringGridTransfer.Cells[1, Nowrow] := RemoteDB.Products.FieldByName('products_intername').Text;
              StringGridTransfer.Cells[2, Nowrow] := EditTransferQuantity.Text;
              StringGridTransfer.Cells[3, Nowrow] := RemoteDB.ProductsProducts_Price.Text;
              if ((RemoteDB.netshop_transfer.FieldByName('product_owner_id').AsInteger >= 100000) or
                (RemoteDB.netshop_transfer.FieldByName('product_supplier_id').AsInteger >= 100000)) then
                StringGridTransfer.Cells[4, Nowrow] := FloatToStr(RemoteDB.netshop_transfer.FieldByName('Product_Price_Stock').AsFloat + 3)
              else
                StringGridTransfer.Cells[4, Nowrow] := RemoteDB.netshop_transfer.FieldByName('Product_Price_Stock').Text;
              StringGridTransfer.Cells[5, Nowrow]   := RemoteDB.netshop_transfer.FieldByName('Product_Price_Gross').Text;
              StringGridTransfer.Cells[6, Nowrow]   := RemoteDB.netshop_transfer.FieldByName('Product_Date_In').Text;
              StringGridTransfer.Cells[7, Nowrow]   := RemoteDB.netshop_transfer.FieldByName('Product_Owner_id').Text;
              StringGridTransfer.Cells[8, Nowrow]   := RemoteDB.netshop_transfer.FieldByName('product_supplier_id').Text;
              StringGridTransfer.Cells[9, Nowrow]   := RemoteDB.netshop_transfer.FieldByName('product_origin').Text;

              StringGridTransfer.RowCount := Nowrow + 2;

              { Reinitialisation de la barre de selection }
              TransferClearEdit;
              if EditTransferModel.Visible then
                EditTransferModel.SetFocus;

            end else begin { Incrmenter une ligne dans le transfer grid }
              if StrtoInt(EditTransferQuantity.Text) <= StrtoInt(EditTransferAvailable.Text) - quantitypresent then
              begin
                StringGridTransfer.Cells[2, rowpresent] := inttostr(quantitypresent + StrtoInt(EditTransferQuantity.Text));
                { Reinitialisation de la barre de selection }
                TransferClearEdit;
                if EditTransferModel.Visible then
                  EditTransferModel.SetFocus;;
              end else begin { Q insuffisante }
                if EditTransferQuantity.Visible then
                begin
                  messagedlg('Quantit insuffisante', mtwarning, [mbok], 0);
                  EditTransferQuantity.SetFocus;
                end;
              end;
            end;
          end else begin { quantit farfelue }
            messagedlg('Quantit non disponnible', mtwarning, [mbok], 0);
            if EditTransferQuantity.Visible then
              EditTransferQuantity.SetFocus;
          end
        end else begin { Product model non localis }
          messagedlg('Modle non valide', mtwarning, [mbok], 0);
        end;
      end; { endif chr(13) }
  end; // End RadioButtonReceiveChecked
end;

procedure TMainForm.EditTransferModelExit(Sender: TObject);
var
  MinPrice: Double;
  MinPriceOwner: string;
  CheckPreviouslyInserted: string;
begin
  if EditTransferModel.Text <> '' then
  begin
    EditTransferModel.Text := UpperCase(EditTransferModel.Text);
    if RadioButtonSend.Checked then
    begin
      ComboBoxTransferOwner.Clear;
      // Verification validit article
      if RemoteDB.Products.Locate('products_model', EditTransferModel.Text, [locaseinsensitive]) then
      begin
        RemoteDB.netshop_stock.DisableControls;
        RemoteDB.netshop_stock.First;
        RemoteDB.netshop_stock.IndexFieldNames := 'product_model';
        // Verification Prsence en Stock
        try
          if RemoteDB.netshop_stock.Locate('product_model;product_location', Vararrayof([EditTransferModel.Text, ConnectedShop]), [locaseinsensitive]) then
          begin
            EditTransferName.Text     := RemoteDB.Products.FieldByName('products_intername').Text;
            EditTransferPrice.Value   := RemoteDB.Products.FieldByName('products_price').AsFloat;
            EditTransferQuantity.Text := '1';
            EditTransferModel.SelectAll;

            // Population de la listbox owner et recherche du prix min
            MinPrice      := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
            MinPriceOwner := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString;

            repeat
              if RemoteDB.netshop_stock.FieldByName('product_model').Text = EditTransferModel.Text then
              begin
                if RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger <= 100000 then
                begin
                  CheckPreviouslyInserted := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString;
                end else begin
                  CheckPreviouslyInserted := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString + '-' +
                    RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsString;
                end;
                if (ComboBoxTransferOwner.items.IndexOf(CheckPreviouslyInserted) = -1) then
                begin
                  ComboBoxTransferOwner.items.Add(CheckPreviouslyInserted);
                  if RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat <= MinPrice then
                  begin
                    MinPrice      := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                    MinPriceOwner := CheckPreviouslyInserted;
                  end;
                end;
                if (ComboBoxTransferOwner.items.IndexOf(RemoteDB.netshop_stock.FieldByName('product_owner_id').Text) = -1) and
                  (RemoteDB.netshop_stock.FieldByName('product_location').AsInteger = ConnectedShop) then
                  ComboBoxTransferOwner.items.Add(RemoteDB.netshop_stock.FieldByName('product_owner_id').Text);
              end;
              RemoteDB.netshop_stock.Next;
            until (RemoteDB.netshop_stock.FieldByName('product_model').AsString <> EditTransferModel.Text) or RemoteDB.netshop_stock.Eof;
            ComboBoxTransferOwner.ItemIndex := ComboBoxTransferOwner.items.IndexOf(inttostr(ConnectedShop));
            ComboBoxTransferOwner.OnChange(EditTransferModel);
            // Fin population listbox
          end else begin
            messagedlg('No Stock', mtwarning, [mbok], 0);
            TransferClearEdit;
            if EditTransferModel.Visible then
              EditTransferModel.SetFocus;
          end;
        finally
          RemoteDB.netshop_stock.EnableControls;
          RemoteDB.netshop_stock.IndexFieldNames := 'Product_Model;Product_owner_id';
        end;
      end else begin
        if (EditTransferModel.Text <> '') and (EditTransferModel.Visible) then
          EditTransferModel.SetFocus;
        TransferClearEdit;
      end;
    end;

    if RadioButtonReceive.Checked then
    begin
      ComboBoxTransferOwner.Clear;
      // Verification validit article
      if RemoteDB.Products.Locate('products_model', EditTransferModel.Text, [locaseinsensitive]) then
      begin
        RemoteDB.netshop_transfer.DisableControls;
        RemoteDB.netshop_transfer.First;
        RemoteDB.netshop_transfer.IndexFieldNames := 'product_model';
        try

          // Verification Prsence en Transfer

          if RemoteDB.netshop_transfer.Locate('product_model;product_destination', Vararrayof([EditTransferModel.Text, ConnectedShop]), [locaseinsensitive])
          then
          begin
            EditTransferName.Text      := RemoteDB.Products.FieldByName('products_intername').Text;
            EditTransferPrice.Value    := RemoteDB.netshop_transfer.FieldByName('Product_Price_Stock').AsFloat;
            EditTransferQuantity.Text  := '1';
            EditTransferAvailable.Text := '0';
            EditTransferModel.SelectAll;
            // Population de la listbox owner   ZZZZZZZZZZZ
            repeat
              if RemoteDB.netshop_transfer.FieldByName('product_model').Text = EditTransferModel.Text then
              begin
                if RemoteDB.netshop_transfer.FieldByName('product_supplier_id').AsInteger < 100000 then
                begin
                  CheckPreviouslyInserted := RemoteDB.netshop_transfer.FieldByName('product_owner_id').AsString;
                end else begin
                  CheckPreviouslyInserted := RemoteDB.netshop_transfer.FieldByName('product_owner_id').AsString + '-' +
                    RemoteDB.netshop_transfer.FieldByName('product_supplier_id').AsString;
                end;
                if (ComboBoxTransferOwner.items.IndexOf(CheckPreviouslyInserted) = -1) then
                begin
                  ComboBoxTransferOwner.items.Add(CheckPreviouslyInserted);
                  if RemoteDB.netshop_transfer.FieldByName('product_price_stock').AsFloat <= MinPrice then
                  begin
                    MinPrice      := RemoteDB.netshop_transfer.FieldByName('product_price_stock').AsFloat;
                    MinPriceOwner := CheckPreviouslyInserted;
                  end;
                end;
              end;
              RemoteDB.netshop_transfer.Next;
            until (RemoteDB.netshop_transfer.FieldByName('product_model').AsString <> EditTransferModel.Text) or RemoteDB.netshop_transfer.Eof;
            ComboBoxTransferOwner.ItemIndex := ComboBoxTransferOwner.items.IndexOf(inttostr(ConnectedShop));
            ComboBoxTransferOwner.OnChange(EditTransferModel);
            // Fin population listbox

            repeat
              if RemoteDB.netshop_transfer.FieldByName('Product_model').Text = EditTransferModel.Text then
              begin
                if (ComboBoxTransferOwner.items.IndexOf(RemoteDB.netshop_transfer.FieldByName('Product_Owner_id').Text) = -1) and
                  (RemoteDB.netshop_transfer.FieldByName('Product_Destination').AsInteger = ConnectedShop) then
                  ComboBoxTransferOwner.items.Add(RemoteDB.netshop_transfer.FieldByName('Product_Owner_id').Text);
              end;
              RemoteDB.netshop_transfer.Next;
            until (RemoteDB.netshop_transfer.FieldByName('Product_model').AsString <> EditTransferModel.Text) or RemoteDB.netshop_transfer.Eof;

            ComboBoxTransferOwner.OnChange(EditTransferModel);
            // Vrification des quantits Disponibles
            RemoteDB.netshop_transfer.First;
            RemoteDB.netshop_transfer.IndexFieldNames := 'Product_Model';
            if RemoteDB.netshop_transfer.FindKey([EditTransferModel.Text]) then
            begin
              repeat
                if (RemoteDB.netshop_transfer.FieldByName('Product_Destination').AsInteger = ConnectedShop) then
                  EditTransferAvailable.Text := inttostr(StrtoInt(EditTransferAvailable.Text) + RemoteDB.netshop_transfer.FieldByName('Product_Quantity')
                    .AsInteger);
                RemoteDB.netshop_transfer.Next;
              until (RemoteDB.netshop_transfer.FieldByName('Product_model').Text <> EditTransferModel.Text) or RemoteDB.netshop_transfer.Eof;
              RemoteDB.netshop_transfer.IndexFieldNames := 'Product_Model;Product_owner_id';
            end;
            ComboBoxTransferOwner.OnChange(EditTransferModel);
          end else begin // Si pas en transfer
            messagedlg('Pas en transfer', mtwarning, [mbok], 0);
            TransferClearEdit;
            if EditTransferModel.Visible then
              EditTransferModel.SetFocus;
          end;
        finally
          RemoteDB.netshop_transfer.EnableControls;
          RemoteDB.netshop_transfer.IndexFieldNames := 'Product_Model;Product_owner_id';
        end;
      end else begin // Si product Model invalide
        messagedlg('Modle non valide', mtwarning, [mbok], 0);
        EditTransferModel.SelectAll;
        EditTransferModel.SetFocus;
      end;
    end;
  end; // Product Model = '';

end;

procedure TMainForm.ComboBoxTransferOwnerChange(Sender: TObject);
var
  TmpStr, owner, supplier: string;
  OwnSup: TStringList;
begin
  if RadioButtonSend.Checked then
  begin
    RemoteDB.netshop_stock.DisableControls;
    try
      EditTransferAvailable.Text := '0';
      EditTransferReserved.Text  := inttostr(RemoteDB.GetReservedStock(EditTransferModel.Text));
      TmpStr                     := inttostr(ConnectedShop) + '-';
      if Pos(TmpStr, ComboBoxTransferOwner.Text) = 1 then
      begin
        // Stock Rachat Mag
        owner                            := inttostr(ConnectedShop);
        supplier                         := RightStr(ComboBoxTransferOwner.Text, Length(ComboBoxTransferOwner.Text) - Length(TmpStr));
        RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';
        RemoteDB.netshop_stock.SetKey;
        RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsString := supplier;
      end else begin
        // Stock Dpot ou Neuf
        owner                            := ComboBoxTransferOwner.Text;
        supplier                         := '-1';
        RemoteDB.netshop_stock.IndexName := 'StockIXModelOwner';
        RemoteDB.netshop_stock.SetKey;
      end;
      RemoteDB.netshop_stock.FieldByName('product_model').AsString := EditTransferModel.Text;
      RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString := owner;

      if RemoteDB.netshop_stock.GotoKey then
      begin
        // Mise  jour des quantits disponibles selon modle, owner, et prix de vente min
        // Prix
        if ComboBoxTransferOwner.Text = inttostr(ConnectedShop) then
        begin
          if RemoteDB.Customerscustomers_htprice.AsString = 'False' then
            EditTransferPrice.Value := RemoteDB.Products.FieldByName('Products_Price_AllIn').AsFloat
          else
            EditTransferPrice.Value := RemoteDB.Products.FieldByName('Products_Price').AsFloat
        end else begin
          EditTransferPrice.Value := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
        end;
        // Date In
        if supplier <> '-1' then
        begin
          while ((RemoteDB.netshop_stock.FieldByName('product_model').Text = EditTransferModel.Text) and
            (RemoteDB.netshop_stock.FieldByName('product_owner_id').Text = owner) and (not RemoteDB.netshop_stock.Eof) and
            (RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text = supplier)) do
          begin
            // Traitement des Rachats
            EditTransferAvailable.Text := inttostr(StrtoInt(EditTransferAvailable.Text) + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger);
            RemoteDB.netshop_stock.Next;
          end;
        end else begin
          while ((RemoteDB.netshop_stock.FieldByName('product_model').Text = EditTransferModel.Text) and
            (RemoteDB.netshop_stock.FieldByName('product_owner_id').Text = owner) and (not RemoteDB.netshop_stock.Eof)) do
          begin
            // Traitement des Dpt et stock Neuf
            if (RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger < 100000) then
            begin
              EditTransferAvailable.Text := inttostr(StrtoInt(EditTransferAvailable.Text) + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger);
            end;
            RemoteDB.netshop_stock.Next;
          end;
        end;
      end;
    finally
      RemoteDB.netshop_stock.EnableControls;
    end;
  end;

  if RadioButtonReceive.Checked then
  begin
    EditTransferAvailable.Text := '0';
    TmpStr                     := '-';
    if Pos(TmpStr, ComboBoxTransferOwner.Text) <> 0 then
    begin
      // Stock Rachat Mag
      OwnSup                              := TStringList.Create;
      OwnSup                              := StrSplit(ComboBoxTransferOwner.Text, '-');
      owner                               := OwnSup[0];
      supplier                            := OwnSup[1];
      RemoteDB.netshop_transfer.IndexName := 'TransferIXModelOwnerSupplier';
      RemoteDB.netshop_transfer.SetKey;
      RemoteDB.netshop_transfer.FieldByName('product_supplier_id').AsString := supplier;
    end else begin
      // Stock Dpot ou Neuf
      owner                               := ComboBoxTransferOwner.Text;
      supplier                            := '-1';
      RemoteDB.netshop_transfer.IndexName := 'TransferIXModelOwner';
      RemoteDB.netshop_transfer.SetKey;
    end;
    RemoteDB.netshop_transfer.FieldByName('product_model').AsString := EditTransferModel.Text;
    RemoteDB.netshop_transfer.FieldByName('product_owner_id').AsString := owner;
    if RemoteDB.netshop_transfer.GotoKey then
    begin

      EditTransferPrice.Value    := RemoteDB.netshop_transfer.FieldByName('Product_Price_Stock').AsFloat;
      EditTransferAvailable.Text := RemoteDB.netshop_transfer.FieldByName('Product_Quantity').AsString;
      if ((RemoteDB.netshop_transfer.FieldByName('product_owner_id').AsInteger >= 100000) or
        (RemoteDB.netshop_transfer.FieldByName('product_supplier_id').AsInteger >= 100000)) then
        EditTransferPrice.Value := EditTransferPrice.Value + 3;

    end;
  end;
end;

procedure TMainForm.BitBtnTransferClearClick(Sender: TObject);
begin
  TransferClearEdit;
  TransferClearStringGrid;
  TransferClearSummary;

  RadioButtonSend.Checked := True;

  RemoteDB.Shops.Locate('Shops_id', ConnectedShop, []);

  // ComboBoxOriginShop.Enabled := True;
  // ComboBoxOriginShop.ItemIndex := ComboBoxOriginShop.items.IndexOf
  // (RemoteDB.Shops.FieldByName('shops_name').AsString);
  // ComboBoxOriginShop.Enabled := False;

  ComboBoxDestShop.Enabled   := True;
  ComboBoxDestShop.ItemIndex := -1;
  ComboBoxDestShop.Text      := 'Select destination';
end;

procedure TMainForm.TransferClearEdit;
begin
  EditTransferModel.Clear;
  EditTransferName.Clear;
  EditTransferQuantity.Text  := '0';
  EditTransferPrice.Value    := 0;
  EditTransferAvailable.Text := '0';
  ComboBoxTransferOwner.Clear;
  ComboBoxTransferOwner.Text := ('Select Owner');
end;

procedure TMainForm.TransferClearStringGrid;
var
  Nowrow, NowCol: Integer;
begin
  for Nowrow := 1 to StringGridTransfer.RowCount - 2 do
  begin
    for NowCol                                 := 0 to StringGridTransfer.ColCount - 1 do
      StringGridTransfer.Cells[NowCol, Nowrow] := '';
  end;
  StringGridTransfer.RowCount := 2;
end;

procedure TMainForm.TransferClearSummary;
begin

end;

procedure TMainForm.ComboBoxOriginShopChange(Sender: TObject);
begin
  if StringGridTransfer.RowCount > 2 then
  begin
    if messagedlg('Changing shop will reset from', mtwarning, [mbok, mbCancel], 0) = mrOK then
    begin
      TransferClearEdit;
      TransferClearStringGrid;
      TransferClearSummary;
    end
    else
      exit;
  end else begin
    TransferClearEdit;
    TransferClearStringGrid;
    TransferClearSummary;
  end;
end;

procedure TMainForm.StockCheckClick(Sender: TObject);
var
  TmpIndex: string;
begin
  RemoteDB.IsUpdating                    := True;
  TmpIndex                               := RemoteDB.netshop_stock.IndexFieldNames;
  RemoteDB.netshop_stock.IndexFieldNames := 'Product_Model;Product_Location;Product_owner_id';
  RemoteDB.netshop_stock.Filter          := 'Product_Model = ' + QuotedStr(RemoteDB.Products.FieldByName('products_model').AsString);
  RemoteDB.netshop_stock.Filtered        := True;
  StockCheckForm.ShowModal;
  RemoteDB.netshop_stock.IndexFieldNames := TmpIndex;
  RemoteDB.netshop_stock.Filtered        := False;
  RemoteDB.netshop_stock.Filter          := '';
  RemoteDB.IsUpdating                    := False;
end;

/// ///
/// ///
/// /// SALES PROCEDURES
/// ///
/// ///
function TMainForm.ValidateCoupon(coupon: string): Boolean;
var
  indexnbr, i: Integer;
  customer_nbr: string;
begin
  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 95 then
    begin
      indexnbr := i;
    end;
  end;

  with TEdit(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexnbr]) do
  begin
    if not RemoteDB.Customers.Locate('customers_nbr', Text, [locaseinsensitive]) then
      exit;
    customer_nbr := Text;
  end;
  if RemoteDB.CDSCoupons.Locate('coupon_code;restrict_to_customers', Vararrayof([coupon, customer_nbr]), []) then
  begin
    if RemoteDB.CDSCoupons.FieldByName('coupon_active').AsString = 'Y' then
    begin
      Result := True;
    end else begin
      if messagedlg('Coupon dj utlis tes vous sur de voulois le r-introduire ? Le remboursement sera ffectu une seule fois', mtwarning, [mbyes, mbno], 0)
        = mryes then
      begin
        Result := True;
      end else begin
        Result := False;
      end;
    end;
  end else begin
    Result := False;
  end;
end;

procedure TMainForm.EditSalesModelExit(Sender: TObject);
var
  TmpIndex, CheckPreviouslyInserted, MinPriceOwner, customer_nbr, ProductCode, owner, supplier: string;
  MinPrice, newvalue: currency;
  indexnbr, i, GridIndex, quantitypresent, Nowrow: Integer;

begin
  RemoteDB.Products.IndexName := 'ProductsIXModel';
  if EditSalesModel.Text <> '' then
  begin
    EditSalesModel.Text := UpperCase(EditSalesModel.Text);
    ComboBoxSalesOwner.Clear;
    // Verification validit article
    if RemoteDB.Products.FindKey([EditSalesModel.Text]) then
    begin
      // Verification Prsence en Stock
      TmpIndex := RemoteDB.netshop_stock.IndexName;
      RemoteDB.netshop_stock.DisableControls;
      RemoteDB.netshop_stock.IndexName := 'StockIXModelLocation';
      try
        if RemoteDB.netshop_stock.FindKey([EditSalesModel.Text, ConnectedShop]) then
        begin
          EditSalesName.Text     := RemoteDB.Products.FieldByName('products_intername').Text;
          EditSalesQuantity.Text := '1';
          EditSalesModel.SelectAll;

          // Population de la listbox owner et recherche du prix min
          MinPrice      := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
          MinPriceOwner := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString;

          repeat
            if RemoteDB.netshop_stock.FieldByName('product_model').Text = EditSalesModel.Text then
            begin
              if RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger < 100000 then
              begin
                CheckPreviouslyInserted := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString;
              end else begin
                CheckPreviouslyInserted := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString + '-' +
                  RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsString;
              end;
              if (ComboBoxSalesOwner.items.IndexOf(CheckPreviouslyInserted) = -1) then
              begin
                ComboBoxSalesOwner.items.Add(CheckPreviouslyInserted);
                if RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat <= MinPrice then
                begin
                  MinPrice      := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                  MinPriceOwner := CheckPreviouslyInserted;
                end;
              end;
            end;
            RemoteDB.netshop_stock.Next;
          until (RemoteDB.netshop_stock.FieldByName('product_model').AsString <> EditSalesModel.Text) or RemoteDB.netshop_stock.Eof;

          // Slection du stock magasin et si non dispo le moins cher des occasions
          if ComboBoxSalesOwner.items.IndexOf(inttostr(ConnectedShop)) = -1 then
          begin
            ComboBoxSalesOwner.ItemIndex := ComboBoxSalesOwner.items.IndexOf(MinPriceOwner)
          end else begin
            ComboBoxSalesOwner.ItemIndex := ComboBoxSalesOwner.items.IndexOf(inttostr(ConnectedShop));
          end;

          for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
          begin
            if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 95 then
            begin
              indexnbr := i;
            end;
          end;

          with TEdit(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexnbr]) do
          begin
            if not RemoteDB.Customers.Locate('customers_nbr', Text, [locaseinsensitive]) then
              exit;
          end;
          ComboBoxSalesOwner.OnChange(EditSalesModel);

        end else begin
          if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'True') then
          begin
            messagedlg('Pas disponible en stock', mtwarning, [mbok], 0);
            SalesClearEdit;
          end else begin
            EditSalesName.Text := RemoteDB.Products.FieldByName('products_intername').Text;
            ComboBoxSalesOwner.items.Add(inttostr(ConnectedShop));
            ComboBoxSalesOwner.ItemIndex := ComboBoxSalesOwner.items.IndexOf(inttostr(ConnectedShop));
            ComboBoxSalesOwner.OnChange(EditSalesModel);
          end;
        end;

      finally
        RemoteDB.netshop_stock.EnableControls;
        RemoteDB.netshop_stock.IndexName := TmpIndex;
      end;
    end else begin // Product model non valide vrifier pour coupon
      if ValidateCoupon(EditSalesModel.Text) then
      begin
        // Rsupration infos coupons
        ComboBoxSalesOwner.items.Add(inttostr(ConnectedShop));
        ComboBoxSalesOwner.ItemIndex := ComboBoxSalesOwner.items.IndexOf(inttostr(ConnectedShop));
        ComboBoxSalesOwner.OnChange(EditSalesModel);
        EditSalesQuantity.Text  := '1';
        EditSalesAvailable.Text := '1';
        EditSalesName.Text      := RemoteDB.CDSCoupons.FieldByName('coupon_description').AsString;
        EditSalesPrice.Value    := -RemoteDB.CDSCoupons.FieldByName('coupon_amount').AsFloat;
        // Rajout immdiat dans le caddy

        for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
          begin
            GridIndex := i;
          end;
        end;

        for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 95 then
          begin
            indexnbr := i;
          end;
        end;

        with TEdit(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexnbr]) do
        begin
          if not RemoteDB.Customers.Locate('customers_nbr', Text, [locaseinsensitive]) then
            exit;
          customer_nbr := Text;
        end;

        begin;
          owner    := inttostr(ConnectedShop);
          supplier := '-1';
        end;

        RemoteDB.netshop_stock.DisableControls;
        RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';

        RemoteDB.Products.DisableControls;
        RemoteDB.Products.IndexName := 'ProductsIXModel';

        EditSalesPrice.SelLength    := 0;
        EditSalesQuantity.SelLength := 0;
        EditSalesName.SelLength     := 0;

        ProductCode := 'COUPONBDAY';

        if (RemoteDB.Products.Locate('products_model', ProductCode, [locaseinsensitive])) then
        begin

          if (ComboBoxSalesOwner.ItemIndex <> -1) then
          begin
            { Rechercher dans le Sales grid pour la meme occurence owner id & product model }
            quantitypresent := 0;
            if supplier = '-1' then

            begin
              for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
              begin
                if ((TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[0, Nowrow] = ProductCode) and
                  (TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[7, Nowrow] = owner)) then
                begin
                  quantitypresent := quantitypresent + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex])
                    .Cells[2, Nowrow]);
                end;
              end;
            end;

            { Rechercher dans le Sales grid pour la somme en valeur du caddy neuf }
            newvalue := 0;
            if supplier = '-1' then
            begin
              for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
              begin
                if (TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[7, Nowrow] = owner) then
                begin
                  if ((StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[7, Nowrow]) < 100000) and
                    (StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[8, Nowrow]) < 100000)) then
                    newvalue := newvalue + StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[4, Nowrow]);
                end;
              end;
            end;

            if (quantitypresent < 1) and (newvalue >= RemoteDB.CDSCoupons.FieldByName('coupon_amount').AsFloat) then
            begin
              { Ajouter d'une ligne dans le Sales grid }
              RemoteDB.Products.Locate('products_model', ProductCode, []);

              with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]) do
              begin
                Nowrow           := RowCount - 1;
                Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
                Cells[1, Nowrow] := EditSalesName.Text;
                // .Stockproduct_name.Value;
                Cells[2, Nowrow] := EditSalesQuantity.Text;
                Cells[3, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price').AsFloat, fffixed, 7, 2);
                if RemoteDB.Customerscustomers_htprice.AsString = 'False' then
                  Cells[4, Nowrow] := FloatToStrF(EditSalesPrice.Value, fffixed, 7, 2)
                else
                  Cells[4, Nowrow] := FloatToStrF(Round(RemoteDB.GetPriceTTC(RemoteDB.Productsproducts_model.Text, EditSalesPrice.Value) * 100) / 100,
                    fffixed, 7, 2);
                if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'False') then
                begin
                  Cells[5, Nowrow] := '0';
                  Cells[6, Nowrow] := VCLToOSCDate(Now);
                  Cells[7, Nowrow] := inttostr(ConnectedShop);
                  Cells[8, Nowrow] := '0';
                end else begin
                  Cells[5, Nowrow] := FloatToStrF(RemoteDB.netshop_stock.FieldByName('Product_Price_Gross').AsFloat, fffixed, 7, 2);
                  Cells[6, Nowrow] := EditSalesDateIn.Text;
                  Cells[7, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_owner_id').Text;
                  Cells[8, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text;
                end;
                RowCount := Nowrow + 2;
              end;

              { Reinitialisation de la barre de selection }
              RemoteDB.CDSCoupons.Edit;
              RemoteDB.CDSCoupons.FieldByName('coupon_active').AsString := 'N';
              RemoteDB.CDSCoupons.Post;
              SalesClearEdit;
              StringGridSalesEditingDone(nil);

            end else begin { quantit farfelue }
              messagedlg('Double utilisation ou valeur caddy insuffisante', mtwarning, [mbok], 0);
              if EditSalesQuantity.Visible then
                EditSalesQuantity.SetFocus;
            end

          end else begin { Pas de owner selectionn }
            messagedlg('Select owner', mtwarning, [mbok], 0);
            if ComboBoxSalesOwner.Visible then
              ComboBoxSalesOwner.SetFocus;
          end;
        end else begin { Product model non localis }
          messagedlg('Modle non valide', mtwarning, [mbok], 0);
          SalesClearEdit;
        end;

      end else begin
        messagedlg('Code article ou coupon invalide', mtwarning, [mbok], 0);
        SalesClearEdit;
      end;
    end;
  end;
end;

procedure TMainForm.EditSalesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);

var
  Nowrow, quantitypresent, i, GridIndex, indexnbr: Integer;
  TmpStr, owner, supplier, customer_nbr: string;
  ExitLib: TFormExitLibrary;
  Grid: TAdvStringGrid;

begin
  if Key = 13 then
    try

      for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
      begin
        if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
        begin
          GridIndex := i;
        end;
      end;

      for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
      begin
        if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 95 then
        begin
          indexnbr := i;
        end;
      end;

      with TEdit(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexnbr]) do
      begin
        if not RemoteDB.Customers.Locate('customers_nbr', Text, [locaseinsensitive]) then
          exit;
        customer_nbr := Text;
      end;

      TmpStr := inttostr(ConnectedShop) + '-';
      if Pos(TmpStr, ComboBoxSalesOwner.Text) = 1 then
      begin
        owner    := inttostr(ConnectedShop);
        supplier := RightStr(ComboBoxSalesOwner.Text, Length(ComboBoxSalesOwner.Text) - Length(TmpStr));
      end else begin;
        owner    := ComboBoxSalesOwner.Text;
        supplier := '-1';
      end;

      RemoteDB.netshop_stock.DisableControls;
      RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';

      RemoteDB.Products.DisableControls;
      RemoteDB.Products.IndexName := 'ProductsIXModel';

      EditSalesPrice.SelLength    := 0;
      EditSalesQuantity.SelLength := 0;
      EditSalesName.SelLength     := 0;

      if (RemoteDB.Products.Locate('products_model', EditSalesModel.Text, [locaseinsensitive])) then
      begin
        if RemoteDB.Products.FieldByName('products_esd').AsFloat = 1 then
        begin
          if StrtoInt(EditSalesQuantity.Text) <> 1 then
          begin
            messagedlg('Produits ESD maximum 1 par ligne', mtwarning, [mbok], 0);
            EditSalesQuantity.Text := '1';
          end;
        end;
        if (ComboBoxSalesOwner.ItemIndex <> -1) then
        begin
          { Rechercher dans le Sales grid pour la meme occurence owner id & product model }
          quantitypresent := 0;
          if supplier = '-1' then
          begin
            // Calculer quantity present pour check disponible

            for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
            begin
              if ((TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[0, Nowrow] = EditSalesModel.Text) and
                (TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[7, Nowrow] = owner)) then
              begin
                quantitypresent := quantitypresent + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex])
                  .Cells[2, Nowrow]);
              end;
            end;
            RemoteDB.netshop_stock.FindKey([EditSalesModel.Text, ComboBoxSalesOwner.Text]);
          end else begin // Supplier Occasion
            for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
            begin
              if ((TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[0, Nowrow] = EditSalesModel.Text) and
                (TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[7, Nowrow] = owner) and
                (TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[8, Nowrow] = supplier)) then
              begin
                quantitypresent := quantitypresent + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex])
                  .Cells[2, Nowrow]);
              end;
            end;
            RemoteDB.netshop_stock.FindKey([EditSalesModel.Text, owner, supplier]);
          end;

          if (StrtoInt(EditSalesQuantity.Text) <= (StrtoInt(EditSalesAvailable.Text) - quantitypresent)) then
          begin
            begin { Ajouter d'une ligne dans le Sales grid }
              RemoteDB.Products.Locate('products_model', EditSalesModel.Text, []);
              { Sortie Du Dacal }
              if ((self.Parameter['MiscCDLibUse'] = 'TRUE')) and
                (RemoteDB.Caroussel.Locate('model;customer_nbr;IsRoot', Vararrayof([RemoteDB.Products.FieldByName('products_model').AsString, StrtoInt(owner),
                True]), []) and (((StrtoInt(owner) < 100000) and (StrtoInt(supplier) >= 100000)) or ((StrtoInt(owner) >= 100000)))) then
              begin
                ExitLib := TFormExitLibrary.Create(self);
                ExitLib.Enter(owner, EditSalesModel.Text);
                ExitLib.Free;
              end;

              with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]) do
              begin
                Nowrow           := RowCount - 1;
                Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
                Cells[1, Nowrow] := EditSalesName.Text;
                // .Stockproduct_name.Value;
                Cells[2, Nowrow] := EditSalesQuantity.Text;
                Cells[3, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price').AsFloat, fffixed, 7, 2);
                if RemoteDB.Customerscustomers_htprice.AsString = 'False' then
                  Cells[4, Nowrow] := FloatToStrF(EditSalesPrice.Value, fffixed, 7, 2)
                else
                  Cells[4, Nowrow] := FloatToStrF(Round(RemoteDB.GetPriceTTC(RemoteDB.Productsproducts_model.Text, EditSalesPrice.Value) * 100) / 100,
                    fffixed, 7, 2);
                if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'False') then
                begin
                  Cells[5, Nowrow] := '0';
                  Cells[6, Nowrow] := VCLToOSCDate(Now);
                  Cells[7, Nowrow] := inttostr(ConnectedShop);
                  Cells[8, Nowrow] := '0';
                end else begin
                  Cells[5, Nowrow] := FloatToStrF(RemoteDB.netshop_stock.FieldByName('Product_Price_Gross').AsFloat, fffixed, 7, 2);
                  Cells[6, Nowrow] := EditSalesDateIn.Text;
                  Cells[7, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_owner_id').Text;
                  Cells[8, Nowrow] := RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text;
                end;
                RowCount := Nowrow + 2;
              end;

              { Sortie des rservations }
              RemoteDB.FilterAlertsNotBought;
              if RemoteDB.netshop_customers_alerts.Locate('customers_alerts_products_model;customers_alerts_customers_nbr',
                Vararrayof([RemoteDB.Productsproducts_model.Text, customer_nbr]), [locaseinsensitive]) then
              begin
               // Add reservation points
               if (RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger<100000) and
                   ( RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger<100000) and
                     (RemoteDB.Products.FieldByName('products_date_available').AsDateTime > Now-7) then
                      if Messagedlg('Ce produit tait rserv, accorder le bonus reservation de 50 points au client ?',mtconfirmation,[mbOk,mbNo],0)=mrOK then
                begin
                  RemoteDB.Customers.Locate('customers_nbr', customer_nbr, [locaseinsensitive]);
                  RemoteDB.Customers.Edit;
                  RemoteDB.Customers.FieldByName('customers_loyalty').AsInteger := RemoteDB.Customers.FieldByName('customers_loyalty').AsInteger + 50;
                  RemoteDB.Customers.Post;
                end;
                begin
                  RemoteDB.netshop_customers_alerts.Edit;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').AsInteger := 3;
                  RemoteDB.netshop_customers_alerts.Post;
                  with AdvAlertWindow.AlertMessages.Add do
                  begin
                    Text.Text := 'Produit en rservation.<br/><br/>Le statut est pass en rservation enleve';
                    AdvAlertWindow.Show;
                  end;
                end;
              end;

              { Reinitialisation de la barre de selection }
              SalesClearEdit;
              StringGridSalesEditingDone(nil);
            end
          end else begin { quantit farfelue }
            messagedlg('Unavailable quantity', mtwarning, [mbok], 0);
            if EditSalesQuantity.Visible then
              EditSalesQuantity.SetFocus;
          end

        end else begin { Pas de owner selectionn }
          messagedlg('Select owner', mtwarning, [mbok], 0);
          if ComboBoxSalesOwner.Visible then
            ComboBoxSalesOwner.SetFocus;
        end;
      end else begin { Product model non localis }
        messagedlg('Modle non valide', mtwarning, [mbok], 0);
        SalesClearEdit;
      end;
    finally
      RemoteDB.netshop_stock.EnableControls;
      RemoteDB.Products.EnableControls;
    end; { endif chr(13) }
end;

procedure TMainForm.ComboBoxSalesOwnerChange(Sender: TObject);
var
  TmpStr, owner, supplier: string;
  State: TKeyboardState;
begin
  RemoteDB.netshop_stock.DisableControls;
  try
    EditSalesAvailable.Text := '0';
    EditSalesReserved.Text  := inttostr(RemoteDB.GetReservedStock(EditSalesModel.Text));

    RemoteDB.Products.FindKey([EditSalesModel.Text]);
    if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'True') then
    begin

      TmpStr := inttostr(ConnectedShop) + '-';
      if Pos(TmpStr, ComboBoxSalesOwner.Text) = 1 then
      begin
        owner                            := inttostr(ConnectedShop);
        supplier                         := RightStr(ComboBoxSalesOwner.Text, Length(ComboBoxSalesOwner.Text) - Length(TmpStr));
        RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';
        RemoteDB.netshop_stock.SetKey;
        RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsString := supplier;
      end else begin
        owner                            := ComboBoxSalesOwner.Text;
        supplier                         := '-1';
        RemoteDB.netshop_stock.IndexName := 'StockIXModelOwner';
        RemoteDB.netshop_stock.SetKey;
      end;
      RemoteDB.netshop_stock.FieldByName('product_model').AsString := EditSalesModel.Text;
      RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString := owner;

      if RemoteDB.netshop_stock.GotoKey then
      begin
        // Mise  jour des quantits disponibles selon modle, owner, et prix de vente min
        // Prix
        if ComboBoxSalesOwner.Text = inttostr(ConnectedShop) then
        begin
          if RemoteDB.Customerscustomers_htprice.AsString = 'False' then
            EditSalesPrice.Value := RemoteDB.Products.FieldByName('Products_price_allin').AsFloat
          else
          begin
            // EditSalesPrice.Value:=RemoteDB.Products.Fieldbyname('Products_price').Value
            EditSalesPrice.Value := RemoteDB.GetWholeSalePrice(EditSalesModel.Text);
          end;
        end else begin
          EditSalesPrice.Value := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
        end;
        // Date In
        EditSalesDateIn.Text := RemoteDB.netshop_stock.FieldByName('product_date_in').AsString;
        if supplier <> '-1' then
        begin
          while ((RemoteDB.netshop_stock.FieldByName('product_model').Text = EditSalesModel.Text) and
            (RemoteDB.netshop_stock.FieldByName('product_owner_id').Text = owner) and (not RemoteDB.netshop_stock.Eof) and
            (RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text = supplier)) do
          begin
            EditSalesAvailable.Text := inttostr(StrtoInt(EditSalesAvailable.Text) + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger);
            RemoteDB.netshop_stock.Next;
          end;
        end else begin
          while ((RemoteDB.netshop_stock.FieldByName('product_model').Text = EditSalesModel.Text) and
            (RemoteDB.netshop_stock.FieldByName('product_owner_id').Text = owner) and (not RemoteDB.netshop_stock.Eof)) do
          begin
            if (RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger < 100000) then
            begin
              EditSalesAvailable.Text := inttostr(StrtoInt(EditSalesAvailable.Text) + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger);
            end;
            RemoteDB.netshop_stock.Next;
          end;
        end;
      end;
    end // end if stock_managed
    else
    begin
      EditSalesAvailable.Text := '99999';
      EditSalesPrice.Value    := RemoteDB.Products.FieldByName('products_price_allin').AsFloat;
    end;
  finally
    RemoteDB.netshop_stock.EnableControls;
  end;

end;

procedure TMainForm.NeditTransferQuantityKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
end; // End procedure

procedure TMainForm.BitBtnSalesProcessClick(Sender: TObject);
var
  AFormProcessSale: TFormProcessSale;
  i, CustomerIndex, GridIndex, LabelTotalIndex, Nowrow, Qloyalty, Qmax: Integer;
  total, loyaltyprice : Double;
begin
  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
    begin
      GridIndex := i;
    end;
  end;

    for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
      if TAdvTabSheet(MainForm.PageControlSalesCaddy.ActivePage).Controls[i].Tag = 97 then
    begin
      LabelTotalIndex := i;
    end;
    total := StrToFloat(TLabel(TAdvTabSheet(MainForm.PageControlSalesCaddy.ActivePage).Controls[LabelTotalIndex]).Caption)
  end;


  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 95 then
    begin
      CustomerIndex := i;
    end;
  end;

  with TEdit(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[CustomerIndex]) do
  begin
    if not RemoteDB.Customers.Locate('customers_nbr', Text, [locaseinsensitive]) then
      exit;
  end;

  //  check for customer loaylty
  if RemoteDB.customers.FieldByName('customers_nbr').AsInteger > 100000 then begin
    if (total>0) and (RemoteDB.customers.FieldByName('customers_loyalty').AsInteger >= LoyaltyThreshold)  then begin
      if messagedlg('Le client dispose d''assez de points de fidlit, veut-il les convertir en bon de rduction ?', mtwarning, [mbyes, mbno], 0) = mrYes then begin
        // Add the reward code the the grid
        if RemoteDB.Products.Locate('products_model','LOYALTY500',[TLocateOption.loCaseInsensitive]) then   begin


            // Remove loyaty if present

            for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
            begin
              if ((TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]).Cells[0, Nowrow] = 'LOYALTY500')) then begin
                with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]) do begin
                    if Nowrow < RowCount - 1 then
                    begin
                      for i := Nowrow to RowCount - 2 do
                        Rows[i].Assign(Rows[i + 1]);
                      Rows[RowCount - 1].Clear;
                      RowCount := RowCount - 1;
                    end;

                end;
              end;
            end;

          with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]) do
                    begin
                      loyaltyprice :=  (Round(RemoteDB.GetPriceTTC(RemoteDB.Products.FieldByName('products_model').Text, RemoteDB.Products.FieldByName('products_price').AsFloat ) * 100) / 100 );
                      QLoyalty := RemoteDB.customers.FieldByName('customers_loyalty').AsInteger div LoyaltyThreshold;
                      QMax := 0;
                      if total>0 then
                      QMax := Trunc(total) div Trunc(loyaltyprice) ;
                      Nowrow           := RowCount - 1;
                      Cells[0, Nowrow] := RemoteDB.Products.FieldByName('products_model').Text;
                      Cells[1, Nowrow] := RemoteDB.Products.FieldByName('products_intername').Text;
                      // .Stockproduct_name.Value;
                      Cells[2, Nowrow] := IntToStr(-Min(QLoyalty,Qmax));
                      Cells[3, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price').AsFloat, fffixed, 7, 2);
                      Cells[4, Nowrow] := FloatToStrF(Round(RemoteDB.GetPriceTTC(RemoteDB.Products.FieldByName('products_model').Text, RemoteDB.Products.FieldByName('products_price').AsFloat ) * 100) / 100,
                          fffixed, 7, 2);
                      if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'False') then
                      begin
                        Cells[5, Nowrow] := '0';
                        Cells[6, Nowrow] := VCLToOSCDate(Now);
                        Cells[7, Nowrow] := inttostr(ConnectedShop);
                        Cells[8, Nowrow] := '0';
                      end else begin
                        Cells[5, Nowrow] := FloatToStrF(RemoteDB.netshop_stock.FieldByName('Product_Price_Gross').AsFloat, fffixed, 7, 2);
                        Cells[6, Nowrow] := VCLToOSCDate(Now);
                        Cells[7, Nowrow] := IntToStr(ConnectedShop);
                        Cells[8, Nowrow] := IntToStr(ConnectedShop);
                      end;
                      RowCount := Nowrow + 2;
                    end;
        end else begin
          ShowMessage('Produit fidlit non trouv');
        end;
      end;

    end;

  end;



  with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[GridIndex]) do
  begin
    if RowCount <= 2 then
      exit;
  end;

  RemoteDB.IsUpdating := True;
  AFormProcessSale    := TFormProcessSale.Create(self);
  try
    StringGridSalesEditingDone(nil);

    if AFormProcessSale.ShowModal = mrOK then
    begin
      BitBtnSalesClearClick(BitBtnSalesProcess);
      Self.TryApplyChangesToDB();
    end
    else
      messagedlg('Vente Annule', mtwarning, [mbok], 0);
  finally
    RemoteDB.IsUpdating := False;
    AFormProcessSale.Free;
  end;
end;

procedure TMainForm.TryApplyChangesToDB();
begin
        if TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType = sitGreen then
      begin;
        if self.Parameter['SyncAutoUpdate'] = 'TRUE' then
          RemoteDB.ProgressUpdate.Execute();
      end
end;

procedure TMainForm.BitBtnSalesReserveClick(Sender: TObject);
var
  i, Index, indexnbr, GridIndex, Nowrow: Integer;
  CustNbr: string;
  SHValue: Double;
  aLabelAddress: TLabelAddress;
  Address: Tstrings;
begin
  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
    begin
      index := i;
    end;
  end;

  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 95 then
    begin
      indexnbr := i;
    end;
  end;

  CustNbr := TEdit(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexnbr]).Text;

  if not RemoteDB.Customers.Locate('customers_nbr', CustNbr, [locaseinsensitive]) then
  begin
    ShowMessage('Client non trouv');
    exit;
  end;

  if RemoteDB.Customers.FieldByName('customers_nbr').AsInteger < 100000 then
  begin
    ShowMessage('Client non valide : impossible de rserver sur les comptes magasins');
    exit;
  end;

  with TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]) do
  begin
    if RowCount <= 2 then
      exit;
  end;

  RemoteDB.IsUpdating := True;
  try
    StringGridSalesEditingDone(nil);
    for i := 0 to TAdvTabSheet(MainForm.PageControlSalesCaddy.ActivePage).ControlCount - 1 do
    begin
      if TAdvTabSheet(MainForm.PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
      begin
        GridIndex := i;
      end;
    end;
    with TAdvStringGrid(TAdvTabSheet(MainForm.PageControlSalesCaddy.ActivePage).Controls[GridIndex]) do
      for Nowrow := 1 to RowCount - 2 do
      begin
        RemoteDB.netshop_customers_alerts.Append;
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsInteger := RemoteDB.Customers.FieldByName('customers_nbr').AsInteger;
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := Cells[0, Nowrow];
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString := Cells[1, Nowrow];
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := '';
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date').AsFloat := Now;
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsString := Cells[2, Nowrow];
        if ((StrtoInt(Cells[7, Nowrow]) >= 100000) or (StrtoInt(Cells[8, Nowrow]) >= 100000)) then
        begin
          SHValue := StrToFloat(Cells[4, Nowrow]);
          if frac(SHValue) > 0 then
            SHValue := trunc(SHValue) + 1
          else
            SHValue := trunc(SHValue);
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').AsInteger := trunc(SHValue);
        end
        else
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').AsString := '0';
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').AsInteger := 2;
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date_notified').AsFloat := Now;
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_attempts').AsInteger := 0;
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_message').AsString := '';
        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_comment').AsString := '';
        RemoteDB.netshop_customers_alerts.Post;
      end;

    //
    // Print Sticker
    //
    aLabelAddress := TLabelAddress.Create;
    Address       := TStringList.Create;
    try
      aLabelAddress.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
      Address.Add('Client # ' + RemoteDB.CustomersCustomers_nbr.AsString);
      Address.Add(RemoteDB.Customerscustomers_firstname.AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
      Address.Add(RemoteDB.Products.FieldByName('products_intername').Text + ' ' + RemoteDB.Products.FieldByName('products_root_category_name').AsString);
      Address.Add('SMS: ' + DateToStr(Now));
      for i := 1 to RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger do
        aLabelAddress.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
    finally
      aLabelAddress.Free;
      Address.Free;
    end;

    BitBtnSalesClearClick(BitBtnSalesProcess)

  finally
    RemoteDB.IsUpdating := False;
  end;
end;

procedure TMainForm.BitBtnStockinClearClickClick(Sender: TObject);
begin
  RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);
  EditStockinCustomerNbr.Text := inttostr(ConnectedShop);
  PageControlStockinCaddy.ActivePage.Free;
  if PageControlStockinCaddy.PageCount = 0 then
    SBNewStockinCaddyClick(self);
  StockinClearEdit;
end;

procedure TMainForm.BitBtnStockinProcessClickClick(Sender: TObject);
var
  i, j, GridIndex, Nowrow, QuantitySum: Integer;
  NbrData, StockinType, AlertMessage, SmsId, SmsFrom, SmsResult: string;
  TicketToPrint: TTicketJob;
  Incoherent, PurchaseValid, signed: Boolean;
  AmountSum, CaddyValue: currency;
  Labelstoprint: Tlabeljob;
  usbDevices : IUsbDevices;
  usbDevice  : IUsbDevice;
  FormSign : TFormSign;

label StockinProcessEnd;
begin
  BitBtnStockinProcessClick.Enabled := False;

  PageControlStockinCaddy.Enabled := False;
  try
  if PageControlStockinCaddy.ActivePage = nil then
  begin
    ShowMessage('Veuillez crer un caddy');
    goto StockinProcessEnd;
  end;

  // Rcupration des Donnes du PageControl
  for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
    begin
      // Index de la grille
      GridIndex := i;
    end;
  end;

  if TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]).RowCount <= 1 then
  begin
    ShowMessage('Caddy vide');
    goto StockinProcessEnd;
  end;

  for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 95 then
    begin
      // Index du premier champs (Nom fourn / ou Num Client)
      NbrData := TEdit(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i]).Text;
    end;
  end;

  for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 10 then
    begin
      // Index du type de transaction
      StockinType := TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i]).Caption;
    end;
  end;

  ProgressBar.Visible       := True;
  ProgressBar.Position      := (1 / (7) * 100);
  StatusLine.Panels[3].Text := 'Initialisation';
  Application.ProcessMessages;

  // Pour les envois Sms ne pas bouger;
  RemoteDB.Shops.FindKey([ConnectedShop]);

  // Envoi des Alertes
  with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
  begin
    ProgressBar.Position      := (2 / (7) * 100);
    StatusLine.Panels[3].Text := 'MAJ Statut rservations';
    Application.ProcessMessages;
    for Nowrow := 1 to RowCount - 2 do
    begin
      self.ProcessAlert(Cells[0, Nowrow], Cells[4, Nowrow], Cells[7, Nowrow], Cells[8, Nowrow], Cells[2, Nowrow]);
    end; // for rows loop
  end; // End Alerts

  if StockinType = 'Neuf' then
  begin
    // Vrifications Pralables
    if not RemoteDB.netshop_suppliers.Locate('suppliers_name', NbrData, [locaseinsensitive]) then
    begin
      ShowMessage('Fournisseur Non Trouv');
      goto StockinProcessEnd;
    end;
    if not RemoteDB.Customers.Locate('Customers_nbr', ConnectedShop, []) then
    begin
      ShowMessage('Compte magasin non trouv');
      goto StockinProcessEnd;
    end;

    // Produits  sortir des previews + Ractivation
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (3 / (7) * 100);
      StatusLine.Panels[3].Text := 'Mise  jour des previews';
      Application.ProcessMessages;
      for Nowrow := 1 to RowCount - 2 do
      begin
        if RemoteDB.Products.FindKey([Cells[0, Nowrow]]) then
        begin
          if (RemoteDB.Products.FieldByName('products_ispreview').AsString = 'True') and (UserLevel <> 0) then
          begin
            RemoteDB.Products.Edit;
            RemoteDB.Products.FieldByName('products_ispreview').AsString := 'False';
            RemoteDB.Products.FieldByName('products_date_added').AsDateTime := trunc(Now);
            RemoteDB.Products.Post;
          end;
          if RemoteDB.Products.FieldByName('products_status').AsInteger = 0 then
          begin
            RemoteDB.Products.Edit;
            RemoteDB.Products.FieldByName('products_status').AsInteger := 0;
            RemoteDB.Products.Post;
          end;
        end
        else
          ShowMessage('Produit non trouv : ' + Cells[0, Nowrow]);
      end;
    end;

    // Entre en Stock
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (4 / (7) * 100);
      StatusLine.Panels[3].Text := 'Entre en stock';
      Application.ProcessMessages;
      for Nowrow := 1 to RowCount - 2 do
      begin
        RemoteDB.netshop_stock.Append;
        RemoteDB.netshop_stock.FieldByName('product_model').Text := Cells[0, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_name').Text := Cells[1, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_owner_id').Text := Cells[7, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_location').AsInteger := ConnectedShop;
        RemoteDB.netshop_stock.FieldByName('product_quantity').Text := Cells[2, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text := Cells[8, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_date_in').Text := Formatdatetime('yyyymmdd', Now);
        RemoteDB.netshop_stock.FieldByName('product_price_gross').Text := Cells[5, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_price_stock').Text := Cells[4, Nowrow];
        RemoteDB.netshop_stock.Post;
      end;
    end; // End Entre en Stock

    // Impressions & Verification Prix
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (5 / (7) * 100);
      StatusLine.Panels[3].Text := 'Impression reu';
      Application.ProcessMessages;
      if (self.Parameter['PrintersTicketEnabled'] = 'TRUE') and (self.Parameter['MiscPrintStockIn'] = 'TRUE') then
      begin
        TicketToPrint := TTicketJob.Create(nil);
        try
          TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
          TicketToPrint.Logo     := PrintLogo;
          TicketToPrint.URL      := WEBURL;
          if ShopdataList <> nil then begin
            TicketToPrint.ShopData := ShopdataList;
            end else begin
              ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
          end;
          if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
            TicketToPrint.Model := TmContinuous;
          TicketToPrint.AddBox('Etat entre', True, bsProd);
          for Nowrow := 1 to RowCount - 2 do
          begin
            TicketToPrint.AddLine(Cells[2, Nowrow], Cells[5, Nowrow], Cells[1, Nowrow], 'Etat entre');
          end;
          TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
          TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);
          if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
            TicketToPrint.PrintOpos
          else
            TicketToPrint.Print;
        finally
          TicketToPrint.Free;
        end;
      end;

      for Nowrow := 1 to RowCount - 2 do
      begin
        try
          if StrToFloat(Cells[5, Nowrow]) > (StrToFloat(Cells[3, Nowrow]) * 1.1) then
          begin
            with AdvAlertWindow.AlertMessages.Add do
            begin
              Text.Text := 'Le produit ' + Cells[1, Nowrow] + ' (' + Cells[0, Nowrow] + ') est vendu  perte ou prix achat incorrect';
              AdvAlertWindow.Show;
              MemoLog.Lines.Add(Text.Text);
            end;
          end;
        except
          MemoLog.Lines.Add('Erreur lors de la vrification des prix entre');
        end;
      end;
      //
      // Impression Etiquettes
      //
      for Nowrow := 1 to RowCount - 2 do
      begin
        PrintPriceTag(Cells[2, Nowrow], Cells[1, Nowrow], Cells[4, Nowrow], Cells[7, Nowrow], Cells[8, Nowrow]);
      end;

    end; // End Impression Reu
    // Fermeture Caddy
    with PageControlStockinCaddy.ActivePage do
    begin
      ProgressBar.Position      := (6 / (7) * 100);
      StatusLine.Panels[3].Text := 'Fermeture caddy';
      Application.ProcessMessages;
      Free;
    end; // End Fermeture Caddy
  end;

  if StockinType = 'Achat' then
  begin
    if not RemoteDB.Customers.Locate('Customers_Nbr', NbrData, [locaseinsensitive]) then
    begin
      ShowMessage('Client Non Trouv');
      goto StockinProcessEnd;
    end;
    if not RemoteDB.CustomersCustomers_nbr.AsInteger >= 100000 then
    begin
      ShowMessage('Client non valide');
      goto StockinProcessEnd;
    end;

    // Vrification Cohrence  + Ractivation
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (3 / (7) * 100);
      StatusLine.Panels[3].Text := 'Vrification Cohrence';
      Application.ProcessMessages;
      Incoherent := False;
      for Nowrow := 1 to RowCount - 2 do
      begin
        if Cells[8, Nowrow] <> RemoteDB.CustomersCustomers_nbr.AsString then
          Incoherent := True;
        if Cells[7, Nowrow] <> inttostr(ConnectedShop) then
          Incoherent := True;
        if RemoteDB.Products.FindKey([Cells[0, Nowrow]]) then
        begin
          if RemoteDB.Products.FieldByName('products_status').AsInteger = 0 then
          begin
            RemoteDB.Products.Edit;
            RemoteDB.Products.FieldByName('products_status').AsInteger := 1;
            RemoteDB.Products.Post;
          end;
        end
        else
          ShowMessage('Produit non trouv : ' + Cells[0, Nowrow]);
      end;
      if Incoherent then
      begin
        ShowMessage('Donnes incohrentes : client caddy <> client produits');
        goto StockinProcessEnd;
      end;
    end; // End Vrification Cohrence

    // Produits  sortir des previews + Ractivation
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (3 / (7) * 100);
      StatusLine.Panels[3].Text := 'Mise  jour des previews';
      Application.ProcessMessages;
      for Nowrow := 1 to RowCount - 2 do
      begin
      end;
    end;

    // Calcul fidlit achat
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (3 / (7) * 100);
      StatusLine.Panels[3].Text := 'Calcul fidlit';
      Application.ProcessMessages;
      CaddyValue := 0;
      for Nowrow := 1 to RowCount - 2 do
      begin
        CaddyValue := CaddyValue + (strtofloat(Cells[5, nowrow]) * strtofloat(Cells[2, nowrow]));
      end;
      RemoteDB.customers.Edit;
      RemoteDB.customers.FieldByName('customers_loyalty').AsInteger := RemoteDB.customers.FieldByName('customers_loyalty').AsInteger
       + (Trunc(CaddyValue) Div 5) *10;
      RemoteDB.customers.Post;
    end;

    // Impression signature
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (4 / (7) * 100);
      StatusLine.Panels[3].Text := 'Signature';
      Application.ProcessMessages;
      PurchaseValid:=False;
      Signed:=False;
      if (Mainform.Parameter['MiscSIGNPADUse'] = 'TRUE') then begin
          /// Utiisation du signpad
          usbDevices := CoUsbDevices.Create();
          if (usbDevices.Count > 0) then
          begin
            FormSign := TFormSign.Create(self);
            try
            try
              begin
                AmountSum  := 0;
                QuantitySum := 0;
                if RowCount > 5 then begin
                  for Nowrow := 1 to RowCount - 2 do
                  begin
                    QuantitySum := QuantitySum + StrtoInt(Cells[2, Nowrow]);
                    AmountSum := AmountSum + StrToFloat(Cells[5, Nowrow]) * StrtoInt(Cells[2, Nowrow]);
                  end;
                  end else begin
                   for Nowrow := 1 to RowCount - 2 do
                  begin
                    FormSign.TextLines.Add(Cells[2, Nowrow] + ' ' + Cells[1, Nowrow] + ' ' +  Cells[5, Nowrow] + ' EUR');
                    QuantitySum := QuantitySum + StrtoInt(Cells[2, Nowrow]);
                    AmountSum := AmountSum + StrToFloat(Cells[5, Nowrow]) * StrtoInt(Cells[2, Nowrow]);
                  end;
                end;

                usbDevice := usbDevices.Item[0]; //select the first device
                // loop the products
                FormSign.TextLines.Add('Rachat : '+ FloatToStr(AmountSum));
                FormSign.TextLines.Add('Client # : ' + RemoteDB.CustomersCustomers_nbr.Text);
                FormSign.TextLines.Add('Nom : ' + RemoteDB.CustomersCustomers_firstname.Text);
                FormSign.TextLines.Add('Nombre de jeux : ' + IntToStr(QuantitySum));
                FormSign.connect(usbDevice);
                FormSign.ShowModal();
              end;
            except
              on e : Exception do
                ShowMessage(e.Message);
            end;
            if FormSign.ModalResult=mrOK then begin
              PurchaseValid:=True;
              Signed:=True;
            end;

            finally
              FormSign.Free;
            end;
          end
          else
          begin
            ShowMessage('Pad de signature non connect');
          end;
      end else begin
          ///
          /// IMPRESSION DU RECU
          ///
          if (self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
          begin
            TicketToPrint := TTicketJob.Create(self);
            try
              TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
              TicketToPrint.Logo     := PrintLogo;
              TicketToPrint.URL      := WEBURL;
              if ShopdataList <> nil then begin
                TicketToPrint.ShopData := ShopdataList;
              end else begin
                ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
              end;
              if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
                TicketToPrint.Model := TmContinuous;
              TicketToPrint.AddBox('Achat', True, bsProd);
              for Nowrow := 1 to RowCount - 2 do
              begin
                TicketToPrint.AddLine(Cells[2, Nowrow], Cells[5, Nowrow], Cells[1, Nowrow], 'Achat');
              end;
              TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
              TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);

              if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
                TicketToPrint.PrintOpos
              else
                TicketToPrint.Print;

              PurchaseValid:=True;
            finally
              TicketToPrint.Free;
            end;
          end;
      end;
    end; // End Impressions signature


   if PurchaseValid then  begin
      // Entre en Stock
      with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
      begin
        ProgressBar.Position      := (5 / (7) * 100);
        StatusLine.Panels[3].Text := 'Entre en stock';
        Application.ProcessMessages;
        ///
        /// Entre en Stock
        ///
        AmountSum  := 0;
        for Nowrow := 1 to RowCount - 2 do
        begin
          RemoteDB.netshop_stock.Append;
          RemoteDB.netshop_stock.FieldByName('product_model').Text := Cells[0, Nowrow];
          RemoteDB.netshop_stock.FieldByName('product_name').Text := Cells[1, Nowrow];
          RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger := ConnectedShop;
          RemoteDB.netshop_stock.FieldByName('product_location').Text := inttostr(ConnectedShop);
          RemoteDB.netshop_stock.FieldByName('product_quantity').Text := Cells[2, Nowrow];
          RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsString := Cells[8, Nowrow];
          RemoteDB.netshop_stock.FieldByName('product_date_in').Text := Formatdatetime('yyyymmdd', Now);
          RemoteDB.netshop_stock.FieldByName('product_price_gross').Text := Cells[5, Nowrow];
          RemoteDB.netshop_stock.FieldByName('product_price_stock').Text := Cells[4, Nowrow];
          RemoteDB.netshop_stock.Post;
          AmountSum := AmountSum + StrToFloat(Cells[5, Nowrow]) * StrtoInt(Cells[2, Nowrow]);
        end;

        ///
        /// Ajour du refund
        ///
        RemoteDB.netshop_refunds.Append;
        RemoteDB.netshop_refunds.FieldByName('refunds_customer_nbr').AsInteger := RemoteDB.Customers.FieldByName('customers_nbr').AsInteger;
        RemoteDB.netshop_refunds.FieldByName('refunds_amount').AsFloat := AmountSum;
        RemoteDB.netshop_refunds.FieldByName('refunds_nature').AsString := 'Achat';
        if Signed then RemoteDB.StoreSignBlob('signature.jpg','refunds');
        RemoteDB.netshop_refunds.Post;

      end; // End Entre en Stock


      // Impressions
      with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
      begin
        ProgressBar.Position      := (6 / (7) * 100);
        StatusLine.Panels[3].Text := 'Impression labels';
        Application.ProcessMessages;
        /// /
        /// / Impression Labels
        /// /
        for Nowrow := 1 to RowCount - 2 do
        begin
          PrintPriceTag(Cells[2, Nowrow], Cells[1, Nowrow], Cells[4, Nowrow], Cells[7, Nowrow], Cells[8, Nowrow]);
        end;

      end; // End Impressions

      // Fermeture Caddy
      with PageControlStockinCaddy.ActivePage do
      begin
        ProgressBar.Position      := (7 / (7) * 100);
        StatusLine.Panels[3].Text := 'Fermeture caddy';
        Application.ProcessMessages;
        Free;
      end; // End Fermeture Caddy
    end;
  end;

  if StockinType = 'Dpt' then
  begin
    if not RemoteDB.Customers.Locate('Customers_Nbr', NbrData, [locaseinsensitive]) then
    begin
      ShowMessage('Client Non Trouv');
      goto StockinProcessEnd;
    end;

    // Vrification Cohrence et re-activation
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (3 / (7) * 100);
      StatusLine.Panels[3].Text := 'Vrification Cohrence';
      Application.ProcessMessages;
      Incoherent := False;
      for Nowrow := 1 to RowCount - 2 do
      begin
        if Cells[7, Nowrow] <> RemoteDB.Customers.FieldByName('customers_nbr').AsString then
          Incoherent := True;
        if RemoteDB.Products.FindKey([Cells[0, Nowrow]]) then
        begin
          if RemoteDB.Products.FieldByName('products_status').AsInteger = 0 then
          begin
            RemoteDB.Products.Edit;
            RemoteDB.Products.FieldByName('products_status').AsInteger := 1;
            RemoteDB.Products.Post;
          end;
        end
        else
          ShowMessage('Produit non trouv : ' + Cells[0, Nowrow]);
      end;
      if Incoherent then
      begin
        ShowMessage('Donnes incohrentes : client caddy <> client produits');
        goto StockinProcessEnd;
      end;
    end; // End Vrification Cohrence

    // Todo dplacer vers ventes
    // Calcul fidlit dpt
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (3 / (7) * 100);
      StatusLine.Panels[3].Text := 'Calcul fidlit';
      Application.ProcessMessages;
      CaddyValue := 0;
      for Nowrow := 1 to RowCount - 2 do
      begin
        CaddyValue := CaddyValue + (strtofloat(Cells[4, nowrow]) * strtofloat(Cells[2, nowrow]));
      end;
      RemoteDB.customers.Edit;
      RemoteDB.customers.FieldByName('customers_loyalty').AsInteger := RemoteDB.customers.FieldByName('customers_loyalty').AsInteger
       + (Trunc(CaddyValue) Div 5) * 2;
      RemoteDB.customers.Post;
    end;

    // Entre en Stock
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (4 / (7) * 100);
      StatusLine.Panels[3].Text := 'Entre en stock';
      Application.ProcessMessages;
      for Nowrow := 1 to RowCount - 2 do
      begin
        RemoteDB.netshop_stock.Append;
        RemoteDB.netshop_stock.FieldByName('product_model').Text := Cells[0, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_name').Text := Cells[1, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString := Cells[7, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_location').Text := inttostr(ConnectedShop);
        RemoteDB.netshop_stock.FieldByName('product_quantity').Text := Cells[2, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_supplier_id').Text := '0';
        RemoteDB.netshop_stock.FieldByName('product_date_in').Text := Formatdatetime('yyyymmdd', Now);
        RemoteDB.netshop_stock.FieldByName('product_price_gross').Text := Cells[5, Nowrow];
        RemoteDB.netshop_stock.FieldByName('product_price_stock').Text := Cells[4, Nowrow];
        RemoteDB.netshop_stock.Post;
      end;
    end; // End Entre en Stock

    // Impressions
    with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
    begin
      ProgressBar.Position      := (5 / (7) * 100);
      StatusLine.Panels[3].Text := 'Impression reu';
      Application.ProcessMessages;
      // Tickets
      if (self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
      begin
        TicketToPrint := TTicketJob.Create(self);
        try
          TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
          TicketToPrint.Logo     := PrintLogo;
          TicketToPrint.URL      := WEBURL;
          if ShopdataList <> nil then begin
            TicketToPrint.ShopData := ShopdataList;
            end else begin
              ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
          end;
          if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
            TicketToPrint.Model := TmContinuous;
          TicketToPrint.AddBox('Dpt', True, bsProd);
          for Nowrow := 1 to RowCount - 2 do
          begin
            TicketToPrint.AddLine(Cells[2, Nowrow], Cells[4, Nowrow], Cells[1, Nowrow], 'Dpt');
          end;
          TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
          TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);

          TicketToPrint.Comment := DepositComment;
          if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
            TicketToPrint.PrintOpos
          else
            TicketToPrint.Print;
        finally
          TicketToPrint.Free;
        end;
      end
      else
        messagedlg('Imprimante  tickets non active', mtwarning, [mbok], 0);
      ProgressBar.Position      := (6 / (7) * 100);
      StatusLine.Panels[3].Text := 'Impression tiquettes';
      Application.ProcessMessages;
      // Labels
      for Nowrow := 1 to RowCount - 2 do
      begin
        PrintPriceTag(Cells[2, Nowrow], Cells[1, Nowrow], Cells[4, Nowrow], Cells[7, Nowrow], Cells[8, Nowrow]);
      end;
    end; // End Impressions

    // Fermeture Caddy
    with PageControlStockinCaddy.ActivePage do
    begin
      ProgressBar.Position      := (6 / (7) * 100);
      StatusLine.Panels[3].Text := 'Fermeture caddy';
      Application.ProcessMessages;
      Free;
    end; // End Fermeture Caddy

  end;

  ProgressBar.Position      := (7 / (7) * 100);
  StatusLine.Panels[3].Text := 'Finalisation';
  Application.ProcessMessages;

  StockinProcessEnd:

  finally

    BitBtnStockinProcessClick.Enabled := True;
    PageControlStockinCaddy.Enabled   := True;
    ProgressBar.Visible               := False;
    StatusLine.Panels[3].Text         := '';

    TryApplyChangesToDB();
  end;

end;

procedure TMainForm.BitBtnSalesClearClick(Sender: TObject);
begin
  RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);
  EditSalesCustomerNbr.Text := inttostr(ConnectedShop);
  PageControlSalesCaddy.ActivePage.Free;
  if PageControlSalesCaddy.PageCount = 0 then
    SBNewSalesCaddyClick(self);
  SalesClearEdit;
end;

procedure TMainForm.SalesClearSummary;
var
  i, Index, indexcount, indexht, indexttc: Integer;
begin
  // Count
  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 99 then
    begin
      TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i]).Caption := '0';
    end;
  end;
  // HT
  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 98 then
    begin
      TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i]).Caption := FloatToStrF(0, fffixed, 7, 2);;
    end;
  end;
  // TTC
  for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
  begin
    if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 97 then
    begin
      TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i]).Caption := FloatToStrF(0, fffixed, 7, 2);;
    end;
  end;
end;

procedure TMainForm.Sauver1Click(Sender: TObject);
var
  i, Index: Integer;
  aSaveDialog: TsaveDialog;
  FileName, FileExt: string;
begin

  if PageControlMainForm.ActivePage = TabsheetSales then
  begin
    FileName := 'CaddyVentes.csv';
    FileExt  := '.csv';
  end;

  if PageControlMainForm.ActivePage = TabSheetStockin then
  begin
    FileName := 'CaddyEntreeStock.csv';
    FileExt  := '.csv';

  end;

  if PageControlMainForm.ActivePage = TabSheetTransfer then
  begin
    FileName := 'TransferTable.csv';
    FileExt  := '.csv';
  end;
end;

procedure TMainForm.SalesClearEdit;
begin
  EditSalesName.Clear;
  EditSalesModel.Clear;
  EditSalesDateIn.Clear;
  EditSalesQuantity.Text  := '0';
  EditSalesPrice.Value    := 0;
  EditSalesAvailable.Text := '0';
  ComboBoxSalesOwner.Clear;
  ComboBoxSalesOwner.ItemIndex := -1;
  ComboBoxSalesOwner.Text      := 'Select owner';
  EditSalesModel.SetFocus;
end;

procedure TMainForm.RentClearEdit;
begin
  EditRentName.Clear;
  EditRentModel.Clear;
  EditRentDateIn.Clear;
  EditRentPrice.Text     := '0.00';
  EditRentAvailable.Text := '0';
  EditRentModel.SetFocus;
end;





procedure TMainForm.SButtonproductimagerotateClick(Sender: TObject);
begin
  TmpBmp.Width  := 0;
  TmpBmp.Height := 0;
  TmpBmp.Width  := ProductImage.Width;
  TmpBmp.Height := ProductImage.Height;
  Janfx.Turn(ProductImage, TmpBmp);
  ProductImage.Assign(TmpBmp);
  ThumbImg.Picture.Assign(ProductImage);
end;

procedure TMainForm.SButtonProductImageOpenClick(Sender: TObject);
var
  LoadPicture: Tpicture;
  BackGround: Longint;
begin
  if RemoteDB.Products.FieldByName('products_model').AsString = '' then
  begin
    messagedlg('Modle du produit non valide', mtwarning, [mbok], 0);
    exit;
  end;

  if OpenPictureDialog.Execute then
  begin
    LoadPicture := Tpicture.Create;
    try
      LoadPicture.LoadfromFile(OpenPictureDialog.FileName);
      ProductImage.Assign(LoadPicture.Graphic);
    finally
      LoadPicture.Free;
    end;
    IdentToColor(MainForm.Parameter['ImageBackColor'], BackGround);

    if ((MainForm.Parameter['ImageResize'] = 'TRUE')) then
    begin
      Janfx.SquareFrame(ProductImage, BackGround, 120);
    end;

    ThumbImg.Picture.Assign(ProductImage);

    RemoteDB.Products.Edit;
    RemoteDB.Products.FieldByName('products_image').AsString := 'products/' + RemoteDB.Products.FieldByName('Products_model').AsString + '.' +
      ansiuppercase(self.Parameter['ImageFileType']);
    RemoteDB.Products.Post

  end;
end;

procedure TMainForm.SButtonProductImageScanClick(Sender: TObject);
var
  flag: Boolean;
  BackGround: Longint;
  s: string;
  AcquireImg: TAcquireImage;
begin
  if RemoteDB.Products.FieldByName('products_model').AsString = '' then
  begin
    messagedlg('Modle du produit non valide', mtwarning, [mbok], 0);
    exit;
  end;

  AcquireImg := TAcquireImage.Create(self);
  try
    flag := False;
    if AcquireImg.loadTwainModule then
    begin
      try
        AcquireImg.openSourceManager;
        s := AcquireImg.GetSource(False);
        AcquireImg.selectSource(s);
        AcquireImg.openSource;
        AcquireImg.acquirebmp(ProductImage);
        flag := True;
      finally
        AcquireImg.closeTwainSession;
        AcquireImg.unloadTwainModule;
      end;
    end
    else
      ShowMessage('Erreur TWAIN');

    if flag then
    begin
      IdentToColor(MainForm.Parameter['ImageBackColor'], BackGround);

      if ((MainForm.Parameter['ImageResize'] = 'TRUE')) then
      begin
        Janfx.SquareFrame(ProductImage, BackGround, 120);
      end;
      RemoteDB.Products.Edit;
      RemoteDB.Products.FieldByName('products_image').AsString := 'products/' + RemoteDB.Products.FieldByName('Products_model').AsString + '.' +
        ansiuppercase(self.Parameter['ImageFileType']);
      RemoteDB.Products.Post;
      ThumbImg.Picture.Bitmap := ProductImage;
    end;
  finally
    AcquireImg.Free;
  end;
end;

procedure TMainForm.SbuttonProductImageSaveClick(Sender: TObject);
begin
  ImageUpSave(False);
end;

procedure TMainForm.SbuttonProductPictureUploadClick(Sender: TObject);
begin;
  ImageUpSave(True);
end;

procedure TMainForm.Image5Click(Sender: TObject);
var
  ITempIndex, STempIndex, ExpensesDesc: string;
  i: Integer;
  UpdateStatus: Boolean;
  DayCashierSummary: TDayCashierSummary;
  Labelstoprint: TLabelAddress;
  Address: Tstrings;
begin

  Screen.Cursor := crHourglass;
  Application.ProcessMessages;
  RemoteDB.SetItemstoSales;

  try
    UpdateStatus := RemoteDB.IsUpdating;
    if not RemoteDB.IsUpdating then
      RemoteDB.IsUpdating := True;

    for i := trunc(MonthCalendarAdminSales.Date) to trunc(MonthCalendarAdminSalesEnd.Date) do
    begin
      DayCashierSummary := RemoteDB.CalcDayCahsierSummary(i, i);
      if DayCashierSummary.Open then
      begin
        if (MainForm.Parameter['PrintersLabelEnabled'] = 'TRUE') then
        begin
          Labelstoprint := TLabelAddress.Create;
          Address       := TStringList.Create;
          try
            Address.Add(DateToStr(i));
            Address.Add('Neuf : ' + FloatToStr(DayCashierSummary.New + DayCashierSummary.NoMargin));
            Address.Add('Occasion : ' + FloatToStr(DayCashierSummary.SH));
            Address.Add('Retours : ' + FloatToStr(DayCashierSummary.Returns));
            Address.Add('Bons : ' + FloatToStr(DayCashierSummary.Voucher));
            Address.Add('Rembours : ' + FloatToStr(DayCashierSummary.Refunds));
            Labelstoprint.LabelPrinter := (MainForm.Parameter['PrintersLabelPrinter']);
            Labelstoprint.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
          finally
            Labelstoprint.Free;
            Address.Free;
          end;
        end
        else
          messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
        Application.ProcessMessages;
      end;
    end;
  finally
    Screen.Cursor       := crDefault;
    RemoteDB.IsUpdating := UpdateStatus;

  end;

end;

procedure TMainForm.ImageUpSave(Upload: Boolean);
var
  SavePng: TpngImage;
  SaveJPG: TJpegImage;
  SrcFile, DestFile: WideString;

begin
  if RemoteDB.Products.FieldByName('products_model').AsString = '' then
  begin
    messagedlg('Modle du produit non valide', mtwarning, [mbok], 0);
    exit;
  end;

  if ThumbImg.Picture.Bitmap.Empty then
  begin
    messagedlg('Image non valide', mtwarning, [mbok], 0);
    exit;
  end;

  if RemoteDB.Products.State <> dsBrowse then
    RemoteDB.Products.Post;

  if self.Parameter['ImageFileType'] = 'JPG' then
  begin
    SaveJPG := TJpegImage.Create;
    try
      SaveJPG.CompressionQuality := 80;
      SaveJPG.Transparent        := True;
      SaveJPG.Assign(ProductImage);
      SaveJPG.Compress;
      SaveJPG.SaveToFile(ExtractFilePath(ParamStr(0)) + '/images/' + RemoteDB.Products.FieldByName('products_image').AsString);
    finally
      SaveJPG.Free;
    end;
  end;

  if self.Parameter['ImageFileType'] = 'PNG' then
  begin
    SavePng := TpngImage.Create;
    try
      SavePng.CompressionLevel := 9;
      SavePng.Transparent      := True;
      SavePng.TransparentColor := clWhite;
      SavePng.Assign(ProductImage);
      SavePng.SaveToFile((ExtractFilePath(ParamStr(0))) + '/images/' + RemoteDB.Products.FieldByName('products_image').AsString);
    finally
      SavePng.Free;
    end;
  end;

  // Upload Image

  if Upload then
    if TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType = sitGreen then
    begin;

      SrcFile  := (ExtractFilePath(ParamStr(0))) + 'images\' + RemoteDB.Products.FieldByName('products_image').AsString;
      DestFile := RemoteDB.Products.FieldByName('products_image').AsString;
      // RemoteDB.IdFTP.host:=FTPHost;
      // RemoteDB.IdFTP.UserName:=FTPUser;
      // RemoteDB.IdFTP.PassWord:=FTPPwd;
      // RemoteDB.IdFTP.Connect;
      // if FTPDir<>'' then RemoteDB.IdFTP.changedir(FTPDir);
      // RemoteDB.IdFTP.Put(srcFile,DestFile);
      // RemoteDB.IdFTP.Disconnect
      FtpImgUp := TFtpUp.Create(SrcFile, DestFile);

    end
    else
      messagedlg('Impossible de joindre le site', mtwarning, [mbok], 0);

end;

procedure TMainForm.BitBtnProductsStockCheckClick(Sender: TObject);
var
  TmpIndex, TmpIndexRent: string;
  AStockCheckForm: TStockCheckForm;
begin
  AStockCheckForm := TStockCheckForm.Create(self);
  try
    RemoteDB.IsUpdating                    := True;
    TmpIndex                               := RemoteDB.netshop_stock.IndexName;
    RemoteDB.netshop_stock.IndexFieldNames := 'Product_Model;Product_Location;Product_owner_id';
    RemoteDB.netshop_stock.Filter          := 'Product_Model = ' + QuotedStr(UpperCase(RemoteDB.Products.FieldByName('Products_model').AsString));
    RemoteDB.netshop_stock.Filtered        := True;

    TmpIndexRent                                := RemoteDB.netshop_rent_stock.IndexName;
    RemoteDB.netshop_rent_stock.IndexFieldNames := 'rent_stock_product_model;rent_stock_last_rent';
    RemoteDB.netshop_rent_stock.Filter := 'rent_stock_product_model = ' + QuotedStr(UpperCase(RemoteDB.Products.FieldByName('Products_model').AsString));
    RemoteDB.netshop_rent_stock.Filtered := True;
    AStockCheckForm.Model                := UpperCase(RemoteDB.Products.FieldByName('Products_model').AsString);
    AStockCheckForm.ShowModal;
  finally
    RemoteDB.netshop_stock.IndexName := TmpIndex;
    RemoteDB.netshop_stock.Filtered  := False;
    RemoteDB.netshop_stock.Filter    := '';

    RemoteDB.netshop_rent_stock.IndexName := TmpIndexRent;
    RemoteDB.netshop_rent_stock.Filtered  := False;
    RemoteDB.netshop_rent_stock.Filter    := '';

    RemoteDB.IsUpdating := False;
    AStockCheckForm.Free;
  end;
end;

procedure TMainForm.ButtonFactureClick(Sender: TObject);
begin
end;
/// /
/// /
/// /  Procdures du menu popup grid customer
/// /
/// /

procedure TMainForm.PrintLabel1Click(Sender: TObject);
var
  Labelstoprint: Tlabeljob;
begin
  if (self.Parameter['PrintersLabelEnabled'] = 'TRUE') then
  begin
    Labelstoprint := Tlabeljob.Create;
    try
      Labelstoprint.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);

      if RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger<100000 then begin
        if RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger<100000 then begin
           Labelstoprint.Style        := lsNew
        end else begin
           Labelstoprint.Style        := lsSH;
        end;
      end else begin
         Labelstoprint.Style        := lsDp
      end;

      Labelstoprint.Logo    := SHLogo;
      Labelstoprint.URL          := WEBURL;
      Labelstoprint.owner        := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
      if (self.Parameter['PrintersLabelContinuous'] = 'TRUE') then
        Labelstoprint.Model := LmContinuous;
      Labelstoprint.Addlabel(RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat, RemoteDB.netshop_stock.FieldByName('product_name').AsString);
      Labelstoprint.Print(StrToBool(self.Parameter['PrintersLabelDialog']));
    finally
      Labelstoprint.Free;
    end;
  end
  else
    messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
end;

procedure TMainForm.CopierBonClick(Sender: TObject);
begin
  ClipBoard.AsText := RemoteDB.CDSCoupons.FieldByName('coupon_code').AsString;
end;

procedure TMainForm.Copiermodle1Click(Sender: TObject);
begin
  ClipBoard.AsText := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
end;
///
///
/// Gestion des recherches dans la DB
///
///

procedure TMainForm.BitBtn_InventoryClearClick(Sender: TObject);
var
  i: Integer;
begin
  if messagedlg('Etes vous sur de vouloir effacer toutes les donnes inventaire', mtconfirmation, [mbok, mbCancel], 0) = mrOK then
  begin

    RemoteDB.Inventory.First;
    RemoteDB.InventoryErrors.First;
    i                    := 0;
    ProgressBar.Visible  := True;
    ProgressBar.Position := (i / (RemoteDB.Inventory.RecordCount + RemoteDB.InventoryErrors.RecordCount) * 100);
    while not(RemoteDB.Inventory.Eof and RemoteDB.Inventory.Bof) do
    begin
      i                    := i + 1;
      ProgressBar.Position := (i / (RemoteDB.Inventory.RecordCount + RemoteDB.InventoryErrors.RecordCount) * 100);
      Application.ProcessMessages;
      RemoteDB.Inventory.delete;
    end;
    while not(RemoteDB.InventoryErrors.Eof and RemoteDB.InventoryErrors.Bof) do
    begin
      i                    := i + 1;
      ProgressBar.Position := (i / (RemoteDB.Inventory.RecordCount + RemoteDB.InventoryErrors.RecordCount) * 100);
      Application.ProcessMessages;
      RemoteDB.InventoryErrors.delete;
    end;
    ProgressBar.Visible := False;
  end; // endif messagedlg=mrok
end;

procedure TMainForm.BitBtn_inventorycloseClick(Sender: TObject);
var
  StockQuantityCount, StockDifference, i: Integer;
begin
  RemoteDB.IsUpdating := True;
  RemoteDB.netshop_stock.DisableControls;
  RemoteDB.Inventory.DisableControls;
  RemoteDB.InventoryErrors.DisableControls;
  RemoteDB.Products.DisableControls;

  RemoteDB.netshop_stock.Filter    := '( Product_supplier_id < 100000 ) and ( Product_Owner_Id = ' + inttostr(ConnectedShop) + ' )';
  RemoteDB.netshop_stock.Filtered  := True;
  RemoteDB.netshop_stock.IndexName := 'StockIXModelDate';

  // Self.Enabled:=False;
  RemoteDB.netshop_stock.First;
  RemoteDB.Products.First;
  ProgressBar.Visible  := True;
  i                    := 0;
  ProgressBar.Position := (i / (RemoteDB.Products.RecordCount) * 100);
  Application.ProcessMessages;

  if not(RemoteDB.Inventory.Eof and RemoteDB.Inventory.Bof) then
    try
      repeat
        /// Si le produit est repris dans l'inventaire
        if RemoteDB.Inventory.Locate('Product_model', RemoteDB.Products.FieldByName('Products_model').AsString, [locaseinsensitive]) then
        begin
          StockQuantityCount := 0;
          /// / Si le produit est dj repris qq part dans le stock
          if RemoteDB.netshop_stock.Locate('product_model', RemoteDB.Inventory.FieldByName('product_model').AsString, [locaseinsensitive]) then
          begin

            // Comptage de la quantit totale reprise en stock
            repeat
              StockQuantityCount := StockQuantityCount + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
              RemoteDB.netshop_stock.Next;
            until (RemoteDB.netshop_stock.FieldByName('product_model').AsString <> RemoteDB.Inventory.FieldByName('product_model').AsString) or
              (RemoteDB.netshop_stock.Eof);
            StockDifference := StockQuantityCount - RemoteDB.Inventory.FieldByName('product_quantity').AsInteger;

            // Ajout d'lments ds le Stock
            if StockQuantityCount < RemoteDB.Inventory.FieldByName('product_quantity').AsInteger then
            begin
              if not RemoteDB.netshop_stock.Eof then
                RemoteDB.netshop_stock.Prior;
              // incrmentation du dernier entr en stock chronoligiquement class
              RemoteDB.netshop_stock.Edit;
              RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger := RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger +
                RemoteDB.Inventory.FieldByName('product_quantity').AsInteger - StockQuantityCount;
              RemoteDB.netshop_stock.Post;
              // Insertions ds la table d'erreur de stock
              RemoteDB.InventoryErrors.Append;
              RemoteDB.InventoryErrors.FieldByName('product_model').AsString := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
              RemoteDB.InventoryErrors.FieldByName('product_owner_id').AsInteger := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
              RemoteDB.InventoryErrors.FieldByName('product_price_stock').AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
              RemoteDB.InventoryErrors.FieldByName('product_location').AsInteger := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
              RemoteDB.InventoryErrors.FieldByName('product_quantity').AsInteger := RemoteDB.Inventory.FieldByName('product_quantity').AsInteger -
                StockQuantityCount;
              RemoteDB.InventoryErrors.FieldByName('product_supplier_id').AsInteger := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
              RemoteDB.InventoryErrors.FieldByName('product_date_in').Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
              RemoteDB.InventoryErrors.FieldByName('product_price_gross').AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
              RemoteDB.InventoryErrors.FieldByName('product_name').AsString := RemoteDB.netshop_stock.FieldByName('product_name').AsString;
              RemoteDB.InventoryErrors.Post;
            end;

            // Retrait d'lments ds le stock
            if StockQuantityCount > RemoteDB.Inventory.FieldByName('product_quantity').AsInteger then
            begin
              repeat // until Stock Difference=0
                RemoteDB.netshop_stock.First;
                RemoteDB.netshop_stock.Locate('Product_model', RemoteDB.Inventoryproduct_model.Value, [locaseinsensitive]);
                // Trouve la plus ancienne entre en stock
                if (StockDifference <> 0) and (RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger = StockDifference) then
                begin
                  // Insertions ds la table d'erreur de stock
                  RemoteDB.InventoryErrors.Append;
                  RemoteDB.InventoryErrorsproduct_model.Value := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
                  RemoteDB.InventoryErrorsproduct_owner_id.Value := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
                  RemoteDB.InventoryErrorsproduct_price_stock.Value := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                  RemoteDB.InventoryErrorsproduct_location.Value := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
                  RemoteDB.InventoryErrorsproduct_quantity.Value := -RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                  RemoteDB.InventoryErrorsproduct_supplier_id.Value := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
                  RemoteDB.InventoryErrorsproduct_date_in.Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
                  RemoteDB.InventoryErrorsproduct_price_gross.Value := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
                  RemoteDB.InventoryErrorsproduct_name.Value := RemoteDB.netshop_stock.FieldByName('product_name').Value;
                  RemoteDB.InventoryErrors.Post;
                  RemoteDB.netshop_stock.delete;
                  StockDifference := 0;
                end;
                if (StockDifference <> 0) and (RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger > StockDifference) then
                begin
                  // Insertions ds la table d'erreur de stock
                  RemoteDB.InventoryErrors.Append;
                  RemoteDB.InventoryErrorsproduct_model.Value := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
                  RemoteDB.InventoryErrorsproduct_owner_id.Value := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
                  RemoteDB.InventoryErrorsproduct_price_stock.Value := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                  RemoteDB.InventoryErrorsproduct_location.Value := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
                  RemoteDB.InventoryErrorsproduct_quantity.Value := -StockDifference;
                  RemoteDB.InventoryErrorsproduct_supplier_id.Value := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
                  RemoteDB.InventoryErrorsproduct_date_in.Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
                  RemoteDB.InventoryErrorsproduct_price_gross.Value := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
                  RemoteDB.InventoryErrorsproduct_name.Value := RemoteDB.netshop_stock.FieldByName('product_name').Value;
                  RemoteDB.InventoryErrors.Post;
                  RemoteDB.netshop_stock.Edit;
                  RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger := RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger -
                    StockDifference;
                  RemoteDB.netshop_stock.Post;
                  StockDifference := 0;
                end;
                if (StockDifference <> 0) and (RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger < StockDifference) then
                begin
                  // Insertions ds la table d'erreur de stock
                  RemoteDB.InventoryErrors.Append;
                  RemoteDB.InventoryErrorsproduct_model.Value := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
                  RemoteDB.InventoryErrorsproduct_owner_id.Value := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
                  RemoteDB.InventoryErrorsproduct_price_stock.Value := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                  RemoteDB.InventoryErrorsproduct_location.Value := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
                  RemoteDB.InventoryErrorsproduct_quantity.Value := -RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                  RemoteDB.InventoryErrorsproduct_supplier_id.Value := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
                  RemoteDB.InventoryErrorsproduct_date_in.Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
                  RemoteDB.InventoryErrorsproduct_price_gross.Value := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
                  RemoteDB.InventoryErrorsproduct_name.Value := RemoteDB.netshop_stock.FieldByName('product_name').Value;
                  RemoteDB.InventoryErrors.Post;
                  StockDifference := StockDifference - RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                  RemoteDB.netshop_stock.delete;
                end;
              until StockDifference = 0 end;
              // Endif Quantite en stock trop importante

            end else begin // endif produit localis en stock donc crr une nouvelle entre
              // Cration d'lments ds le stock
              RemoteDB.netshop_stock.Append;
              RemoteDB.netshop_stock.FieldByName('product_model').AsString := RemoteDB.Inventoryproduct_model.Value;
              RemoteDB.netshop_stock.FieldByName('product_name').Value := RemoteDB.Inventoryproduct_name.Value;
              RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger := (ConnectedShop);
              RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger := RemoteDB.Inventoryproduct_quantity.Value;
              RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger := StrtoInt(DefaultSupplierId);
              RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := RemoteDB.Inventoryproduct_price_gross.AsFloat;
              RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat := RemoteDB.Inventoryproduct_price_stock.AsFloat;
              RemoteDB.netshop_stock.Post;

              // Insertions ds la table d'erreur de stock
              RemoteDB.InventoryErrors.Append;
              RemoteDB.InventoryErrorsproduct_model.Value := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
              RemoteDB.InventoryErrorsproduct_owner_id.Value := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
              RemoteDB.InventoryErrorsproduct_price_stock.AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
              RemoteDB.InventoryErrorsproduct_location.Value := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
              RemoteDB.InventoryErrorsproduct_quantity.Value := RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
              RemoteDB.InventoryErrorsproduct_supplier_id.Value := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
              RemoteDB.InventoryErrorsproduct_date_in.Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
              RemoteDB.InventoryErrorsproduct_price_gross.AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
              RemoteDB.InventoryErrorsproduct_name.Value := RemoteDB.netshop_stock.FieldByName('product_name').Value;
              RemoteDB.InventoryErrors.Post;
            end;
          end else begin // Fin de si repris en inventaire
            // Produit non repris dans l'inventaire donc suprimer du stock si existant
            if RemoteDB.netshop_stock.Locate('Product_model', RemoteDB.Productsproducts_model.Value, [locaseinsensitive]) then
            begin
              // RemoteDB.netshop_stock.FieldByName('.Filtered:=False;
              RemoteDB.netshop_stock.Filter := '( Product_supplier_id < 100000 ) and (Product_Owner_Id = ' + inttostr(ConnectedShop) +
                ') and ( Product_Model = ' + QuotedStr(RemoteDB.Products.FieldByName('products_model').Value) + ')';
              RemoteDB.netshop_stock.First;
              while not RemoteDB.netshop_stock.Eof do
              begin
                // Insertions ds la table d'erreur de stock
                RemoteDB.InventoryErrors.Append;
                RemoteDB.InventoryErrorsproduct_model.Value := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
                RemoteDB.InventoryErrorsproduct_owner_id.Value := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
                RemoteDB.InventoryErrorsproduct_price_stock.AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                RemoteDB.InventoryErrorsproduct_location.Value := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
                RemoteDB.InventoryErrorsproduct_quantity.Value := -RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                RemoteDB.InventoryErrorsproduct_supplier_id.Value := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
                RemoteDB.InventoryErrorsproduct_date_in.Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
                RemoteDB.InventoryErrorsproduct_price_gross.AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
                RemoteDB.InventoryErrorsproduct_name.Value := RemoteDB.netshop_stock.FieldByName('product_name').Value;
                RemoteDB.InventoryErrors.Post;
                RemoteDB.netshop_stock.delete;
              end;
              RemoteDB.netshop_stock.Filter := '( Product_supplier_id < 100000 ) and (Product_Owner_Id = ' + inttostr(ConnectedShop) + ')';
            end; // endif produit prsent en stock test pour vider delete si pas de record
          end;

          RemoteDB.Products.Next;
          i                    := i + 1;
          ProgressBar.Position := (i / (RemoteDB.Products.RecordCount) * 100);
          Application.ProcessMessages;
          until RemoteDB.Products.Eof;

        finally
          RemoteDB.netshop_stock.EnableControls;
          RemoteDB.netshop_stock.Filtered := False;
          RemoteDB.netshop_stock.Filter   := '';
          RemoteDB.Inventory.EnableControls;
          RemoteDB.InventoryErrors.EnableControls;
          RemoteDB.Products.EnableControls;
          RemoteDB.IsUpdating := False;
          ProgressBar.Visible := False;
          // Self.Enabled:=True;
        end;
      end;



procedure TMainForm.btnRefreshESDClick(Sender: TObject);
var
  ESDGate: EsdSoap;
  EsdAuth: ESD.ESDAuth;
  EsdToken:ESD.ESDToken;
begin
     try
      ESDGate     := GetEsdSoap();
      if ESDGate.Identify(GlobalsUnit.CLDLogin,GlobalsUnit.CLDPass) then
      begin
        RemoteDB.netshop_items_sold.First;
        while not RemoteDB.netshop_items_sold.eof  do begin
          if RemoteDB.netshop_items_sold.FieldByName('items_sold_esd_guid').AsString.Length>=32 then begin
            EsdToken:=ESDGate.Requesttoken(RemoteDB.netshop_items_sold.FieldByName('items_sold_esd_guid').AsString);
            if EsdToken.status=1 then begin
              RemoteDB.netshop_items_sold.FieldByName('items_sold_esd').AsString:=EsdToken.token;
            end else begin
             ShowMessage(EsdToken.comment+ ' GUID: ' + RemoteDB.netshop_items_sold.FieldByName('items_sold_esd_guid').AsString);
            end;
          end;
        RemoteDB.netshop_items_sold.Next;
        end;
      end else begin
        ShowMessage('Login ESD impossible');
      end;

    except
      ShowMessage('Erreur de connection au serveur ESD');
    end;


 end;


procedure TMainForm.ChangeOrice1Click(Sender: TObject);
      var
        aChangePriceForm: TChangePriceForm;
      begin
        try
          RemoteDB.IsUpdating := True;
          aChangePriceForm    := TChangePriceForm.Create(self);
          try
            if aChangePriceForm.ShowModal = mrOK then
            begin
              RemoteDB.netshop_stock.Post;
              PrintLabel1Click(nil);
            end
            else
              RemoteDB.netshop_stock.Cancel;
          finally
            aChangePriceForm.Free;
          end;
        finally
          RemoteDB.IsUpdating := False;
        end;
      end;

      procedure TMainForm.Chargertable1Click(Sender: TObject);
      var
        i, Index: Integer;
        aOpenDialog: TOpenDialog;
        FileName, FileExt: string;
      begin

        if PageControlMainForm.ActivePage = TabsheetSales then
        begin
          FileName := 'CaddyVentes.csv';
          FileExt  := '.csv';
        end;

        if PageControlMainForm.ActivePage = TabSheetStockin then
        begin
          FileName := 'CaddyEntreeStock.csv';
          FileExt  := '.csv';

        end;

        if PageControlMainForm.ActivePage = TabSheetTransfer then
        begin
          FileName := 'TransferTable.csv';
          FileExt  := '.csv';
        end;

      end;

      /// /
      /// /
      /// / OUTLOOK BAR ACTIONS
      /// /
      /// /

      procedure TMainForm.ActionLogExecute(Sender: TObject);
      begin
        RemoteDB.FreeItemsTo;
        RemoteDB.FreeItemsRefundedTo;
        RemoteDB.FreeStockto;
        RemoteDB.freesalesto;
        RemoteDB.FreeRentTo;
        RemoteDB.FreeInvoicesItems;
        RemoteDB.FreeInvoicesToCustomers;
        RemoteDB.FreeAlertsTo;

        RemoteDB.Products.IndexName := 'ProductsIXModel';
        RemoteDB.Products.Filter    := '';
        RemoteDB.Products.Filtered  := False;

        // SearchString.Enabled:=False;
        searchstring.Text := '';
        // SButtonSearch.Enabled:=False;

        DBNavigatorMain.DataSource := nil;
        DBNavigatorFirst1.Enabled  := True;
        DBNavigatorPrev1.Enabled   := True;
        DBNavigatorNext1.Enabled   := True;
        DBNavigatorLast1.Enabled   := True;
        DBNavigatorInsert1.Enabled := True;
        DBNavigatorDelete1.Enabled := True;
        DBNavigatorEdit1.Enabled   := True;
        DBNavigatorPost1.Enabled   := True;
        DBNavigatorCancel1.Enabled := True;

        PageControlMainForm.ActivePage := TabSheetLog;
      end;

      procedure TMainForm.inventoryExecute(Sender: TObject);
      begin
        begin // Inventory
          RemoteDB.FreeItemsTo;
          RemoteDB.FreeItemsRefundedTo;
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := RemoteDB.InventorySRC;
          DBNavigatorFirst1.Enabled  := True;
          DBNavigatorPrev1.Enabled   := True;
          DBNavigatorNext1.Enabled   := True;
          DBNavigatorLast1.Enabled   := True;
          DBNavigatorInsert1.Enabled := True;
          DBNavigatorDelete1.Enabled := True;
          DBNavigatorEdit1.Enabled   := True;
          DBNavigatorPost1.Enabled   := True;
          DBNavigatorCancel1.Enabled := True;

          RemoteDB.Inventory.First;

          PageControlMainForm.ActivePage := TabSheetInventory;
        end;
      end;

      procedure TMainForm.RentExecute(Sender: TObject);
      begin
        begin // Location  RemoteDB.FreeItemsTo;
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          EditRentCustomerId.Text := inttostr(ConnectedShop);
          RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabSheetRent;
        end;
      end;

      procedure TMainForm.netshop_expensesExecute(Sender: TObject);
      begin
        begin // Expenses
          RemoteDB.FreeItemsTo;
          RemoteDB.FreeItemsRefundedTo;
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.Filter   := '';
          RemoteDB.Products.Filtered := False;

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource         := RemoteDB.ExpensesSRC;
          RemoteDB.netshop_expenses.Filter   := '';
          RemoteDB.netshop_expenses.Filtered := False;
          DBNavigatorFirst1.Enabled          := True;
          DBNavigatorPrev1.Enabled           := True;
          DBNavigatorNext1.Enabled           := True;
          DBNavigatorLast1.Enabled           := True;
          DBNavigatorInsert1.Enabled         := True;
          DBNavigatorDelete1.Enabled         := True;
          DBNavigatorEdit1.Enabled           := True;
          DBNavigatorPost1.Enabled           := True;
          DBNavigatorCancel1.Enabled         := True;

          PageControlMainForm.ActivePage := TabSheetExpenses;
        end;
      end;

      procedure TMainForm.ConfigExecute(Sender: TObject);
      begin
        begin // Configuration

          RemoteDB.FreeStockto;
          RemoteDB.FreeItemsTo;
          RemoteDB.FreeItemsRefundedTo;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabSheetConfiguration;
        end;
      end;

      procedure TMainForm.MailingExecute(Sender: TObject);
      begin
        begin // Mailing

          RemoteDB.FreeStockto;
          RemoteDB.FreeItemsTo;
          RemoteDB.FreeItemsRefundedTo;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabSheetMailing;
        end;
      end;

      procedure TMainForm.AdminExecute(Sender: TObject);
      begin
        begin // Admin

          RemoteDB.SetItemstoSales;
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRefundsTo;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabSheetAdmin;

        end;
      end;


procedure TMainForm.VenteExecute(Sender: TObject);
      begin
        begin // Sales
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          EditSalesCustomerNbr.Text := inttostr(ConnectedShop);
          RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabsheetSales;
          StringGridSalesEditingDone(nil);
          if EditSalesModel.Visible then
            EditSalesModel.SetFocus;

        end;
      end;

      procedure TMainForm.TransfertExecute(Sender: TObject);
      begin
        begin // Transfer

          RemoteDB.FreeItemsTo;
          RemoteDB.FreeItemsRefundedTo;
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabSheetTransfer;
        end;
      end;

      procedure TMainForm.ClientsExecute(Sender: TObject);
      begin
        try
          // MainForm.Enabled:=False;
          cxGridViewRepositoryDBTableViewStockDeposit.Controller.ClearSelection;
          RemoteDB.SetAddress_bookToCustomers;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          DBNavigatorMain.DataSource := RemoteDB.CustomersSRC;
          DBNavigatorFirst1.Enabled  := True;
          DBNavigatorPrev1.Enabled   := True;
          DBNavigatorNext1.Enabled   := True;
          DBNavigatorLast1.Enabled   := True;
          DBNavigatorInsert1.Enabled := True;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := True;
          DBNavigatorPost1.Enabled   := True;
          DBNavigatorCancel1.Enabled := True;

          RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);


          // SearchString.Enabled:=True;

          SButtonSearch.Enabled := True;

          PageControlMainForm.ActivePage := TabSheetCustomers;
          Application.ProcessMessages;
          PageControlCustomers.ActivePage        := TabSheetCustomersSales;
          PageControlCustomersDetails.ActivePage := TabSheetDetails;
          PageControlCustomers.OnChange(nil);

          searchstring.SetFocus(True);

        finally
          // MainForm.Enabled:=True;
        end;
      end;

      procedure TMainForm.ProduitsExecute(Sender: TObject);
      begin
        RemoteDB.FreeItemsTo;
        RemoteDB.FreeItemsRefundedTo;
        RemoteDB.FreeStockto;
        RemoteDB.freesalesto;
        RemoteDB.FreeRentTo;
        RemoteDB.FreeInvoicesItems;
        RemoteDB.FreeInvoicesToCustomers;
        RemoteDB.FreeAlertsTo;

        RemoteDB.Products.IndexName := 'ProductsIXModel';
        RemoteDB.Products.Filter    := '';
        RemoteDB.Products.Filtered  := False;

        // SearchString.Enabled:=True;
        SButtonSearch.Enabled := True;

        DBNavigatorMain.DataSource := RemoteDB.ProductsSRC;
        DBNavigatorFirst1.Enabled  := True;
        DBNavigatorPrev1.Enabled   := True;
        DBNavigatorNext1.Enabled   := True;
        DBNavigatorLast1.Enabled   := True;
        DBNavigatorInsert1.Enabled := False;
        DBNavigatorDelete1.Enabled := False;
        DBNavigatorEdit1.Enabled   := True;
        DBNavigatorPost1.Enabled   := True;
        DBNavigatorCancel1.Enabled := True;

        RemoteDB.Products.FindKey([RemoteDB.Products.FieldByName('products_model').AsString]);

        PageControlMainForm.ActivePage := TabSheetProducts;
      end;

      procedure TMainForm.EntreeExecute(Sender: TObject);
      begin
        begin // Stockin
          RemoteDB.FreeItemsTo;
          RemoteDB.FreeItemsRefundedTo;
          RemoteDB.FreeStockto;
          RemoteDB.freesalesto;
          RemoteDB.FreeRentTo;
          RemoteDB.FreeInvoicesItems;
          RemoteDB.FreeInvoicesToCustomers;
          RemoteDB.FreeAlertsTo;

          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filter    := '';
          RemoteDB.Products.Filtered  := False;

          RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);
          EditStockinCustomerNbr.Text := inttostr(ConnectedShop);

          // SearchString.Enabled:=False;
          searchstring.Text := '';
          // SButtonSearch.Enabled:=False;

          DBNavigatorMain.DataSource := nil;
          DBNavigatorFirst1.Enabled  := False;
          DBNavigatorPrev1.Enabled   := False;
          DBNavigatorNext1.Enabled   := False;
          DBNavigatorLast1.Enabled   := False;
          DBNavigatorInsert1.Enabled := False;
          DBNavigatorDelete1.Enabled := False;
          DBNavigatorEdit1.Enabled   := False;
          DBNavigatorPost1.Enabled   := False;
          DBNavigatorCancel1.Enabled := False;

          PageControlMainForm.ActivePage := TabSheetStockin;
          if cxEditStockinModel.Visible then
            cxEditStockinModel.SetFocus;

        end;
      end;

      procedure TMainForm.PageControlCustomersChange(Sender: TObject);
      begin
        if RemoteDB.Customers.FieldByName('customers_nbr').AsInteger >= 100000 then
          dxBarMRUListItemCustomers.AddItem(RemoteDB.CustomersCustomers_nbr.AsString + ' - ' + RemoteDB.Customerscustomers_firstname.AsString + ' ' +
            RemoteDB.CustomersCustomers_Lastname.AsString, nil);

        if PageControlCustomers.ActivePage = TabSheetCustomersDeposit then
        begin
          RemoteDB.SetStockToCustomers;
          RemoteDB.SetItemstoCustomers;
          ActionCustomerDepositAll.Execute;
        end;
        if PageControlCustomers.ActivePage = TabSheetCustomersSales then
        begin
          RemoteDB.netshop_items_sold.Filtered := False;
          RemoteDB.SetSalesToCustomers;
          RemoteDB.SetItemstoSales;
          RemoteDB.SetItemsRefundedtoRefunds;
        end;
        if PageControlCustomers.ActivePage = TabSheetCustomersRefund then
        begin
          RemoteDB.SetRefundsToCustomers;
        end;
        if PageControlCustomers.ActivePage = TabSheetCustomersInvoice then
        begin
          RemoteDB.SetInvoicesToCustomers;
          RemoteDB.SetInvoicesItemsToInvoices;
        end;
        if PageControlCustomers.ActivePage = TabSheetCustomersRepair then
        begin
          RemoteDB.SetRepairToCustomers;
          ActionCustomerRepairAll.Execute;
        end;
        if PageControlCustomers.ActivePage = TabSheetCustomersRent then
        begin
          RemoteDB.SetRentToCustomers;
          ActionCustomerRentAll.Execute;
        end;
        if PageControlCustomers.ActivePage = tsVouchers then
        begin
          RemoteDB.SetCouponsToCustomers;
        end;
        if PageControlCustomers.ActivePage = TabSheetCustomersOrders then
        begin
          RemoteDB.SetAlertsToCustomers;
          RemoteDB.FilterAlertsReserved;
          RadioButtonAlertsreserved.Checked := True;
          RemoteDB.FilterProductsPreOrder;
          RadioButtonAlertsProductFilterPreOrder.Checked := True;
        end;

      end;

      procedure TMainForm.PageControlCustomersExit(Sender: TObject);
      begin
        RemoteDB.FilterProductsAll
      end;

      procedure TMainForm.ButtonInventoryShowClick(Sender: TObject);
      begin
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInventory', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvSystem.DefaultDest    := rdpreview;
        ReportModule.RvSystem.DoNativeOutput := True;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
      end;

      procedure TMainForm.InvCheckPricesClick(Sender: TObject);
      begin
        try
          while not RemoteDB.Inventory.Eof do
          begin
            if RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat > RemoteDB.Inventory.FieldByName('product_price_stock').AsFloat /
              (0.90 + (MarginNew / 100)) then
            begin
              if messagedlg('Le produit ' + RemoteDB.Inventory.FieldByName('product_name').AsString + ' semble sur-valu', mtwarning, [mbyes, mbno], 0) = mryes
              then
              begin
                RemoteDB.Inventory.Edit;
                RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat := RemoteDB.Inventory.FieldByName('product_price_stock').AsFloat /
                  (1 + (MarginNew / 100));
                RemoteDB.Inventory.Post;
              end;
            end;
            RemoteDB.Inventory.Next;
          end;
        finally
        end;
      end;

      procedure TMainForm.TimerUpdateConnectionLedsTimer(Sender: TObject);
      begin
        if RemoteDB.IsConnected then
        begin
          StatusLine.Panels[0].Text := 'Connect';
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType := sitGreen;
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[1].IndicatorType := sitOff;
        end else begin
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType := sitOff;
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[1].IndicatorType := sitRed;
          StatusLine.Panels[0].Text := 'Non connect';
        end;
        {
          if StatusWeb > 0 then begin
          StatusLine.Panels[0].Text:='Temps ping : '+inttostr(StatusWeb)+' ms';
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.Items[1].PanelStyle).Indicators.Items[0].IndicatorType:=sitGreen;
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.Items[1].PanelStyle).Indicators.Items[1].IndicatorType:=sitOff;
          end else begin
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.Items[1].PanelStyle).Indicators.Items[0].IndicatorType:=sitOff;
          TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.Items[1].PanelStyle).Indicators.Items[1].IndicatorType:=sitRed;
          StatusLine.Panels[0].Text:='Non connect';
          end;
        }
      end;

      procedure TMainForm.ToolButtonInventoryErrorsExportClick(Sender: TObject);
      var
        QexportDialog: TQexport4Dialog;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        if not(DirectoryExists('export')) then
        begin
          CreateDir('export');
        end;
        ChDir(ExtractFilePath(ParamStr(0)) + '/export');

        QexportDialog := TQexport4Dialog.Create(self);
        try
          QexportDialog.DataSet := RemoteDB.InventoryErrors;
          QexportDialog.Execute;
        finally
          QexportDialog.Free;
        end;
      end;

      procedure TMainForm.ToolButton3Click(Sender: TObject);
      var
        Pindex: Integer;
      begin
        Pindex := Printer.Printers.IndexOf((self.Parameter['PrintersRapportPrinter']));
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInventory', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvSystem.DefaultDest := rdPrinter;
        // ReportModule.RvSystem.DoNativeOutput := true;
        ReportModule.RvSystem.SystemSetups := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
        // ReportModule.RvSystem.Execute;
        ReportModule.RvNDRWriter.PrinterIndex         := Pindex;
        ReportModule.RvSystem.SystemPreview.FormState := wsMaximized;
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
      end;

      procedure TMainForm.ToolButtonExportClick(Sender: TObject);
      var
        QexportDialog: TQexport4Dialog;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        if not(DirectoryExists('export')) then
        begin
          CreateDir('export');
        end;
        ChDir(ExtractFilePath(ParamStr(0)) + '/export');

        QexportDialog := TQexport4Dialog.Create(self);
        try
          QexportDialog.DataSet := RemoteDB.Inventory;
          QexportDialog.Execute;
        finally
          QexportDialog.Free;
        end;

      end;

      procedure TMainForm.ToolButtonInvErrOpenClick(Sender: TObject);
      var
        aOpenDialog: TOpenDialog;
      begin

        ChDir(ExtractFilePath(ParamStr(0)));
        aOpenDialog            := TOpenDialog.Create(self);
        aOpenDialog.DefaultExt := 'xml';
        aOpenDialog.FileName   := 'inventory_errors.xml';
        try
          if aOpenDialog.Execute then
          begin
            RemoteDB.InventoryErrors.LoadfromFile(aOpenDialog.FileName);
          end;
        finally
          aOpenDialog.Free;
        end;
      end;

      procedure TMainForm.ToolButtonInvErrPrintClick(Sender: TObject);
      var
        Pindex: Integer;
      begin
        Pindex := Printer.Printers.IndexOf((self.Parameter['PrintersRapportPrinter']));
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInventoryErros', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvSystem.DefaultDest := rdPrinter;
        // ReportModule.RvSystem.DoNativeOutput := true;
        ReportModule.RvSystem.SystemSetups := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
        // ReportModule.RvSystem.Execute;
        ReportModule.RvNDRWriter.PrinterIndex         := Pindex;
        ReportModule.RvSystem.SystemPreview.FormState := wsMaximized;
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
      end;

      procedure TMainForm.ToolButtonInvErrSaveClick(Sender: TObject);
      var
        aSaveDialog: TsaveDialog;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        if not(DirectoryExists('export')) then
        begin
          CreateDir('export');
        end;
        ChDir(ExtractFilePath(ParamStr(0)) + '/export');
        aSaveDialog            := TsaveDialog.Create(self);
        aSaveDialog.DefaultExt := 'xml';
        aSaveDialog.FileName   := 'inventory_errors.xml';
        try
          if aSaveDialog.Execute then
          begin
            RemoteDB.InventoryErrors.SaveToFile(aSaveDialog.FileName, dfxml);
          end;
        finally
          aSaveDialog.Free;
        end;
      end;

      procedure TMainForm.ToolButtonInvErrViewClick(Sender: TObject);
      begin
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInventoryErrors', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvSystem.DefaultDest    := rdpreview;
        ReportModule.RvSystem.DoNativeOutput := True;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
        // ReportModule.RvSystem.Execute;
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
      end;

      procedure TMainForm.ToolButtonMergeClick(Sender: TObject);
      var
        table: TClientDataset;
        aOpenDialog: TOpenDialog;
        i: Integer;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        aOpenDialog                        := TOpenDialog.Create(self);
        aOpenDialog.DefaultExt             := 'cds';
        aOpenDialog.FileName               := 'inventory.cds';
        RemoteDB.Inventory.IndexFieldNames := 'product_model';
        try
          if aOpenDialog.Execute then
          begin
            table := TClientDataset.Create(Application);
            table.LoadfromFile(aOpenDialog.FileName);
            table.First;
            while not table.Eof do
            begin
              if RemoteDB.Inventory.FindKey([table.FieldByName('product_model').AsString]) then
              begin
                RemoteDB.Inventory.Edit;
                RemoteDB.Inventory.FieldByName('product_quantity').AsInteger := RemoteDB.Inventory.FieldByName('product_quantity').AsInteger +
                  table.FieldByName('product_quantity').AsInteger;
                RemoteDB.Inventory.Post;
              end else begin
                RemoteDB.Inventory.Append;
                for i := 0 to (table.Fieldcount - 1) do
                begin
                  RemoteDB.Inventory.fields[i].Value := table.fields[i].Value;
                end;
                RemoteDB.Inventory.Post;
              end;
              table.Next;
            end;
          end;
        finally
          aOpenDialog.Free;
          table.Free;
        end;

      end;

      procedure TMainForm.ToolButtonOpenClick(Sender: TObject);
      var
        aOpenDialog: TOpenDialog;
      begin

        ChDir(ExtractFilePath(ParamStr(0)));
        aOpenDialog            := TOpenDialog.Create(self);
        aOpenDialog.DefaultExt := 'xml';
        aOpenDialog.FileName   := 'inventory.xml';
        try
          if aOpenDialog.Execute then
          begin
            RemoteDB.Inventory.LoadfromFile(aOpenDialog.FileName);
          end;
        finally
          aOpenDialog.Free;
        end;
      end;

      procedure TMainForm.ToolButtonSaveClick(Sender: TObject);
      var
        aSaveDialog: TsaveDialog;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        if not(DirectoryExists('export')) then
        begin
          CreateDir('export');
        end;
        ChDir(ExtractFilePath(ParamStr(0)) + '/export');
        aSaveDialog            := TsaveDialog.Create(self);
        aSaveDialog.DefaultExt := 'xml';
        aSaveDialog.FileName   := 'inventory.xml';
        try
          if aSaveDialog.Execute then
          begin
            RemoteDB.Inventory.SaveToFile(aSaveDialog.FileName, dfxml);
          end;
        finally
          aSaveDialog.Free;
        end;
      end;

      procedure TMainForm.ToolButtonViewClick(Sender: TObject);
      begin

        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInventory', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvSystem.DefaultDest    := rdpreview;
        ReportModule.RvSystem.DoNativeOutput := True;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
        // ReportModule.RvSystem.Execute;
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;

      end;

      procedure TMainForm.ButtonStockinNewCustomerClick(Sender: TObject);
      begin
        Clients.Execute;
        RemoteDB.Customers.Append;
      end;

      procedure TMainForm.ActionCustomerDepositnonrefundedExecute(Sender: TObject);
      begin
        RemoteDB.netshop_items_sold.Filter            := 'items_refunded = ' + QuotedStr('0');
        RemoteDB.netshop_items_sold.Filtered          := True;
        RadioButtonCustomerDepositNonRefunded.Checked := True;
      end;

      procedure TMainForm.ActionCustomerDepositRefundedExecute(Sender: TObject);
      begin
        RemoteDB.netshop_items_sold.Filter         := 'items_refunded = ' + QuotedStr('1');
        RemoteDB.netshop_items_sold.Filtered       := True;
        RadioButtonCustomerDepositRefunded.Checked := True;
      end;

      procedure TMainForm.ActionCustomerDepositAllExecute(Sender: TObject);
      begin
        RemoteDB.netshop_items_sold.Filter    := '';
        RemoteDB.netshop_items_sold.Filtered  := False;
        RadioButtonCustomerDepositAll.Checked := True;
      end;

      procedure TMainForm.ActionCustomerRepairAllExecute(Sender: TObject);
      begin
        BitBtnCustomerRepairExecute.Enabled  := True;
        BitBtnCustomerRepairReturn.Enabled   := True;
        RemoteDB.netshop_repair.Filter       := '(repair_fixed=' + QuotedStr('false') + ') and (repair_returned=' + QuotedStr('false') + ' )';
        RemoteDB.netshop_repair.Filtered     := True;
        RadioButtonCustomerRepairAll.Checked := True;
      end;

      procedure TMainForm.ActionCustomerRepairProcessedExecute(Sender: TObject);
      begin
        BitBtnCustomerRepairExecute.Enabled        := False;
        BitBtnCustomerRepairReturn.Enabled         := True;
        RemoteDB.netshop_repair.Filter             := '( repair_fixed= ' + QuotedStr('true') + ') and (repair_returned=' + QuotedStr('false') + ' )';
        RemoteDB.netshop_repair.Filtered           := True;
        RadioButtonCustomerRepairProcessed.Checked := True;
      end;

      procedure TMainForm.ActionCustomerRepairReturnedExecute(Sender: TObject);
      begin
        BitBtnCustomerRepairReturn.Enabled        := False;
        BitBtnCustomerRepairExecute.Enabled       := False;
        RemoteDB.netshop_repair.Filter            := '(repair_returned=' + QuotedStr('true') + ' )';
        RemoteDB.netshop_repair.Filtered          := True;
        RadioButtonCustomerRepairReturned.Checked := True;
      end;

      procedure TMainForm.JvExpressButton13Click(Sender: TObject);
      begin
        if RemoteDB.Tips.RecordCount > 0 then
          RemoteDB.Tips.delete;
      end;

      procedure TMainForm.InvEraseGrossPriceClick(Sender: TObject);
      begin
        RemoteDB.Inventory.DisableControls;
        RemoteDB.Inventory.First;
        try
          while not RemoteDB.Inventory.Eof do
          begin
            if RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat = 0 then
            begin
            end else begin
              RemoteDB.Inventory.Edit;
              RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat := 0;
              RemoteDB.Inventory.Post;
            end;
            RemoteDB.Inventory.Next;
          end;
        finally
          RemoteDB.Inventory.EnableControls;
        end;

      end;

      procedure TMainForm.InvExportXlsClick(Sender: TObject);
      begin;
      end;



      procedure TMainForm.DBLookupTreeViewProductsCategoriesDropDown(Sender: TObject);
      begin
        RemoteDB.Products.Edit;
      end;

      procedure TMainForm.DBMemoCustomersMemoChange(Sender: TObject);
      begin
        if DBMemoCustomersMemo.Lines.Count > 0 then
        begin
          DBEditCustomerNbr.Style.Color := ClRed;
        end else begin
          DBEditCustomerNbr.Style.Color := clWindow;
        end;

      end;

      procedure TMainForm.Button1Click(Sender: TObject);
      var
        LabelCode39: TLabelCODE39;
      begin
        if (self.Parameter['PrintersLabelEnabled'] = 'TRUE') then
        begin
          LabelCode39 := TLabelCODE39.Create;
          try
            LabelCode39.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);

            LabelCode39.Print('A-009-05', RemoteDB.Products.FieldByName('products_intername').Text, 0, (StrToBool(self.Parameter['PrintersLabelDialog'])));
          finally
            LabelCode39.Free;
          end;
        end
        else
          messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
      end;

      procedure TMainForm.ButtonAddProductsPathClick(Sender: TObject);
      var
        TempStr: string;
      begin
        RemoteDB.Products.First;
        while not RemoteDB.Products.Eof do
        begin
          if Pos('products/', lowercase(RemoteDB.Products.FieldByName('products_image').AsString)) = 0 then
          begin
            TempStr := RemoteDB.Products.FieldByName('products_image').AsString;
            Insert('products/', TempStr, 0);
            RemoteDB.Products.Edit;
            RemoteDB.Products.FieldByName('products_image').AsString := TempStr;
            RemoteDB.Products.Post;
          end;
          RemoteDB.Products.Next;
        end;
      end;

      procedure TMainForm.ButtonCustomerAlertsResetAttemptsClick(Sender: TObject);
      begin
        RemoteDB.netshop_customers_alerts.First;
        while not RemoteDB.netshop_customers_alerts.Eof do
        begin
          RemoteDB.netshop_customers_alerts.Edit;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_attempts').AsInteger := 0;
          RemoteDB.netshop_customers_alerts.Post;
          RemoteDB.netshop_customers_alerts.Next;
        end;
      end;

      procedure TMainForm.StringGridSalesEditingDone(Sender: TObject);
      var
        Nowrow, i, Index, indexcount, indexttc, indexht: Integer;
      begin
        SalesClearSummary;
        // Grid
        for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
          begin
            index := i;
          end;
        end;
        // Count
        for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 99 then
          begin
            indexcount := i;
          end;
        end;
        // HT
        for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 98 then
          begin
            indexht := i;
          end;
        end;
        // TTC
        for i := 0 to TAdvTabSheet(PageControlSalesCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[i].Tag = 97 then
          begin
            indexttc := i;
          end;
        end;
        with TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexcount]) do
          Caption := '0';
        with TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexht]) do
          Caption := FloatToStrF(0, fffixed, 7, 2);
        with TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexttc]) do
          Caption  := FloatToStrF(0, fffixed, 7, 2);
        for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).RowCount - 2 do
        begin
          with TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexcount]) do
            Caption := inttostr(StrtoInt(Caption) + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).Cells[2, Nowrow]));
          with TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexht]) do
            Caption := FloatToStrF(StrToFloat(Caption) + RemoteDB.GetPriceHT(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index])
              .Cells[0, Nowrow], StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).Cells[4, Nowrow])) *
              StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).Cells[2, Nowrow]), fffixed, 7, 2);
          with TLabel(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[indexttc]) do
            Caption := FloatToStrF(StrToFloat(Caption) + StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).Cells[4,
              Nowrow]) * StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlSalesCaddy.ActivePage).Controls[index]).Cells[2, Nowrow]), fffixed, 7, 2);
        end;
      end;

      procedure TMainForm.StringGridStockinEditingDone(Sender: TObject);
      var
        Nowrow, i, Index, indexcount, indexttc, indexht: Integer;
      begin
        // Grid
        for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
          begin
            index := i;
          end;
        end;
        // Count
        for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 99 then
          begin
            indexcount := i;
          end;
        end;
        // HT
        for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 98 then
          begin
            indexht := i;
          end;
        end;
        // TTC
        for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 97 then
          begin
            indexttc := i;
          end;
        end;
        with TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexcount]) do
          Caption := '0';
        with TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexht]) do
          Caption := FloatToStrF(0, fffixed, 7, 2);
        with TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexttc]) do
          Caption  := FloatToStrF(0, fffixed, 7, 2);
        for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]).RowCount - 2 do
        begin
          with TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexcount]) do
            Caption := inttostr(StrtoInt(Caption) + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]).Cells[2,
              Nowrow]));
          with TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexht]) do
            Caption := FloatToStrF(StrToFloat(Caption) + RemoteDB.GetPriceHT(TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index])
              .Cells[0, Nowrow], StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]).Cells[4, Nowrow])) *
              StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]).Cells[2, Nowrow]), fffixed, 7, 2);
          with TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexttc]) do
            Caption := FloatToStrF(StrToFloat(Caption) + StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]).Cells[4,
              Nowrow]) * StrToFloat(TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[index]).Cells[2, Nowrow]), fffixed, 7, 2);
        end;
      end;

      procedure TMainForm.ActionDBSyncExecute(Sender: TObject);
      begin
        // Self.Enabled:=False;
        try
          begin
            if TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType = sitGreen then
            begin;
              RemoteDB.SynchroniseMin;
            end else begin
              messagedlg('Serveur DB Inacessible : ', mtwarning, [mbok], 0);
            end;
          end;
        finally
          // Self.Enabled:=True;
        end;
      end;

      procedure TMainForm.ActionDBCheckCatExecute(Sender: TObject);
      begin
        RemoteDB.ProductsRebuildRootCatNames;
      end;

      procedure TMainForm.ActionDBCheckEanExecute(Sender: TObject);
      begin
        RemoteDB.CheckProductsEan;
      end;

      procedure TMainForm.ActionDBBuildIdExecute(Sender: TObject);
      begin
        RemoteDB.BuildProductsId;
      end;

      procedure TMainForm.ActionRaportDayCashierExecute(Sender: TObject);
      begin
        try
          RemoteDB.Shops.IndexName := 'ShopsIXId';
          RemoteDB.Shops.FindKey([ConnectedShop]);
          RemoteDB.FreeItemsTo;
          RemoteDB.netshop_refunds.Filter := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< refunds_date_time and refunds_date_time < ' +
            FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (refunds_shop_id = ' + inttostr(ConnectedShop) + ')';
          RemoteDB.netshop_refunds.Filtered := True;
          RemoteDB.netshop_sales.Filter     := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< sales_date_time and sales_date_time < ' +
            FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (sales_location = ' + inttostr(ConnectedShop) + ')';
          RemoteDB.netshop_sales.Filtered    := True;
          ReportModule.RvSystem.SystemSetups := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
          ReportModule.RvProject.ExecuteReport('ReportDaySales');
          // ReportModule.RvProject.ExecuteReport('SalesReport');
          // ReportModule.RvProject.DesignReport('ReportDaySales');
        finally
          RemoteDB.netshop_refunds.Filter   := '';
          RemoteDB.netshop_refunds.Filtered := False;
          RemoteDB.netshop_sales.Filter     := '';
          RemoteDB.netshop_sales.Filtered   := False;
          RemoteDB.SetItemstoSales;
        end;

      end;

      procedure TMainForm.ActionWebInfoExecute(Sender: TObject);
      begin
        RemoteDB.FreeItemsTo;
        RemoteDB.FreeItemsRefundedTo;
        RemoteDB.FreeStockto;
        RemoteDB.freesalesto;
        RemoteDB.FreeRentTo;
        RemoteDB.FreeInvoicesItems;
        RemoteDB.FreeInvoicesToCustomers;
        RemoteDB.FreeAlertsTo;

        RemoteDB.Products.IndexName := 'ProductsIXModel';
        RemoteDB.Products.Filter    := '';
        RemoteDB.Products.Filtered  := False;

        // SearchString.Enabled:=True;
        SButtonSearch.Enabled := True;

        DBNavigatorMain.DataSource := nil;
        DBNavigatorFirst1.Enabled  := False;
        DBNavigatorPrev1.Enabled   := False;
        DBNavigatorNext1.Enabled   := False;
        DBNavigatorLast1.Enabled   := False;
        DBNavigatorInsert1.Enabled := False;
        DBNavigatorDelete1.Enabled := False;
        DBNavigatorEdit1.Enabled   := False;
        DBNavigatorPost1.Enabled   := False;
        DBNavigatorCancel1.Enabled := False;

        PageControlMainForm.ActivePage := TabSheetWebInfo;
      end;

      procedure TMainForm.ActionWebOrdersExecute(Sender: TObject);
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Verifications commandes WEB';
        RemoteDB.CDSActions.Post;
        RemoteDB.FreeItemsTo;
        RemoteDB.FreeItemsRefundedTo;
        RemoteDB.FreeStockto;
        RemoteDB.freesalesto;
        RemoteDB.FreeRentTo;
        RemoteDB.FreeInvoicesItems;
        RemoteDB.FreeInvoicesToCustomers;
        RemoteDB.FreeAlertsTo;

        RemoteDB.Products.IndexName := 'ProductsIXModel';
        RemoteDB.Products.Filter    := '';
        RemoteDB.Products.Filtered  := False;

        // SearchString.Enabled:=True;
        searchstring.Text := '';
        // SButtonSearch.Enabled:=False;

        DBNavigatorMain.DataSource := nil;
        DBNavigatorFirst1.Enabled  := False;
        DBNavigatorPrev1.Enabled   := False;
        DBNavigatorNext1.Enabled   := False;
        DBNavigatorLast1.Enabled   := False;
        DBNavigatorInsert1.Enabled := False;
        DBNavigatorDelete1.Enabled := False;
        DBNavigatorEdit1.Enabled   := False;
        DBNavigatorPost1.Enabled   := False;
        DBNavigatorCancel1.Enabled := False;

        PageControlMainForm.ActivePage := TabSheetWebOrders;
      end;

      procedure TMainForm.JvLookOutButton2Click(Sender: TObject);
      var
        ITempIndex, STempIndex: string;
        LowMargin: Boolean;
        CurrentSaleSubTot, ActualSaleSubTot: currency;
        i: Integer;
        UpdateStatus: Boolean;

      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Analyse des ventes produits';
        RemoteDB.CDSActions.Post;
        UpdateStatus := RemoteDB.IsUpdating;

        if not RemoteDB.IsUpdating then
          RemoteDB.IsUpdating := True;

        LowMargin := False;

        // StringGridAdmin.RowCount:=1;
        StringGridAdmin.RowCount := 2;

        StringGridAdmin.Clear;

        StringGridAdmin.ColCount     := 11;
        StringGridAdmin.Cells[0, 0]  := 'Modle';
        StringGridAdmin.Cells[1, 0]  := 'Description';
        StringGridAdmin.Cells[2, 0]  := 'Quantit';
        StringGridAdmin.Cells[3, 0]  := 'P. catalogue';
        StringGridAdmin.Cells[4, 0]  := 'P. stock';
        StringGridAdmin.Cells[5, 0]  := 'P. achat';
        StringGridAdmin.Cells[6, 0]  := 'Date entre';
        StringGridAdmin.Cells[7, 0]  := 'Propritaire';
        StringGridAdmin.Cells[8, 0]  := 'Fournisseur';
        StringGridAdmin.Cells[9, 0]  := 'Identifiant';
        StringGridAdmin.Cells[10, 0] := 'TVA';

        // Resize Columns
        StringGridAdmin.ColWidths[0]   := 95;
        StringGridAdmin.ColWidths[1]   := Max(StringGridAdmin.ClientWidth - 100 - (StringGridAdmin.ColCount - 2) * 60, 150);
        for i                          := 2 to StringGridAdmin.ColCount - 1 do
          StringGridAdmin.ColWidths[i] := 60;

        StringGridFiguresClear;

        StringGridAdmin.BeginUpdate;
        // StringGridFigures.BeginUpdate;
        MainForm.Cursor := crHourglass;
        Application.ProcessMessages;
        self.Enabled := False;

        STempIndex := RemoteDB.netshop_sales.IndexName;
        ITempIndex := RemoteDB.netshop_items_sold.IndexName;
        RemoteDB.FreeItemsTo;
        RemoteDB.SetItemstoSales;
        RemoteDB.netshop_sales.IndexName := 'SalesIXLocationId';
        RemoteDB.netshop_sales.Filter    := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< sales_date_time and sales_date_time < ' +
          FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (sales_location = ' + inttostr(ConnectedShop) + ')';
        RemoteDB.netshop_sales.Filtered       := True;
        RemoteDB.netshop_items_sold.IndexName := 'ItemsIXLocationId';
        RemoteDB.netshop_items_sold.DisableControls;
        RemoteDB.Products.IndexName := 'ProductsIXModel';
        RemoteDB.Products.Filtered  := False;

        RemoteDB.SetItemstoSales;
        if ((RemoteDB.netshop_sales.RecordCount < 10000) and (RemoteDB.netshop_items_sold.RecordCount < 15000)) then
          try
            Screen.Cursor := crHourglass;
            RemoteDB.netshop_sales.First;
            while not RemoteDB.netshop_sales.Eof do
            begin
              if (True) then
              begin

                ///
                /// Analyse des moyens de payment
                ///
                StringGridFigures.Cells[3, 0] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 0]) + RemoteDB.netshop_sales.FieldByName('sales_paid_cash')
                  .AsFloat, fffixed, 7, 2);
                StringGridFigures.Cells[3, 2] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 2]) + RemoteDB.netshop_sales.FieldByName('sales_paid_proton')
                  .AsFloat, fffixed, 7, 2);
                StringGridFigures.Cells[3, 1] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 1]) + RemoteDB.netshop_sales.FieldByName('sales_paid_bct')
                  .AsFloat, fffixed, 7, 2);
                StringGridFigures.Cells[3, 3] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 3]) + RemoteDB.netshop_sales.FieldByName('sales_paid_visa')
                  .AsFloat, fffixed, 7, 2);
                StringGridFigures.Cells[3, 4] :=
                  FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 4]) + RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').AsFloat, fffixed, 7, 2);
                StringGridFigures.Cells[3, 5] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 4]) + StrToFloat(StringGridFigures.Cells[3, 3]) +
                  StrToFloat(StringGridFigures.Cells[3, 2]) + StrToFloat(StringGridFigures.Cells[3, 1]) + StrToFloat(StringGridFigures.Cells[3, 0]),
                  fffixed, 7, 2);
                RemoteDB.netshop_items_sold.First;
                CurrentSaleSubTot := 0;
                while not RemoteDB.netshop_items_sold.Eof do
                begin
                  ///
                  /// Analyse de la nature des produits
                  ///
                  if (RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 100000) and
                    (RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger < 10000) then
                  begin
                    if RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value]) then
                    begin
                      if RemoteDB.Products.FieldByName('products_promo').AsString <> 'True' then
                        LowMargin := False
                      else
                        LowMargin := True;
                    end;
                    if not LowMargin then
                    begin
                      StringGridFigures.Cells[1, 0] :=
                        FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 0]) + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').AsFloat *
                        RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger, fffixed, 7, 2);
                    end else begin
                      StringGridFigures.Cells[1, 2] :=
                        FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 2]) + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').AsFloat *
                        RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger, fffixed, 7, 2);
                    end;
                  end else begin
                    StringGridFigures.Cells[1, 1] :=
                      FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 1]) + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat *
                      RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger, fffixed, 7, 2);
                  end;

                  StringGridFigures.Cells[1, 5] := FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 0]) + StrToFloat(StringGridFigures.Cells[1, 1]) +
                    StrToFloat(StringGridFigures.Cells[1, 2]) + StrToFloat(StringGridFigures.Cells[1, 3]) + StrToFloat(StringGridFigures.Cells[1, 4]),
                    fffixed, 7, 2);
                  ///
                  /// Comptabilisation des produits dans le Grid
                  ///
                  StringGridAdmin.Cells[0, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Text;
                  StringGridAdmin.Cells[1, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_name').Text;
                  StringGridAdmin.Cells[2, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').Text;
                  StringGridAdmin.Cells[3, StringGridAdmin.RowCount - 1] :=
                    FloatToStrF(RemoteDB.netshop_items_sold.FieldByName('items_sold_price_catalog').AsFloat, fffixed, 7, 2);
                  StringGridAdmin.Cells[4, StringGridAdmin.RowCount - 1] :=
                    FloatToStrF(RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').AsFloat, fffixed, 7, 2);
                  StringGridAdmin.Cells[5, StringGridAdmin.RowCount - 1] :=
                    FloatToStrF(RemoteDB.netshop_items_sold.FieldByName('items_sold_price_gross').AsFloat, fffixed, 7, 2);
                  StringGridAdmin.Cells[6, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_date_in').Text;
                  StringGridAdmin.Cells[7, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').Text;
                  StringGridAdmin.Cells[8, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').Text;
                  StringGridAdmin.Cells[9, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_sales_id').Text;
                  if RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString]) then
                  begin
                    if RemoteDB.Productsproducts_tax_class_id.AsFloat = 2 then
                      StringGridAdmin.Cells[10, StringGridAdmin.RowCount - 1] := '6';
                    if RemoteDB.Productsproducts_tax_class_id.AsFloat = 1 then
                      StringGridAdmin.Cells[10, StringGridAdmin.RowCount - 1] := '21';
                  end else begin
                    ShowMessage('Produit supprim ' + RemoteDB.netshop_items_sold.FieldByName('items_sold_model').AsString);
                    StringGridAdmin.Cells[10, StringGridAdmin.RowCount - 1] := '21';
                  end;
                  StringGridAdmin.RowCount := StringGridAdmin.RowCount + 1;
                  ///
                  /// Analyse concordance Montants Items et Sales
                  ///
                  CurrentSaleSubTot := CurrentSaleSubTot + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').AsFloat *
                    RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsFloat;
                  Application.ProcessMessages;
                  RemoteDB.netshop_items_sold.Next;
                end;
              end;
              ActualSaleSubTot := RemoteDB.netshop_sales.FieldByName('sales_paid_total').AsFloat;
              if not(ActualSaleSubTot = CurrentSaleSubTot) then
              begin
                messagedlg('La Vente ' + RemoteDB.netshop_sales.FieldByName('sales_id').AsString + ' pose problme. Total produits = ' +
                  FloatToStr(CurrentSaleSubTot) + ' <> total vente = ' + RemoteDB.netshop_sales.FieldByName('sales_paid_total').AsString, mtwarning, [mbok], 0)
              end;
              Application.ProcessMessages;
              RemoteDB.netshop_sales.Next;
            end;
          finally

            RemoteDB.netshop_items_sold.Filter   := '';
            RemoteDB.netshop_items_sold.Filtered := False;
            RemoteDB.netshop_sales.Filter        := '';
            RemoteDB.netshop_sales.Filtered      := False;
            // RemoteDB.netshop_sales.FieldByName('.IndexName:=STempIndex;
            // RemoteDB.Items_sold.IndexName:=ITempIndex;
            RemoteDB.netshop_sales.EnableControls;
            RemoteDB.netshop_items_sold.EnableControls;
            if StringGridAdmin.RowCount > 2 then
              StringGridAdmin.RowCount := StringGridAdmin.RowCount - 1;
            Screen.Cursor              := crDefault;
            RemoteDB.IsUpdating        := UpdateStatus;
            self.Enabled               := True;
            StringGridAdmin.EndUpdate;
            // StringGridFigures.EndUpdate;
            MainForm.Cursor := crDefault;
          end
        else
          ShowMessage('Selection trop large, veuillez utiliser une autre plage de dates');
      end;

      procedure TMainForm.JvLookOutButtonPaymentAnalysis(Sender: TObject);
      var
        ITempIndex, STempIndex: string;
        LowMargin: Boolean;
        CurrentSaleSubTot, ActualSaleSubTot: currency;
        i: Integer;
        margin: Double;
        UpdateStatus: Boolean;

      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Analyse des ventes paiements';
        RemoteDB.CDSActions.Post;
        UpdateStatus := RemoteDB.IsUpdating;
        // Self.Enabled:=False;
        if not RemoteDB.IsUpdating then
          RemoteDB.IsUpdating := True;

        StringGridAdmin.RowCount := 2;

        StringGridAdmin.Clear;

        StringGridAdmin.ColCount    := 10;
        StringGridAdmin.Cells[0, 0] := 'Id';
        StringGridAdmin.Cells[1, 0] := 'Total';
        StringGridAdmin.Cells[2, 0] := 'Cash';
        StringGridAdmin.Cells[3, 0] := 'Banque';
        StringGridAdmin.Cells[4, 0] := 'Bancontact';
        StringGridAdmin.Cells[5, 0] := 'Visa';
        StringGridAdmin.Cells[6, 0] := 'Bon';
        StringGridAdmin.Cells[9, 0] := 'Id';

        // Resize Columns
        StringGridAdmin.ColWidths[0]   := 95;
        StringGridAdmin.ColWidths[1]   := Max(StringGridAdmin.ClientWidth - 100 - (StringGridAdmin.ColCount - 2) * 60, 150);
        for i                          := 2 to StringGridAdmin.ColCount - 1 do
          StringGridAdmin.ColWidths[i] := 60;

        // StringGridAdmin.BeginUpdate;
        StringGridFiguresClear;
        Application.ProcessMessages;

        // StringGridAdmin.BeginUpdate;

        STempIndex := RemoteDB.netshop_sales.IndexName;
        ITempIndex := RemoteDB.netshop_items_sold.IndexName;
        RemoteDB.FreeItemsTo;
        RemoteDB.SetItemstoSales;
        RemoteDB.netshop_sales.IndexName := 'SalesIXLocationId';
        RemoteDB.netshop_sales.Filter    := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< sales_date_time and sales_date_time < ' +
          FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (sales_location = ' + inttostr(ConnectedShop) + ')';
        RemoteDB.netshop_sales.Filtered := True;

        if ((RemoteDB.netshop_sales.RecordCount < 10000)) then
          try
            Screen.Cursor := crHourglass;
            RemoteDB.netshop_sales.First;
            while not RemoteDB.netshop_sales.Eof do
            begin

              ///
              /// Analyse des moyens de payment
              ///
              StringGridFigures.Cells[3, 0] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 0]) + RemoteDB.netshop_sales.FieldByName('sales_paid_cash')
                .AsFloat, fffixed, 7, 2);
              StringGridFigures.Cells[3, 2] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 2]) + RemoteDB.netshop_sales.FieldByName('sales_paid_proton')
                .AsFloat, fffixed, 7, 2);
              StringGridFigures.Cells[3, 1] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 1]) + RemoteDB.netshop_sales.FieldByName('sales_paid_bct')
                .AsFloat, fffixed, 7, 2);
              StringGridFigures.Cells[3, 3] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 3]) + RemoteDB.netshop_sales.FieldByName('sales_paid_visa')
                .AsFloat, fffixed, 7, 2);
              StringGridFigures.Cells[3, 4] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 4]) + RemoteDB.netshop_sales.FieldByName('sales_paid_voucher')
                .AsFloat, fffixed, 7, 2);
              StringGridFigures.Cells[3, 5] := FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 4]) + StrToFloat(StringGridFigures.Cells[3, 3]) +
                StrToFloat(StringGridFigures.Cells[3, 2]) + StrToFloat(StringGridFigures.Cells[3, 1]) + StrToFloat(StringGridFigures.Cells[3, 0]),
                fffixed, 7, 2);
              ///
              /// Comptabilisation des produits dans le Grid
              ///
              StringGridAdmin.Cells[0, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_id').Text;
              StringGridAdmin.Cells[1, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_paid_total').Text;
              StringGridAdmin.Cells[2, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_paid_cash').Text;
              StringGridAdmin.Cells[3, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_paid_proton').Text;
              StringGridAdmin.Cells[4, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_paid_BCT').Text;
              StringGridAdmin.Cells[5, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_paid_visa').Text;
              StringGridAdmin.Cells[6, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_paid_voucher').Text;
              StringGridAdmin.Cells[9, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_sales.FieldByName('sales_id').Text;
              StringGridAdmin.RowCount := StringGridAdmin.RowCount + 1;

              Application.ProcessMessages;
              RemoteDB.netshop_sales.Next;
            end;
          finally

            RemoteDB.netshop_sales.Filter   := '';
            RemoteDB.netshop_sales.Filtered := False;

            if StringGridAdmin.RowCount > 2 then
              StringGridAdmin.RowCount := StringGridAdmin.RowCount - 1;
            Screen.Cursor              := crDefault;
            RemoteDB.IsUpdating        := UpdateStatus;

          end
        else
          ShowMessage('Selection trop large, veuillez utiliser une autre plage de dates');
      end;

      procedure TMainForm.JvLookOutButton3Click(Sender: TObject);
      var
        TempIndex, Hello, code: string;
        check: Integer;
        CLDGate: CatalogSoap;
      begin

        StringGridAdmin.Clear;
        StringGridAdmin.RowCount    := 2;
        StringGridAdmin.Cells[0, 0] := 'Modle';
        StringGridAdmin.Cells[1, 0] := 'Description';
        StringGridAdmin.Cells[2, 0] := 'Quantit';
        StringGridAdmin.Cells[3, 0] := 'P. catalogue';
        StringGridAdmin.Cells[4, 0] := 'P. stock';
        StringGridAdmin.Cells[5, 0] := 'P. achat';
        StringGridAdmin.Cells[6, 0] := 'Date entre';
        StringGridAdmin.Cells[7, 0] := 'Propritaire';
        StringGridAdmin.Cells[8, 0] := 'Fournisseur';
        Screen.Cursor               := crHourglass;
        StringGridFiguresClear;
        Application.ProcessMessages;

        StringGridAdmin.BeginUpdate;
        TempIndex                        := RemoteDB.netshop_sales.IndexName;
        RemoteDB.netshop_sales.IndexName := 'SalesIXLocationId';
        RemoteDB.netshop_sales.Filter    := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< sales_date_time and sales_date_time < ' +
          FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (sales_location = ' + inttostr(ConnectedShop) + ')';
        RemoteDB.netshop_sales.Filtered := True;
        RemoteDB.netshop_items_sold.DisableControls;

        try
          RemoteDB.netshop_sales.First;
          while not RemoteDB.netshop_sales.Eof do
          begin
            if (True) then
            begin
              ///
              /// Analyse des moyens de payment
              ///
              RemoteDB.netshop_items_sold.First;
              while not RemoteDB.netshop_items_sold.Eof do
              begin
                ///
                /// Analyse de la nature des produits
                ///
                RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value]);

                if (RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 100000) and
                  (RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger < 100000) and
                  (RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat < RemoteDB.netshop_items_sold.FieldByName
                  ('items_sold_price_catalog').AsFloat * 1.20) then
                begin
                  if RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 100000 then
                  begin
                    if RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value]) then
                    begin
                      // if RemoteDB.Products.Locate('products_model',RemoteDB.items_sold.Fieldbyname('items_sold_model').Value,[]) then begin
                      if RemoteDB.Products.FieldByName('products_promo').AsString <> 'True' then
                      begin
                        StringGridFigures.Cells[1, 0] :=
                          FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 0]) + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat *
                          RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger, fffixed, 7, 2);
                      end;
                    end;
                  end else begin
                    StringGridFigures.Cells[1, 1] :=
                      FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 1]) + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').AsFloat *
                      RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').Value, fffixed, 7, 2);
                  end;
                  // if RemoteDB.Products.Locate('products_model',RemoteDB.items_sold.Fieldbyname('items_sold_model').Value,[]) then begin
                  if RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 100000 then
                  begin
                    if RemoteDB.Products.FieldByName('products_promo').AsString = 'True' then
                    begin
                      StringGridFigures.Cells[1, 2] :=
                        FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 2]) + RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').AsFloat *
                        RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsInteger, fffixed, 7, 2);
                    end;
                  end;

                  StringGridFigures.Cells[1, 5] := FloatToStrF(StrToFloat(StringGridFigures.Cells[1, 0]) + StrToFloat(StringGridFigures.Cells[1, 1]) +
                    StrToFloat(StringGridFigures.Cells[1, 2]) + StrToFloat(StringGridFigures.Cells[1, 3]) + StrToFloat(StringGridFigures.Cells[1, 4]),
                    fffixed, 7, 2);

                  StringGridFigures.Cells[3, 0] :=
                    FloatToStrF(StrToFloat(StringGridFigures.Cells[3, 0]) +
                    (RemoteDB.CalcPriceVATIN(RemoteDB.netshop_items_sold.FieldByName('items_sold_price_catalog').AsFloat,
                    RemoteDB.Products.FieldByName('products_tax_class_id').Value) - RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat),
                    fffixed, 7, 2);

                  ///
                  /// Comptabilisation des produits dans le Grid
                  ///
                  StringGridAdmin.Cells[1, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_name').Text;
                  StringGridAdmin.Cells[0, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Text;
                  StringGridAdmin.Cells[2, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').Text;
                  StringGridAdmin.Cells[3, StringGridAdmin.RowCount - 1] :=
                    FloatToStr(RemoteDB.netshop_items_sold.FieldByName('items_sold_price_catalog').AsFloat * 1.21);
                  StringGridAdmin.Cells[4, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_price_Stock').Text;
                  StringGridAdmin.Cells[5, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_price_gross').Text;
                  StringGridAdmin.Cells[7, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').Text;
                  StringGridAdmin.Cells[8, StringGridAdmin.RowCount - 1] := RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').Text;
                  StringGridAdmin.Cells[6, StringGridAdmin.RowCount - 1] := datetimetostr(RemoteDB.netshop_sales.FieldByName('sales_date_time_value').Value);
                  StringGridAdmin.RowCount := StringGridAdmin.RowCount + 1;
                end; // if
                RemoteDB.netshop_items_sold.Next;
              end; // while
            end;
            RemoteDB.netshop_sales.Next;
          end;
        finally
          RemoteDB.netshop_items_sold.Filter   := '';
          RemoteDB.netshop_items_sold.Filtered := False;
          RemoteDB.netshop_sales.Filter        := '';
          RemoteDB.netshop_sales.Filtered      := False;
          RemoteDB.netshop_sales.IndexName     := TempIndex;
          RemoteDB.netshop_sales.EnableControls;
          RemoteDB.netshop_items_sold.EnableControls;
          if StringGridAdmin.RowCount > 2 then
            StringGridAdmin.RowCount := StringGridAdmin.RowCount - 1;
          StringGridAdmin.EndUpdate;
          Screen.Cursor := crDefault;
        end;
      end;

      procedure TMainForm.ActionDBProductsVisibilityExecute(Sender: TObject);
      var
        TempIX: string;
        Archived: Boolean;
        Months, SaleIdMin: Integer;
      begin
        Months := 8;

        TempIX                           := RemoteDB.netshop_stock.IndexName;
        RemoteDB.netshop_stock.IndexName := 'StockIXModelLocation';
        RemoteDB.Products.DisableControls;
        RemoteDB.netshop_stock.DisableControls;

        RemoteDB.netshop_sales.Filter   := 'sales_date_time > ' + inttostr(Round(Now - Months * 30));
        RemoteDB.netshop_sales.Filtered := True;
        RemoteDB.netshop_sales.First;
        SaleIdMin                       := RemoteDB.netshop_sales.FieldByName('sales_id').AsInteger;
        RemoteDB.netshop_sales.Filtered := False;
        RemoteDB.netshop_sales.Filter   := '';

        try
          with RemoteDB do
          begin

            Products.First;
            while not Products.Eof do
            begin
              if Products.FieldByName('products_status').AsInteger <> 1 then
              begin
                Products.Edit;
                Products.FieldByName('products_status').AsInteger := 1;
                Products.Post;
              end;
              Products.Next;
            end;
            //
            // Invisibilit des oldies non en stock
            //

            Products.First;
            while not Products.Eof do
            begin
              Archived := False;
              if not IsInArchives(Products.FieldByName('products_model').AsString) then
              begin
                // Vieux
                if not((Products.FieldByName('products_date_added').AsDateTime > (Now - Months * 30))) then
                begin
                  RemoteDB.netshop_items_sold.Filter := '(items_sold_sales_id > ' + inttostr(SaleIdMin) + ') and (items_sold_model = ' +
                    Products.FieldByName('products_model').AsString + ')';
                  RemoteDB.netshop_items_sold.Filtered := True;
                  if RemoteDB.netshop_items_sold.RecordCount > Months then
                  begin
                    if messagedlg('Mettre le produit ' + RemoteDB.Products.FieldByName('products_intername').Text + ' vendu 1 x par mois aux archives ?',
                      mtwarning, [mbyes, mbno], 0) = mryes then
                    begin
                      MoveToArchives(RemoteDB.Products.FieldByName('Products_model').AsString);
                      Archived := True;
                    end;
                  end else begin
                    MoveToArchives(RemoteDB.Products.FieldByName('Products_model').AsString);
                    Archived := True;
                  end;

                end else begin
                  // messagedlg('le produit '+CDSProDescFR.FieldByName('products_name').AsString+' '+FloattoStr(Products.FieldByName('products_date_added').AsDateTime)+' Non archiv',mtwarning,[mbyes,mbNo],0)
                end;
                // Sans Image
                if (Products.FieldByName('products_image').AsString = 'products/default.gif') and (Archived = False) then
                begin
                  if messagedlg('Mettre le produit ' + Products.FieldByName('products_intername').Text + ' sans image en archive', mtwarning, [mbyes, mbno], 0)
                    = mryes then
                  begin
                    MoveToArchives(Products.FieldByName('Products_model').AsString);
                    // Archived:=True;
                  end;
                end;
              end;
              RemoteDB.Products.Next;
            end;

          end;
        finally
          // Self.Enabled:=True;
          RemoteDB.Products.EnableControls;
          RemoteDB.netshop_stock.EnableControls;
          RemoteDB.netshop_stock.IndexName     := TempIX;
          RemoteDB.netshop_items_sold.Filter   := '';
          RemoteDB.netshop_items_sold.Filtered := False;
        end;
      end;

      procedure TMainForm.SpeedButtonToArchivesClick(Sender: TObject);
      begin
        RemoteDB.MoveToArchives(RemoteDB.Products.FieldByName('products_model').AsString);
      end;

      procedure TMainForm.SpeedButtonToLiveClick(Sender: TObject);
      begin
        RemoteDB.RestoreFromArchives(RemoteDB.Products.FieldByName('products_model').AsString);
      end;


      procedure TMainForm.dxBarButtonUkClick(Sender: TObject);
      begin
        FormEnterLibrary.ShowModal;
      end;

      procedure TMainForm.dxBarLargeButtonFullSyncClick(Sender: TObject);
      begin
        // Self.Enabled:=False;
        try
          begin
            if TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType = sitGreen then
            begin;
              RemoteDB.Synchronise;
            end else begin
              messagedlg('Serveur DB Inacessible : ', mtwarning, [mbok], 0);
            end;
          end;
        finally
          // Self.Enabled:=True;
        end;
      end;

      procedure TMainForm.dxBarLargeButtonSyncPartialClick(Sender: TObject);
      begin
        // Self.Enabled:=False;
        try
          begin
            if TdxStatusBarStateIndicatorPanelStyle(StatusLine.Panels.items[1].PanelStyle).Indicators.items[0].IndicatorType = sitGreen then
            begin;
              RemoteDB.ApplyUpdates;
            end else begin
              messagedlg('Serveur DB Inacessible : ', mtwarning, [mbok], 0);
            end;
          end;
        finally
          // Self.Enabled:=True;
        end;

      end;

      procedure TMainForm.dxBarMRUListItemCustomersClick(Sender: TObject);
      var
        DestCustomer, MruItem: string;
        i: Integer;
      begin
        ClientsExecute(nil);
        MruItem      := dxBarMRUListItemCustomers.items[dxBarMRUListItemCustomers.ItemIndex];
        DestCustomer := '';
        for i        := 1 to Length(MruItem) do
        begin
          if MruItem[i] = ' ' then
            Break;
          DestCustomer := DestCustomer + MruItem[i];
        end;
        RemoteDB.Customers.Locate('customers_nbr', DestCustomer, [locaseinsensitive]);
      end;

      procedure TMainForm.dxBarSubItemCustomersCloseUp(Sender: TObject);
      begin
        AllowMRUClientAccess := True;
      end;

      procedure TMainForm.dxBarSubItemCustomersPopup(Sender: TObject);
      begin
        AllowMRUClientAccess := False;
      end;

      procedure TMainForm.dxbrbtnAlertsMarkAsSentClick(Sender: TObject);
begin
  RemoteDB.AlertsMarkAsNotified
end;

procedure TMainForm.OnUSBCDDeviceChange;
      var
        i, NowCol, Nowrow: Integer;
        DeviceCount: Integer;
        DeviceID: Integer;
      begin
        InitUSBCDLibrary();
        for Nowrow := 1 to StringGridDacal.RowCount - 2 do
        begin
          for NowCol                              := 0 to StringGridDacal.ColCount - 1 do
            StringGridDacal.Cells[NowCol, Nowrow] := '';
        end;
        StringGridDacal.RowCount := 2;
        DeviceCount              := GetDeviceNumber;
        for i                    := 0 to DeviceCount - 1 do
        begin
          DeviceID := EnumDevice(i);
          StringGridDacal.Cells[0, StringGridDacal.RowCount - 1] := inttostr(DeviceID);
          StringGridDacal.Cells[1, StringGridDacal.RowCount - 1] := inttostr(i + 1);
          StringGridDacal.AddRow;
        end;
      end;

      procedure TMainForm.OnUSBCDDeviceChangeNotify(var msg: TMessage);
      begin
        OnUSBCDDeviceChange;
      end;

      procedure TMainForm.dxBarButtonNLClick(Sender: TObject);
      begin
        FormExitlibrary.ShowModal;
      end;

      procedure TMainForm.dxBarButtonProductsClick(Sender: TObject);
      begin
        Produits.Execute;
        self.dxBarButtonSearchLocalClick(nil);
      end;


      procedure TMainForm.ActionCustomerRentAllExecute(Sender: TObject);
      begin
        RemoteDB.netshop_rent_transaction.Filter   := '';
        RemoteDB.netshop_rent_transaction.Filtered := True;
        RadioButtonCustomerRentAll.Checked         := True;
      end;

      procedure TMainForm.ActionCustomerRentPendingExecute(Sender: TObject);
      begin
        RemoteDB.netshop_rent_transaction.Filter   := 'rent_transaction_returned = 0';
        RemoteDB.netshop_rent_transaction.Filtered := True;
        RadioButtonCustomerRentPending.Checked     := True;
      end;

      procedure TMainForm.ActionCustomerRentClosedExecute(Sender: TObject);
      begin
        RemoteDB.netshop_rent_transaction.Filter   := 'rent_transaction_returned = 1';
        RemoteDB.netshop_rent_transaction.Filtered := True;
        RadioButtonCustomerRentClosed.Checked      := True;
      end;

      procedure TMainForm.InvClick(Sender: TObject);
      begin
        RemoteDB.Inventory.DisableControls;
        RemoteDB.Inventory.IndexFieldNames := 'product_model';
        RemoteDB.Inventory.First;
        while not RemoteDB.Inventory.Eof do
        begin
          RemoteDB.Inventory.Edit;
          if RemoteDB.Products.Locate('products_model', UpperCase(RemoteDB.Inventoryproduct_model.AsString), [locaseinsensitive]) then
          begin
            RemoteDB.Inventory.FieldByName('product_price_gross').AsFloat := RemoteDB.Products.FieldByName('products_cldprice').AsFloat;
          end;
          RemoteDB.Inventory.Post;
          RemoteDB.Inventory.Next;
        end;
        RemoteDB.Inventory.EnableControls;
      end;

      procedure TMainForm.Corriger1Click(Sender: TObject);
      var
        i, selindex, Asavepoint: Integer;
        aSalesCorrectForm: TSalesCorrectForm;
      begin
        if (StringGridAdmin.Selection.Top < StringGridAdmin.RowCount) and (StringGridAdmin.Selection.Top >= 0) then
        begin
          try
            RemoteDB.IsUpdating := True;
            if not RemoteDB.netshop_sales.Locate('sales_id', StrtoInt(StringGridAdmin.Cells[9, StringGridAdmin.Selection.Top]), []) then
              exit;
            Asavepoint        := RemoteDB.netshop_sales.SavePoint;
            aSalesCorrectForm := TSalesCorrectForm.Create(self);
            try
              aSalesCorrectForm.InitValue.Caption := RemoteDB.netshop_sales.FieldByName('sales_paid_total').AsString;
              if aSalesCorrectForm.ShowModal <> mrOK then
                RemoteDB.netshop_sales.SavePoint := Asavepoint;
            finally
              aSalesCorrectForm.Free;
            end;
          finally
            RemoteDB.IsUpdating := False;
          end;
        end;
      end;

      procedure TMainForm.ButtonProductsSetPriceClick(Sender: TObject);
      begin
        RemoteDB.SetProductPrice(EditProductNewPrice.Value);
      end;

      procedure TMainForm.DBEditCustomerPCodeExit(Sender: TObject);
      var
        pcode: string;

      begin
        pcode := ClearPhoneNbr(DBEditCustomerPCode.Text);
        if pcode <> '' then
          if RemoteDB.Cities.FindKey([StrtoInt(pcode)]) then
          begin
            RemoteDB.Cities.Filter   := 'Postcode = ' + ClearPhoneNbr(DBEditCustomerPCode.Text);
            RemoteDB.Cities.Filtered := True;
            DBComboCustomerCity.Properties.items.Clear;
            while not RemoteDB.Cities.Eof do
            begin
              DBComboCustomerCity.Properties.items.Add(RemoteDB.CitiesName.AsString);
              RemoteDB.Cities.Next;
            end;
            DBComboCustomerCity.Properties.ImmediateDropDown := True;

            { if RemoteDB.Customers.State=dsEdit then begin
              RemoteDB.Address_Book.Edit;
              RemoteDB.Address_Bookentry_city.Value:=RemoteDB.CitiesName.Value;
              RemoteDB.Address_Book.Post;
              end;
            }
            RemoteDB.Cities.Filter   := '';
            RemoteDB.Cities.Filtered := False;
          end;
      end;

      procedure TMainForm.DBEditCustomerVATEditing(Sender: TObject; var CanEdit: Boolean);
      begin
        if not cxDBCheckBoxCustIsTVA.Checked then
        begin
          ShowMessage('Veuillez cocher la case assujetti');
          cxDBCheckBoxCustIsTVA.SetFocus;
        end;
      end;

      procedure TMainForm.searchstringKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
      begin
        if Key = 13 then
        begin
          searchstring.Text := searchstring.CurText;
          dxBarButtonSearchLocal.Click;
        end;
      end;

      procedure TMainForm.dxBarButtonBatchPrintClick(Sender: TObject);
      var
        aInvoiceBatchPrintForm: TInvoiceBatchPrintForm;
      begin
        Produits.Execute;
        RemoteDB.FreeInvoicesToCustomers;
        aInvoiceBatchPrintForm := TInvoiceBatchPrintForm.Create(self);
        try
          aInvoiceBatchPrintForm.ShowModal;
        finally
          aInvoiceBatchPrintForm.Free;
        end;
      end;

      procedure TMainForm.CustomersInvoiceMailClick(Sender: TObject);
      var
        title, FileName: string;
        Body: TStringList;
        i: Integer;
        aSendEmail: TSmartSendEmail;
      begin
        // Prparation du rapport
        ChDir(ExtractFilePath(ParamStr(0)));
        title := 'Facture N ' + RemoteDB.netshop_invoices.FieldByName('invoices_location').AsString + '-' +
          RemoteDB.netshop_invoices.FieldByName('invoices_id').AsString;
        FileName := 'reports\invoices\Facture_' + RemoteDB.netshop_invoices.FieldByName('invoices_location').AsString + '-' +
          RemoteDB.netshop_invoices.FieldByName('invoices_id').AsString + '.pdf';

        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInvoice', True);

        ReportModule.RvProject.SetParam('TVA6', FloatToStr(RemoteDB.CalcInvoiceTVA(6)));
        ReportModule.RvProject.SetParam('TVA21', FloatToStr(RemoteDB.CalcInvoiceTVA(21)));
        ReportModule.RvProject.SetParam('BASE6', FloatToStr(RemoteDB.CalcInvoiceTVABASE(6)));
        ReportModule.RvProject.SetParam('BASE21', FloatToStr(RemoteDB.CalcInvoiceTVABASE(21)));
        Randomize;
        i := trunc(Random(RemoteDB.Tips.RecordCount));
        RemoteDB.Tips.First;
        if not RemoteDB.Tips.Eof then
        begin
          while i <> 0 do
          begin
            RemoteDB.Tips.Next;
            i := i - 1;
          end;
          ReportModule.RvProject.SetParam('Conditions', RemoteDB.TipsTipsText.AsString);
        end
        else
          ReportModule.RvProject.SetParam('Conditions', '');

        if RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat > 0 then
        begin
          ReportModule.RvProject.SetParam('URL', 'COMMUNICATION : SMARTFACT*' + RemoteDB.netshop_invoices.FieldByName('invoices_customer_id').AsString + '*' +
            RemoteDB.netshop_invoices.FieldByName('invoices_location').AsString + '-' + RemoteDB.netshop_invoices.FieldByName('invoices_id').AsString);
        end else begin
          ReportModule.RvProject.SetParam('URL', WEBURL);
        end;

        ReportModule.RvSystem.DefaultDest    := rdFile;
        ReportModule.RvSystem.DoNativeOutput := False;
        ReportModule.RvSystem.RenderObject   := ReportModule.RvRenderPDF;
        ReportModule.RvSystem.OutputFileName := FileName;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
        ReportModule.RvSystem.Execute;
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;

        // Corps du message
        Body := TStringList.Create;
        Body.Add(('Ce message contient en pice jointe une facture au format Adobe PDF' + chr(13) + chr(10)));
        Body.Add(ShopData1.Text);
        Body.Add(ShopData2.Text);
        Body.Add(ShopData3.Text);
        Body.Add(ShopData4.Text);
        Body.Add(ShopData5.Text);

        // Prepare le corps de l email
        aSendEmail := TSmartSendEmail.Create(ShopData1.Text, ShopData5.Text, RemoteDB.Customerscustomers_email_address.AsString, title, FileName, Body);
        Body.Free;
      end;

      procedure TMainForm.edsearchKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
      var
        ExactMatch: Boolean;
        ANotifyServer: TNotifyServer;
      begin
        if (Key = VK_DELETE) or (Key = VK_BACK) then
        begin
          if Length(Edsearch.Text) > 0 then
          begin;
            // onchange event should not be executed...
            edfromcode := True;
          end;
        end;

        if Key = 13 then
        begin
          if RemoteDB.netshop_customers_alerts.Locate('customers_alerts_customers_nbr;customers_alerts_products_model',
            Vararrayof([RemoteDB.CustomersCustomers_nbr.AsString, RemoteDB.Productsproducts_model.AsString]), [locaseinsensitive]) then
          begin
            if messagedlg('Client dj inscrit ? Voulez-vous rajouter un article supplmentaire ?', mtwarning, [mbyes, mbno], 0, mbno) = mryes then
            begin
              RemoteDB.netshop_customers_alerts.Edit;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger :=
                RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger + 1;
              RemoteDB.netshop_customers_alerts.Post;
            end;
            exit;
          end;
          // goto nearest match
          if Sender=Edsearch then begin
          with RemoteDB.Products do
          begin
            IndexName := 'ProductsIXName';
            SetKey;
            FieldByName('products_intername').AsString := Edsearch.Text;
            ExactMatch                                 := GotoKey;
          end;
          end else begin
           with RemoteDB.Products do
          begin
            IndexName := 'ProductsIXModel';
            SetKey;
            FieldByName('products_model').AsString := Edsearch.Text;
            ExactMatch                                 := GotoKey;
          end;
          end;
          if ExactMatch then
          begin
            RemoteDB.netshop_customers_alerts.Append;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString :=
              RemoteDB.Products.FieldByName('products_intername').Text;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := Round(StrtoInt(CustomerAlertMaxPrice.Text));
            RemoteDB.netshop_customers_alerts.Post;
          end else begin
            if messagedlg('Attention pas de reference dans la DB cette commande ne generera pas de SMS', mtwarning, [mbok, mbCancel], 0) = mrOK then
            begin
              RemoteDB.netshop_customers_alerts.Append;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := 'NILL';
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString := Edsearch.Text;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
              RemoteDB.netshop_customers_alerts.Post;
            end;
          end;
          if UserType = 1 then
          begin
            ANotifyServer := TNotifyServer.Create('smsalert', RemoteDB.Customerscustomers_email_address.AsString, '', NOTIFYURL);
          end;
          CustomerAlertMaxPrice.Text := '0';
        end;
      end;

      procedure TMainForm.edsearchChange(Sender: TObject);
      var
        txt, sfind: string;
        len: Integer;
      begin
        // don't do anything if user presses
        // delete or backspace
        RemoteDB.Products.IndexName := 'ProductsIXName';
        if edfromcode = True then
        begin
          edfromcode := False;
          exit;
        end;

        // don't do anything if there is
        // no text in edSearch
        txt := Edsearch.Text;
        if Length(txt) = 0 then
          exit;

        // goto nearest match
        with RemoteDB.Products do
        begin
          SetKey;
          FieldByName('products_intername').AsString := Edsearch.Text;
          GotoNearest;
        end;

        // calculate what part of text should be selected
        sfind := RemoteDB.Products.FieldByName('products_intername').AsString;
        len   := Length(sfind) - Length(txt);
        if len > 0 then
        begin
          edfromcode         := True;
          Edsearch.Text      := sfind;
          Edsearch.SelStart  := Length(txt);
          Edsearch.SelLength := len;
        end;
      end;

      procedure TMainForm.CustomersInvoicePreviewClick(Sender: TObject);
      var
        i: Integer;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInvoice', True);
        ReportModule.RvProject.SetParam('TVA6', FloatToStr(RemoteDB.CalcInvoiceTVA(6)));
        ReportModule.RvProject.SetParam('TVA21', FloatToStr(RemoteDB.CalcInvoiceTVA(21)));
        ReportModule.RvProject.SetParam('BASE6', FloatToStr(RemoteDB.CalcInvoiceTVABASE(6)));
        ReportModule.RvProject.SetParam('BASE21', FloatToStr(RemoteDB.CalcInvoiceTVABASE(21)));
        Randomize;
        i := trunc(Random(RemoteDB.Tips.RecordCount));
        RemoteDB.Tips.First;
        if not RemoteDB.Tips.Eof then
        begin
          while i <> 0 do
          begin
            RemoteDB.Tips.Next;
            i := i - 1;
          end;
          ReportModule.RvProject.SetParam('Conditions', RemoteDB.TipsTipsText.AsString);
        end
        else
          ReportModule.RvProject.SetParam('Conditions', '');

        if RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat > 0 then
        begin
          ReportModule.RvProject.SetParam('URL', 'COMMUNICATION : SMARTFACT*' + RemoteDB.netshop_invoices.FieldByName('invoices_customer_id').AsString + '*' +
            RemoteDB.netshop_invoices.FieldByName('invoices_location').AsString + '-' + RemoteDB.netshop_invoices.FieldByName('invoices_id').AsString);
        end else begin
          ReportModule.RvProject.SetParam('URL', WEBURL);
        end;

        ReportModule.RvSystem.DefaultDest    := rdpreview;
        ReportModule.RvSystem.DoNativeOutput := True;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
        // ReportModule.RvSystem.Execute;

        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
      end;

      procedure TMainForm.SpeedButtonProductsSortDateClick(Sender: TObject);
      begin
        RemoteDB.Products.IndexFieldNames := 'products_date_added';
      end;

      procedure TMainForm.SpeedButton1Click(Sender: TObject);
      begin
        DBDebugExecute(self);
      end;

      procedure TMainForm.SpeedButtonChangeEANClick(Sender: TObject);
      var
        aDialogChangeEanForm: TChangeEanForm;
      begin
        aDialogChangeEanForm := TChangeEanForm.Create(self);
        try
          aDialogChangeEanForm.ShowModal;
        finally
          aDialogChangeEanForm.Free;
        end;
      end;

      procedure TMainForm.SpeedButtonPauseClick(Sender: TObject);
      var
        aSendEmail: TSmartSendEmail;
        aStrings: TStringList;
      begin
        aStrings := TStringList.Create;
        if Screen.Cursor = crNoDrop then
        begin
          RemoteDB.CDSActions.Append;
          RemoteDB.CDSActions.FieldByName('action').AsString := 'Fin pause';
          RemoteDB.CDSActions.Post;
          aSendEmail := TSmartSendEmail.Create(ShopData1.Text, ShopData5.Text, PauseNotification, 'Fin pause ' + ShopData1.Text, '',
            aStrings);
          Screen.Cursor := crDefault;
        end else begin
          RemoteDB.CDSActions.Append;
          RemoteDB.CDSActions.FieldByName('action').AsString := 'Dbut pause';
          RemoteDB.CDSActions.Post;
          aSendEmail := TSmartSendEmail.Create(ShopData1.Text, ShopData5.Text, PauseNotification, 'Dbut pause ' + ShopData1.Text, '',
            aStrings);
          Screen.Cursor := crNoDrop;
        end;

      end;

      procedure TMainForm.SpeedButtonProductSortModelClick(Sender: TObject);
      begin
        RemoteDB.Products.IndexName := 'ProductsIXModel';
      end;

      procedure TMainForm.CustomerAlertMaxPriceEnter(Sender: TObject);
      begin
        CustomerAlertMaxPrice.SelectAll;
      end;

      procedure TMainForm.CustomerAlertMaxPriceKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
      var
        ExactMatch: Boolean;
        ANotifyServer: TNotifyServer;
      begin
        if Key = 13 then
        begin
          if RemoteDB.netshop_customers_alerts.Locate('customers_alerts_customers_nbr;customers_alerts_products_model',
            Vararrayof([RemoteDB.CustomersCustomers_nbr.AsString, RemoteDB.Productsproducts_model.AsString]), [locaseinsensitive]) then
          begin
            ShowMessage('Ce client est deja inscrit pour ce produit');
            exit;
          end;
          // goto nearest match
          with RemoteDB.Products do
          begin
            // SetKey;
            // FieldByName('products_name').AsString:=edSearch.text;
            // ExactMatch:=GotoKey;
          end;
          if ExactMatch then
          begin
            RemoteDB.netshop_customers_alerts.Append;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString :=
              RemoteDB.Products.FieldByName('products_intername').AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
            RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := Round(StrtoInt(CustomerAlertMaxPrice.Text));
            RemoteDB.netshop_customers_alerts.Post;
            if UserType = 1 then
            begin
              ANotifyServer := TNotifyServer.Create('smsalert', RemoteDB.Customerscustomers_email_address.AsString, '', NOTIFYURL);
            end;

          end else begin
            if messagedlg('Attention pas de reference dans la DB cette commande ne generera pas de SMS', mtwarning, [mbok, mbCancel], 0) = mrOK then
            begin
              RemoteDB.netshop_customers_alerts.Append;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := 'NILL';
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString := Edsearch.Text;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
              RemoteDB.netshop_customers_alerts.Post;
            end;
          end;
        end;
      end;

      procedure TMainForm.CustomersInvoiceCancelClick(Sender: TObject);
      var
        aInvoicesCancelItemForm: TInvoicesCancelItemForm;
      begin
        if not(RemoteDB.netshop_invoices.Bof and RemoteDB.netshop_invoices.Eof) then
        begin
          if not(RemoteDB.netshop_invoices_items.Eof and RemoteDB.netshop_invoices_items.Bof) then
          begin
            if RemoteDB.netshop_invoices.FieldByName('invoices_closed').Value <> 1 then
            begin
              aInvoicesCancelItemForm := TInvoicesCancelItemForm.Create(self);
              try
                aInvoicesCancelItemForm.ShowModal;
              finally
                aInvoicesCancelItemForm.Free;
              end;
            end else begin
              // Invoice Closed
              messagedlg('La facture est cloture', mtwarning, [mbok], 0);
            end;
          end else begin
            // No invoices Items
            messagedlg('La facture est vide', mtwarning, [mbok], 0);
          end;
        end else begin
          // No invoice
          messagedlg('Aucune facture disponnible', mtwarning, [mbok], 0);
        end;
      end;

      procedure TMainForm.dxBarButtonFrenchClick(Sender: TObject);
      begin
        RemoteDB.TimerSaveDBTimer(nil);
      end;

      procedure TMainForm.dxBarButtonInvendusClick(Sender: TObject);
      var
        aReportSQL: TReportSQL;
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Rapport invendus depot';
        RemoteDB.CDSActions.Post;
        with RemoteDB.SQLQuery do
        begin
          CommandText := 'SELECT products_root_category_name as Plateforme, product_model as Modele,';
          CommandText := CommandText + ' product_name as Nom , product_owner_id as Proprio, product_price_stock as PStock, product_date_in as DateIn ';
          CommandText := CommandText +
            ' FROM netshop_stock inner join products on products.products_model=netshop_stock.product_model WHERE `product_owner_id` >= 100000 AND `product_location` =  '
            + inttostr(ConnectedShop);
          CommandText := CommandText + ' and product_date_in < ' + VCLToOSCDate(Now - 365);
          CommandText := CommandText + ' order by products_root_category_name, product_date_in';
        end;
        aReportSQL := TReportSQL.Create(self);
        try
          aReportSQL.CDSReport.Open;
          aReportSQL.cxGridReportDBTableViewReport.DataController.CreateAllItems(True);
          aReportSQL.ShowModal;
        finally
          aReportSQL.Free;
        end;
      end;

      procedure TMainForm.JvLookOutButtonReassortClick(Sender: TObject);
      var
        aReorderForm: TReorderForm;
        i, j, InStock, OutStock: Integer;
      begin
        AdvPageControlBrowser.ActivePage := AdvTabSheetBrowserCLD;
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_callishop.aspx?ishopmethod=loginCustomer2&C_ID=' + GlobalsUnit.CLDLogin + '&C_PW='+GlobalsUnit.CLDPass);
        aReorderForm                     := TReorderForm.Create(self);

        try
          RemoteDB.SetItemstoSales;
          RemoteDB.netshop_sales.IndexName := 'SalesIXLocationId';
          RemoteDB.netshop_sales.Filter    := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< sales_date_time and sales_date_time < ' +
            FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (sales_location = ' + inttostr(ConnectedShop) + ')';
          RemoteDB.netshop_sales.Filtered       := True;
          RemoteDB.netshop_items_sold.IndexName := 'ItemsIXLocationId';
          RemoteDB.netshop_items_sold.DisableControls;
          RemoteDB.Products.IndexName := 'ProductsIXModel';
          RemoteDB.Products.Filtered  := False;

          RemoteDB.netshop_stock.IndexName := 'StockIXModelLocation';
          RemoteDB.netshop_stock.Filter    := 'product_owner_id<100000 and product_supplier_id<100000';
          RemoteDB.netshop_stock.Filtered  := True;

          RemoteDB.Transferout.Filter := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< date_time and date_time < ' +
            FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (product_origin = ' + inttostr(ConnectedShop) + ')';
          RemoteDB.Transferout.Filtered := True;

          ProgressBar.Visible := True;
          i                   := 0;
          j                   := RemoteDB.netshop_sales.RecordCount + RemoteDB.Transferout.RecordCount;
          if j > 0 then
            ProgressBar.Position := (i / (j) * 100);
          aReorderForm.TableData.Close;
          aReorderForm.TableData.Open;

          // Parse the sales of the day
          while not RemoteDB.netshop_sales.Eof do
          begin
            RemoteDB.netshop_items_sold.First;
            while not RemoteDB.netshop_items_sold.Eof do
            begin
              if ((RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger < 10000) and
                (RemoteDB.netshop_items_sold.FieldByName('items_sold_supplier_id').AsInteger < 10000)) then
              begin
                if not RemoteDB.netshop_stock.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value, ConnectedShop]) then
                begin
                  RemoteDB.Products.FindKey([RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value]);
                  if RemoteDB.Products.FieldByName('products_esd').AsInteger = 0 then

                    if not aReorderForm.TableData.Locate('EAN', RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value, [locaseinsensitive]) then
                    begin
                      aReorderForm.TableData.Append;
                      aReorderForm.TableDataEAN.Value := RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value;
                      aReorderForm.TableDataNom.Value := RemoteDB.Products.FieldByName('products_intername').AsString;
                      aReorderForm.TableDataRootCategoryName.Value := RemoteDB.Productsproducts_root_category_name.Value;
                      aReorderForm.TableDataQuantity.Value := 0;
                      aReorderForm.TableDataQSTOCK.Value := 0;
                      if not VarIsNull(RemoteDB.Products.FieldByName('products_CLD_id').Value) then
                      begin
                        aReorderForm.TableDataConfirmBO.Value := True;
                        aReorderForm.TableDataIDART.Value := RemoteDB.Productsproducts_CLD_id.AsString;
                      end else begin
                        aReorderForm.TableDataIDART.AsString := '00000';
                        aReorderForm.TableDataConfirmBO.Value := False;
                      end;
                      RemoteDB.CheckExtStock(RemoteDB.netshop_items_sold.FieldByName('items_sold_model').Value, InStock, OutStock);
                      aReorderForm.TableDataGroupAvailable.AsInteger := InStock;
                      aReorderForm.TableDataAvailable.AsInteger := OutStock;
                      aReorderForm.TableData.FieldByName('QCLD').AsInteger := RemoteDB.Products.FieldByName('products_cld_stock').Value;
                      aReorderForm.TableData.Post;
                    end;
                end;
              end;
              RemoteDB.netshop_items_sold.Next;
            end;
            i                    := i + 1;
            ProgressBar.Position := (i / (RemoteDB.netshop_sales.RecordCount) * 100);
            Application.ProcessMessages;
            RemoteDB.netshop_sales.Next;
          end;

          // Parse the transfered products

          RemoteDB.Transferout.First;
          while not RemoteDB.Transferout.Eof do
          begin

            if not RemoteDB.netshop_stock.FindKey([RemoteDB.transferOutproduct_model.Value, ConnectedShop]) then
            begin
              RemoteDB.Products.FindKey([RemoteDB.transferOutproduct_model.Value]);
              if not aReorderForm.TableData.Locate('EAN', RemoteDB.transferOutproduct_model.Value, [locaseinsensitive]) then
              begin
                aReorderForm.TableData.Append;
                aReorderForm.TableDataEAN.Value := RemoteDB.transferOutproduct_model.Value;
                aReorderForm.TableDataNom.Value := RemoteDB.Products.FieldByName('products_intername').AsString;
                aReorderForm.TableDataRootCategoryName.Value := RemoteDB.Productsproducts_root_category_name.Value;
                aReorderForm.TableDataQuantity.Value := 0;
                if not VarIsNull(RemoteDB.Productsproducts_CLD_id.Value) then
                begin
                  aReorderForm.TableDataConfirmBO.Value := True;
                  aReorderForm.TableDataIDART.Value     := RemoteDB.Productsproducts_CLD_id.AsString;
                end else begin
                  ReorderForm.TableDataIDART.AsString   := '00000';
                  aReorderForm.TableDataConfirmBO.Value := False;
                end;
                RemoteDB.CheckExtStock(RemoteDB.transferOutproduct_model.Value, InStock, OutStock);
                aReorderForm.TableDataGroupAvailable.AsInteger := InStock;
                aReorderForm.TableDataAvailable.AsInteger := OutStock;
                aReorderForm.TableData.Post;
              end;
            end;
            ProgressBar.Position := (i / (j) * 100);
            Application.ProcessMessages;
            RemoteDB.Transferout.Next;
          end;

          aReorderForm.ShowModal;
          RemoteDB.CDSActions.Append;
          RemoteDB.CDSActions.FieldByName('action').AsString := 'Action reassort';
          RemoteDB.CDSActions.Post;
        finally
          RemoteDB.netshop_sales.Filtered      := False;
          RemoteDB.netshop_sales.Filter        := '';
          RemoteDB.netshop_items_sold.Filtered := False;
          RemoteDB.netshop_items_sold.Filter   := '';
          RemoteDB.netshop_items_sold.EnableControls;
          RemoteDB.Transferout.Filtered   := False;
          RemoteDB.Transferout.Filter     := '';
          RemoteDB.netshop_stock.Filter   := '';
          RemoteDB.netshop_stock.Filtered := False;
          ProgressBar.Visible             := False;
          aReorderForm.Free
        end;
        ActionWebInfo.Execute;
      end;

      procedure TMainForm.JvLookOutButtonReorderTopSellersClick(Sender: TObject);
      var
        aReorderForm: TReorderForm;
        i, j, InStock, OutStock: Integer;
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Action reassort bestsellers';
        RemoteDB.CDSActions.Post;
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_callishop.aspx?ishopmethod=loginCustomer2&C_ID=' + GlobalsUnit.CLDLogin + '&C_PW='+GlobalsUnit.CLDPass );
        AdvPageControlBrowser.ActivePage := AdvTabSheetBrowserCLD;
        aReorderForm                     := TReorderForm.Create(self);

        try

          with RemoteDB.SQLQuery do
          begin
            CommandText := 'call TopSellersToOrderByShop(' + inttostr(ConnectedShop) +')';
          end;
          RemoteDB.CDSQuery.Open;

          ProgressBar.Visible := True;
          i                   := 0;
          j                   := RemoteDB.CDSQuery.RecordCount;
          if j > 0 then
          ProgressBar.Position := (i / (j) * 100);
          aReorderForm.TableData.Close;
          aReorderForm.TableData.Open;

          // Parse the sales of the day
          while not RemoteDB.CDSQuery.Eof do
          begin
            RemoteDB.Products.FindKey([RemoteDB.CDSQuery.FieldByName('products_model').Value]);

                    if not aReorderForm.TableData.Locate('EAN', RemoteDB.CDSQuery.FieldByName('products_model').Value, [locaseinsensitive]) then
                    begin
                      aReorderForm.TableData.Append;
                      aReorderForm.TableData.FieldByName('EAN').Value := RemoteDB.CDSQuery.FieldByName('products_model').Value;
                      aReorderForm.TableData.FieldByName('Name').Value := RemoteDB.CDSQuery.FieldByName('products_name').AsString;
                      aReorderForm.TableData.FieldByName('RootCategoryName').Value := RemoteDB.CDSQuery.FieldByName('products_root_category_name').AsString;
                      aReorderForm.TableData.FieldByName('Quantity').Value := RemoteDB.CDSQuery.FieldByName('TOORDER').Value;
                      aReorderForm.TableData.FieldByName('QSTOCK').Value := RemoteDB.CDSQuery.FieldByName('STOCK').Value;

                      if not VarIsNull(RemoteDB.Products.FieldByName('products_CLD_id').Value) then
                      begin
                        aReorderForm.TableData.FieldByName('ConfirmBO').Value := True;
                        aReorderForm.TableData.FieldByName('IDART').Value := RemoteDB.Productsproducts_CLD_id.AsString;
                      end else begin
                        aReorderForm.TableData.FieldByName('IDART').AsString := '00000';
                        aReorderForm.TableData.FieldByName('ConfirmBO').Value := False;
                      end;
                      RemoteDB.CheckExtStock(RemoteDB.CDSQuery.FieldByName('products_model').Value, InStock, OutStock);
                      aReorderForm.TableData.FieldByName('GroupAvailable').AsInteger := InStock;
                      aReorderForm.TableData.FieldByName('Available').AsInteger := OutStock;
                      aReorderForm.TableData.FieldByName('QCLD').AsInteger := RemoteDB.Products.FieldByName('products_cld_stock').Value;
                      aReorderForm.TableData.Post;
                    end;
            i                    := i + 1;
            ProgressBar.Position := (i / (RemoteDB.CDSQuery.RecordCount) * 100);
            Application.ProcessMessages;
            RemoteDB.CDSQuery.Next;
          end;



          aReorderForm.ShowModal;
        finally
          RemoteDB.CDSQuery.Close;
          ProgressBar.Visible             := False;
          aReorderForm.Free
        end;
        ActionWebInfo.Execute;
end;

procedure TMainForm.JvLookOutButtonReassortBestsellers(Sender: TObject);
begin
end;

procedure TMainForm.JvLookOutButtonReassortBestsellersClick(Sender: TObject);
begin
      end;

      procedure TMainForm.JvLookOutButton6Click(Sender: TObject);
      var
        ITempIndex, STempIndex, ExpensesDesc: string;
        i: Integer;
        DayCashierSummary: TDayCashierSummary;
        AFormCashRegister: TFormCashRegister;
        Accu: Double;
        UpdateStatus: Boolean;

      begin

        AFormCashRegister := TFormCashRegister.Create(self);
        AFormCashRegister.Show;
        AFormCashRegister.Enabled := False;
        Screen.Cursor             := crHourglass;
        Application.ProcessMessages;
        RemoteDB.SetItemstoSales;

        try
          UpdateStatus := RemoteDB.IsUpdating;
          if not RemoteDB.IsUpdating then
            RemoteDB.IsUpdating := True;

          Accu  := StartValue.Value;
          for i := trunc(MonthCalendarAdminSales.Date) to trunc(MonthCalendarAdminSalesEnd.Date) do
          begin
            DayCashierSummary := RemoteDB.CalcDayCahsierSummary(i, i);
            if DayCashierSummary.Open then
            begin

              Accu := Accu + DayCashierSummary.TotalPay;

              ///
              /// Population Grid
              ///
              AFormCashRegister.CashData.Append;
              AFormCashRegister.CashData.FieldByName('Nbr').Value := AFormCashRegister.CashData.FieldByName('Nbr').Value + 1;
              AFormCashRegister.CashData.FieldByName('Date').Value := i;
              AFormCashRegister.CashData.FieldByName('NEW-0').Value := DayCashierSummary.New0;
              AFormCashRegister.CashData.FieldByName('NEW-6').Value := DayCashierSummary.New6;
              AFormCashRegister.CashData.FieldByName('NEW-21').Value := DayCashierSummary.New21;
              AFormCashRegister.CashData.FieldByName('New').Value := DayCashierSummary.New + DayCashierSummary.NoMargin;
              AFormCashRegister.CashData.FieldByName('SH').Value := DayCashierSummary.SH;
              AFormCashRegister.CashData.FieldByName('Depot').Value := DayCashierSummary.SHDeposit;
              AFormCashRegister.CashData.FieldByName('Rachat').Value := DayCashierSummary.SHBought;
              AFormCashRegister.CashData.FieldByName('CostOfBought').Value := DayCashierSummary.SHCostOfBought;
              AFormCashRegister.CashData.FieldByName('Serv').Value := DayCashierSummary.Service;
              AFormCashRegister.CashData.FieldByName('Returns').Value := DayCashierSummary.Returns;
              AFormCashRegister.CashData.FieldByName('Total').Value := DayCashierSummary.TotalNature;
              AFormCashRegister.CashData.FieldByName('Cash').Value := DayCashierSummary.Cash;
              AFormCashRegister.CashData.FieldByName('Bct').Value := DayCashierSummary.BCT;
              AFormCashRegister.CashData.FieldByName('Visa').Value := DayCashierSummary.Visa;
              AFormCashRegister.CashData.FieldByName('Proton').Value := DayCashierSummary.Proton;
              AFormCashRegister.CashData.FieldByName('Voucher').Value := DayCashierSummary.Voucher;
              AFormCashRegister.CashData.FieldByName('Refunds').Value := DayCashierSummary.Refunds;
              AFormCashRegister.CashData.FieldByName('Purchased').Value := DayCashierSummary.Purchased;
              AFormCashRegister.CashData.FieldByName('TotalPay').Value := DayCashierSummary.TotalPay;
              AFormCashRegister.CashData.FieldByName('CaisseTot').Value := Accu;
              AFormCashRegister.CashData.FieldByName('Expenses').Value := DayCashierSummary.Expenses;
              AFormCashRegister.CashData.FieldByName('ExpensesDesc').Value := DayCashierSummary.ExpensesDesc;
              AFormCashRegister.CashData.FieldByName('INV-21').Value := DayCashierSummary.Invoice21;
              AFormCashRegister.CashData.FieldByName('INV-6').Value := DayCashierSummary.Invoice6;
              AFormCashRegister.CashData.FieldByName('INV-0').Value := DayCashierSummary.Invoice0;
              AFormCashRegister.CashData.Post;
              Application.ProcessMessages;
            end;
          end;
        finally
          Screen.Cursor             := crDefault;
          RemoteDB.IsUpdating       := UpdateStatus;
          AFormCashRegister.Enabled := True;
        end;
        AFormCashRegister.Show;

      end;

      procedure TMainForm.JvExpressButtonWebOrdersEraseClick(Sender: TObject);
      begin
        if messagedlg('Confirmez vous la suppression de la commade ' + RemoteDB.WebOrdersproducts_name.AsString + ' ?', mtwarning, [mbyes, mbno], 0) = mryes
        then
        begin
          RemoteDB.WebOrders.Edit;
          RemoteDB.WebOrdersorders_status_id.AsInteger := 12;
          RemoteDB.WebOrders.Post;
        end;

      end;

      procedure TMainForm.JvExpressButtonWebOrdersProcessClick(Sender: TObject);
      var
        processed, setresult: Boolean;
        aLabelAddress: TLabelAddress;
        Address: Tstrings;
        ANotifyServer: TNotifyServer;
      begin
        processed := False;
        if RemoteDB.Customers.Locate('customers_nbr', RemoteDB.WebOrderscustomers_id.AsString, []) then
        begin
          if RemoteDB.netshop_stock.Locate('product_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]) then
          begin
            if messagedlg('Produit en stock ! Le stock est-il disponnible ?', mtwarning, [mbyes, mbno], 0) = mryes then
            begin
              RemoteDB.Products.Locate('products_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]);
              //
              // Print Sticker
              //
              aLabelAddress := TLabelAddress.Create;
              Address       := TStringList.Create;
              try
                aLabelAddress.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
                Address.Add('Client # ' + RemoteDB.CustomersCustomers_nbr.AsString);
                Address.Add(RemoteDB.Customerscustomers_firstname.AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
                Address.Add(RemoteDB.Products.FieldByName('products_intername').AsString + ' ' + RemoteDB.Products.FieldByName('products_root_category_name')
                  .AsString);
                Address.Add('Rs: ' + DateToStr(Now));
                aLabelAddress.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
              finally
                aLabelAddress.Free;
                Address.Free;
              end;
              ///
              /// Ajouter dans les rservations
              ///
              RemoteDB.netshop_customers_alerts.Append;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString := RemoteDB.Products.FieldByName('products_intername').AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := 0;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').Value := 2;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date_notified').AsFloat := Now;
              RemoteDB.netshop_customers_alerts.Post;
              ///
              /// Notify customer
              ///
              if UserType = 1 then
              begin
                ANotifyServer := TNotifyServer.Create('stockalert', RemoteDB.Products.FieldByName('products_id').AsString, '', NOTIFYURL);
              end;
              ///
              /// Change Status
              ///
              RemoteDB.WebOrders.Edit;
              RemoteDB.WebOrdersorders_status_id.AsInteger := 12;
              RemoteDB.WebOrders.Post;
            end else begin // MessageDLG produit en stock mais non dispo
              setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
                RemoteDB.WebOrdersproducts_model.AsString);
              if not setresult then
              begin
                RemoteDB.WebOrders.Edit;
                RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
                RemoteDB.WebOrders.Post;
                ShowMessage('Rservation enregistre');
              end else begin
                ShowMessage('Problme lors de la rservation');
              end;
            end; // Fin MessDLG

          end else begin // Si produit pas de stock
            setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
              RemoteDB.WebOrdersproducts_model.AsString);
            if not setresult then
            begin
              RemoteDB.WebOrders.Edit;
              RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
              RemoteDB.WebOrders.Post;
              ShowMessage('Rservation enregistre');
            end else begin
              ShowMessage('Problme lors de la rservation');
            end;
          end;
          processed := True;
        end;

        if ((not processed) and (RemoteDB.Customers.Locate('customers_email_address', RemoteDB.WebOrderscustomers_email_address.AsString,
          [locaseinsensitive, loPartialKey]))) then
        begin

          if RemoteDB.netshop_stock.Locate('product_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]) then
          begin
            if messagedlg('Produit en stock ! Le stock est-il disponnible ?', mtwarning, [mbyes, mbno], 0) = mryes then
            begin

              RemoteDB.Products.Locate('products_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]);
              //
              // Print Sticker
              //
              aLabelAddress := TLabelAddress.Create;
              Address       := TStringList.Create;
              try
                aLabelAddress.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
                Address.Add('Client # ' + RemoteDB.CustomersCustomers_nbr.AsString);
                Address.Add(RemoteDB.Customerscustomers_firstname.AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
                Address.Add(RemoteDB.Products.FieldByName('products_intername').AsString + ' ' + RemoteDB.Products.FieldByName('products_root_category_name')
                  .AsString);
                Address.Add('Rs: ' + DateToStr(Now));
                aLabelAddress.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
              finally
                aLabelAddress.Free;
                Address.Free;
              end;
              ///
              /// Ajouter dans les rservations
              ///
              RemoteDB.netshop_customers_alerts.Append;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString :=
                RemoteDB.Products.FieldByName('products_intername').AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := 0;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').Value := 2;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date_notified').AsFloat := Now;
              RemoteDB.netshop_customers_alerts.Post;
              ///
              /// Notify customer
              ///
              if UserType = 1 then
              begin
                ANotifyServer := TNotifyServer.Create('stockalert', RemoteDB.Products.FieldByName('products_id').AsString, '', NOTIFYURL);
              end;
              ///
              /// Change Status
              ///
              RemoteDB.WebOrders.Edit;
              RemoteDB.WebOrdersorders_status_id.AsInteger := 12;
              RemoteDB.WebOrders.Post;
            end else begin // MessageDLG produit en stock mais non dispo
              setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
                RemoteDB.WebOrdersproducts_model.AsString);
              if not setresult then
              begin
                RemoteDB.WebOrders.Edit;
                RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
                RemoteDB.WebOrders.Post;
                ShowMessage('Rservation enregistre');
              end else begin
                ShowMessage('Problme lors de la rservation');
              end;
            end; // Fin MessDLG

          end else begin // Si produit pas de stock
            setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
              RemoteDB.WebOrdersproducts_model.AsString);
            if not setresult then
            begin
              RemoteDB.WebOrders.Edit;
              RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
              RemoteDB.WebOrders.Post;
              ShowMessage('Rservation enregistre');
            end else begin
              ShowMessage('Problme lors de la rservation');
            end;
          end;
          processed := True;

        end;

        if not processed then
        begin
          if messagedlg('Client non trouv, voulez-vous le rajouter  votre fichier ?', mtwarning, [mbyes, mbno], 0) = mryes then
          begin
            // Add customer
            if RemoteDB.WebOrderscustomers_id.Value >= 100000 then
            begin

              if messagedlg
                ('Ce client est inscrit dans un autre magasin, afin de ne pas bloquer l accs  son compte son adresse mail et password ne seront pas transfrs, veuillez prendre contact avec le client pour ffectuer ce transfer',
                mtwarning, [mbok], 0) = mrOK then
              begin

                RemoteDB.Customers.Append;
                RemoteDB.Customerscustomers_firstname.Value := RemoteDB.WebOrderscustomers_firstname.Value;
                RemoteDB.CustomersCustomers_Lastname.Value := RemoteDB.WebOrderscustomers_lastname.Value;
                RemoteDB.Customerscustomers_dob.Value := RemoteDB.WebOrderscustomers_dob.Value;
                if LeftStr(RemoteDB.WebOrderscustomers_fax.AsString, 3) <> '+32' then
                begin
                  RemoteDB.Customerscustomers_fax.Value := InputBox('Le prfixe pays semble-t-il correct ? Si non corriger.', 'N de GSM',
                    '+32' + RemoteDB.WebOrderscustomers_fax.AsString);
                end else begin
                  RemoteDB.Customerscustomers_fax.Value := RemoteDB.WebOrderscustomers_fax.Value;
                end;
                RemoteDB.Customerscustomers_telephone.Value := RemoteDB.WebOrderscustomers_telephone.Value;
                RemoteDB.Customerscustomers_gender.Value := RemoteDB.WebOrderscustomers_gender.Value;
                // RemoteDB.Customerscustomers_password.Value:=RemoteDB.WebOrderscustomers_password.Value;
                // remoteDB.Customerscustomers_email_address.Value:=RemoteDB.WebOrderscustomers_email_address.Value;

                // RemoteDB.Address_Book.Append;
                // Dj dans la procdure on new record;
                RemoteDB.Address_Book.Edit;
                RemoteDB.Address_Bookentry_gender.Value    := RemoteDB.WebOrderscustomers_gender.Value;
                RemoteDB.Address_Bookentry_company.Value   := RemoteDB.WebOrderscustomers_company.Value;
                RemoteDB.Address_Bookentry_firstname.Value := RemoteDB.WebOrderscustomers_firstname.Value;
                RemoteDB.Address_Bookentry_lastname.Value  := RemoteDB.WebOrderscustomers_lastname.Value;
                RemoteDB.Address_Bookentry_street_address.Value := RemoteDB.WebOrderscustomers_street_address.Value;
                RemoteDB.Address_Bookentry_suburb.Value   := RemoteDB.WebOrderscustomers_suburb.Value;
                RemoteDB.Address_Bookentry_postcode.Value := RemoteDB.WebOrderscustomers_postcode.Value;
                RemoteDB.Address_Bookentry_city.Value     := RemoteDB.WebOrderscustomers_city.Value;
                RemoteDB.Address_Bookentry_state.Value    := RemoteDB.WebOrderscustomers_state.Value;
                if RemoteDB.countries.Locate('countries_name', RemoteDB.WebOrderscustomers_country.AsString, [locaseinsensitive]) then
                  RemoteDB.Address_Bookentry_country_id.Value := RemoteDB.Countriescountries_id.Value;
                RemoteDB.Address_Book.Post;

                RemoteDB.Customers.Post;
                //
                // Todo Delete original customer
                //

                if RemoteDB.netshop_stock.Locate('product_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]) then
                begin
                  if messagedlg('Produit en stock ! Le stock est-il disponnible ?', mtwarning, [mbyes, mbno], 0) = mryes then
                  begin
                    RemoteDB.Products.Locate('products_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]);
                    //
                    // Print Sticker
                    //
                    aLabelAddress := TLabelAddress.Create;
                    Address       := TStringList.Create;
                    try
                      aLabelAddress.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
                      Address.Add('Client # ' + RemoteDB.CustomersCustomers_nbr.AsString);
                      Address.Add(RemoteDB.Customerscustomers_firstname.AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
                      Address.Add(RemoteDB.Products.FieldByName('products_intername').AsString + ' ' +
                        RemoteDB.Products.FieldByName('products_root_category_name').AsString);
                      Address.Add('Rs: ' + DateToStr(Now));
                      aLabelAddress.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
                    finally
                      aLabelAddress.Free;
                      Address.Free;
                    end;
                    ///
                    /// Ajouter dans les rservations
                    ///
                    RemoteDB.netshop_customers_alerts.Append;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString :=
                      RemoteDB.Products.FieldByName('products_intername').AsString;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString :=
                      RemoteDB.Productsproducts_root_category_name.AsString;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := 0;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').Value := 2;
                    RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date_notified').AsFloat := Now;
                    RemoteDB.netshop_customers_alerts.Post;
                    ///
                    /// Notify customer
                    ///
                    if UserType = 1 then
                    begin
                      ANotifyServer := TNotifyServer.Create('stockalert', RemoteDB.Products.FieldByName('products_id').AsString, '', NOTIFYURL);
                    end;
                    ///
                    /// Change Status
                    ///
                    RemoteDB.WebOrders.Edit;
                    RemoteDB.WebOrdersorders_status_id.AsInteger := 12;
                    RemoteDB.WebOrders.Post;
                  end else begin // MessageDLG produit en stock mais non dispo
                    setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
                      RemoteDB.WebOrdersproducts_model.AsString);
                    if not setresult then
                    begin
                      RemoteDB.WebOrders.Edit;
                      RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
                      RemoteDB.WebOrders.Post;
                      ShowMessage('Rservation enregistre');
                    end else begin
                      ShowMessage('Problme lors de la rservation');
                    end;
                  end; // Fin MessDLG

                end else begin // Si produit pas de stock
                  setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
                    RemoteDB.WebOrdersproducts_model.AsString);
                  if not setresult then
                  begin
                    RemoteDB.WebOrders.Edit;
                    RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
                    RemoteDB.WebOrders.Post;
                    ShowMessage('Rservation enregistre');
                  end else begin
                    ShowMessage('Problme lors de la rservation');
                  end;
                end;
                processed := True;

              end;

            end else begin

              RemoteDB.Customers.Append;
              RemoteDB.Customerscustomers_firstname.Value := RemoteDB.WebOrderscustomers_firstname.Value;
              RemoteDB.CustomersCustomers_Lastname.Value  := RemoteDB.WebOrderscustomers_lastname.Value;
              RemoteDB.Customerscustomers_dob.Value       := RemoteDB.WebOrderscustomers_dob.Value;
              RemoteDB.Customerscustomers_fax.Value       := RemoteDB.WebOrderscustomers_fax.Value;
              RemoteDB.Customerscustomers_telephone.Value := RemoteDB.WebOrderscustomers_telephone.Value;
              RemoteDB.Customerscustomers_gender.Value    := RemoteDB.WebOrderscustomers_gender.Value;
              RemoteDB.Customerscustomers_password.Value  := RemoteDB.WebOrderscustomers_password.Value;
              RemoteDB.Customerscustomers_email_address.Value := RemoteDB.WebOrderscustomers_email_address.Value;

              // RemoteDB.Address_Book.Append;
              // Dj dans la procdure on new record;
              RemoteDB.Address_Book.Edit;
              RemoteDB.Address_Bookentry_gender.Value    := RemoteDB.WebOrderscustomers_gender.Value;
              RemoteDB.Address_Bookentry_company.Value   := RemoteDB.WebOrderscustomers_company.Value;
              RemoteDB.Address_Bookentry_firstname.Value := RemoteDB.WebOrderscustomers_firstname.Value;
              RemoteDB.Address_Bookentry_lastname.Value  := RemoteDB.WebOrderscustomers_lastname.Value;
              RemoteDB.Address_Bookentry_street_address.Value := RemoteDB.WebOrderscustomers_street_address.Value;
              RemoteDB.Address_Bookentry_suburb.Value   := RemoteDB.WebOrderscustomers_suburb.Value;
              RemoteDB.Address_Bookentry_postcode.Value := RemoteDB.WebOrderscustomers_postcode.Value;
              RemoteDB.Address_Bookentry_city.Value     := RemoteDB.WebOrderscustomers_city.Value;
              RemoteDB.Address_Bookentry_state.Value    := RemoteDB.WebOrderscustomers_state.Value;
              if RemoteDB.countries.Locate('countries_name', RemoteDB.WebOrderscustomers_country.AsString, [locaseinsensitive]) then
                RemoteDB.Address_Bookentry_country_id.Value := RemoteDB.Countriescountries_id.Value;
              RemoteDB.Address_Book.Post;

              RemoteDB.Customers.Post;
              //
              // Todo Delete original customer
              //
              if RemoteDB.netshop_stock.Locate('product_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]) then
              begin
                if messagedlg('Produit en stock ! Le stock est-il disponnible ?', mtwarning, [mbyes, mbno], 0) = mryes then
                begin
                  RemoteDB.Products.Locate('products_model', RemoteDB.WebOrdersproducts_model.AsString, [locaseinsensitive]);
                  //
                  // Print Sticker
                  //
                  aLabelAddress := TLabelAddress.Create;
                  Address       := TStringList.Create;
                  try
                    aLabelAddress.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
                    Address.Add('Client # ' + RemoteDB.CustomersCustomers_nbr.AsString);
                    Address.Add(RemoteDB.Customerscustomers_firstname.AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
                    Address.Add(RemoteDB.Products.FieldByName('products_intername').AsString + ' ' +
                      RemoteDB.Products.FieldByName('products_root_category_name').AsString);
                    Address.Add('Rs: ' + DateToStr(Now));
                    aLabelAddress.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
                  finally
                    aLabelAddress.Free;
                    Address.Free;
                  end;
                  ///
                  /// Ajouter dans les rservations
                  ///
                  RemoteDB.netshop_customers_alerts.Append;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString :=
                    RemoteDB.Products.FieldByName('products_intername').AsString;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString :=
                    RemoteDB.Productsproducts_root_category_name.AsString;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := 0;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').Value := 2;
                  RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date_notified').AsFloat := Now;
                  RemoteDB.netshop_customers_alerts.Post;
                  ///
                  /// Notify customer
                  ///
                  if UserType = 1 then
                  begin
                    ANotifyServer := TNotifyServer.Create('stockalert', RemoteDB.Products.FieldByName('products_id').AsString, '', NOTIFYURL);
                  end;
                  ///
                  /// Change Status
                  ///
                  RemoteDB.WebOrders.Edit;
                  RemoteDB.WebOrdersorders_status_id.AsInteger := 12;
                  RemoteDB.WebOrders.Post;
                end else begin // MessageDLG produit en stock mais non dispo
                  setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
                    RemoteDB.WebOrdersproducts_model.AsString);
                  if not setresult then
                  begin
                    RemoteDB.WebOrders.Edit;
                    RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
                    RemoteDB.WebOrders.Post;
                    ShowMessage('Rservation enregistre');
                  end else begin
                    ShowMessage('Problme lors de la rservation');
                  end;
                end; // Fin MessDLG

              end else begin // Si produit pas de stock
                setresult := RemoteDB.SetAlert(RemoteDB.CustomersCustomers_nbr.AsInteger, RemoteDB.WebOrdersproducts_quantity.AsInteger,
                  RemoteDB.WebOrdersproducts_model.AsString);
                if not setresult then
                begin
                  RemoteDB.WebOrders.Edit;
                  RemoteDB.WebOrdersorders_status_id.AsInteger := 11;
                  RemoteDB.WebOrders.Post;
                  ShowMessage('Rservation enregistre');
                end else begin
                  ShowMessage('Problme lors de la rservation');
                end;
              end;
              processed := True;

            end;
          end; // End if rajout fiche
        end;
      end;

      procedure TMainForm.StringGridFiguresClear;
      var
        i: Integer;
      begin
        for i := 0 to StringGridFigures.RowCount do
        begin
          StringGridFigures.Cells[3, i] := FloatToStrF(0, fffixed, 7, 2);
          StringGridFigures.Cells[1, i] := FloatToStrF(0, fffixed, 7, 2);
        end;
      end;


      procedure TMainForm.JvLookOutButtonAdminDayCashClick(Sender: TObject);
      var
        FirstSalesId, LastSalesId: Integer;
      begin
        RemoteDB.Shops.IndexName := 'ShopsIXId';
        RemoteDB.Shops.FindKey([ConnectedShop]);
        RemoteDB.FreeItemsTo;
        RemoteDB.netshop_refunds.Filter := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< refunds_date_time and refunds_date_time < ' +
          FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (refunds_shop_id = ' + inttostr(ConnectedShop) + ')';
        RemoteDB.netshop_refunds.Filtered := True;
        RemoteDB.netshop_sales.Filter     := '(' + FloatToStr(trunc(MonthCalendarAdminSales.Date)) + '< sales_date_time and sales_date_time < ' +
          FloatToStr(trunc(MonthCalendarAdminSalesEnd.Date) + 1) + ') and (sales_location = ' + inttostr(ConnectedShop) + ')';
        RemoteDB.netshop_sales.Filtered := True;
        RemoteDB.netshop_sales.First;
        FirstSalesId := RemoteDB.netshop_sales.FieldByName('sales_id').AsInteger;
        RemoteDB.netshop_sales.Last;
        LastSalesId                        := RemoteDB.netshop_sales.FieldByName('sales_id').AsInteger;
        RemoteDB.netshop_items_sold.Filter := '(items_sold_sales_id <= ' + inttostr(LastSalesId) + ') and (items_sold_sales_id >= ' +
          inttostr(FirstSalesId) + ')';
        RemoteDB.netshop_items_sold.Filtered := True;

        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportDaySales', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvSystem.DefaultDest    := rdpreview;
        ReportModule.RvSystem.DoNativeOutput := True;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
        // ReportModule.RvSystem.Execute;

        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
      end;

      procedure TMainForm.JvLookOutButtonCLDPushClick(Sender: TObject);
      var
        aReorderForm: TReorderForm;
        i, InStock, OutStock: Integer;
        ProductsClone, StockClone: TClientDataset;
        aSqlCon: TSqlConnection;
        aSqlDataset: TSqlDataset;
      begin
        aReorderForm         := TReorderForm.Create(self);
        aReorderForm.Caption := 'CLD Push';
        try
          i          := 1;
          StockClone := TClientDataset.Create(self);
          StockClone.CloneCursor(RemoteDB.netshop_stock, False, False);
          ProductsClone := TClientDataset.Create(self);
          ProductsClone.CloneCursor(RemoteDB.Products, False, False);

          StockClone.IndexFieldNames := 'product_model;product_location';

          aSqlCon := TSqlConnection.Create(self);
          with aSqlCon do
          begin
            DriverName    := RemoteDB.SQLConnection.DriverName;
            GetDriverFunc := RemoteDB.SQLConnection.GetDriverFunc;
            LibraryName   := RemoteDB.SQLConnection.LibraryName;
            VendorLib     := RemoteDB.SQLConnection.VendorLib;
            aSqlCon.Params.Values['Database'] := RemoteDB.SQLConnection.Params.values['Database'];
            aSqlCon.Params.Values['User_Name'] := RemoteDB.SQLConnection.Params.values['User_Name'];
            aSqlCon.Params.Values['Password'] := RemoteDB.SQLConnection.Params.values['Password'];
            aSqlCon.Params.Values['HostName'] := RemoteDB.SQLConnection.Params.values['Hostname'];
            aSqlCon.Params.Values['Compressed'] := RemoteDB.SQLConnection.Params.values['Compressed'];

            LoginPrompt := False;
            Open;
          end;

          aSqlDataset               := TSqlDataset.Create(self);
          aSqlDataset.SQLConnection := aSqlCon;
          aSqlDataset.CommandType   := ctQuery;
          aSqlDataset.CommandText   := 'SELECT products_model, products_cld_stock from products where products_cld_stock > 0';
          aSqlDataset.Open;

          aReorderForm.TableData.DisableControls;
          ProductsClone.DisableControls;
          StockClone.DisableControls;
          aReorderForm.TableData.Open;

          ProgressBar.Visible       := True;
          ProgressBar.Position      := (i / (aSqlDataset.RecordCount) * 100);
          StatusLine.Panels[3].Text := 'Cration de la liste push';
          aSqlDataset.First;
          while (not aSqlDataset.Eof) and (True) do
          begin
            StatusLine.Panels[3].Text := 'Produit : ' + ProductsClone.FieldByName('products_CLD_id').AsString;
            if not StockClone.FindKey([aSqlDataset.FieldByName('products_model').AsString, ConnectedShop]) then
            begin
              if ProductsClone.FindKey([aSqlDataset.FieldByName('Products_model').AsString]) then
              begin
                if not aReorderForm.TableData.Locate('EAN', aSqlDataset.FieldByName('Products_model').AsString, [locaseinsensitive]) then
                begin
                  aReorderForm.TableData.Append;
                  aReorderForm.TableDataEAN.Value    := aSqlDataset.FieldByName('Products_model').AsString;
                  aReorderForm.TableDataNom.AsString := ProductsClone.FieldByName('products_intername').AsString;
                  aReorderForm.TableDataRootCategoryName.Value := ProductsClone.FieldByName('products_root_category_name').Value;
                  aReorderForm.TableDataQuantity.Value := 0;

                  if not VarIsNull(ProductsClone.FieldByName('products_CLD_id').Value) then
                  begin
                    aReorderForm.TableDataConfirmBO.Value := True;
                    aReorderForm.TableDataIDART.Value     := ProductsClone.FieldByName('products_CLD_id').AsString;

                  end else begin
                    aReorderForm.TableDataIDART.AsInteger := 0;
                    aReorderForm.TableDataConfirmBO.Value := False;
                  end;

                  RemoteDB.CheckExtStock(aSqlDataset.FieldByName('Products_model').AsString, InStock, OutStock);
                  aReorderForm.TableDataGroupAvailable.AsInteger := InStock;
                  aReorderForm.TableDataAvailable.AsInteger := OutStock;
                  aReorderForm.TableDataQCLD.AsInteger := aSqlDataset.FieldByName('products_cld_stock').AsInteger;
                  aReorderForm.TableData.Post;
                end;
              end;
            end;
            i                    := i + 1;
            ProgressBar.Position := (i / (aSqlDataset.RecordCount) * 100);

            Application.ProcessMessages;
            aSqlDataset.Next;
          end;
          aReorderForm.TableData.EnableControls;
          aReorderForm.Show;
        finally
          StatusLine.Panels[3].Text := '';
          ProgressBar.Visible       := False;
          aSqlDataset.Close;
          aSqlCon.Close;
          aSqlDataset.Free;
          aSqlCon.Free;
          ProductsClone.EnableControls;
          StockClone.EnableControls;
          StockClone.Free;
          ProductsClone.Free;
          RemoteDB.SQLConnection.Close;
        end;
        ActionWebInfo.Execute;
      end;

      procedure TMainForm.JvLookOutButtonCloseCashClick(Sender: TObject);
      var
        aFormCashClose: TFormCashClose;
        DayCashierSummary: TDayCashierSummary;
        CashClosePreviousAmount, CashClosePreviousDate: Double;
        Labelstoprint: TLabelAddress;
        i: Integer;
        Address: Tstrings;
      begin

      RemoteDB.CDSActions.Filter :=  'action = ' + QuotedStr('Action reassort');
      RemoteDB.CDSActions.Filtered := True;
      RemoteDB.CDSActions.First;

      if (RemoteDB.CDSActions.FieldByName('datetime').AsDateTime<(Now()-0.5)) then begin
        ShowMessage('Rassort non fait');
        Exit;
        RemoteDB.CDSActions.Filtered := False;
      end;
      RemoteDB.CDSActions.Filtered := False;


      if RemoteDB.ChangeCount>0 then begin
        ShowMessage('Mise  jour partielle de la DB');
        RemoteDB.ApplyUpdates;
      end;

        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Action cloture caisse';
        RemoteDB.CDSActions.Post;
        RemoteDB.netshop_cashclose.First;
        if trunc(RemoteDB.netshop_cashclose.FieldByName('cashclose_datetime').AsFloat) >= trunc(Now) then
        begin
          ShowMessage('Caisse dj cloture');
        end else begin
          aFormCashClose := TFormCashClose.Create(self);
          try
            aFormCashClose.PreviousAmount := RemoteDB.netshop_cashclose.FieldByName('cashclose_amountleft').AsFloat;
            CashClosePreviousDate         := RemoteDB.netshop_cashclose.FieldByName('cashclose_datetime').AsFloat;
            RemoteDB.netshop_cashclose.Append;

            DayCashierSummary := RemoteDB.CalcDayCahsierSummary(trunc(CashClosePreviousDate + 1), trunc(Now));

            aFormCashClose.LabelStatDate.Caption         := DateToStr(trunc(CashClosePreviousDate));
            aFormCashClose.LabelEndDate.Caption          := DateToStr(trunc(Now));
            aFormCashClose.cxCurrencyEditNew.Value       := DayCashierSummary.New;
            aFormCashClose.cxCurrencyEditBought.Value    := DayCashierSummary.SHBought;
            aFormCashClose.cxCurrencyEditDeposit.Value   := DayCashierSummary.SHDeposit;
            aFormCashClose.cxCurrencyEditReturn.Value    := DayCashierSummary.Returns;
            aFormCashClose.cxCurrencyEditTotalIn.Value   := DayCashierSummary.TotalNature;
            aFormCashClose.cxCurrencyEditBCT.Value       := DayCashierSummary.BCT;
            aFormCashClose.cxCurrencyEditBANK.Value      := DayCashierSummary.Proton;
            aFormCashClose.cxCurrencyEditVISA.Value      := DayCashierSummary.Visa;
            aFormCashClose.cxCurrencyEditVOUCHER.Value   := DayCashierSummary.Voucher;
            aFormCashClose.cxCurrencyEditREFUNDS.Value   := DayCashierSummary.Refunds;
            aFormCashClose.cxCurrencyEditPurchased.Value := DayCashierSummary.Purchased;
            aFormCashClose.cxCurrencyEditEXPENSES.Value  := DayCashierSummary.Expenses;
            aFormCashClose.cxCurrencyEditTotalCash.Value := DayCashierSummary.TotalPay;
            aFormCashClose.cxCurrencyEditTotalOut.Value  := DayCashierSummary.Expenses + DayCashierSummary.Refunds + DayCashierSummary.Purchased +
              DayCashierSummary.Voucher + DayCashierSummary.Visa + DayCashierSummary.Proton + DayCashierSummary.BCT;
            RemoteDB.netshop_cashclose.FieldByName('cashclose_amountout').AsInteger := Round(DayCashierSummary.TotalPay / 5) * 5;
            aFormCashClose.cxCurrencyEditCashLeft.Value := aFormCashClose.PreviousAmount - aFormCashClose.cxCurrencyEditToTake.Value +
              DayCashierSummary.TotalPay;
            if aFormCashClose.ShowModal <> mrOK then
            begin
              RemoteDB.netshop_cashclose.Cancel
            end else begin
              RemoteDB.netshop_cashclose.Post;
              for i := trunc(CashClosePreviousDate + 1) to trunc(Now) do
              begin
                DayCashierSummary := RemoteDB.CalcDayCahsierSummary(i, i);
                if DayCashierSummary.Open then
                begin
                  if (MainForm.Parameter['PrintersLabelEnabled'] = 'TRUE') then
                  begin
                    Labelstoprint := TLabelAddress.Create;
                    Address       := TStringList.Create;
                    try
                      Address.Add(DateToStr(i));
                      Address.Add('Neuf : ' + FloatToStr(DayCashierSummary.New + DayCashierSummary.NoMargin));
                      Address.Add('Occasion : ' + FloatToStr(DayCashierSummary.SH));
                      Address.Add('Retours : ' + FloatToStr(DayCashierSummary.Returns));
                      Address.Add('Bons : ' + FloatToStr(DayCashierSummary.Voucher));
                      Address.Add('Rembours : ' + FloatToStr(DayCashierSummary.Refunds));
                      Labelstoprint.LabelPrinter := (MainForm.Parameter['PrintersLabelPrinter']);
                      Labelstoprint.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
                    finally
                      Labelstoprint.Free;
                      Address.Free;
                    end;
                  end
                  else
                    messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
                  Application.ProcessMessages;
                end;
              end;
            end;
          finally
            aFormCashClose.Free;
          end;
        end; // Fin si caisse dj cloture;

      end;

      procedure TMainForm.PageControlAdminSalesResize(Sender: TObject);
      var
        i: Integer;
      begin
        for i := 0 to StringGridFigures.RowCount - 1 do
        begin
          StringGridFigures.RowHeights[i]    := StringGridFigures.ClientHeight div StringGridFigures.RowCount;
          StringGridFigures.Alignments[0, i] := taCenter;
          StringGridFigures.Alignments[2, i] := taCenter;
        end;
        StringGridFigures.RowHeights[StringGridFigures.RowCount - 1] := StringGridFigures.RowHeights[StringGridFigures.RowCount - 1] +
          StringGridFigures.ClientHeight mod StringGridFigures.RowCount;
        for i := 0 to StringGridFigures.ColCount - 1 do
        begin
          StringGridFigures.ColWidths[i] := StringGridFigures.ClientWidth div StringGridFigures.ColCount;
        end;
        StringGridFigures.ColWidths[StringGridFigures.ColCount - 1] := StringGridFigures.ColWidths[StringGridFigures.ColCount - 1] +
          StringGridFigures.ClientWidth mod StringGridFigures.ColCount;
      end;

      procedure TMainForm.ParamTreeParamList(Sender: TObject; ANode: TTreeNode; href: string; values: TStringList; var DoPopup: Boolean);
      begin
        if href = 'PrintersTicketPrinter' then
        begin
          values.Assign(Printer.Printers);
        end;
        if href = 'PrintersRapportPrinter' then
        begin
          values.Assign(Printer.Printers);
        end;
        if href = 'PrintersLabelPrinter' then
        begin
          values.Assign(Printer.Printers);
        end;
        if href = 'SMSProvider' then
        begin
          values.Clear;
          values.Add('Clickatel');
          values.Add('Betamax');
          values.Add('OVH');
        end;
      end;

      procedure TMainForm.ParamTreeParamPopup(Sender: TObject; ANode: TTreeNode;
  href: string; values: TStringList; var DoPopup: Boolean);
begin
        if href = 'PrintersTicketPrinter' then
        begin
          values.Assign(Printer.Printers);
        end;
        if href = 'PrintersRapportPrinter' then
        begin
          values.Assign(Printer.Printers);
        end;
        if href = 'PrintersLabelPrinter' then
        begin
          values.Assign(Printer.Printers);
        end;
        if href = 'SMSProvider' then
        begin
          values.Clear;
          values.Add('Clickatel');
          values.Add('Betamax');
          values.Add('OVH');
        end;
end;

procedure TMainForm.PhidgetRFIDAttach(Sender: TObject);
      begin
        PhidgetRFID.AntennaOn := True;
      end;

      procedure TMainForm.PhidgetRFIDOutputChange(ASender: TObject; Index: Integer; NewState: WordBool);
      begin
        PhidgetRFID.AntennaOn := True;
      end;

      procedure TMainForm.PhidgetRFIDTag(ASender: TObject; const TagNumber: WideString);
      var
        ADroppedDown: Boolean;
      begin
        if POSBANK then
        begin
          if RemoteDB.CloneDSCustomers.Locate('customers_rfid', TagNumber, [locaseinsensitive]) then
          begin

            if RemoteDB.CloneDSCustomers.FieldByName('customers_nbr').Value >= 100000 then
            begin
              if AllowMRUClientAccess then
                dxBarMRUListItemCustomers.AddItem(RemoteDB.CloneDSCustomers.FieldByName('customers_nbr').AsString + ' - ' +
                  RemoteDB.CloneDSCustomers.FieldByName('customers_firstname').AsString + ' ' + RemoteDB.CloneDSCustomers.FieldByName('customers_lastname')
                  .AsString, nil);
            end;
            ACustomerDisplay.PanelAdvert.Visible       := False;
            ACustomerDisplay.PanelCustomerSale.Visible := False;
            ACustomerDisplay.PanelCustomerData.Visible := True;

            ACustomerDisplay.LabelCustomerSold.Caption := 'Dpt vendus : ' + #13#10;
            RemoteDB.CloneDSItems_Sold.Filter          := 'items_sold_owner_id=' + RemoteDB.CloneDSCustomers.FieldByName('customers_nbr').AsString +
              ' AND items_refunded=0';
            RemoteDB.CloneDSItems_Sold.Filtered := True;
            RemoteDB.CloneDSItems_Sold.First;
            while not RemoteDB.CloneDSItems_Sold.Eof do
            begin
              ACustomerDisplay.LabelCustomerSold.Caption := ACustomerDisplay.LabelCustomerSold.Caption + #13#10 +
                RemoteDB.CloneDSItems_Sold.FieldByName('items_sold_name').AsString + '  ' + RemoteDB.CloneDSItems_Sold.FieldByName('items_sold_price_stock')
                .AsString + ' ';
              RemoteDB.CloneDSItems_Sold.Next;
            end;

            ACustomerDisplay.LabelCustomerOrder.Caption := 'Jeux commands : ' + #13#10;
            RemoteDB.CloneDSAlerts.Filter               := 'customers_alerts_status=0 and customers_alerts_customers_nbr=' +
              RemoteDB.CloneDSCustomers.FieldByName('customers_nbr').AsString;
            RemoteDB.CloneDSAlerts.Filtered := True;
            RemoteDB.CloneDSAlerts.First;
            while not RemoteDB.CloneDSAlerts.Eof do
            begin
              ACustomerDisplay.LabelCustomerOrder.Caption := ACustomerDisplay.LabelCustomerOrder.Caption + #13#10 +
                RemoteDB.CloneDSAlerts.FieldByName('customers_alerts_products_name').AsString;
              RemoteDB.CloneDSAlerts.Next;
            end;

            ACustomerDisplay.LabelCustomerName.Caption := 'Nom : ' + RemoteDB.CloneDSCustomers.FieldByName('customers_firstname').AsString + ' ' +
              RemoteDB.CloneDSCustomers.FieldByName('customers_lastname').AsString;
            ACustomerDisplay.LabelCustomerVoucher.Caption := 'Bon : ' + RemoteDB.CloneDSCustomers.FieldByName('customers_credit').AsString + ' ';

          end else begin
            if (PageControlMainForm.ActivePage = TabSheetCustomers) and ((RemoteDB.Customers.State = dsEdit) or (RemoteDB.Customers.State = dsInsert)) then
            begin
              RemoteDB.Customers.FieldByName('customers_rfid').AsString := TagNumber;
            end;
          end;
        end;
      end;

      procedure TMainForm.PhidgetRFIDTagLost(ASender: TObject; const TagNumber: WideString);
      begin
        if POSBANK then
        begin
          ACustomerDisplay.PanelAdvert.Visible       := True;
          ACustomerDisplay.PanelCustomerData.Visible := False;
          ACustomerDisplay.PanelCustomerSale.Visible := False;
          ACustomerDisplay.LabelCustomerName.Caption := 'Nom : ';
        end;
      end;

      function TMainForm.GetParameter(Name: string): string;
      var
        TmpStr: string;
      begin
        TmpStr := Trim(self.ParamTree.Parameter[name]);
        Result := TmpStr;
        if TmpStr = 'Oui' then
          Result := 'TRUE';
        if TmpStr = 'Non' then
          Result := 'FALSE';
      end;

      procedure TMainForm.SetParameter(Name: string; const Value: string);
      var
        TmpStr: string;
      begin
        self.ParamTree.Parameter[name] := Value;
      end;

      procedure TMainForm.AutoColWidth(TheGrid: TAdvStringGrid);
      var
        i, a, t: Integer;
        nw: Double;
      begin
        a := 0;
        t := 0;
        with TheGrid do
        begin
          for i := 0 to ColCount - 1 do
            t   := t + ColWidths[i];
          for i := 0 to ColCount - 1 do
          begin
            nw           := ColWidths[i] / t * ClientWidth;
            ColWidths[i] := Round(nw);
            a            := a + ColWidths[i]
          end;
          ColWidths[ColCount - 1] := ColWidths[ColCount - 1] + a - ClientWidth;
        end;
      end;

      procedure TMainForm.ActionExportInvoiceExecute(Sender: TObject);
      var
        AWB, BWB: Variant;
        WBSTR1, WBSTR2, WBSTR3: WideString;
        i: Integer;
        Result: WordBool;
      begin
        AWB := CreateOleObject('WinbooksOfficeApi.WinbooksObject');
        try
          MainForm.Enabled          := False;
          StatusLine.Panels[3].Text := 'Initialisation Winbooks';
          i                         := AWB.init;

          if i <> 0 then
          begin
            ShowMessage('Initialisation de Winbooks impossible. Erreur #' + inttostr(i) + AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          WBSTR1 := MainForm.Parameter['WBLogin'];
          WBSTR2 := MainForm.Parameter['WBPass'];
          WBSTR3 := MainForm.Parameter['WBLang'];

          StatusLine.Panels[3].Text := 'Login Winbooks';
          if AWB.Login(WBSTR1, WBSTR2, WBSTR3) <> 0 then
          begin
            ShowMessage('Impossible de se connecter  Winbooks avec la login "' + WBSTR1 + '" et le mt de passe "' + WBSTR2 + '". Erreur #' +
              AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          StatusLine.Panels[3].Text := 'Ouverture dossier Winbooks';
          WBSTR1                    := MainForm.Parameter['WBDossier'];
          if AWB.OpenDossier(WBSTR1) <> 0 then
          begin
            ShowMessage('Impossible de rentrer dans le dossier "' + WBSTR1 + '". Erreur #' + AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          StatusLine.Panels[3].Text := 'Ouverture exercice Winbooks';
          WBSTR1                    := MainForm.Parameter['WBBookYear'];
          if AWB.OpenBookYear(WBSTR1) <> 0 then
          begin
            ShowMessage('Impossible de trouver la priode "' + WBSTR1 + '" dans le dossier. Erreur #' + AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          StatusLine.Panels[3].Text := 'Verification DB Winbooks';
          if AWB.Import.FileFormat('DBF') = False then
          begin
            ShowMessage(AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          StatusLine.Panels[3].Text := 'Ouverture rpertoire export';
          if AWB.Import.Directory(ExtractFilePath(ParamStr(0)) + 'export') = False then
          begin
            ShowMessage(AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          AWB.Import.Linkformat := wbWinbooks;

          StatusLine.Panels[3].Text := 'Cration backup donnes export';
          if AWB.Import.Backup(ExtractFilePath(ParamStr(0)) + 'export/backup') = False then
          begin
            ShowMessage(AWB.LastErrorMessage);
          end;

          StatusLine.Panels[3].Text := 'Valeurs par dfaut et traitement des erreurs';
          if AWB.Import.SetDefaultPeriod(AWB.Param.PeriodInternalCode('01/01/2009')) = False then
          begin
            ShowMessage(AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          // Traitement des erreurs
          begin
            // Compte manquant -> fiche blanche
            AWB.Import.ErrorCodes.Item('ACC_MISS').SetResolution := wbBlankRecord;
            // Memo chang : remplacer par le mmo import
            AWB.Import.ErrorCodes.Item('MEM_DIFF').SetResolution := wbReplace;
            // Fiche modifie : prendre le contenu de la fiche importe
            AWB.Import.ErrorCodes.Item('ACC_MOD').SetResolution := wbReplace;
            // Rupture dans la numrotation : le signaler : on laisse  WbToResolve
            AWB.Import.ErrorCodes.Item('SEQ_RUPT').SetResolution := wbAccept;
            // Un document existe dj dans le dossier cible : remplacer
            AWB.Import.ErrorCodes.Item('DOC_NUM').SetResolution := wbReplace;
            // Le libell d'un code table a chang : remplacer par le libell import
            AWB.Import.ErrorCodes.Item('TAB_MOD').SetResolution := wbReplace;
            // Il y a un taux de change diffrent pour cette devise : prendre le taux import
            AWB.Import.ErrorCodes.Item('CUR_ERR').SetResolution := wbReplace;
            // Le fichier d'importation contient des critures rigoureusement identiques au dossier cible : continuer
            AWB.Import.ErrorCodes.Item('SAM_FIL').SetResolution := wbAccept;
            // criture avec date hors-priode : accepter
            AWB.Import.ErrorCodes.Item('OUT_DAT').SetResolution := wbAccept;
          end;



          // On lance la procdure de test

          StatusLine.Panels[3].Text := 'Dbut procdure de test Winbooks';
          if not(AWB.Import.Test) then
          begin
            ShowMessage('Erreur lors de la procedure de test. Erreur #' + AWB.LastErrorMessage);
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          for i := 1 to AWB.Import.Warnings.Count do
          begin
            if AWB.Import.Warnings.Item(i).GetResolution = 0 then
            begin
              ShowMessage('Toutes les alertes ne sont pas corrigs (' + AWB.Import.Warnings.Item(i).code + ')');
            end;
          end;

          if AWB.Import.FatalErrors.Count > 0 then
          begin
            ShowMessage('Erreurs fatales dans les fichiers d' + chr(39) + 'importation. Impossible de poursuivre !');
            AWB.CloseDossier;
            AWB := Unassigned;
            exit;
          end;

          if AWB.Import.Warnings.Count > 0 then
          begin
            if messagedlg('Erreurs de type warning dans les fichiers d' + chr(39) + 'importation. Voulez-vous continuer ?', mtwarning, [mbok, mbCancel], 0) = mrcancel
            then
              exit;
          end;

          StatusLine.Panels[3].Text := 'Dbut exportation';
          if AWB.Import.Execute = 0 then
          begin
            ShowMessage('Importation ralise avec succs');
            AWB.CloseDossier
          end
          else
            ShowMessage(AWB.LastErrorMessage);

          StatusLine.Panels[3].Text := '';
        finally
          AWB              := Unassigned;
          MainForm.Enabled := True;
        end;

      end;

      procedure TMainForm.ActionMarketPlaceUpdateExecute(Sender: TObject);
      var
        ExportGrid: TAdvStringGrid;
        SaveDialog: TsaveDialog;
        RejectedCategories: string;
        InventoryFields: TStringList;
        i, j: Integer;
        ProductsClone, StockClone: TClientDataset;
        AFtpUp: TFtpUp;

      begin
        RejectedCategories := 'Import' + 'Cinema' + 'Figurines' + 'Trading Card';
        // Self.Enabled:=False;
        ExportGrid             := TAdvStringGrid.Create(self);
        ExportGrid.ColCount    := 12;
        ExportGrid.RowCount    := 2;
        ExportGrid.FixedCols   := 0;
        ExportGrid.FloatFormat := '%.2f';
        SaveDialog             := TsaveDialog.Create(self);
        InventoryFields        := TStringList.Create;
        StockClone             := TClientDataset.Create(self);
        StockClone.CloneCursor(RemoteDB.netshop_stock, False, False);
        ProductsClone := TClientDataset.Create(self);
        ProductsClone.CloneCursor(RemoteDB.Products, False, False);
        try
          ExportGrid.Cells[0, ExportGrid.RowCount - 1]  := 'Code_barre';
          ExportGrid.Cells[1, ExportGrid.RowCount - 1]  := 'Prix';
          ExportGrid.Cells[2, ExportGrid.RowCount - 1]  := 'Pays';
          ExportGrid.Cells[3, ExportGrid.RowCount - 1]  := 'Quantite';
          ExportGrid.Cells[4, ExportGrid.RowCount - 1]  := 'Commentaire';
          ExportGrid.Cells[5, ExportGrid.RowCount - 1]  := 'Mode_envoi';
          ExportGrid.Cells[6, ExportGrid.RowCount - 1]  := 'Type';
          ExportGrid.Cells[7, ExportGrid.RowCount - 1]  := 'Catgorie_console';
          ExportGrid.Cells[8, ExportGrid.RowCount - 1]  := 'Etat';
          ExportGrid.Cells[9, ExportGrid.RowCount - 1]  := 'Titre';
          ExportGrid.Cells[10, ExportGrid.RowCount - 1] := 'Description';
          ExportGrid.Cells[11, ExportGrid.RowCount - 1] := 'Image_URL';

          ExportGrid.FixedRows := 1;

          for i := 0 to ExportGrid.ColCount - 1 do
          begin
            InventoryFields.Add(ExportGrid.Cells[i, ExportGrid.RowCount - 1]);
          end;

          i                   := 0;
          StockClone.Filter   := 'product_owner_id = ' + inttostr(ConnectedShop) + ' and product_supplier_id>=100000';
          StockClone.Filtered := True;
          j                   := StockClone.RecordCount;

          StockClone.Filter   := 'product_owner_id = ' + inttostr(ConnectedShop) + ' and product_supplier_id<100000';
          StockClone.Filtered := True;
          j                   := j + StockClone.RecordCount;

          ProgressBar.Visible       := True;
          ProgressBar.Position      := (i / (j) * 100);
          StatusLine.Panels[3].Text := 'Exportation marketplace en cours';
          Application.ProcessMessages;

          StockClone.Filter   := 'product_owner_id = ' + inttostr(ConnectedShop) + ' and product_price_stock>0 and product_supplier_id>=100000';
          StockClone.Filtered := True;
          StockClone.First;
          while not StockClone.Eof do
          begin
            if ProductsClone.Locate('products_model', StockClone.FieldByName('product_model').AsString, []) then
            begin
              if Pos(ProductsClone.FieldByName('products_root_category_name').AsString, RejectedCategories) = 0 then
              begin
                ExportGrid.Cells[0, ExportGrid.RowCount - 2] := StockClone.FieldByName('product_model').AsString;
                ExportGrid.Cells[1, ExportGrid.RowCount - 2] := FloatToStrF(StockClone.FieldByName('product_price_stock').AsFloat * 1.15, fffixed, 7, 2);
                ExportGrid.Cells[2, ExportGrid.RowCount - 2] := 'BE';
                ExportGrid.Cells[3, ExportGrid.RowCount - 2] := '1';
                ExportGrid.Cells[4, ExportGrid.RowCount - 2] := 'Envoi Rapide sous Bulles - Versions ';
                ExportGrid.Cells[5, ExportGrid.RowCount - 2] := 'Normal Recommand';
                ExportGrid.Cells[6, ExportGrid.RowCount - 2] := 'Jeux-video';
                ExportGrid.Cells[7, ExportGrid.RowCount - 2] := ProductsClone.FieldByName('products_root_category_name').Value;
                ExportGrid.Cells[8, ExportGrid.RowCount - 2] := '3';
                ExportGrid.Cells[9, ExportGrid.RowCount - 2] := ProductsClone.FieldByName('products_intername').AsString;
                ExportGrid.Cells[10, ExportGrid.RowCount - 2] := ProductsClone.FieldByName('products_description').AsString;
                ExportGrid.Cells[11, ExportGrid.RowCount - 2] := ProductImageURL + ProductsClone.FieldByName('products_image')
                  .AsString;
                ExportGrid.AddRow;
              end;
            end;
            i                    := i + 1;
            ProgressBar.Position := (i / (j) * 100);
            Application.ProcessMessages;
            StockClone.Next;
          end;

          StockClone.Filter   := 'product_owner_id = ' + inttostr(ConnectedShop) + ' and product_price_stock>0 and product_supplier_id<100000';
          StockClone.Filtered := True;
          StockClone.First;
          while not StockClone.Eof do
          begin
            if ProductsClone.Locate('products_model', StockClone.FieldByName('product_model').AsString, []) then
            begin
              if Pos(ProductsClone.FieldByName('products_root_category_name').AsString, RejectedCategories) = 0 then
              begin
                ExportGrid.Cells[0, ExportGrid.RowCount - 2] := StockClone.FieldByName('product_model').AsString;
                ExportGrid.Cells[1, ExportGrid.RowCount - 2] := FloatToStrF(StockClone.FieldByName('product_price_stock').AsFloat, fffixed, 7, 2);
                ExportGrid.Cells[2, ExportGrid.RowCount - 2] := 'N';
                ExportGrid.Cells[3, ExportGrid.RowCount - 2] := '1';
                ExportGrid.Cells[4, ExportGrid.RowCount - 2] := 'Envoi Rapide sous Bulles - Versions Francaises';
                ExportGrid.Cells[5, ExportGrid.RowCount - 2] := 'Normal Recommand';
                ExportGrid.Cells[6, ExportGrid.RowCount - 2] := 'Jeux-video';
                ExportGrid.Cells[7, ExportGrid.RowCount - 2] := ProductsClone.FieldByName('products_root_category_name').Value;
                ExportGrid.Cells[8, ExportGrid.RowCount - 2] := '0';
                ExportGrid.Cells[9, ExportGrid.RowCount - 2] := ProductsClone.FieldByName('products_intername').AsString;
                ExportGrid.Cells[10, ExportGrid.RowCount - 2] := ProductsClone.FieldByName('products_description').AsString;
                ExportGrid.Cells[11, ExportGrid.RowCount - 2] := ProductImageURL + ProductsClone.FieldByName('products_image')
                  .AsString;
                ExportGrid.AddRow;
              end;
            end;
            i                    := i + 1;
            ProgressBar.Position := (i / (j) * 100);
            Application.ProcessMessages;
            StockClone.Next;
          end;

          ChDir(ExtractFilePath(ParamStr(0)));
          if not(DirectoryExists('export')) then
          begin
            CreateDir('export');
          end;
          ChDir(ExtractFilePath(ParamStr(0)) + '/export');

          SaveDialog.FileName := ExtractFilePath(ParamStr(0)) + 'export\' + 'marketplace.xml';
          // if SaveDialog.Execute then begin
          ExportGrid.SaveToXml(SaveDialog.FileName, 'invetory', 'inventory_lines', InventoryFields);
          // end;

          AFtpUp := TFtpUp.Create(SaveDialog.FileName, './' + ExtractFileName(SaveDialog.FileName), self.Parameter['M2XHost'], self.Parameter['M2XLogin'],
            self.Parameter['M2XPass'])

        finally
          StatusLine.Panels[3].Text := '';
          ProgressBar.Visible       := False;
          SaveDialog.Free;
          ExportGrid.Free;
          InventoryFields.Free;
          // Self.Enabled:=True;
          StockClone.Free;
          ProductsClone.Free;
        end;
      end;

      procedure TMainForm.SalesCaddyClose(Sender: TObject);
      begin
        with Sender as TAdvTabSheet do
        begin
          if AdvPageControl.PageCount = 1 then
          begin
            EditSalesCustomerNbr.Text := inttostr(ConnectedShop);
            RemoteDB.Customers.FindKey([inttostr(ConnectedShop)]);
            self.SBNewSalesCaddyClick(self);
          end;
        end;
      end;

      procedure TMainForm.StockinCaddyClose(Sender: TObject);
      begin
        with Sender as TAdvTabSheet do
        begin
          if AdvPageControl.PageCount = 1 then
          begin
            EditStockinCustomerNbr.Text := inttostr(ConnectedShop);
            RemoteDB.Customers.FindKey([inttostr(ConnectedShop)]);
            // Self.SBNewStockinCaddyClick(self);
          end;
        end;
      end;

      procedure TMainForm.StockinCaddyShow(Sender: TObject);
      var
        i: Integer;
        StockinType: string;
      begin
        with Sender as TAdvTabSheet do
        begin
          for i := 0 to TAdvTabSheet(Sender).ControlCount - 1 do
          begin
            if TAdvTabSheet(Sender).Controls[i].Tag = 10 then
            begin
              // Index du type de transaction
              StockinType := TLabel(TAdvTabSheet(Sender).Controls[i]).Caption;
            end;
          end;
        end;

        if StockinType = 'Neuf' then
        begin
          cxEditStockinPriceGross.Enabled := True;
          cxEditStockinPrice.Enabled      := False;
        end;
        if StockinType = 'Achat' then
        begin
          cxEditStockinPriceGross.Enabled := True;
          cxEditStockinPrice.Enabled      := True;
        end;
        if StockinType = 'Dpt' then
        begin
          cxEditStockinPriceGross.Enabled := False;
          cxEditStockinPrice.Enabled      := True;
        end;

      end;

      procedure TMainForm.DBComboCustomerCountryExit(Sender: TObject);
      begin
        if not RemoteDB.countries.Locate('countries_id', RemoteDB.Address_Book.FieldByName('entry_country_id').Value, []) then
          exit;
        if RemoteDB.Countries_To_Vat.Locate('countries_to_vat_iso', RemoteDB.countries.FieldByName('countries_iso_code_2').Value, []) then
        begin
          // if Customers.State=dsBrowse then Customers.Edit;
          // RemoteDB.Customerscustomers_TVA.Value:='';
          DBEditCustomerVAT.Properties.EditMask := RemoteDB.Countries_To_Vat.FieldByName('countries_to_vat_mask').Value;
        end else begin
          DBEditCustomerVAT.Properties.EditMask := '';
        end;
      end;

      procedure TMainForm.DBCheckCustCountryClick(Sender: TObject);
      begin
        RemoteDB.IsUpdating := True;
        RemoteDB.Customers.First;

        while not RemoteDB.Customers.Eof do
        begin
          ShowMessage(RemoteDB.Customerscustomers_firstname.AsString);
          if not(RemoteDB.Address_Bookentry_country_id.AsInteger > 0) then
          begin
            RemoteDB.Customers.Edit;
            ShowMessage(RemoteDB.Address_Bookentry_firstname.Value);
            RemoteDB.Address_Bookentry_country_id.AsInteger := 21;
            RemoteDB.Customers.Post;
          end;
          RemoteDB.Customers.Next;
        end;
        RemoteDB.IsUpdating := False;
      end;

      procedure TMainForm.ParamTreeParamChanged(Sender: TObject; ANode: TTreeNode; href, oldvalue, newvalue: string);
      begin
        if href = 'SyncAutoEnabled' then
        begin
          if newvalue = 'Oui' then
            MainForm.TimerDBupdate.Enabled := True
          else
            MainForm.TimerDBupdate.Enabled := False;
        end;
        if href = 'SyncDelay' then
        begin
          if StrtoInt(newvalue) < 15 then
          begin
            newvalue                              := '15';
            oldvalue                              := '15';
            self.ParamTree.Parameter['SyncDelay'] := '15';
          end;
          MainForm.TimerDBupdate.Interval := StrtoInt(newvalue) * 60000;
        end;
      end;

      procedure TMainForm.Ajouteraufiltre1Click(Sender: TObject);
      var
        MousePos: TPoint;
      begin
        // RemoteDB.Products.Filtered:=False;
        RemoteDB.Products.Filter   := 'categories_id = ' + inttostr(RemoteDB.Productscategories_id.Value);
        RemoteDB.Products.Filtered := True;
      end;

      procedure TMainForm.SuperWebSearch(product: string);
      var
        strData: string;
        PostData: OleVariant;
        Headers: OleVariant;
        i: Integer;
      begin

        Headers := 'Content-Type: application/x-www-form-urlencoded' + #10#13;

        strData := 'email=' + HTTPEncode(self.Parameter['BEMSLogin']) + '&' + 'password=' + HTTPEncode(self.Parameter['BEMSPass']) + '&' + 'etap=' +
          HTTPEncode('6') + '&' + '=' + HTTPEncode('Login');

        PostData := VarArrayCreate([0, Length(strData) - 1], varByte);

        for i             := 1 to Length(strData) do
          PostData[i - 1] := Ord(strData[i]);


        WebBrowserCLDReady := False;
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_callishop.aspx?ishopmethod=loginCustomer2&C_ID=' + GlobalsUnit.CLDLogin + '&C_PW=' +
          GlobalsUnit.CLDPass);
        while WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE do
          Application.ProcessMessages;
        self.WebBrowserCLD.Navigate('http://www.cld.be/SearchResults.aspx?Cle=' + HTTPEncode(product) + '&Platform=%25&Rayon=%25');
      end;

      procedure TMainForm.Supprimerfiltre1Click(Sender: TObject);
      begin
        RemoteDB.Products.Filtered := False;
        RemoteDB.Products.Filter   := '';
      end;

      procedure TMainForm.MenuItem1Click(Sender: TObject);
      begin
        // RemoteDB.Products.Filtered:=False;
        RemoteDB.Products.Filter   := 'manufacturers_id = ' + inttostr(RemoteDB.Productsmanufacturers_id.Value);
        RemoteDB.Products.Filtered := True;
      end;

      procedure TMainForm.model_comyClick(Sender: TObject);
      begin
        ClipBoard.AsText := StringGridAdmin.Cells[0, StringGridAdmin.Row];
      end;

      procedure TMainForm.MonthCalendarAdminSalesCloseUp(Sender: TObject);
      begin
        MonthCalendarAdminSalesEnd.Date := MonthCalendarAdminSales.Date;
      end;

      procedure TMainForm.WebbrowserCLDAddItems(QueryString: WideString);
      var
        FStartTime: TTime;
        Request   : String;
      begin
        FStartTime         := Now;
        WebBrowserCLDReady := False;
        Request :=  'http://www.cld.be/GM_callishop.aspx?ishopmethod=loginCustomer2&C_ID=' + GlobalsUnit.CLDLogin + '&C_PW=' +
          GlobalsUnit.CLDPass  ;
        self.WebBrowserCLD.Navigate(Request);
        while (WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE) and ((FStartTime - Now) > -5) do
          Application.ProcessMessages;
        // ShowMessage( FloatToStr(( FStartTime-now )));
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_callishop.aspx?ishopmethod=addItems&' + 'id_art=0&q=0' + QueryString + '');
        while (WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE) and ((FStartTime - Now) > -10) do
          Application.ProcessMessages;
        // ShowMessage( FloatToStr(( FStartTime-now )));
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_ShowCaddie.aspx');
        while (WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE) and ((FStartTime - Now) > -15) do
          Application.ProcessMessages;
      end;
      procedure TMainForm.WebbrowserCLDAddReturnItems(QueryString: WideString);
      var
        FStartTime: TTime;
        Request   : String;
      begin
        FStartTime         := Now;
        WebBrowserCLDReady := False;
        Request :=  'http://www.cld.be/GM_callishop.aspx?ishopmethod=loginCustomer2&C_ID=' + GlobalsUnit.CLDLogin + '&C_PW=' +
          GlobalsUnit.CLDPass  ;
        self.WebBrowserCLD.Navigate(Request);
        while (WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE) and ((FStartTime - Now) > -5) do
          Application.ProcessMessages;
        // ShowMessage( FloatToStr(( FStartTime-now )));
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_callishop.aspx?ishopmethod=returnadditems&' + 'id_art=0&q=0' + QueryString + '');
        while (WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE) and ((FStartTime - Now) > -10) do
          Application.ProcessMessages;
        // ShowMessage( FloatToStr(( FStartTime-now )));
        self.WebBrowserCLD.Navigate('http://www.cld.be/GM_ShowReturnCaddie.aspx');
        while (WebBrowserCLD.ReadyState <> READYSTATE_COMPLETE) and ((FStartTime - Now) > -15) do
          Application.ProcessMessages;
      end;


      procedure TMainForm.WebbrowserCLDAddItem(productmodel: string);
      begin
      end;

      procedure TMainForm.WebBrowserCLDDocumentComplete(ASender: TObject; const pDisp: IDispatch; var URL: OleVariant);
      begin
        WebBrowserCLDReady := True;
      end;

      procedure TMainForm.WebBrowserDownloadComplete(Sender: TObject);
      begin
        // showmessage('Comptet');
      end;

      procedure TMainForm.EdsearchEditing(Sender: TObject; var CanEdit: Boolean);
      var
        txt, sfind: string;
        len: Integer;
      begin
        // don't do anything if user presses
        // delete or backspace
        RemoteDB.Products.IndexName := 'ProductsIXName';
        if edfromcode = True then
        begin
          edfromcode := False;
          exit;
        end;

        // don't do anything if there is
        // no text in edSearch
        txt := Edsearch.Text;
        if Length(txt) = 0 then
          exit;

        // goto nearest match
        with RemoteDB.Products do
        begin
          SetKey;
          FieldByName('products_intername').AsString := Edsearch.Text;
          GotoNearest;
        end;

        // calculate what part of text should be selected
        sfind := RemoteDB.Products.FieldByName('products_intername').AsString;
        len   := Length(sfind) - Length(txt);
        if len > 0 then
        begin
          edfromcode         := True;
          Edsearch.Text      := sfind;
          Edsearch.SelStart  := Length(txt);
          Edsearch.SelLength := len;
        end;
      end;

      procedure TMainForm.EdsearchKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
      var
        txt, sfind: string;
        len: Integer;
      begin
        // don't do anything if user presses
        // delete or backspace
        RemoteDB.Products.IndexName := 'ProductsIXName';
        if edfromcode = True then
        begin
          edfromcode := False;
          exit;
        end;

        // don't do anything if there is
        // no text in edSearch          ww
        txt := Edsearch.Text;
        if Length(txt) = 0 then
          exit;

        // goto nearest match
        with RemoteDB.Products do
        begin
          SetKey;
          FieldByName('products_intername').AsString := Edsearch.Text;
          GotoNearest;
        end;

        // calculate what part of text should be selected
        sfind := RemoteDB.Products.FieldByName('products_intername').AsString;
        len   := Length(sfind) - Length(txt);
        if len > 0 then
        begin
          if UpperCase(LeftStr(sfind, Length(txt))) = UpperCase(Edsearch.Text) then
          begin
            edfromcode         := True;
            Edsearch.Text      := sfind;
            Edsearch.SelStart  := Length(txt);
            Edsearch.SelLength := len;
          end;
        end;

      end;

      procedure TMainForm.DBGridOrdersCellClick(Column: TColumn);
      begin
        Edsearch.Text := RemoteDB.Products.FieldByName('products_intername').AsString;
      end;

      procedure TMainForm.dxBarButtonCheckDacalClick(Sender: TObject);
      var
        AFormCheckLib: TFormCheckLib;
      begin
        RemoteDB.Products.Filtered:=False;
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Verifier Dacal';
        RemoteDB.CDSActions.Post;
        AFormCheckLib := TFormCheckLib.Create(self);
        AFormCheckLib.Show;
      end;

      procedure TMainForm.CustomersInvoicesPrintStickerClick(Sender: TObject);
      var
        Labelstoprint: TLabelAddress;
        Address: Tstrings;
      begin
        if (self.Parameter['PrintersLabelEnabled'] = 'TRUE') then
        begin
          Labelstoprint := TLabelAddress.Create;
          Address       := TStringList.Create;
          try
            Labelstoprint.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
            Address.Add('Client : ' + RemoteDB.CustomersCustomers_nbr.AsString);
            Address.Add(RemoteDB.Customers.FieldByName('customers_firstname').AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
            Address.Add(RemoteDB.Customerscustomers_fax.AsString);
            Address.Add(DateToStr(Now()));
            Labelstoprint.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
          finally
            Labelstoprint.Free;
            Address.Free;
          end;
        end
        else
          messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
      end;

      procedure TMainForm.cxButtonAdminDateRangeDayClick(Sender: TObject);
      begin
        MonthCalendarAdminSales.Date    := Now;
        MonthCalendarAdminSalesEnd.Date := Now;
      end;

      procedure TMainForm.cxButtonAdminDateRangeMonthClick(Sender: TObject);
      begin
        MonthCalendarAdminSalesEnd.Date := EndOfTheMonth(MonthCalendarAdminSales.Date);
        MonthCalendarAdminSales.Date    := EndOfTheMonth(MonthCalendarAdminSalesEnd.Date - 32) + 1;
      end;

      procedure TMainForm.cxButtonAdminDateRangeWeekClick(Sender: TObject);
      begin
        MonthCalendarAdminSalesEnd.Date := Endoftheweek(MonthCalendarAdminSales.Date);
        MonthCalendarAdminSales.Date    := MonthCalendarAdminSalesEnd.Date - 6;
      end;

      procedure TMainForm.cxEditStockinModelExit(Sender: TObject);
      var
        i: Integer;
        StockinType: string;
        suppliername: string;
        MinPrice, MinPriceDP, MinPriceSH: Double;
        DispoDP, DispoSH, Dispo: Integer;
      label Procend;
      begin
        cxEditStockinPriceGross.Value := 0;
        CxEditStockinQuantity.Text    := '1';
        LabelStockinWarning.Caption   := '';
        cxEditStockinModel.Text       := Trim(UpperCase(cxEditStockinModel.Text));

        if cxEditStockinModel.Text = '' then
        begin
          goto Procend;
        end;

        if PageControlStockinCaddy.ActivePage <> nil then
        begin
          for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
          begin
            if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 10 then
            begin
              StockinType := TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i]).Caption;
            end;

            if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 95 then
            begin
              suppliername := TEdit(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i]).Text;
            end;
          end;
        end else begin
          ShowMessage('Veuillez crer un caddy');
          goto Procend;
        end;

        if StockinType = 'Neuf' then
        begin
          // if RemoteDB.Suppliers.Locate('suppliers_name',SupplierName,[]) then begin
          // if RemoteDB.Suppliersstock.locate('products_model;suppliers_id',Vararrayof ([cxEditStockinModel.Text,RemoteDB.SuppliersSuppliers_id.AsVariant]),[locaseinsensitive]) then begin
          // cxEditStockinPriceGross.Value:=RemoteDB.SuppliersstockSuppliers_price.AsFloat
          // end else begin
          // cxEditStockinPriceGross.Value:=0;
          // end;
          // end else cxEditStockinPriceGross.Value:=0;
          if RemoteDB.Products.FindKey([cxEditStockinModel.Text]) then
          begin
            RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';

            if RemoteDB.netshop_stock.FindKey([cxEditStockinModel.Text]) then
            begin

              // Population de la listbox owner et recherche du prix min
              MinPrice   := 9999999;
              MinPriceDP := 9999999;
              MinPriceSH := 9999999;
              DispoDP    := 0;
              DispoSH    := 0;
              Dispo      := 0;

              repeat
                if RemoteDB.netshop_stock.FieldByName('product_model').Text = cxEditStockinModel.Text then
                begin
                  // Jeu Neuf
                  if ((RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger < 100000) and
                    (RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger < 100000)) then
                  begin
                    Dispo := Dispo + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                    if RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat < MinPrice then
                      MinPrice := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                  end;
                end;
                if (Dispo) > 0 then
                begin
                  LabelStockinWarning.Caption := 'Dj ';
                  if Dispo > 0 then
                  begin
                    LabelStockinWarning.Caption := LabelStockinWarning.Caption + inttostr(Dispo) + ' neuf(s)  ' + FloatToStr(MinPrice) + ' - ';
                  end;
                  LabelStockinWarning.Visible := True;
                end else begin
                  LabelStockinWarning.Caption := '';
                  LabelStockinWarning.Visible := False;
                end;
                RemoteDB.netshop_stock.Next;
              until (RemoteDB.netshop_stock.FieldByName('product_model').AsString <> cxEditStockinModel.Text) or RemoteDB.netshop_stock.Eof;
            end
          end;
          if RemoteDB.Products.FieldByName('products_cldprice').AsFloat > 0 then
          begin
            cxEditStockinPriceGross.Value := RemoteDB.Products.FieldByName('products_cldprice').AsFloat
          end else begin
            cxEditStockinPriceGross.Value := 0;
          end;
        end;

        if (StockinType = 'Dpt') or (StockinType = 'Achat') then
        begin
          // if RemoteDB.Suppliers.Locate('suppliers_name',SupplierName,[]) then begin
          // if RemoteDB.Suppliersstock.locate('products_model;suppliers_id',Vararrayof ([cxEditStockinModel.Text,RemoteDB.SuppliersSuppliers_id.AsVariant]),[locaseinsensitive]) then begin
          // cxEditStockinPriceGross.Value:=RemoteDB.SuppliersstockSuppliers_price.AsFloat
          // end else begin
          // cxEditStockinPriceGross.Value:=0;
          // end;
          // end else cxEditStockinPriceGross.Value:=0;
          if RemoteDB.Products.FindKey([cxEditStockinModel.Text]) then
          begin
            if RemoteDB.Products.FieldByName('products_used_price').AsFloat > 0 then
            begin
              cxEditStockinPrice.Value := RemoteDB.Products.FieldByName('products_used_price').AsFloat
            end
            else
              cxEditStockinPrice.Value := 0;
          end;

          RemoteDB.netshop_stock.IndexName := 'StockIXModelOwnerSupplier';

          if RemoteDB.netshop_stock.FindKey([cxEditStockinModel.Text]) then
          begin

            // Population de la listbox owner et recherche du prix min
            MinPrice   := 9999999;
            MinPriceDP := 9999999;
            MinPriceSH := 9999999;
            DispoDP    := 0;
            DispoSH    := 0;
            Dispo      := 0;

            repeat
              if RemoteDB.netshop_stock.FieldByName('product_model').Text = cxEditStockinModel.Text then
              begin
                // Jeu Neuf
                if ((RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger < 100000) and
                  (RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger < 100000)) then
                begin
                  Dispo := Dispo + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                  if RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat < MinPrice then
                    MinPrice := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                end;
                // Jeu occase
                if ((RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger >= 100000) and
                  (RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger < 100000)) then
                begin
                  DispoSH := DispoSH + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                  if RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat < MinPriceSH then
                    MinPriceSH := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                end;
                // Jeu dpt
                if RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger >= 100000 then
                begin
                  DispoDP := DispoDP + RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
                  if RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat < MinPriceDP then
                    MinPriceDP := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
                end;
              end;
              if (Dispo + DispoSH + DispoDP) > 0 then
              begin
                LabelStockinWarning.Caption := 'Dj ';
                if Dispo > 0 then
                begin
                  LabelStockinWarning.Caption := LabelStockinWarning.Caption + inttostr(Dispo) + ' neuf(s)  ' + FloatToStr(MinPrice) + ' - ';
                end;
                if DispoSH > 0 then
                begin
                  LabelStockinWarning.Caption := LabelStockinWarning.Caption + inttostr(DispoSH) + ' rachat(s)  ' + FloatToStr(MinPriceSH) + ' - ';
                end;
                if DispoDP > 0 then
                begin
                  LabelStockinWarning.Caption := LabelStockinWarning.Caption + inttostr(DispoDP) + ' dpt(s)  ' + FloatToStr(MinPriceDP) + ' - ';
                end;
                LabelStockinWarning.Visible := True;
              end else begin
                LabelStockinWarning.Caption := '';
                LabelStockinWarning.Visible := False;
              end;
              RemoteDB.netshop_stock.Next;
            until (RemoteDB.netshop_stock.FieldByName('product_model').AsString <> cxEditStockinModel.Text) or RemoteDB.netshop_stock.Eof;
          end
        end;

      Procend:
      end;

      procedure TMainForm.cxGridDBTableViewCustomersOrdersDblClick(Sender: TObject);
      var
        aTransferRequestForm: TTransferRequestForm;
      begin
        aTransferRequestForm                        := TTransferRequestForm.Create(self);
        aTransferRequestForm.products_model         := RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString;
        aTransferRequestForm.products_name          := RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString;
        aTransferRequestForm.products_root_category := RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString;
        aTransferRequestForm.Show;
      end;

      procedure TMainForm.cxGridViewRepositoryDBTableViewSalesDepositStylesGetContentStyl(
  Sender: TcxCustomGridTableView; ARecord: TcxCustomGridRecord;
  AItem: TcxCustomGridTableItem; var AStyle: TcxStyle);
      var
        AColumn: TcxCustomGridTableItem;
      begin
        AColumn := (Sender as TcxGridDBTableView).GetColumnByFieldName('product_isdefect');
        if VarToStr(ARecord.values[AColumn.Index]) = '1' then
          AStyle := StyleError;
      end;

procedure TMainForm.cxGridViewRepositoryDBTableViewSalesDepositStylesGetContentStyle(
  Sender: TcxCustomGridTableView; ARecord: TcxCustomGridRecord;
  AItem: TcxCustomGridTableItem; var AStyle: TcxStyle);
      var
        AColumn: TcxCustomGridTableItem;
      begin
        AColumn := (Sender as TcxGridDBTableView).GetColumnByFieldName('product_isdefect');
        if VarToStr(ARecord.values[AColumn.Index]) = '1' then
          AStyle := StyleError;
      end;

procedure TMainForm.cxtxtdtEanKeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
      var
        txt, sfind: string;
        len: Integer;
      begin
        // don't do anything if user presses
        // delete or backspace
        RemoteDB.Products.IndexName := 'ProductsIXModel';
        if edfromcode = True then
        begin
          edfromcode := False;
          exit;
        end;

        // don't do anything if there is
        // no text in edSearch          ww
        txt := cxtxtdtEan.Text;
        if Length(txt) = 0 then
          exit;

        // goto nearest match
        with RemoteDB.Products do
        begin
          SetKey;
          FieldByName('products_model').AsString := cxtxtdtEan.Text;
          GotoNearest;
        end;

        // calculate what part of text should be selected
        sfind := RemoteDB.Products.FieldByName('products_model').AsString;
        len   := Length(sfind) - Length(txt);
        if len > 0 then
        begin
          if UpperCase(LeftStr(sfind, Length(txt))) = UpperCase(cxtxtdtEan.Text) then
          begin
            edfromcode         := True;
            cxtxtdtEan.Text      := sfind;
            cxtxtdtEan.SelStart  := Length(txt);
            cxtxtdtEan.SelLength := len;
          end;
        end;
end;

procedure TMainForm.EditStockinCustomerIdKeyPress(Sender: TObject; var Key: Char);
      const
        backspace = #8; { key code for backspace character }
      begin
        if Key in [backspace, '0' .. '9'] then
        begin

          exit;
        end;
        Key := #0;
      end;

      procedure TMainForm.EditStockinCustomerIdKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
      begin
        if (EditStockinCustomerNbr.Text > '0') and (EditStockinCustomerNbr.Text < '99999999') then
        begin
          if not RemoteDB.Customers.Locate('Customers_nbr', EditStockinCustomerNbr.Text, [locaseinsensitive]) then
            RemoteDB.Customers.First;
        end else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
          EditStockinCustomerNbr.Text := inttostr(ConnectedShop);
        end;
      end;

      procedure TMainForm.EditStockinCustomerNbrKeyPress(Sender: TObject; var Key: Char);
      const
        backspace = #8; { key code for backspace character }
      begin
        if Length(EditStockinCustomerNbr.Text) < 8 then
        begin
          if Key in [backspace, '0' .. '9'] then
          begin
            exit;
          end;
          Key := #0;
        end else begin
          if Key <> #8 then
            Key := #0;
        end;
      end;

      procedure TMainForm.EditStockinCustomerNbrKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
      begin
        if (EditStockinCustomerNbr.Text > '0') and (EditStockinCustomerNbr.Text < '99999999') then
        begin
          if not RemoteDB.Customers.Locate('Customers_nbr', EditStockinCustomerNbr.Text, [locaseinsensitive]) then
            RemoteDB.Customers.First;
        end else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
          EditStockinCustomerNbr.Text := inttostr(ConnectedShop);
        end;
      end;

      procedure TMainForm.EditSalesCustomerNbrKeyPress(Sender: TObject; var Key: Char);
      const
        backspace = #8; { key code for backspace character }
      begin
        if Key in [backspace, '0' .. '9'] then
        begin
          exit;
        end;
        Key := #0;
      end;

      procedure TMainForm.EditSalesCustomerNbrEnter(Sender: TObject);
      begin
        EditSalesCustomerNbr.SelectAll;
      end;

      procedure TMainForm.EditSalesCustomerNbrKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
      begin
        if (EditSalesCustomerNbr.Text > '0') and (EditSalesCustomerNbr.Text < '99999999') then
        begin
          if not RemoteDB.Customers.Locate('Customers_nbr', EditSalesCustomerNbr.Text, [locaseinsensitive]) then
            RemoteDB.Customers.First;
        end else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
          EditSalesCustomerNbr.Text := inttostr(ConnectedShop);
        end;
      end;

      procedure TMainForm.BitBtnPurchaseHistoryClick(Sender: TObject);
      var
        aFormProductSaleHistory: TFormProductSaleHistory;
      begin
        RemoteDB.netshop_items_sold.Filter   := 'items_sold_model = ' + QuotedStr(RemoteDB.Productsproducts_model.AsString);
        RemoteDB.netshop_items_sold.Filtered := True;
        RemoteDB.IsUpdating                  := True;
        aFormProductSaleHistory              := TFormProductSaleHistory.Create(self);
        aFormProductSaleHistory.Model        := QuotedStr(RemoteDB.Productsproducts_model.AsString);
        try
          aFormProductSaleHistory.ShowModal
        finally
          RemoteDB.IsUpdating                  := False;
          RemoteDB.netshop_items_sold.Filtered := False;
          RemoteDB.netshop_items_sold.Filter   := '';
          aFormProductSaleHistory.Free;
        end;
      end;

      procedure TMainForm.DBDebugExecute(Sender: TObject);
      var
        DebugForm: TDebug;
      begin
        DebugForm := TDebug.Create(self);
        try
          RemoteDB.IsUpdating := True;
          DebugForm.ShowModal();
        finally
          DebugForm.Free;
          RemoteDB.IsUpdating := False;
        end;
      end;

      procedure TMainForm.SpeedButtonTipsAddClick(Sender: TObject);
      begin
        RemoteDB.Tips.Append;
      end;

      procedure TMainForm.SpeedButtonTipsDeleteClick(Sender: TObject);
      begin
        with RemoteDB.Tips do
        begin
          if not(Eof and Bof) then
            delete;
        end;
      end;

      procedure TMainForm.DBGridOrdersDblClick(Sender: TObject);
      var
        ANotifyServer: TNotifyServer;
      begin
        begin
          if RemoteDB.netshop_customers_alerts.Locate('customers_alerts_customers_nbr;customers_alerts_products_model',
            Vararrayof([RemoteDB.CustomersCustomers_nbr.AsString, RemoteDB.Productsproducts_model.AsString]), [locaseinsensitive]) then
          begin
            if messagedlg('Client dj inscrit ? Voulez-vous rajouter un article supplmentaire ?', mtwarning, [mbyes, mbno], 0, mbno) = mryes then
            begin
              RemoteDB.netshop_customers_alerts.Edit;
              RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger :=
                RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger + 1;
              RemoteDB.netshop_customers_alerts.Post;
            end;
            exit;
          end;
          RemoteDB.netshop_customers_alerts.Append;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.CustomersCustomers_nbr.AsString;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := RemoteDB.Productsproducts_model.AsString;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString :=
            RemoteDB.Products.FieldByName('products_intername').AsString;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_cat').AsString := RemoteDB.Productsproducts_root_category_name.AsString;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := Round(StrtoInt(CustomerAlertMaxPrice.Text));
          RemoteDB.netshop_customers_alerts.Post;

          if UserType = 1 then
          begin
            ANotifyServer := TNotifyServer.Create('smsalert', RemoteDB.Customerscustomers_email_address.AsString, '', NOTIFYURL);
          end;

          CustomerAlertMaxPrice.Text := '0';
        end;
      end;

      procedure TMainForm.dxBarButtonRapportStockNewClick(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        Filter                          := RemoteDB.netshop_stock.Filter;
        FilterState                     := RemoteDB.netshop_stock.Filtered;
        RemoteDB.netshop_stock.Filter   := 'product_supplier_id<100000 and product_owner_id = ' + inttostr(ConnectedShop);
        RemoteDB.netshop_stock.Filtered := True;
        try
          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportStock', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally
          RemoteDB.netshop_stock.Filter   := Filter;
          RemoteDB.netshop_stock.Filtered := FilterState;
        end;
      end;

      procedure TMainForm.dxBarButtonRebuildRootCatClick(Sender: TObject);
      begin
        RemoteDB.ProductsRebuildRootCatNames;
      end;

      procedure TMainForm.dxBarButtonReportAlertsClick(Sender: TObject);
      var
        i: Integer;
        originalIndex: string;
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Rapport commandes';
        RemoteDB.CDSActions.Post;
        ChDir(ExtractFilePath(ParamStr(0)));
        originalIndex := RemoteDB.netshop_customers_alerts.IndexName;
        RemoteDB.FilterAlertsReserved;
        RemoteDB.netshop_customers_alerts.IndexName := 'AlertsIXModel';
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportAlerts', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);

        ReportModule.RvSystem.DefaultDest    := rdpreview;
        ReportModule.RvSystem.DoNativeOutput := True;
        ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
        // ReportModule.RvSystem.Execute;

        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;
        RemoteDB.FilterAlertsAll;
        RemoteDB.netshop_customers_alerts.IndexName := originalIndex;
      end;

      procedure TMainForm.dxBarButtonReportCustomerCreditClick(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        Filter                      := RemoteDB.Customers.Filter;
        FilterState                 := RemoteDB.Customers.Filtered;
        RemoteDB.Customers.Filter   := 'customers_credit>0';
        RemoteDB.Customers.Filtered := True;
        try
          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportCustomerCredit', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally
          RemoteDB.Customers.Filter   := Filter;
          RemoteDB.Customers.Filtered := FilterState;
        end;
      end;

      procedure TMainForm.dxBarButtonReportDepositNonRefundedClick(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        Filter                               := RemoteDB.netshop_items_sold.Filter;
        FilterState                          := RemoteDB.netshop_items_sold.Filtered;
        RemoteDB.netshop_items_sold.Filter   := 'items_sold_owner_id>=100000 AND items_refunded=0';
        RemoteDB.netshop_items_sold.Filtered := True;
        try
          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportCustomerStockSold', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally
          RemoteDB.netshop_items_sold.Filter   := Filter;
          RemoteDB.netshop_items_sold.Filtered := FilterState;
        end;
      end;

      procedure TMainForm.dxBarButtonReportInvoiceBatchClick(Sender: TObject);
      var
        aInvoiceBatchPrintForm: TInvoiceBatchPrintForm;
      begin
        aInvoiceBatchPrintForm := TInvoiceBatchPrintForm.Create(self);
        try
          aInvoiceBatchPrintForm.ShowModal;
        finally
          aInvoiceBatchPrintForm.Free;
        end

      end;

      procedure TMainForm.dxBarButtonReportRepairClick(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        Filter                           := RemoteDB.netshop_repair.Filter;
        FilterState                      := RemoteDB.netshop_repair.Filtered;
        RemoteDB.netshop_repair.Filter   := 'repair_returned = ' + QuotedStr('false');
        RemoteDB.netshop_repair.Filtered := True;
        try
          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportRepair', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally
          RemoteDB.netshop_repair.Filter   := Filter;
          RemoteDB.netshop_repair.Filtered := FilterState;
        end;
      end;

      procedure TMainForm.dxBarButtonReportsStockSHClick(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        Filter                          := RemoteDB.netshop_stock.Filter;
        FilterState                     := RemoteDB.netshop_stock.Filtered;
        RemoteDB.netshop_stock.Filter   := 'product_supplier_id>=100000 and product_owner_id = ' + inttostr(ConnectedShop);
        RemoteDB.netshop_stock.Filtered := True;
        try
          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportStock', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups - [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally
          RemoteDB.netshop_stock.Filter   := Filter;
          RemoteDB.netshop_stock.Filtered := FilterState;
        end;
      end;

      procedure TMainForm.dxBarButtonScanDacalClick(Sender: TObject);
begin
OnUSBCDDeviceChange;
end;

procedure TMainForm.dxBarButtonSearchCLDClick(Sender: TObject);
      begin
        ActionWebInfo.Execute;
        AdvPageControlBrowser.ActivePage := AdvTabSheetBrowserCLD;
        self.dxBarButtonSearchLocalClick(nil);
      end;

      procedure TMainForm.dxBarButtonSearchLocalClick(Sender: TObject);
      var
        Found, followup: Boolean;
      begin
        Found := False;
        if lowercase(searchstring.Text) = LastSearchString then
          followup := True
        else
          followup       := False;
        LastSearchString := lowercase(searchstring.Text);

        case PageControlMainForm.ActivePageIndex of
          0:
            begin
              try
                RemoteDB.Products.DisableControls;
                if not followup then
                  RemoteDB.Products.First
                else
                  RemoteDB.Products.Next;
                while (not Found) and (not RemoteDB.Products.Eof) do
                begin
                  if Pos(lowercase(searchstring.Text), lowercase(RemoteDB.Products.FieldByName('products_model').AsString)) <> 0 then
                  begin
                    Found := True;
                  end;
                  if Pos(lowercase(searchstring.Text), lowercase(RemoteDB.Products.FieldByName('products_intername').AsString)) <> 0 then
                  begin
                    Found := True;
                  end;
                  if not Found then
                    RemoteDB.Products.Next;
                end;
              finally
                if RemoteDB.Products.Eof then
                begin
                  LastSearchString := '';
                  if Found = False then
                    messagedlg('Produit non trouv', mtwarning, [mbok], 0);
                end;
                RemoteDB.Products.EnableControls;
              end;
            end;

          1:
            begin
              try
                RemoteDB.Customers.DisableControls;
                if not followup then
                  RemoteDB.Customers.First
                else
                  RemoteDB.Customers.Next;
                while (not Found) and (not RemoteDB.Customers.Eof) do
                begin
                  if Pos(lowercase(searchstring.Text), lowercase(RemoteDB.Customers.FieldByName('customers_nbr').AsString)) <> 0 then
                  begin
                    Found := True;
                  end;
                  if Pos(lowercase(searchstring.Text), lowercase(RemoteDB.Customers.FieldByName('customers_firstname').AsString)) <> 0 then
                  begin
                    Found := True;
                  end;
                  if Pos(lowercase(searchstring.Text), lowercase(RemoteDB.Customers.FieldByName('customers_lastname').AsString)) <> 0 then
                  begin
                    Found := True;
                  end;
                  if Pos(lowercase(searchstring.Text), lowercase(RemoteDB.Customers.FieldByName('customers_email_address').AsString)) <> 0 then
                  begin
                    Found := True;
                  end;
                  if not Found then
                    RemoteDB.Customers.Next;
                end;
              finally
                if RemoteDB.Customers.Eof then
                begin
                  LastSearchString := '';
                  if Found = False then
                    messagedlg('Client non trouv', mtwarning, [mbok], 0);
                end;
                RemoteDB.Customers.EnableControls;
              end;
            end;

          10:
            begin
              SuperWebSearch(searchstring.Text);
            end;
        end;

      end;


      procedure TMainForm.dxBarButtonStock0valComputeClick(Sender: TObject);
      var
        MinPrice, PriceCat: Double;
        Position, RecordCount, margin: Integer;

      begin
        RemoteDB.IsUpdating             := True;
        RemoteDB.netshop_stock.Filter   := 'product_price_gross=0 and product_supplier_id<100000 and product_owner_id = ' + inttostr(ConnectedShop);
        RemoteDB.netshop_stock.Filtered := True;
        RecordCount                     := RemoteDB.netshop_stock.RecordCount;
        ProgressBar.Position            := 0;
        ProgressBar.Visible             := True;
        Position                        := 0;

        try
          RemoteDB.netshop_stock.First;
          while not RemoteDB.netshop_stock.Eof do
          begin
            if RemoteDB.Products.FindKey([RemoteDB.netshop_stock.FieldByName('product_model').AsString]) and (RemoteDB.ProductsProducts_Price.AsFloat > 0) then
            begin
              RemoteDB.netshop_stock.Edit;

              if ((RemoteDB.netshop_stock.FieldByName('product_model').AsString = 'MICRO') or
                (RemoteDB.netshop_stock.FieldByName('product_model').AsString = 'REPA') or (RemoteDB.Productsproducts_posa.AsInteger=1)) then
              begin
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := 0;

              end
              else
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat :=
                  Round(RemoteDB.ProductsProducts_Price.AsFloat / (1 + (MarginNew / 100)) * 100) / 100;;
              if RemoteDB.netshop_stock.State = dsEdit then
                RemoteDB.netshop_stock.Post;

            end else begin
              RemoteDB.netshop_stock.Edit;

              if ((RemoteDB.netshop_stock.FieldByName('product_model').AsString = 'MICRO') or
                (RemoteDB.netshop_stock.FieldByName('product_model').AsString = 'REPA')) then
              begin
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := 0;

              end
              else
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat :=
                  Round(RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat / (1 + (MarginNew / 1.21 / 100)) *
                  100) / 100;;

              if RemoteDB.netshop_stock.State = dsEdit then
                RemoteDB.netshop_stock.Post;
            end;
            Position             := Position + 1;
            ProgressBar.Position := (Position / RecordCount * 100);
            RemoteDB.netshop_stock.Next;
            Application.ProcessMessages;
          end;
        finally
          RemoteDB.netshop_stock.Filtered := False;
          RemoteDB.netshop_stock.Filter   := '';
          ProgressBar.Visible             := False;
          ProgressBar.Position            := 0;
          RemoteDB.IsUpdating             := False;
        end;

      end;

      procedure TMainForm.dxBarButtonStockByPlatformClick(Sender: TObject);
      var
        aReportSQL: TReportSQL;
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Rapport stock occasion par plateforme';
        RemoteDB.CDSActions.Post;
        with RemoteDB.SQLQuery do
        begin
          CommandText :=
            'SELECT p.products_root_category_name as Platform,ns.product_name as Product, ns.product_quantity as Q, ns.product_owner_id as Owner, ns.product_supplier_id as Supplier, ns.product_price_stock as Price ';
          CommandText := CommandText + ' FROM netshop_stock ns inner join products p on p.products_model=ns.product_model';
          CommandText := CommandText + ' WHERE ns.product_location=' + inttostr(ConnectedShop) +
            ' and (ns.product_owner_id>=100000 or ns.product_supplier_id>=100000)';
          CommandText := CommandText + ' ORDER BY p.products_root_category_name,ns.product_price_stock';
        end;

        aReportSQL := TReportSQL.Create(self);
        try
          aReportSQL.CDSReport.Open;
          aReportSQL.cxGridReportDBTableViewReport.DataController.CreateAllItems(True);
          aReportSQL.ShowModal;
        finally
          aReportSQL.Free;
        end;
      end;

      procedure TMainForm.dxBarButtonStockClearValueClick(Sender: TObject);
      var
        MinPrice, PriceCat: Double;
        Position, RecordCount, margin: Integer;

      begin
        RemoteDB.IsUpdating             := True;
        RemoteDB.netshop_stock.Filter   := 'product_supplier_id<100000 and product_owner_id = ' + inttostr(ConnectedShop);
        RemoteDB.netshop_stock.Filtered := True;
        RecordCount                     := RemoteDB.netshop_stock.RecordCount;
        ProgressBar.Position            := 0;
        ProgressBar.Visible             := True;
        Position                        := 0;

        try
          RemoteDB.netshop_stock.First;
          while not RemoteDB.netshop_stock.Eof do
          begin
            RemoteDB.netshop_stock.Edit;
            RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := 0;
            RemoteDB.netshop_stock.Post;
            Position             := Position + 1;
            ProgressBar.Position := (Position / RecordCount * 100);
            Application.ProcessMessages;
            RemoteDB.netshop_stock.Next;
          end;
        finally
          RemoteDB.netshop_stock.Filtered := False;
          RemoteDB.netshop_stock.Filter   := '';
          ProgressBar.Visible             := False;
          ProgressBar.Position            := 0;
          RemoteDB.IsUpdating             := False;
        end;
      end;

      procedure TMainForm.EntrerCaroussel1Click(Sender: TObject);
      var
        AEnterLib: TFormEnterLibrary;
      begin
        AEnterLib := TFormEnterLibrary.Create(self);
        try
          AEnterLib.Enter(RemoteDB.netshop_stock.FieldByName('product_owner_id').AsString, RemoteDB.netshop_stock.FieldByName('product_model').AsString);
        finally
          AEnterLib.Free;
        end;

      end;

      procedure TMainForm.EditRentCustomerIdOldEnter(Sender: TObject);
      begin
        EditRentCustomerId.SelectAll
      end;

      procedure TMainForm.EditRentCustomerIdOldKeyPress(Sender: TObject; var Key: Char);
      const
        backspace = #8; { key code for backspace character }
      begin
        if Key in [backspace, '0' .. '9'] then
        begin

          exit;
        end;
        Key := #0;
      end;

      procedure TMainForm.EditRentCustomerIdOldKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
      begin
        if (EditRentCustomerId.Text > '0') and (EditRentCustomerId.Text < '99999999') then
        begin
          if not RemoteDB.Customers.Locate('Customers_nbr', EditRentCustomerId.Text, [locaseinsensitive]) then
            RemoteDB.Customers.First;
        end else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
          EditRentCustomerId.Text := inttostr(ConnectedShop);
        end;
      end;

      procedure TMainForm.JVButtonCustomerRentActivateClick(Sender: TObject);
      var
        Nowrow, i, j, Index, page: Integer;

      begin
        // Find Customer Caddy
        page  := -1;
        for i := 0 to self.PageControlSalesCaddy.PageCount - 1 do
        begin
          for j := 0 to TAdvTabSheet(self.PageControlSalesCaddy.Pages[i]).ControlCount - 1 do
          begin
            if self.PageControlSalesCaddy.Pages[i].Controls[j].Tag = 100 then
            begin
              if TEdit(self.PageControlSalesCaddy.Pages[i].Controls[j]).Text = RemoteDB.CustomersCustomers_nbr.AsString then
              begin
                page := i;
              end;
            end;
          end;
        end;

        // Create New caddy if not found
        if page = -1 then
        begin
          SBNewSalesCaddyClick(self);
          page := self.PageControlSalesCaddy.ActivePageIndex;
        end;

        // Find Grid and populate
        for i := 0 to TAdvTabSheet(self.PageControlSalesCaddy.Pages[page]).ControlCount - 1 do
        begin
          if TAdvTabSheet(self.PageControlSalesCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
          begin
            index := i;
          end;
        end;
        with TAdvStringGrid(TAdvTabSheet(self.PageControlSalesCaddy.Pages[page]).Controls[index]) do
        begin
          Nowrow           := RowCount - 1;
          Cells[0, Nowrow] := 'LOCA';
          Cells[1, Nowrow] := 'Activation';
          Cells[2, Nowrow] := '1';
          Cells[3, Nowrow] := '15';
          Cells[4, Nowrow] := '15';
          Cells[5, Nowrow] := '0';
          Cells[6, Nowrow] := DateToStr(Now);
          Cells[7, Nowrow] := inttostr(ConnectedShop);
          Cells[8, Nowrow] := '0';
          RowCount         := Nowrow + 2;
        end;
      end;

      procedure TMainForm.dxBarButton6Click(Sender: TObject);
      var
        LastCust, Pindex, i: Integer;
        CustArray: array of Integer;

      begin
        RemoteDB.netshop_rent_transaction.Filter   := 'rent_transaction_returned=0 and rent_transaction_due_date < ' + FloatToStr(Round(Now));
        RemoteDB.netshop_rent_transaction.Filtered := True;
        RemoteDB.netshop_rent_transaction.First;
        try
          RemoteDB.Rent_late.First;
          while not RemoteDB.Rent_late.Eof do
            RemoteDB.Rent_late.delete;
          while not RemoteDB.netshop_rent_transaction.Eof do
          begin
            RemoteDB.Rent_late.Append;
            RemoteDB.Rent_lateCustomer_Nbr.Value  := RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_customer_nbr').AsInteger;
            RemoteDB.Rent_lateProduct_Model.Value := RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_product_model').Value;
            RemoteDB.Rent_lateDate_Out.Value      := RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_start_date').Value;
            RemoteDB.Rent_lateDate_Due.Value      := RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_due_date').Value;
            RemoteDB.Rent_lateProduct_Name.Value  := RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_product_name').Value;
            RemoteDB.Rent_lateOverdue_Days.Value  := trunc(Now - RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_due_date').Value);
            if not RemoteDB.netshop_rent_schemes.FindKey([RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_scheme_id').Value]) then
            begin
              ShowMessage('Rent Scheme not found');
              RemoteDB.netshop_rent_transaction.Filtered := False;
              exit;
            end;
            RemoteDB.Rent_lateOverdue_Amont.Value := RemoteDB.Rent_lateOverdue_Days.Value * RemoteDB.netshop_rent_schemes.FieldByName
              ('rent_scheme_extra_price').Value;
            RemoteDB.Rent_late.Post;
            RemoteDB.netshop_rent_transaction.Next;
          end;
        finally
          RemoteDB.netshop_rent_transaction.Filter   := '';
          RemoteDB.netshop_rent_transaction.Filtered := False;
        end;

        RemoteDB.SetAddress_bookToCustomers;
        ChDir(ExtractFilePath(ParamStr(0)));
        Pindex := Printer.Printers.IndexOf((self.Parameter['PrintersRapportPrinter']));
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportRentLate', True);
        ReportModule.RvProject.SetParam('URL', WEBURL);
        ReportModule.RvProject.SetParam('Date', DateToStr(trunc(Now)));
        ReportModule.RvProject.SetParam('Conditions', '');
        ReportModule.RvSystem.DefaultDest             := rdPrinter;
        ReportModule.RvSystem.SystemSetups            := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
        ReportModule.RvNDRWriter.PrinterIndex         := Pindex;
        ReportModule.RvSystem.SystemPreview.FormState := wsMaximized;

        RemoteDB.Rent_late.IndexFieldNames := 'customer_nbr';
        RemoteDB.Rent_late.First;
        LastCust := 0;
        while not RemoteDB.Rent_late.Eof do
        begin
          if RemoteDB.Rent_lateCustomer_Nbr.Value <> LastCust then
          begin
            LastCust := RemoteDB.Rent_lateCustomer_Nbr.Value;
            SetLength(CustArray, Length(CustArray) + 1);
            CustArray[high(CustArray)] := LastCust;
          end;
          RemoteDB.Rent_late.Next;
        end;

        for i := 0 to high(CustArray) do
        begin
          RemoteDB.Customers.FindKey([CustArray[i]]);
          RemoteDB.Rent_late.Filter   := 'Customer_Nbr = ' + inttostr(CustArray[i]);
          RemoteDB.Rent_late.Filtered := True;
          ReportModule.RvProject.Execute;
        end;

        ReportModule.RvProject.Close;
        RemoteDB.Rent_late.Filtered := False;
      end;

      procedure TMainForm.dxBarButton8Click(Sender: TObject);
      var
        AFormExportWinbooks: TFormExportWinbooks;
      begin
        AFormExportWinbooks := TFormExportWinbooks.Create(self);
        try
          AFormExportWinbooks.ShowModal;
        finally
          AFormExportWinbooks.Free;
        end;
      end;

      procedure TMainForm.dxBarButtonApplyUpdatesClick(Sender: TObject);
      begin
        RemoteDB.ApplyUpdates;
      end;

      procedure TMainForm.dxBarButtonCleanStockClick(Sender: TObject);
      var
        i: Integer;
      begin
        ProduitsExecute(self);
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Purger DB';
        RemoteDB.CDSActions.Post;
        try
          i                   := 0;
          RemoteDB.IsUpdating := True;
          RemoteDB.Products.DisableControls;
          RemoteDB.netshop_stock.DisableControls;
          RemoteDB.netshop_stock.First;
          ProgressBar.Visible := True;
          self.Enabled        := False;
          if RemoteDB.netshop_stock.RecordCount > 0 then
            ProgressBar.Position := i / (RemoteDB.netshop_stock.RecordCount) * 100;
          while not RemoteDB.netshop_stock.Eof do
          begin

            if not RemoteDB.Products.Locate('products_model', RemoteDB.netshop_stock.FieldByName('product_model').AsString, [locaseinsensitive]) then
            begin
              if messagedlg('Le produit ' + RemoteDB.netshop_stock.FieldByName('product_name').AsString + ' va tre supprim du stock', mtwarning,
                [mbyes, mbno], 0) = mryes then
              begin
                RemoteDB.netshop_stock.delete;
              end
              else
                RemoteDB.netshop_stock.Next;

            end
            else
              RemoteDB.netshop_stock.Next;
            i                    := i + 1;
            ProgressBar.Position := i / (RemoteDB.netshop_stock.RecordCount) * 100;
            Application.ProcessMessages;
          end;
        finally
          RemoteDB.IsUpdating := False;
          RemoteDB.Products.EnableControls;
          RemoteDB.netshop_stock.EnableControls;
          ProgressBar.Visible := False;
          self.Enabled        := True;
        end;
      end;

      procedure TMainForm.dxBarButtonClientsClick(Sender: TObject);
      begin
        Clients.Execute;
        self.dxBarButtonSearchLocalClick(nil);
      end;

      procedure TMainForm.dxBarButton11Click(Sender: TObject);
      var
        Filter: string;
        FilterState: Boolean;
      begin
        Filter                          := RemoteDB.netshop_stock.Filter;
        FilterState                     := RemoteDB.netshop_stock.Filtered;
        RemoteDB.netshop_stock.Filter   := 'product_owner_id >= 100000';
        RemoteDB.netshop_stock.Filtered := True;
        try
          RemoteDB.Shops.FindKey([ConnectedShop]);
          ReportModule.RvProject.Open;
          ReportModule.RvProject.SelectReport('ReportStock', True);
          ReportModule.RvProject.SetParam('URL', WEBURL);
          ReportModule.RvSystem.DefaultDest    := rdpreview;
          ReportModule.RvSystem.DoNativeOutput := True;
          ReportModule.RvSystem.SystemSetups   := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
          // ReportModule.RvSystem.Execute;

          ReportModule.RvProject.Execute;
          ReportModule.RvProject.Close;
        finally
          RemoteDB.netshop_stock.Filter   := Filter;
          RemoteDB.netshop_stock.Filtered := FilterState;
        end;
      end;

      procedure TMainForm.dxBarButton14Click(Sender: TObject);
      begin
        self.WebbrowserCLDAddItem(searchstring.Text);
      end;

      procedure TMainForm.dxBarButton1Click(Sender: TObject);
      var
        MinPrice, PriceCat: Double;
        Position, RecordCount, margin: Integer;

      begin
        RemoteDB.IsUpdating             := True;
        RemoteDB.netshop_stock.Filter   := 'product_supplier_id<100000 and product_owner_id = ' + inttostr(ConnectedShop);
        RemoteDB.netshop_stock.Filtered := True;
        RecordCount                     := RemoteDB.netshop_stock.RecordCount;
        ProgressBar.Position            := 0;
        ProgressBar.Visible             := True;
        Position                        := 0;

        try
          RemoteDB.netshop_stock.First;
          while not RemoteDB.netshop_stock.Eof do
          begin
            // if RemoteDB.SuppliersStock.Locate('Products_model',Uppercase(RemoteDB.netshop_stock.FieldByName('product_model.AsString),[locaseinsensitive])  then begin
            // RemoteDB.netshop_stock.FieldByName('.Edit;
            // RemoteDB.netshop_stock.FieldByName('product_price_gross.AsFloat:=RemoteDB.SuppliersStocksuppliers_price.AsFloat;
            // RemoteDB.netshop_stock.FieldByName('.Post;
            // end;

            if RemoteDB.Products.Locate('products_model', UpperCase(RemoteDB.netshop_stock.FieldByName('product_model').AsString), [locaseinsensitive]) then
            begin
              RemoteDB.netshop_stock.Edit;
              if RemoteDB.Productsproducts_posa.AsInteger=1 then  begin
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := 0;
              end else begin
              if ((RemoteDB.Products.FieldByName('products_price').AsFloat) < (RemoteDB.Products.FieldByName('products_cldprice').AsFloat * 1.0)) then
              begin
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := (RemoteDB.Products.FieldByName('products_price').AsFloat / 1.1);
              end else begin
                RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat := RemoteDB.Products.FieldByName('products_cldprice').AsFloat;
              end;
              end;
              RemoteDB.netshop_stock.Post;
            end;

            Position             := Position + 1;
            ProgressBar.Position := (Position / RecordCount * 100);
            Application.ProcessMessages;
            RemoteDB.netshop_stock.Next;
          end;

        finally
          RemoteDB.netshop_stock.Filtered := False;
          RemoteDB.netshop_stock.Filter   := '';
          ProgressBar.Visible             := False;
          ProgressBar.Position            := 0;
          RemoteDB.IsUpdating             := False;
        end;

      end;

      procedure TMainForm.SBReadEIDClick(Sender: TObject);
      var
        Identity : TEIDIdentity;
        Address : TEIDAddress;
        Pic : TEIDPicture;
        MS : TMemoryStream;
        Img : TJPEGImage;
        Picture: Variant;
        ReadIdentity, ReadNationalNumber, ReadGender: WideString;
        IsUpdate: Boolean;

      begin

   if not IsEIDCard then
   begin
         ShowMessage('La carte dtecte dans le lecteur n''est pas une carte d''identit Belge');
         Exit;
   end;

    FillChar(Identity, sizeof(TEIDIdentity), 0);

   if ReadIDData(@Identity) then
   begin
     FillChar(Address, sizeof(TEIDAddress), 0);
     ReadAddress(@Address);

      ReadIdentity := Identity.cardNumber;
      ReadNationalNumber := Identity.nationalNumber;
      ReadGender := Identity.sex;

                    if RemoteDB.Customers.Locate('customers_identity', ReadIdentity, [locaseinsensitive]) then
              begin
                IsUpdate := True;
              end else begin
                IsUpdate := False;
              end;

              if IsUpdate then
                RemoteDB.Customers.Edit
              else
                RemoteDB.Customers.Append;

              RemoteDB.Customers.FieldByName('customers_firstname').AsString := Identity.firstName1;
              RemoteDB.Customers.FieldByName('customers_Lastname').AsString := Identity.name;
              RemoteDB.Customers.FieldByName('customers_nationalnbr').AsString := ReadNationalNumber;
              RemoteDB.Customers.FieldByName('customers_identity').AsString := ReadIdentity;
              RemoteDB.Customers.FieldByName('customers_gender').AsString := ReadGender;
              RemoteDB.Customers.FieldByName('customers_dob').AsDateTime :=
              InvFormatDatetime(Identity.birthDate,'yyyymmdd');
              RemoteDB.Customers.Post;


                if IsUpdate then
                  RemoteDB.Address_Book.Edit
                else
                  RemoteDB.Address_Book.Append;
                RemoteDB.Address_Bookentry_street_address.AsString :=  Trim(Address.Street);
                RemoteDB.Address_Bookentry_postcode.Value := Address.zip;

                RemoteDB.Address_Bookentry_city.Value := Address.municipality;



   end;


   if ReadPictureEx(@Pic) then
    begin
       MS := TMemoryStream.Create;
       MS.Write(Pic.picture, Pic.pictureLength);
       MS.Position := 0;
       Img := TJPEGImage.Create;
       Img.LoadFromStream(MS);
       // TODO store image in DB
       Img.Free;
       MS.Free;
    end;





      end;

      procedure TMainForm.NewStockinCaddy(OwnerId, SupplierId: Integer);
      var
        Date: string;
        NewName: string;
        NewPanel: TAdvTabSheet;
        NewGrid: TAdvStringGrid;
        Count, TopLabels: Integer;
        StdGridWidth: Integer;
        StockinType: string;
      begin
        if OwnerId >= 100000 then
          StockinType := 'DEPOSIT'
        else
        begin
          if SupplierId >= 100000 then
            StockinType := 'BOUGHT'
          else
          begin
            StockinType := 'NEW';
          end;
        end;
        DatetimeToString(Date, 'dd/mm-hh:mm', Now);
        NewPanel  := TAdvTabSheet.Create(self);
        TopLabels := 37;
        with NewPanel do
        begin
          AdvPageControl := PageControlStockinCaddy;
          Caption        := Date;
          ImageIndex     := 34;
          NewName        := name;
          ShowClose      := True;
          OnClose        := StockinCaddyClose;
          OnShow         := StockinCaddyShow;

        end;
        NewGrid := TAdvStringGrid.Create(self);
        with NewGrid do
        begin
          Parent                   := NewPanel;
          Look                     := glXP;
          ScrollBarAlways          := SaVert;
          ScrollBars               := ssBoth;
          SelectionColor           := clBtnFace;
          SelectionTextColor       := clBlack;
          ColumnSize.Stretch       := True;
          ColumnSize.StretchColumn := 1;
          PopupMenu                := PopupStringGrid;
          OnEditingDone            := StringGridStockinEditingDone;
          Align                    := alBottom;
          Height                   := Parent.ClientHeight - 80;
          Anchors                  := Anchors + [AkTop];
          FixedCols                := 0;
          FixedFooters             := 0;
          FixedRows                := 1;
          StdGridWidth             := 85;
          RowCount                 := 2;
          ColCount                 := 9;
          NewGrid.options          := options + [gorowselect];
          Flat                     := False;
          AutoNumAlign             := True;
          AutoThemeAdapt           := True;
          FloatFormat              := '&.2f';
          Cells[0, 0]              := 'Modle';
          Cells[1, 0]              := 'Description';
          Cells[2, 0]              := 'Quantit';
          Cells[3, 0]              := 'PHT catalogue';
          Cells[4, 0]              := 'PTTC stock';
          Cells[5, 0]              := 'PHT achat';
          Cells[6, 0]              := 'Date entre';
          Cells[7, 0]              := 'Propritaire';
          Cells[8, 0]              := 'Fournisseur';
          for Count                := 0 to ColCount - 1 do
          begin
            ColWidths[Count] := StdGridWidth;
          end;
          ColWidths[1] := ClientWidth - StdGridWidth * (ColCount - 1);
          Refresh;
          Repaint;
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 97;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := TopLabels;
          Left      := Parent.ClientWidth - 100;
          Font.Size := 25;
          Caption   := '0.00';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 98;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := TopLabels;
          Left      := Parent.ClientWidth - 300;
          Font.Size := 25;
          Caption   := '0.00';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 99;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := TopLabels;
          Left      := Parent.ClientWidth - 500;
          Font.Size := 25;
          Caption   := '0';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := TopLabels;
          Left      := Parent.ClientWidth - 80;
          Font.Size := 10;
          Caption   := 'P. TTC';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := TopLabels;
          Left      := Parent.ClientWidth - 280;
          Font.Size := 10;
          Caption   := 'P. HT';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := TopLabels;
          Left      := Parent.ClientWidth - 480;
          Font.Size := 10;
          Caption   := 'Pcs';
        end;

        if StockinType = 'DEPOSIT' then
        begin

          with TLabel.Create(self) do
          begin
            Tag       := 10;
            Parent    := NewPanel;
            Anchors   := Anchors - [akleft] + [akright];
            Top       := 9;
            Left      := 230;
            Font.Size := 15;
            Caption   := 'Dpt';
          end;

          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 13;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Numero';
          end;
          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 33;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Nom';
          end;
          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 53;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Prenom';
          end;
          with TEdit.Create(self) do
          begin
            Tag    := 95;
            Parent := NewPanel;
            Top    := 10;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.CustomersCustomers_nbr.AsString;
          end;
          with TEdit.Create(self) do
          begin
            Tag    := 1;
            Parent := NewPanel;
            Top    := 30;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.CustomersCustomers_Lastname.AsString;
          end;
          with TEdit.Create(self) do
          begin
            Tag    := 1;
            Parent := NewPanel;
            Top    := 50;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.Customerscustomers_firstname.AsString;
          end;
        end;

        if StockinType = 'BOUGHT' then
        begin

          with TLabel.Create(self) do
          begin
            Tag       := 10;
            Parent    := NewPanel;
            Anchors   := Anchors - [akleft] + [akright];
            Top       := 9;
            Left      := 230;
            Font.Size := 15;
            Caption   := 'Achat';
          end;

          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 13;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Numero';
          end;
          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 33;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Nom';
          end;
          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 53;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Prenom';
          end;
          with TEdit.Create(self) do
          begin
            Tag    := 95;
            Parent := NewPanel;
            Top    := 10;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.CustomersCustomers_nbr.AsString;
          end;
          with TEdit.Create(self) do
          begin
            Tag    := 1;
            Parent := NewPanel;
            Top    := 30;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.CustomersCustomers_Lastname.AsString;
          end;
          with TEdit.Create(self) do
          begin
            Tag    := 1;
            Parent := NewPanel;
            Top    := 50;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.Customerscustomers_firstname.AsString;
          end;
        end;

        if StockinType = 'NEW' then
        begin

          with TLabel.Create(self) do
          begin
            Tag       := 10;
            Parent    := NewPanel;
            Anchors   := Anchors - [akleft] + [akright];
            Top       := 9;
            Left      := 230;
            Font.Size := 15;
            Caption   := 'Neuf';
          end;

          with TLabel.Create(self) do
          begin
            Tag       := 1;
            Parent    := NewPanel;
            Anchors   := Anchors + [akleft] - [akright];
            Top       := 13;
            Left      := 10;
            Font.Size := 10;
            Caption   := 'Fournisseur';
          end;

          RemoteDB.netshop_suppliers.FindKey([SupplierId]);
          with TEdit.Create(self) do
          begin
            Tag    := 95;
            Parent := NewPanel;
            Top    := 10;
            Left   := 100;
            // Border:=0;
            readonly := True;
            Text     := RemoteDB.netshop_suppliers.FieldByName('Suppliers_Name').AsString;
          end;

        end;
        StockinCaddyShow(NewPanel);
        PageControlStockinCaddy.ActivePage := NewPanel;
      end;

      procedure TMainForm.Notilog(Mssg: string);
      begin
        MainForm.StatusLine.Panels[3].Text := Mssg;
        MainForm.MemoLog.Lines.Add(Mssg);
        with MainForm.AdvAlertWindow.AlertMessages.Add do
        begin
          Text.Text := Mssg;
          AdvAlertWindow.Show;
        end;
      end;

      procedure TMainForm.SBNewStockinBoughtCaddyClick(Sender: TObject);
      begin
        if RemoteDB.Customers.FindKey([EditStockinCustomerNbr.Text]) then
        begin
          if StrtoInt(EditStockinCustomerNbr.Text) >= 100000 then
          begin
            NewStockinCaddy(ConnectedShop, RemoteDB.CustomersCustomers_nbr.AsInteger);
          end
          else
            ShowMessage('Client non valide');
        end
        else
          ShowMessage('Client non trouv');

      end;

      procedure TMainForm.SBNewStockinCaddyClick(Sender: TObject);
      var
        SupplierId: Integer;
      begin
        if RemoteDB.netshop_suppliers.Locate('suppliers_name', ComboBoxSupplier.Text, [locaseinsensitive]) then
        begin
          if RemoteDB.Customers.FindKey([ConnectedShop]) then
          begin
            NewStockinCaddy(ConnectedShop, RemoteDB.netshop_suppliers.FieldByName('Suppliers_id').AsInteger);
          end
          else
            ShowMessage('Client magasin non trouv');
        end else begin
          ShowMessage('Fournisseur non valide');
        end;
      end;

      procedure TMainForm.SBNewStockinDepositCaddyClick(Sender: TObject);
      begin

        if RemoteDB.Customers.FindKey([EditStockinCustomerNbr.Text]) then
        begin
          if StrtoInt(EditStockinCustomerNbr.Text) >= 100000 then
          begin
            NewStockinCaddy(RemoteDB.CustomersCustomers_nbr.AsInteger, 0);
          end
          else
            ShowMessage('Client non valable');
        end
        else
          ShowMessage('Client non trouv');

      end;

      procedure TMainForm.SBProductsOrderStatusClick(Sender: TObject);
      begin
        RemoteDB.Products.IndexFieldNames := 'products_status';
      end;

      procedure TMainForm.EditStockinNewKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);

      var
        Nowrow, quantitypresent, i, GridIndex, indexnbr, IndexType: Integer;
        TmpStr, owner, supplier, StockinType, NbrData: string;
        ExitLib: TFormExitLibrary;
        Grid: TAdvStringGrid;
        NewProductResult: TModalResult;
        ANewProductForm: TNewproductForm;
        AEnterLib: TFormEnterLibrary;
      label
        Procend;

      begin
        if Key = 13 then
        begin

          if PageControlStockinCaddy.ActivePage = nil then
          begin
            ShowMessage('Veuillez crer un caddy');
            goto Procend;
          end;

          if StrtoInt(CxEditStockinQuantity.Text) < 1 then
          begin
            ShowMessage('Quantit non valide');
            goto Procend;
          end;

          if not RemoteDB.Products.FindKey([cxEditStockinModel.Text]) then
          begin
            if ValidateModel(cxEditStockinModel.Text) then
            begin
              // creation d'un nouvel enregistrement dans la base de donns produits
              RemoteDB.IsUpdating := True;
              RemoteDB.Products.Append;
              RemoteDB.Productsproducts_model.Text    := cxEditStockinModel.Text;
              RemoteDB.ProductsProducts_Price.AsFloat :=
                ((Round(cxEditStockinPriceGross.Value * 100) / 100 * (1 + (MarginNew / 100))));
              ANewProductForm := TNewproductForm.Create(self);
              try
                ANewProductForm.ThumbImg.Picture.Bitmap.Assign(nil);
                NewProductResult := ANewProductForm.ShowModal;
                if NewProductResult <> mrOK then
                begin
                  RemoteDB.Products.Cancel;
                  StockinClearEdit;
                  if cxEditStockinModel.Visible then
                    cxEditStockinModel.SetFocus;
                end;
              finally
                ANewProductForm.Free;
                RemoteDB.IsUpdating := False;
              end;
              if NewProductResult <> mrOK then
                goto Procend;
            end else begin
              StockinClearEdit;
              if cxEditStockinModel.Visible then
                cxEditStockinModel.SetFocus;
              goto Procend;
            end;
          end else begin

            if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'True') then
            begin

            end else begin
              ShowMessage('Produit non gr en stock');
              goto Procend;
            end;

          end;

          for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
          begin
            if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
            begin
              // Index de la grille
              GridIndex := i;
            end;
          end;

          for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
          begin
            if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 95 then
            begin
              // Index du premier champs (Nom fourn / ou Num Client)
              indexnbr := i;
              NbrData  := TEdit(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i]).Text;
            end;
          end;

          for i := 0 to TAdvTabSheet(PageControlStockinCaddy.ActivePage).ControlCount - 1 do
          begin
            if TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i].Tag = 10 then
            begin
              // Index du type de transaction
              IndexType   := i;
              StockinType := TLabel(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[i]).Caption;
            end;
          end;

          if StockinType = 'Neuf' then
          begin
            if cxEditStockinPriceGross.Value > 0 then
            begin
              // RemoteDB.SetSupplierPrice(cxEditStockinPriceGross.Value,TEdit(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[indexNbr]).Text,cxEditStockinModel.Text);
            end;
            if not RemoteDB.netshop_suppliers.Locate('suppliers_name', NbrData, [locaseinsensitive]) then
            begin
              ShowMessage('Fournisseur non trouv');
              goto Procend;
            end;
            with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
            begin
              Nowrow           := RowCount - 1;
              Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
              Cells[1, Nowrow] := RemoteDB.Products.FieldByName('products_intername').Text;
              Cells[2, Nowrow] := CxEditStockinQuantity.Text;

              Cells[3, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price').AsFloat, fffixed, 7, 2);

              if cxEditStockinPrice.Value <> 0 then
                Cells[4, Nowrow] := FloatToStrF(cxEditStockinPrice.Value, fffixed, 7, 2)
              else
                Cells[4, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price_allin').AsFloat, fffixed, 7, 2);

              Cells[5, Nowrow] := FloatToStrF(cxEditStockinPriceGross.Value, fffixed, 7, 2);
              Cells[6, Nowrow] := Formatdatetime('yyyymmdd', Now);
              Cells[7, Nowrow] := inttostr(ConnectedShop);
              Cells[8, Nowrow] := RemoteDB.netshop_suppliers.FieldByName('Suppliers_id').Text;
              RowCount         := Nowrow + 2;
            end;
            StockinClearEdit;
            cxEditStockinModel.SetFocus;
            goto Procend;
          end;

          if StockinType = 'Achat' then
          begin
            // Vrification prix
            if cxEditStockinPrice.Value < cxEditStockinPriceGross.Value then
            begin
              ShowMessage('Prix vente infrieur au prix achat');
              cxEditStockinPrice.SetFocus;
              goto Procend;
            end;
            // Entre en Dacal
            if (self.Parameter['MiscCDLibUse'] = 'TRUE') then
            begin
              AEnterLib := TFormEnterLibrary.Create(self);
              try
                AEnterLib.Enter(inttostr(ConnectedShop), RemoteDB.Products.FieldByName('Products_model').AsString);
              finally
                AEnterLib.Free;
              end;
            end;

            // Descente en String Grid
            with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
            begin
              Nowrow           := RowCount - 1;
              Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
              Cells[1, Nowrow] := RemoteDB.Products.FieldByName('products_intername').Text;
              Cells[2, Nowrow] := CxEditStockinQuantity.Text;

              Cells[3, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price').AsFloat, fffixed, 7, 2);

              Cells[4, Nowrow] := FloatToStrF(cxEditStockinPrice.Value, fffixed, 7, 2);

              Cells[5, Nowrow] := FloatToStrF(cxEditStockinPriceGross.Value, fffixed, 7, 2);
              Cells[6, Nowrow] := Formatdatetime('yyyymmdd', Now);
              Cells[7, Nowrow] := inttostr(ConnectedShop);
              Cells[8, Nowrow] := NbrData;
              RowCount         := Nowrow + 2;
            end;
            StockinClearEdit;
            cxEditStockinModel.SetFocus;
            goto Procend;

          end;

          if StockinType = 'Dpt' then
          begin
            // Entre en Dacal
            if (self.Parameter['MiscCDLibUse'] = 'TRUE') then
            begin
              AEnterLib := TFormEnterLibrary.Create(self);
              try
                AEnterLib.Enter(NbrData, RemoteDB.Products.FieldByName('products_model').AsString);
              finally
                AEnterLib.Free;
              end;
            end;

            // Descente en String Grid
            with TAdvStringGrid(TAdvTabSheet(PageControlStockinCaddy.ActivePage).Controls[GridIndex]) do
            begin
              Nowrow           := RowCount - 1;
              Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
              Cells[1, Nowrow] := RemoteDB.Products.FieldByName('products_intername').Text;
              Cells[2, Nowrow] := CxEditStockinQuantity.Text;

              Cells[3, Nowrow] := FloatToStrF(RemoteDB.Products.FieldByName('products_price').AsFloat, fffixed, 7, 2);

              Cells[4, Nowrow] := FloatToStrF(cxEditStockinPrice.Value, fffixed, 7, 2);

              Cells[5, Nowrow] := '0';
              Cells[6, Nowrow] := Formatdatetime('yyyymmdd', Now);
              Cells[7, Nowrow] := NbrData;
              Cells[8, Nowrow] := NbrData;
              RowCount         := Nowrow + 2;
            end;
            StockinClearEdit;
            cxEditStockinModel.SetFocus;
            goto Procend;

          end;
        Procend:
          StringGridStockinEditingDone(self);
        end; { endif chr(13) }

      end;

      procedure TMainForm.SBTransferSuggestInClick(Sender: TObject);
      var
        ATransferSuggest: TTransferSuggest;
      var
        SRCSHOP: Integer;
      begin
        RemoteDB.AllShops.Locate('shops_name', ComboBoxSuggest.Text, [locaseinsensitive]);
        SRCSHOP := RemoteDB.AllShops.FieldByName('shops_id').Value;

        if (SRCSHOP = ConnectedShop) and (ComboBoxSuggest.ItemIndex = -1) then
        begin
          messagedlg('Destination non valide', mtwarning, [mbok], 0);
          exit;
        end;

        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Transfert IN ' + ComboBoxSuggest.Text;
        RemoteDB.CDSActions.Post;

        with TTransferSuggest.Create(self) do
        begin
          if CheckBoxEmptyStock.Checked then
            Empty := True
          else
            Empty    := False;
          Direction  := 'in';
          TargetShop := SRCSHOP;
          Show;
        end;
      end;

      procedure TMainForm.SBTransferSuggetsOutClick(Sender: TObject);
      var
        ATransferSuggest: TTransferSuggest;
      var
        DESTSHOP: Integer;
      begin
        RemoteDB.AllShops.Locate('shops_name', ComboBoxSuggest.Text, [locaseinsensitive]);
        DESTSHOP := RemoteDB.AllShops.FieldByName('shops_id').Value;

        if (DESTSHOP = ConnectedShop) and (ComboBoxSuggest.ItemIndex = -1) then
        begin
          messagedlg('Destination non valide', mtwarning, [mbok], 0);
          exit;
        end;

        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Transfert OUT ' + ComboBoxSuggest.Text;
        RemoteDB.CDSActions.Post;

        with TTransferSuggest.Create(self) do
        begin
          Direction := 'out';
          if CheckBoxEmptyStock.Checked then
            Empty := True
          else
            Empty    := False;
          TargetShop := DESTSHOP;
          Show;
        end;
      end;

      procedure TMainForm.SBCustomersEraseClick(Sender: TObject);
      var
        WasdsBrowse: Boolean;
      begin
        if RemoteDB.Customers.State = dsBrowse then
        begin
          RemoteDB.Customers.Edit;
          WasdsBrowse := True;
        end else begin
          WasdsBrowse := False;
        end;

        RemoteDB.Customers.FieldByName('customers_rfid').AsString := '';

        if WasdsBrowse then
          RemoteDB.Customers.Post;
      end;

      procedure TMainForm.SBCustomersSalesShortcutClick(Sender: TObject);
      begin
        self.SBNewSalesCaddyClick(self);
        Vente.Execute;
      end;

      procedure TMainForm.SBDeleteProDescFRClick(Sender: TObject);
      begin
        RemoteDB.CDSProDescFR.delete;
      end;

      procedure TMainForm.SBDeleteProDescNLClick(Sender: TObject);
      begin
        RemoteDB.CDSProDescNL.delete;
      end;

      procedure TMainForm.SBNewSalesCaddyClick(Sender: TObject);
      var
        Date: string;
        NewName: string;
        NewPanel: TAdvTabSheet;
        NewGrid: TAdvStringGrid;
        Count: Integer;
        StdGridWidth: Integer;
      begin
        if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
          dxBarMRUListItemCustomers.AddItem(RemoteDB.CustomersCustomers_nbr.AsString + ' - ' + RemoteDB.Customerscustomers_firstname.AsString + ' ' +
            RemoteDB.CustomersCustomers_Lastname.AsString, nil);

        DatetimeToString(Date, 'dd/mm-hh:mm', Now);
        NewPanel := TAdvTabSheet.Create(self);

        with NewPanel do
        begin
          AdvPageControl := PageControlSalesCaddy;
          Caption        := Date;
          ImageIndex     := 34;
          NewName        := name;
          ShowClose      := True;
          OnClose        := SalesCaddyClose;
        end;
        NewGrid := TAdvStringGrid.Create(self);
        with NewGrid do
        begin
          Parent                   := NewPanel;
          Look                     := glOffice2007;
          ScrollBarAlways          := SaVert;
          ScrollBars               := ssBoth;
          SelectionColor           := clBtnFace;
          SelectionTextColor       := clBlack;
          ColumnSize.Stretch       := True;
          ColumnSize.StretchColumn := 1;
          PopupMenu                := PopupStringGrid;
          OnEditingDone            := StringGridSalesEditingDone;
          Align                    := alBottom;
          Height                   := Parent.ClientHeight - 80;
          Anchors                  := Anchors + [AkTop];
          FixedCols                := 0;
          FixedFooters             := 0;
          FixedRows                := 1;
          StdGridWidth             := 85;
          RowCount                 := 2;
          ColCount                 := 11;
          NewGrid.options          := options + [gorowselect];
          Flat                     := False;
          AutoNumAlign             := True;
          AutoThemeAdapt           := True;
          FloatFormat              := '&.2f';
          Cells[0, 0]              := 'Modle';
          Cells[1, 0]              := 'Description';
          Cells[2, 0]              := 'Quantit';
          Cells[3, 0]              := 'PHT catalogue';
          Cells[4, 0]              := 'PTTC stock';
          Cells[5, 0]              := 'PHT achat';
          Cells[6, 0]              := 'Date entre';
          Cells[7, 0]              := 'Propritaire';
          Cells[8, 0]              := 'Fournisseur';
          Cells[9, 0]              := 'Esd guid';
          Cells[10, 0]              := 'Link ID';
          for Count                := 0 to ColCount - 1 do
          begin
            ColWidths[Count] := StdGridWidth;
          end;
          ColWidths[9] := 0;
          ColWidths[10] := 0;
          ColWidths[1] := ClientWidth - StdGridWidth * (ColCount - 1);
          Refresh;
          Repaint;
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 97;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 100;
          Font.Size := 25;
          Caption   := '0.00';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 98;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 300;
          Font.Size := 25;
          Caption   := '0.00';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 99;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 550;
          Font.Size := 25;
          Caption   := '0';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 80;
          Font.Size := 10;
          Caption   := 'P. TTC';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 280;
          Font.Size := 10;
          Caption   := 'P. HT';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 528;
          Font.Size := 10;
          Caption   := 'Pcs';
        end;

        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors + [akleft] - [akright];
          Top       := 13;
          Left      := 10;
          Font.Size := 10;
          Caption   := 'Numero';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors + [akleft] - [akright];
          Top       := 33;
          Left      := 10;
          Font.Size := 10;
          Caption   := 'Nom';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors + [akleft] - [akright];
          Top       := 53;
          Left      := 10;
          Font.Size := 10;
          Caption   := 'Prenom';
        end;
        with TEdit.Create(self) do
        begin
          Tag    := 95;
          Parent := NewPanel;
          Top    := 10;
          Left   := 100;
          // Border:=0;
          readonly := True;
          Text     := RemoteDB.CustomersCustomers_nbr.AsString;
        end;
        with TEdit.Create(self) do
        begin
          Parent := NewPanel;
          Top    := 30;
          Left   := 100;
          // Border:=0;
          readonly := True;
          Text     := RemoteDB.CustomersCustomers_Lastname.AsString;
        end;
        with TEdit.Create(self) do
        begin
          Parent := NewPanel;
          Top    := 50;
          Left   := 100;
          // Border:=0;
          readonly := True;
          Text     := RemoteDB.Customerscustomers_firstname.AsString;
        end;
        PageControlSalesCaddy.ActivePage := NewPanel;
      end;

      procedure TMainForm.dxBarButtonCodaClick(Sender: TObject);
      var
        myFile: TextFile;
        line, line2, Line3: string;
        PreviousOperationID, OperationID, i, nbrint, thepos, j, k, Pos, ln: Integer;
        AmountGross, AmountDisc, AmountNet: Double;
        Comment, Comment2, PartyID, ShopAccount, OpCode, Nbr, Location, CustNbr, StrAmt: string;
        DateExec, DateDoc, DateVal: TDateTime;
        AACTDBBANK: TACTDBBANK;
        processed, InCustNbr: Boolean;
        decSep: Char;

      begin
        if OpenDialog.Execute then
        begin
          decSep                                          := System.SysUtils.FormatSettings.DecimalSeparator;
          System.SysUtils.FormatSettings.DecimalSeparator := '.';
          AACTDBBANK                                      := TACTDBBANK.Create(RemoteDB);
          try
            // Try to open the Test.txt file for writing to
            ProgressBar.Position := 0;
            ProgressBar.Visible  := True;
            for i                := 0 to OpenDialog.Files.Count - 1 do
            begin
              if OpenDialog.Files.Count > 1 then
                ProgressBar.Position := i / (OpenDialog.Files.Count * 2 - 1) * 100;
              Application.ProcessMessages;
              AssignFile(myFile, OpenDialog.Files[i]);

              // Reopen the file for reading
              Reset(myFile);
              ln := 0;
              // Display the file contents
              while not Eof(myFile) do
              begin
                ln := ln + 1;
                ReadLn(myFile, line);
                // StatusLine.Panels[3].Text :=  ExtractFileName(OpenDialog.Files[i]) + ' line : '+inttostr(ln);
                // Application.processmessages;
                if line[1] = '1' then
                begin
                  // Process Headers
                  PreviousOperationID := -1;
                end;
                if line[1] = '2' then
                begin
                  // Process Code
                  OperationID := StrtoInt(MidStr(line, 3, 4));
                  if OperationID > PreviousOperationID then
                  begin
                    // New Operation
                    PreviousOperationID := OperationID;
                    processed           := False;
                    line2               := '';
                    Line3               := '';
                    StrAmt              := MidStr(line, 33, 15);
                    AmountGross         := StrtoInt(StrAmt) / 1000;
                    if StrtoInt(line[32]) = 1 then
                      AmountGross := -AmountGross;
                    DateVal       := BankToVCLDate(MidStr(line, 48, 6));
                    Comment       := MidStr(line, 63, 53);
                    PartyID       := MidStr(line, 63, 53);
                    DateDoc       := BankToVCLDate(MidStr(line, 116, 6));
                    Nbr           := inttostr(Yearof(DateDoc));
                    Nbr           := Nbr + '0000';
                    nbrint        := StrtoInt(Nbr);
                    nbrint        := nbrint + StrtoInt((MidStr(line, 122, 3)));
                    Nbr           := inttostr(nbrint);
                    OpCode        := MidStr(line, 55, 7);


                    // StatusLine.Panels[3].Text := StatusLine.Panels[3].Text + ' '+OpCode;
{$REGION '0150000...Virements In Visa / AX / Factures'}
                    if OpCode = '0150000' then
                    begin
                      // Virement in
                      ShopAccount := '499000';
                      if (ansipos('MC', Comment) = 18) or (ansipos('VI', Comment) = 18) then
                      begin
                        // Visa MC
                        ReadLn(myFile, line);
                        DateExec    := BankToVCLShortDate(MidStr(line, 59, 5));
                        AmountGross := StrToFloat(ConvertToPoint(MidStr(line, 15, 10)));
                        AmountDisc  := StrToFloat(ConvertToPoint(MidStr(line, 31, 8)));
                        if ansipos('16630899', Comment) > 0 then
                          ShopAccount := '580101'; // WAVRE
                        if ansipos('16630907', Comment) > 0 then
                          ShopAccount := '580104'; // UCCLE
                        if (ansipos('17342577', Comment) > 0) then
                          ShopAccount := '580100'; // NET
                        if ansipos('16824898', Comment) > 0 then
                          ShopAccount := '580102'; // BOURSE
                        if ansipos('27933431', Comment) > 0 then
                          ShopAccount := '580125'; // VERV
                        if ansipos('xxxxxxxx', Comment) > 0 then
                          ShopAccount := '580106'; // WOLUWE
                        if ansipos('16717852', Comment) > 0 then
                          ShopAccount := '580199'; // NIVELLES
                        if ansipos('27951144', Comment) > 0 then
                          ShopAccount := '580107'; // SOIGNIES
                        if ansipos('28671766', Comment) > 0 then
                          ShopAccount := '580187'; // JODOIGNE
                        if ansipos('28671774', Comment) > 0 then
                          ShopAccount := '580179'; // HANNUT
                        AACTDBBANK.AddVisaIn(DateExec, DateDoc, Nbr, ShopAccount, AmountGross, AmountDisc, Comment);
                        processed := True;
                      end;
                      if (ansipos('AX', Comment) = 18) then
                      begin
                        // AMEX
                        DateExec := BankToVCLShortDate(MidStr(line, 74, 5));
                        ReadLn(myFile, line);
                        AmountGross := StrToFloat(ConvertToPoint(MidStr(line, 15, 11)));
                        AmountDisc  := StrToFloat(ConvertToPoint(MidStr(line, 29, 10)));
                        if ansipos('16630899', Comment) > 0 then
                          ShopAccount := '580101'; // WAVRE
                        if ansipos('16630907', Comment) > 0 then
                          ShopAccount := '580104'; // UCCLE
                        if (ansipos('17342577', Comment) > 0) then
                          ShopAccount := '580100'; // NET
                        if ansipos('16824898', Comment) > 0 then
                          ShopAccount := '580102'; // BOURSE
                        if ansipos('27933431', Comment) > 0 then
                          ShopAccount := '580125'; // VERV
                        if ansipos('xxxxxxxx', Comment) > 0 then
                          ShopAccount := '580106'; // WOLUWE
                        if ansipos('16717852', Comment) > 0 then
                          ShopAccount := '580199'; // NIVELLES
                        if ansipos('27951144', Comment) > 0 then
                          ShopAccount := '580107'; // SOIGNIES
                        if ansipos('28671766', Comment) > 0 then
                          ShopAccount := '580187'; // JODOIGNE
                        if ansipos('28671774', Comment) > 0 then
                          ShopAccount := '580179'; // HANNUT
                        AACTDBBANK.AddVisaIn(DateExec, DateDoc, Nbr, ShopAccount, AmountGross, AmountDisc, Comment);
                        processed := True;
                      end;

                      thepos := ansipos('EBAY', Comment);
                      if (thepos <> 0) then
                      begin
                        AACTDBBANK.AddCustomerIn(DateDoc, DateDoc, Nbr, 'NET       ', AmountGross, Comment);
                        processed := True;
                      end;

                      if (ansipos('SMARTFACT', ansiuppercase(Comment)) <> 0) then
                      begin
                        // Facture Client
                        CustNbr := '';
                        k       := ansipos('SMARTFACT', ansiuppercase(Comment));

                        InCustNbr := False;
                        for j     := k + 9 to Length(Comment) do
                        begin
                          if IsStrIntNum(Comment[j]) then
                          begin
                            InCustNbr := True;
                          end;
                          if (InCustNbr and not IsStrIntNum(Comment[j])) then
                          begin
                            Break;
                          end;
                          if InCustNbr then
                            CustNbr := CustNbr + Comment[j];
                        end;

                        AACTDBBANK.AddCustomerIn(DateDoc, DateDoc, Nbr, CustNbr, AmountGross, Comment);
                        processed := True;
                      end;

                      if not processed then
                      begin
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                        processed := True;
                      end;

                    end;
{$ENDREGION}
{$REGION '0501000...Domiciliations'}
                    if OpCode = '0501000' then
                    begin
                      // Domiciliation
                      ReadLn(myFile, line2);
                      ReadLn(myFile, Line3);
                      Comment2 := MidStr(line2, 54, 16);

                      if (ansipos('10703875765970', PartyID) > 0) then
                      begin
                        // LUMINUS
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'LUMINUS   ', AmountGross, Comment);
                        processed := True;
                      end;

                      Pos := ansipos('107038312095656', PartyID);
                      // '1070383120956560305122012065218                    00'
                      if (Pos > 0) then
                      begin
                        // EDP
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'EDPNET    ', AmountGross, Comment);
                        processed := True;
                      end;

                      if (ansipos('1070487822660570311', PartyID) > 0) or (ansipos('1070487822660570610', PartyID) > 0) then
                      begin
                        // PSA
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'PSA       ', AmountGross, Comment);
                        processed := True;
                      end;

                      // 1070486194151812310 Banksys 10703874426703220041
                      if (ansipos('107048619415181', PartyID) > 0) or (ansipos('107038744267032', PartyID) > 0) or (ansipos('107038736744276', PartyID) > 0)
                      then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'BANK      ', AmountGross, Comment);
                        processed := True;
                      end;

                      // 107038736094780 Lampiris
                      if (ansipos('107038736094780', PartyID) > 0) then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'LAMPIRIS  ', AmountGross, Comment);
                        processed := True;
                      end;

                      // 107038946067953 FUELCard
                      if (ansipos('107038946067953', PartyID) > 0) then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'FUELCARD  ', AmountGross, Comment);
                        processed := True;
                      end;

                      // ISABELL 10704896843755
                      if (ansipos('10704896843755', PartyID) > 0) then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'ISABEL    ', AmountGross, Comment);
                        processed := True;
                      end;

                      // Partena 107038521737817 OR 107048968437551
                      if (ansipos('107038521737817', PartyID) > 0) then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'PARTENA   ', AmountGross, PartyID);
                        processed := True;
                      end;

                      // BELGACOM 107048613932257
                      if (ansipos('107048613932257', PartyID) > 0) then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'BEL       ', AmountGross, Comment);
                        processed := True;
                      end;

                      // BELGACOM 1070388457074
                      if (ansipos('1070388457074', PartyID) > 0) then
                      begin
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'PROX      ', AmountGross, Comment);
                        processed := True;
                      end;

                      if not processed then
                      begin
                        Comment := Trim(Trim(MidStr(Line3, 48, 32)) + ' ' + Comment);
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '499000', AmountGross, Comment);
                        processed := True;
                      end;

                    end;
{$ENDREGION}
{$REGION '0303000...Paiement par carte de banque'}
                    if OpCode = '0303000' then
                    begin
                      // Paiement par carte de banque
                      ReadLn(myFile, line2);
                      // Essence
                      if (ansipos('11304127002750100041', Comment) <> 0) or (ansipos('11304127002699200021', Comment) <> 0) or
                        (ansipos('11304126927443600021', Comment) <> 0) or (ansipos('11304127002729500071', Comment) <> 0) or

                      // Raphael Pluta
                        (ansipos('11304140089272600031', Comment) <> 0) or
                      // David Sonnet
                        (ansipos('11304127002749700121', Comment) <> 0) or
                      // Frederic Sonnet
                        (ansipos('11304127002750100151', Comment) <> 0) or

                        (ansipos('11304127002749700011', Comment) <> 0) then
                      begin
                        // ESSENCE
                        Comment := Trim(MidStr(Line3, 48, 32)) + ' ' + Comment;
                        AACTDBBANK.AddSupplierOut(DateDoc, DateDoc, Nbr, 'ESS       ', AmountGross, Comment);
                        processed := True;
                      end;

                      if not processed then
                      begin
                        Comment := Trim(MidStr(Line3, 48, 32)) + ' ' + Comment;
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '499000', AmountGross, Comment);
                        processed := True;
                      end;

                    end;
{$ENDREGION}
{$REGION '0101000...Virement entrant'}
                    if OpCode = '0101000' then
                    begin
                      // Virement vers compte
                      ReadLn(myFile, line2);
                      Comment     := Trim(MidStr(line, 63, 64));
                      ShopAccount := '499000';
                      if (ansipos('REMB CMDE', Comment) > 0) then
                      begin
                        AACTDBBANK.AddCustomerIn(DateDoc, DateDoc, Nbr, 'NET       ', AmountGross, Comment);
                        processed := True;
                      end;

                      if not processed then
                      begin
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                        processed := True;
                      end;
                    end;
{$ENDREGION}
{$REGION '0368000...Proton'}
                    if (OpCode = '0368000') or (OpCode = '0468000') then
                    begin
                      // Proton

                      // Wavre
                      if (ansipos('208221', PartyID) > 0) then
                      begin
                        ShopAccount := '580001';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Bruxelles
                      if (ansipos('209223', PartyID) > 0) then
                      begin
                        ShopAccount := '580002';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Uccle
                      if (ansipos('209193', PartyID) > 0) then
                      begin
                        ShopAccount := '580004';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Woluwe
                      if (ansipos('245220', PartyID) > 0) then
                      begin
                        ShopAccount := '580006';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Soignies
                      if (ansipos('336344', PartyID) > 0) then
                      begin
                        ShopAccount := '580007';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Verviers
                      if (ansipos('336085', PartyID) > 0) then
                      begin
                        ShopAccount := '580025';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Jodoigne
                      if (ansipos('610442', PartyID) > 0) then
                      begin
                        ShopAccount := '580087';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      // Hannut
                      if (ansipos('610439', PartyID) > 0) then
                      begin
                        ShopAccount := '580079';
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, 'PROTON');
                        processed := True;
                      end;
                      processed := True;
                    end;
{$ENDREGION}
{$REGION '0350000...Globalisation BCT'}
                    if (OpCode = '0350000') or (OpCode = '0450000') then
                    begin
                      // Globalisation BCT
                      ShopAccount := '499000';
                      DateExec    := BankToVCLDate(MidStr(line, 82, 6));
                      Location    := '';

                      if ansipos('101607', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580104';
                        Location    := 'C04';
                      end;
                      if ansipos('513737', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580102';
                        Location    := 'C02';
                      end;
                      if ansipos('189042', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '5800101';
                        Location    := 'C01';
                      end;
                      if ansipos('209193', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580104';
                        Location    := 'C04';
                      end;
                      if ansipos('209223', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580102';
                        Location    := 'C02';
                      end;
                      if ansipos('245220', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580106';
                        Location    := 'C06';
                      end;
                      if ansipos('208221', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580101';
                        Location    := 'C01';
                      end;
                      if ansipos('336085', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580125';
                        Location    := 'C25';
                      end;
                      if ansipos('1610439', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580179';
                        Location    := 'C79';
                      end;
                      if ansipos('1610442', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580187';
                        Location    := 'C87';
                      end;
                      if ansipos('1211085', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580199';
                        Location    := 'C99';
                      end;
                      if ansipos('336344', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580107';
                        Location    := 'C07';
                      end;
                      if ansipos('011346', UpperCase(Comment)) > 0 then
                      begin
                        ShopAccount := '580100';
                        Location    := 'NET';
                      end;
                      if Location = '' then
                      begin
                        ShopAccount := '580103';
                        Location    := 'INCONNU';
                      end;
                      Comment := 'Globalisation ' + Location + ' ' + MidStr(line, 82, 6);
                      AACTDBBANK.AddBCTIn(DateExec, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;
{$ENDREGION}
{$REGION '095X000...Dpot cash machine et guichet'}
                    if (OpCode = '0950000') then
                    begin
                      // Versement
                      ShopAccount := '499000';
                      if (ansipos('UCC', UpperCase(Comment)) > 0) or (ansipos('UKK', UpperCase(Comment)) > 0) then
                        ShopAccount := '580004';
                      if ansipos('WAV', UpperCase(Comment)) > 0 then
                        ShopAccount := '580001';
                      if (ansipos('BRU', UpperCase(Comment)) > 0) or (ansipos('BXL', UpperCase(Comment)) > 0) then
                        ShopAccount := '580002';
                      if ansipos('VER', UpperCase(Comment)) > 0 then
                        ShopAccount := '580025';
                      if ansipos('SOI', UpperCase(Comment)) > 0 then
                        ShopAccount := '580007';
                      if ansipos('WOL', UpperCase(Comment)) > 0 then
                        ShopAccount := '580006';
                      if ansipos('NIV', UpperCase(Comment)) > 0 then
                        ShopAccount := '580099';
                      if ansipos('HAN', UpperCase(Comment)) > 0 then
                        ShopAccount := '580079';
                      if ansipos('JOD', UpperCase(Comment)) > 0 then
                        ShopAccount := '580087';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if (OpCode = '0954000') or (OpCode = '0453000') then
                    begin
                      // Versement
                      ReadLn(myFile, line2);
                      ReadLn(myFile, Line3);
                      Comment     := Trim(MidStr(line2, 54, 16)) + Trim(MidStr(Line3, 83, 42));
                      ShopAccount := '499000';
                      if (ansipos('UCC', UpperCase(Comment)) > 0) or (ansipos('UKK', UpperCase(Comment)) > 0) then
                        ShopAccount := '580004';
                      if ansipos('WAV', UpperCase(Comment)) > 0 then
                        ShopAccount := '580001';
                      if (ansipos('BRU', UpperCase(Comment)) > 0) or (ansipos('BXL', UpperCase(Comment)) > 0) then
                        ShopAccount := '580002';
                      if ansipos('SOI', UpperCase(Comment)) > 0 then
                        ShopAccount := '580007';
                      if ansipos('WOL', UpperCase(Comment)) > 0 then
                        ShopAccount := '580006';
                      if ansipos('VER', UpperCase(Comment)) > 0 then
                        ShopAccount := '580025';
                      if ansipos('HAN', UpperCase(Comment)) > 0 then
                        ShopAccount := '580079';
                      if ansipos('JOD', UpperCase(Comment)) > 0 then
                        ShopAccount := '580087';
                      if ansipos('NIV', UpperCase(Comment)) > 0 then
                        ShopAccount := '580099';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;
{$ENDREGION}
                    if OpCode = '0402000' then
                    begin
                      // Paiements
                      ReadLn(myFile, line2);
                      ReadLn(myFile, Line3);
                      Comment     := MidStr(Line3, 48, 32);
                      ShopAccount := '499999';

                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if OpCode = '0107000' then
                    begin
                      // Enveloppe de virements
                      ReadLn(myFile, line2);
                      Comment     := MidStr(line2, 63, 64);
                      ShopAccount := '581000';

                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if OpCode = '0154000' then
                    begin
                      // Virement depuis compte
                      ReadLn(myFile, line2);
                      Comment     := MidStr(line, 48, 32);
                      ShopAccount := '499000';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if OpCode = '0319000' then
                    begin
                      // prelevement visa
                      ShopAccount := '416100';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if OpCode = '0105000' then
                    begin
                      // prelevement Salaires
                      ShopAccount := '455000';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if OpCode = '8003000' then
                    begin
                      // prelevement Salaires
                      ShopAccount := '65600';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    if OpCode = '1301000' then
                    begin
                      // Remboursememnt Emprunt
                      Comment := 'Remb.: ' + FloatToStr(AmountGross);
                      ReadLn(myFile, line);
                      AmountDisc := StrtoInt(MidStr(line, 33, 15)) / 1000;
                      if StrtoInt(line[32]) = 1 then
                        AmountDisc := -AmountDisc;

                      AmountGross := AmountGross - AmountDisc;
                      Comment     := Comment + ' K: ' + FloatToStr(AmountDisc) + ' Int.: ' + FloatToStr(AmountGross);
                      ShopAccount := '650000';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      ShopAccount := '420000';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountDisc, Comment);
                      processed := True;
                    end;

                    if OpCode = '8015000' then
                    begin
                      // Remboursememnt Emprunt
                      Comment     := 'Remb.: ' + FloatToStr(AmountGross);
                      ShopAccount := '656000';
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                      processed := True;
                    end;

                    // LOYERS
{$REGION 'Loyers'}
                    if ansipos('CAVE BOXEUR', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '710000', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER RDC BORGVAL 7', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610002', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER CH ALSEMBER 622', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610004', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER RDC HENRI 367', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610006', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER HARMONIE 28', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610025', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER ALBER1 37 RDC', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610079', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER RDC PL VICTOIRE 6A', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610087', AmountGross, Comment);
                      processed := True;
                    end;
                    if ansipos('LOYER NIVELLES R DU GEANT', Comment) > 0 then
                    begin
                      AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, '610099', AmountGross, Comment);
                      processed := True;
                    end;
{$ENDREGION}
                    if not processed then
                    begin
                      // Unidentified operation
                      // Get fetchcomment lines
                      ShopAccount := '499000';

                      if not processed then
                        AACTDBBANK.AddBCTIn(DateDoc, DateDoc, Nbr, ShopAccount, AmountGross, Comment);
                    end;

                  end else begin
                    // Sequel to previous Operation
                  end;
                  if line[2] = '1' then
                  begin
                    // Process New Line
                  end;
                  if line[2] = '2' then
                  begin
                    // Process Comment
                  end;
                  if line[2] = '3' then
                  begin
                    // Process Comment
                  end;

                end;
                if line[1] = '8' then
                begin
                  // Process Footer
                end;
                if line[1] = '9' then
                begin
                  // Process Checksum
                end;
              end;
              CloseFile(myFile);
            end;
            //
            // Transfer Files to the processed folder
            //
            for i := 0 to OpenDialog.Files.Count - 1 do
            begin
              ProgressBar.Position := (i + OpenDialog.Files.Count) / (OpenDialog.Files.Count * 2 - 1) * 100;
              Application.ProcessMessages;
              scShellMoveFile(self.Handle, OpenDialog.Files[i], ExtractFilePath(OpenDialog.Files[i]) + 'PROCESSED\' + ExtractFileName(OpenDialog.Files[i]));
            end;

          finally
            AACTDBBANK.Free;
            System.SysUtils.FormatSettings.DecimalSeparator := decSep;
            ProgressBar.Visible := False;;
            ProgressBar.Position := 0;
          end;

        end;
      end;

      procedure TMainForm.dxBarButtonDacalSearchClick(Sender: TObject);
      var
        aFormDacalSearch: TFormDacalSearch;
      begin

        aFormDacalSearch := TFormDacalSearch.Create(self);
        try
          aFormDacalSearch.ShowModal;
        finally
          aFormDacalSearch.Free;
        end;

      end;

      procedure TMainForm.dxBarButtonDPOverpricedClick(Sender: TObject);
      var
        aReportSQL: TReportSQL;
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Rapport prix a baissr dept';
        RemoteDB.CDSActions.Post;
        with RemoteDB.SQLQuery do
        begin
          CommandText :=
            'SELECT products_root_category_name as Plateforme, `product_model` as Modele , `product_name` as Nom , `product_owner_id` As Porprio , `product_price_stock` as PStock , ROUND(p.`products_price` *(1+tr.`tax_rate`/100),2) AS PNEW ';
          CommandText := CommandText + ' FROM netshop_stock ns';
          CommandText := CommandText + ' INNER JOIN products p ON p.products_model = ns.product_model';
          CommandText := CommandText + ' INNER JOIN tax_rates tr ON tr.`tax_class_id`=p.`products_tax_class_id` ';
          CommandText := CommandText + ' WHERE `product_owner_id` >=100000 ';
          CommandText := CommandText + ' AND `product_location` = ' + inttostr(ConnectedShop);
          CommandText := CommandText + ' AND tax_zone_id='+inttostr(GeoZoneTaxId);
          CommandText := CommandText + ' AND p.`products_price` *(1+tr.`tax_rate`/100)*0.85<product_price_stock ';
          CommandText := CommandText + ' ORDER BY products_root_category_name, product_date_in ';

        end;

        aReportSQL := TReportSQL.Create(self);
        try
          aReportSQL.CDSReport.Open;
          aReportSQL.cxGridReportDBTableViewReport.DataController.CreateAllItems(True);
          aReportSQL.ShowModal;
        finally
          aReportSQL.Free;
        end;
      end;

      procedure TMainForm.dxBarButtonEmptyUnsellableClick(Sender: TObject);
      var
        AFormCheckLib: TFormDacalEmptyUnsold;
      begin
        RemoteDB.CDSActions.Append;
        RemoteDB.CDSActions.FieldByName('action').AsString := 'Verifier Invendus Dacal';
        RemoteDB.CDSActions.Post;
        AFormCheckLib := TFormDacalEmptyUnsold.Create(self);
        AFormCheckLib.Show;
      end;

      procedure TMainForm.JvButtonCustomerRentStatusClick(Sender: TObject);
      var
        Data: WideString;
        Num, i: Integer;
        TicketToPrint: TTicketJob;
      begin
        ActionCustomerRentPendingExecute(nil);
        if ((MainForm.Parameter['PrintersTicketEnabled'] = 'TRUE')) then
        begin
          TicketToPrint := TTicketJob.Create(self);
          try
            TicketToPrint.Printer := MainForm.Parameter['PrintersTicketPrinter'];
            TicketToPrint.Logo    := PrintLogo;
            TicketToPrint.URL     := WEBURL;
            TicketToPrint.ID := RemoteDB.netshop_sales.FieldByName('sales_location').AsString + '-' + RemoteDB.netshop_sales.FieldByName('sales_id').AsString;
            if ShopdataList <> nil then begin
              TicketToPrint.ShopData := ShopdataList;
            end else begin
              ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
            end;
            if MainForm.Parameter['PrintersTicketContinuous'] = 'TRUE' then
              TicketToPrint.Model := TmContinuous;
            TicketToPrint.AddBox('Location', True, bsProd);

            RemoteDB.netshop_rent_transaction.First;
            while not RemoteDB.netshop_rent_transaction.Eof do
            begin
              TicketToPrint.AddLine(RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_product_name').AsString, '', '', 'Location');
              TicketToPrint.AddLine('Du ' + DateToStr(RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_start_date').AsFloat) + ' Au ' +
                DateToStr(RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_due_date').AsFloat), '', '', 'Location');
              RemoteDB.netshop_rent_transaction.Next;
            end;
            if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
            begin
              TicketToPrint.AddCustomerLine('Client # : ', RemoteDB.CustomersCustomers_nbr.Text);
              TicketToPrint.AddCustomerLine('Nom : ', RemoteDB.CustomersCustomers_Lastname.Text);
              TicketToPrint.AddCustomerLine('Prenom : ', RemoteDB.Customerscustomers_firstname.Text);
              TicketToPrint.AddCustomerLine('CI : ', RemoteDB.Customerscustomers_identity.Text);
              TicketToPrint.AddCustomerLine('SIGNATURE', '');
            end;

            if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
              TicketToPrint.PrintOpos
            else
              TicketToPrint.Print;
          finally
            TicketToPrint.Free;
          end;
        end; // End Ticket

      end;

      procedure TMainForm.JvButtonCustomerRentExtendClick(Sender: TObject);
      var
        i: Integer;
        aFormRentExtend: TFormRentExtend;
      begin
        if RadioButtonCustomerRentPending.Enabled then
        begin
          if cxGridViewRepositoryDBTableViewCustRent.Controller.SelectedRowCount > 0 then
          begin
            aFormRentExtend := TFormRentExtend.Create(self);
            try
              for i := 0 to cxGridViewRepositoryDBTableViewCustRent.Controller.SelectedRowCount - 1 do
              begin
                // GotoBookmark (pointer(cxGridViewRepositoryDBTableViewCustRent.DataController.GetSelectedBookmark(i)));
                if aFormRentExtend.ShowModal = mrOK then
                begin

                end;
              end;
            finally
              aFormRentExtend.Free;
            end;
          end else begin
            ShowMessage('Veuillez slectionner une transaction  tendre');
          end;
        end else begin
          ShowMessage('Veuillez activer le filtre "non-retourn" et slectionner la transaction  tendre');
        end;

      end;

      procedure TMainForm.SBCustomerCreateCaddyBoughtClick(Sender: TObject);
      begin

        if RemoteDB.CustomersCustomers_nbr.AsInteger >= 100000 then
        begin
          dxBarMRUListItemCustomers.AddItem(RemoteDB.CustomersCustomers_nbr.AsString + ' - ' + RemoteDB.Customerscustomers_firstname.AsString + ' ' +
            RemoteDB.CustomersCustomers_Lastname.AsString, nil);
          NewStockinCaddy(ConnectedShop, RemoteDB.CustomersCustomers_nbr.AsInteger);
        end
        else
          ShowMessage('Client non valide');
        Entree.Execute;

      end;

      procedure TMainForm.SBCustomerCreateCaddyDepositClick(Sender: TObject);
      begin

        if RemoteDB.CustomersCustomers_nbr.AsInteger >= 100000 then
        begin
          dxBarMRUListItemCustomers.AddItem(RemoteDB.CustomersCustomers_nbr.AsString + ' - ' + RemoteDB.Customerscustomers_firstname.AsString + ' ' +
            RemoteDB.CustomersCustomers_Lastname.AsString, nil);
          NewStockinCaddy(RemoteDB.CustomersCustomers_nbr.AsInteger, 0);
        end
        else
          ShowMessage('Client non valable');
        Entree.Execute;

      end;

      procedure TMainForm.SBCustomerRentInShortcutClick(Sender: TObject);
      begin
        NewRentCaddyClick(Sender, RentIn);
        Rent.Execute;
      end;

      procedure TMainForm.SBCustomerRentOutShortcutClick(Sender: TObject);
      begin
        NewRentCaddyClick(Sender, RentOut);
        Rent.Execute;
      end;

      /// /// Rent Page
      /// /// Rent Page
      /// /// Rent Page
      /// /// Rent Page
      /// /// Rent Page
      /// /// Rent Page
      /// /// Rent Page
      /// /// Rent Page

      procedure TMainForm.RentCaddyClose(Sender: TObject);
      begin

      end;

      procedure TMainForm.BitBtnRentClearClick(Sender: TObject);
      begin
        RemoteDB.Customers.Locate('Customers_nbr', inttostr(ConnectedShop), [locaseinsensitive]);
        EditRentCustomerId.Text := inttostr(ConnectedShop);
        PageControlRentCaddy.ActivePage.Free;
        PageControlRentCaddyChange(nil);
        RentClearEdit;
      end;

      procedure TMainForm.BitBtnRentProcessClick(Sender: TObject);
      var
        AFormProcessRent: TFormProcessRent;
        i, GridIndex, indexnbr: Integer;
        j, page, Nowrow, nowrowsales, overduedays: Integer;
        overdueamount: Double;
        ARentOperation: TRentOperation;
      begin
        for i := 0 to TAdvTabSheet(PageControlRentCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
          begin
            GridIndex := i;
          end;
        end;

        with TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]) do
        begin
          if RowCount <= 2 then
            exit;
        end;

        ARentOperation := GetRentCaddyType;

        RemoteDB.IsUpdating            := True;
        AFormProcessRent               := TFormProcessRent.Create(self);
        AFormProcessRent.RentOperation := ARentOperation;
        try
          if AFormProcessRent.ShowModal = mrOK then
          begin
            BitBtnRentClearClick(BitBtnRentProcess);
          end
          else
            messagedlg('Location annule', mtwarning, [mbok], 0);
        finally
          RemoteDB.IsUpdating := False;
          AFormProcessRent.Free;
        end;

        TryApplyChangesToDB();

      end;

      procedure TMainForm.EditRentCustomerIdEnter(Sender: TObject);
      begin
        EditSalesCustomerNbr.SelectAll;
      end;

      procedure TMainForm.EditRentCustomerIdKeyPress(Sender: TObject; var Key: Char);
      const
        backspace = #8; { key code for backspace character }
      begin
        if Key in [backspace, '0' .. '9'] then
        begin
          exit;
        end;
        Key := #0;
      end;

      procedure TMainForm.EditRentCustomerIdKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
      begin
        if (EditRentCustomerId.Text > '0') and (EditRentCustomerId.Text < '99999999') then
        begin
          if not RemoteDB.Customers.Locate('Customers_nbr', EditRentCustomerId.Text, [locaseinsensitive]) then
            RemoteDB.Customers.First;
        end else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
          EditRentCustomerId.Text := inttostr(ConnectedShop);
        end;
      end;

      procedure TMainForm.NewRentCaddyClick(Sender: TObject; TransactionType: TRentOperation);
      var
        Date: string;
        NewName: string;
        NewPanel: TAdvTabSheet;
        NewGrid: TAdvStringGrid;
        Count: Integer;
        StdGridWidth: Integer;
      begin
        DatetimeToString(Date, 'dd/mm-hh:mm', Now);
        NewPanel := TAdvTabSheet.Create(self);
        with NewPanel do
        begin
          AdvPageControl := PageControlRentCaddy;
          Caption        := Date;
          ImageIndex     := 34;
          NewName        := name;
          ShowClose      := True;
          OnClose        := RentCaddyClose;
        end;
        NewGrid := TAdvStringGrid.Create(self);
        with NewGrid do
        begin
          Parent                   := NewPanel;
          Look                     := glXP;
          SelectionColor           := clBtnFace;
          SelectionTextColor       := clBlack;
          ScrollBars               := ssBoth;
          ScrollBarAlways          := SaVert;
          ColumnSize.Stretch       := True;
          ColumnSize.StretchColumn := 1;
          PopupMenu                := PopupStringGrid;
          Align                    := alBottom;
          Height                   := Parent.ClientHeight - 80;
          Anchors                  := Anchors + [AkTop];
          FixedCols                := 0;
          FixedFooters             := 0;
          FixedRows                := 1;
          StdGridWidth             := 85;
          RowCount                 := 2;
          ColCount                 := 8;
          NewGrid.options          := options + [gorowselect];
          Flat                     := False;
          AutoNumAlign             := True;
          AutoThemeAdapt           := True;
          FloatFormat              := '&.2f';
          Cells[0, 0]              := 'Modle';
          Cells[1, 0]              := 'Description';
          Cells[2, 0]              := 'Quantit';
          Cells[3, 0]              := 'Dpart';
          Cells[4, 0]              := 'Retour';
          Cells[5, 0]              := 'Forfait';
          Cells[6, 0]              := 'Extra';
          Cells[7, 0]              := 'Valeur';
          for Count                := 0 to ColCount - 1 do
          begin
            ColWidths[Count] := StdGridWidth;
          end;
          ColWidths[1] := ClientWidth - StdGridWidth * (ColCount - 1);
          Refresh;
          Repaint;
        end;

        /// OUT / IN
        with TLabel.Create(self) do
        begin
          Tag       := 96;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 450;
          Font.Size := 25;
          if TransactionType = RentIn then
          begin
            Caption              := 'IN';
            ComboBoxRent.Enabled := False;
          end else begin
            ComboBoxRent.Enabled := True;
            Caption              := 'OUT';
          end;
        end;

        // Pices
        with TLabel.Create(self) do
        begin
          Tag       := 99;
          Parent    := NewPanel;
          Alignment := TaRightJustify;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 250;
          Font.Size := 25;
          Caption   := '0';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors - [akleft] + [akright];
          Top       := 15;
          Left      := Parent.ClientWidth - 228;
          Font.Size := 10;
          Caption   := 'Pcs';
        end;

        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors + [akleft] - [akright];
          Top       := 13;
          Left      := 10;
          Font.Size := 10;
          Caption   := 'Numero';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors + [akleft] - [akright];
          Top       := 33;
          Left      := 10;
          Font.Size := 10;
          Caption   := 'Nom';
        end;
        with TLabel.Create(self) do
        begin
          Tag       := 1;
          Parent    := NewPanel;
          Anchors   := Anchors + [akleft] - [akright];
          Top       := 53;
          Left      := 10;
          Font.Size := 10;
          Caption   := 'Prenom';
        end;
        with TEdit.Create(self) do
        begin
          Tag      := 95;
          Parent   := NewPanel;
          Top      := 10;
          Left     := 100;
          readonly := True;
          Text     := RemoteDB.CustomersCustomers_nbr.AsString;
        end;
        with TEdit.Create(self) do
        begin
          Parent   := NewPanel;
          Top      := 30;
          Left     := 100;
          readonly := True;
          Text     := RemoteDB.CustomersCustomers_Lastname.AsString;
        end;
        with TEdit.Create(self) do
        begin
          Parent   := NewPanel;
          Top      := 50;
          Left     := 100;
          readonly := True;
          Text     := RemoteDB.Customerscustomers_firstname.AsString;
        end;
        PageControlRentCaddy.ActivePage := NewPanel;
      end;

      procedure TMainForm.EditRentModelExit(Sender: TObject);
      var
        TransactionType: TRentOperation;
        i: Integer;
      begin
        // Initialisation environement
        RemoteDB.Products.IndexName := 'ProductsIXModel';

        if PageControlRentCaddy.PageCount = 0 then
        begin
          ShowMessage('Veuillez crer un caddy');
          exit;
        end;

        TransactionType := GetRentCaddyType;

        // Product model Verification validit
        if EditRentModel.Text <> '' then
        begin
          EditRentModel.Text := UpperCase(EditRentModel.Text);
          if RemoteDB.Products.Locate('products_model', EditRentModel.Text, [locaseinsensitive]) then
          begin

            if TransactionType = RentOut then
            begin
              // Verification Prsence en Stock Location
              if RemoteDB.netshop_rent_stock.Locate('rent_stock_product_model;rent_stock_state',
                Vararrayof([RemoteDB.Products.FieldByName('products_model').Value, 1]), [locaseinsensitive]) then
              begin
                // Recherche du prix Neuf et Nom
                EditRentName.Text   := RemoteDB.netshop_rent_stock.FieldByName('rent_stock_name').Value;
                EditRentPrice.Text  := RemoteDB.Products.FieldByName('products_price').AsString;
                EditRentDateIn.Text := DateToStr(RemoteDB.netshop_rent_stock.FieldByName('rent_stock_date_added').Value);

                // Calcul des quantits dispo
                EditRentAvailable.Text             := '0';
                RemoteDB.netshop_rent_stock.Filter := '(rent_stock_product_model = ' + QuotedStr(RemoteDB.Products.FieldByName('products_model').AsString) +
                  ') and (rent_stock_state= 1)';
                RemoteDB.netshop_rent_stock.Filtered := True;
                RemoteDB.netshop_rent_stock.First;
                while not RemoteDB.netshop_rent_stock.Eof do
                begin
                  EditRentAvailable.Text := inttostr(StrtoInt(EditRentAvailable.Text) + 1);
                  RemoteDB.netshop_rent_stock.Next;
                end;
                RemoteDB.netshop_rent_stock.Filtered := False;
              end else begin
                messagedlg('Plus disponible en location', mtwarning, [mbok], 0);
                RentClearEdit;
              end;

            end;

            if TransactionType = RentIn then
            begin

              // Verification Prsence en Transaction Location
              EditRentAvailable.Text := '0';
              with RemoteDB.netshop_rent_transaction do
              begin
                Filter := '(rent_transaction_product_model =' + QuotedStr(RemoteDB.Products.FieldByName('products_model').AsString) +
                  ' ) and ( rent_transaction_returned = 0 ) and (rent_transaction_customer_nbr = ' + inttostr(GetRentCaddyCustomerNbr) + ' )';
                Filtered := True;
                if not(Eof and Bof) then
                  while not Eof do
                  begin
                    EditRentAvailable.Text := inttostr(StrtoInt(EditRentAvailable.Text) + 1);
                    Next;
                  end;
                Filtered := False;
              end;

              if StrtoInt(EditRentAvailable.Text) > 0 then
              begin

                // Recherche du prix Neuf et Nom
                EditRentName.Text   := RemoteDB.Products.FieldByName('products_intername').Text;
                EditRentPrice.Text  := RemoteDB.Products.FieldByName('products_price').AsString;
                EditRentDateIn.Text := DateToStr(Now);

              end else begin
                messagedlg('Pas en location', mtwarning, [mbok], 0);
                RentClearEdit;
              end;
            end;
            // Product model non valide
          end else begin
            messagedlg('Code article invalide', mtwarning, [mbok], 0);
            RentClearEdit;
          end;
        end;
      end;

      procedure TMainForm.SBNewRentCaddyOutClick(Sender: TObject);
      begin
        if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
        begin
          NewRentCaddyClick(Sender, RentOut);
        end else begin
          ShowMessage('Veuillez choisir un client valide');
        end;
      end;

      procedure TMainForm.SBNewRentCaddyInClick(Sender: TObject);
      begin
        if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
        begin
          NewRentCaddyClick(Sender, RentIn);
        end else begin
          ShowMessage('Veuillez choisir un client valide');
        end;
      end;

      procedure TMainForm.PageControlRentCaddyChange(Sender: TObject);
      var
        i: Integer;
      begin
        if GetRentCaddyType = RentIn then
          ComboBoxRent.Enabled := False
        else
          ComboBoxRent.Enabled := True;
      end;

      function TMainForm.GetRentCaddyCustomerNbr: Integer;
      var
        i: Integer;
      begin
        for i := 0 to TAdvTabSheet(PageControlRentCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[i].Tag = 95 then
          begin
            Result := StrtoInt(TEdit(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[i]).Text);
          end;
        end;
      end;

      function TMainForm.GetRentCaddyType: TRentOperation;
      var
        i: Integer;
      begin
        for i := 0 to TAdvTabSheet(PageControlRentCaddy.ActivePage).ControlCount - 1 do
        begin
          if TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[i].Tag = 96 then
          begin
            if TLabel(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[i]).Caption = 'IN' then
            begin
              Result := RentIn;
            end else begin
              Result := RentOut;
            end;
          end;
        end;
      end;

      procedure TMainForm.NEditRentAvailableKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
      var
        i, Nowrow, rowpresent, quantitypresent, GridIndex: Integer;
        ProductPresent: Boolean;
        TransactionType: TRentOperation;
      begin
        RemoteDB.Products.IndexName := 'ProductsIXModel';
        quantitypresent             := 0;
        if Key = VK_RETURN then
        begin

          for i := 0 to TAdvTabSheet(PageControlRentCaddy.ActivePage).ControlCount - 1 do
          begin
            if TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[i].ClassType = TAdvStringGrid then
            begin
              GridIndex := i;
            end;
          end;

          TransactionType := GetRentCaddyType;
          EditRentModelExit(nil);

          if RemoteDB.Products.FindKey([EditRentModel.Text]) then
          begin

            if TransactionType = RentOut then
            begin

              if StrtoInt(EditRentAvailable.Text) > 0 then
              begin

                { Rechercher dans le Rent grid pour la meme occurence owner id & product model }
                ProductPresent  := False;
                rowpresent      := -1;
                quantitypresent := 0;

                for Nowrow := 1 to TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
                begin
                  if (TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]).Cells[0, Nowrow] = EditRentModel.Text) then
                  begin
                    quantitypresent := quantitypresent + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex])
                      .Cells[2, Nowrow]);
                    ProductPresent := True;
                    rowpresent     := Nowrow;
                  end;
                end;


                // Selection du Rent Scheme

                if not RemoteDB.netshop_rent_schemes.Locate('rent_scheme_name', ComboBoxRent.Text, []) then
                begin
                  ShowMessage('Veuillez slectionner un schma de location');
                  exit;
                end;

                if StrtoInt(EditRentAvailable.Text) >= quantitypresent + 1 then
                begin

                  { Ajouter d'une ligne dans le Rent grid }
                  RemoteDB.netshop_rent_stock.Locate('rent_stock_product_model', EditRentModel.Text, []);

                  with TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]) do
                  begin
                    Nowrow           := RowCount - 1;
                    Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
                    Cells[1, Nowrow] := RemoteDB.netshop_rent_stock.FieldByName('rent_stock_name').Value;
                    // CDSProDescFR.FieldByName('products_name').Text;
                    Cells[2, Nowrow] := '1';
                    Cells[3, Nowrow] := DateToStr(Now);
                    Cells[4, Nowrow] := DateToStr(Now + RemoteDB.netshop_rent_schemes.FieldByName('rent_scheme_base_days').Value);
                    Cells[5, Nowrow] := RemoteDB.netshop_rent_schemes.FieldByName('rent_scheme_base_price').AsString;
                    Cells[6, Nowrow] := RemoteDB.netshop_rent_schemes.FieldByName('rent_scheme_extra_price').AsString;
                    Cells[7, Nowrow] := FloatToStrF(RemoteDB.ProductsProducts_Price.AsFloat, fffixed, 7, 2);
                    RowCount         := Nowrow + 2;
                  end;

                  { Reinitialisation de la barre de selection }
                  RentClearEdit;
                  EditRentModel.SetFocus;

                end else begin
                  messagedlg('Quantit indisponnible', mtwarning, [mbok], 0);
                end;
              end else begin { quantit farfelue }
                messagedlg('Quantit indisponnible', mtwarning, [mbok], 0);
              end;
            end;

            if TransactionType = RentIn then
            begin

              if StrtoInt(EditRentAvailable.Text) > 0 then
              begin
                { Rechercher dans le Rent grid pour la meme occurence owner id & product model }
                ProductPresent  := False;
                rowpresent      := -1;
                quantitypresent := 0;
                for Nowrow      := 1 to TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]).RowCount - 2 do
                begin
                  if (TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]).Cells[0, Nowrow] = EditRentModel.Text) then
                  begin
                    quantitypresent := quantitypresent + StrtoInt(TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex])
                      .Cells[2, Nowrow]);
                    ProductPresent := True;
                    rowpresent     := Nowrow;
                  end;
                end;

                if StrtoInt(EditRentAvailable.Text) >= quantitypresent + 1 then
                begin

                  RemoteDB.Products.FindKey([EditRentModel.Text]);

                  with RemoteDB.netshop_rent_transaction do
                  begin
                    Filter := '(rent_transaction_product_model = ' + QuotedStr(RemoteDB.Products.FieldByName('products_model').AsString) +
                      ' ) and ( rent_transaction_returned = 0 ) and ( rent_transaction_customer_nbr = ' + RemoteDB.CustomersCustomers_nbr.AsString + ' )';
                    Filtered := True;
                  end;

                  RemoteDB.netshop_rent_schemes.Locate('Rent_scheme_id', RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_scheme_id').Value, []);

                  with TAdvStringGrid(TAdvTabSheet(PageControlRentCaddy.ActivePage).Controls[GridIndex]) do
                  begin
                    Nowrow           := RowCount - 1;
                    Cells[0, Nowrow] := RemoteDB.Productsproducts_model.Text;
                    Cells[1, Nowrow] := RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_product_name').Value;
                    // CDSProDescFR.FieldByName('products_name').Text;
                    Cells[2, Nowrow] := '1';
                    Cells[3, Nowrow] := DateToStr(RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_start_date').Value);
                    Cells[4, Nowrow] := DateToStr(RemoteDB.netshop_rent_transaction.FieldByName('rent_transaction_due_date').Value);
                    Cells[5, Nowrow] := RemoteDB.netshop_rent_schemes.FieldByName('rent_scheme_base_price').AsString;
                    Cells[6, Nowrow] := RemoteDB.netshop_rent_schemes.FieldByName('rent_scheme_extra_price').AsString;
                    Cells[7, Nowrow] := FloatToStrF(RemoteDB.ProductsProducts_Price.AsFloat, fffixed, 7, 2);
                    RowCount         := Nowrow + 2;
                  end;

                  { Reinitialisation de la barre de selection }
                  RentClearEdit;
                  EditRentModel.SetFocus;

                end else begin
                  messagedlg('Quantit indisponnible', mtwarning, [mbok], 0);
                end;
              end else begin { quantit farfelue }
                messagedlg('Quantit indisponnible', mtwarning, [mbok], 0);
              end;
            end;
          end else begin { Product model non localis }
            messagedlg('Modle non valide', mtwarning, [mbok], 0);
            RentClearEdit;
          end;
        end;
      end;

      procedure TMainForm.BitBtnCustomerDepositAddFundClick(Sender: TObject);
      var
        ThisAddFundForm: TAddFundForm;
      begin
        ///
        /// Ajout de fonds
        ///
        if RemoteDB.Customers.FieldByName('customers_nbr').Value >= 100000 then
          try
            ThisAddFundForm     := TAddFundForm.Create(self);
            RemoteDB.IsUpdating := True;
            // Self.Enabled:=False;
            ThisAddFundForm.cxCurrencyEditOldAmount.Value := RemoteDB.Customers.FieldByName('customers_credit').Value;
            ThisAddFundForm.FnpAmount.Value               := 0;
            ThisAddFundForm.Edit1.Text                    := '';
            if ThisAddFundForm.ShowModal = mrOK then
            begin
            end;
          finally
            // Self.Enabled:=True;
            RemoteDB.IsUpdating := False;
            ThisAddFundForm.Free;
          end
        else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
        end;
      end;

      procedure TMainForm.BitBtnCustomerDepositDefectClick(Sender: TObject);
      begin
        RemoteDB.netshop_stock.Edit;
        RemoteDB.netshop_stock.FieldByName('product_isdefect').Value := 1;
        RemoteDB.netshop_stock.Post;
        TryApplyChangesToDB();
      end;

      procedure TMainForm.BitBtnCustomerDepositRefundClick(Sender: TObject);
      var
        UpdateStatus: Boolean;
        aRefundForm: TRefundForm;
      begin
        ///
        /// Rembours
        ///
        if RemoteDB.Customers.FieldByName('customers_nbr').Value >= 100000 then
          try
            UpdateStatus := RemoteDB.IsUpdating;
            if not RemoteDB.IsUpdating then
              RemoteDB.IsUpdating := True;
            aRefundForm           := TRefundForm.Create(self);
            try
              aRefundForm.ShowModal
            finally
              aRefundForm.Free;
            end;
          finally
            RemoteDB.IsUpdating := UpdateStatus;
            TryApplyChangesToDB();
          end
        else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
        end;

      end;

      procedure ReturnStock();
      begin
        RemoteDB.netshop_stock_returned.Append;
        RemoteDB.netshop_stock_returned.Append;
        RemoteDB.netshop_stock_returned.FieldByName('product_model').AsString := RemoteDB.netshop_stock.FieldByName('product_model').AsString;
        RemoteDB.netshop_stock_returned.FieldByName('product_name').Value := RemoteDB.netshop_stock.FieldByName('product_name').Value;
        RemoteDB.netshop_stock_returned.FieldByName('product_owner_id').AsInteger := RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger;
        RemoteDB.netshop_stock_returned.FieldByName('product_price_stock').AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat;
        RemoteDB.netshop_stock_returned.FieldByName('product_location').AsInteger := RemoteDB.netshop_stock.FieldByName('product_location').AsInteger;
        RemoteDB.netshop_stock_returned.FieldByName('product_quantity').AsInteger := RemoteDB.netshop_stock.FieldByName('product_quantity').AsInteger;
        RemoteDB.netshop_stock_returned.FieldByName('product_supplier_id').AsInteger := RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger;
        RemoteDB.netshop_stock_returned.FieldByName('product_date_in').Value := RemoteDB.netshop_stock.FieldByName('product_date_in').Value;
        RemoteDB.netshop_stock_returned.FieldByName('product_price_gross').AsFloat := RemoteDB.netshop_stock.FieldByName('product_price_gross').AsFloat;
        RemoteDB.netshop_stock_returned.FieldByName('product_isdefect').Value := RemoteDB.netshop_stock.FieldByName('product_isdefect').Value;
        RemoteDB.netshop_stock_returned.FieldByName('date_returned').Value := Now;
        RemoteDB.netshop_stock_returned.Post;
        RemoteDB.netshop_stock.delete;
      end;

      procedure TMainForm.BitBtnCustomerDepositReturnClick(Sender: TObject);
      var
        TicketToPrint: TTicketJob;
        i: Integer;
        ExitLib: TFormExitLibrary;

      begin
        ///
        /// IMPRESSION DU RECU  Restitution
        ///
        if RemoteDB.Customers.FieldByName('customers_nbr').Value >= 100000 then
          try

            // Self.Enabled:=False;
            if not(self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
              if messagedlg('Imprimante  tickets non active ! Voulez-vous continuer ?', mtwarning, [mbyes, mbno], 0) = mrno then
                exit;
            begin
              if (self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
              begin
                TicketToPrint := TTicketJob.Create(nil);
                try
                  TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
                  TicketToPrint.Logo     := PrintLogo;
                  TicketToPrint.URL      := WEBURL;
                  if ShopdataList <> nil then begin
                    TicketToPrint.ShopData := ShopdataList;
                  end else begin
                    ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
                  end;
                  if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
                    TicketToPrint.Model := TmContinuous;

                  TicketToPrint.AddBox('Articles restitus', True, bsProd);
                  with RemoteDB.netshop_stock do

                  begin
                    TicketToPrint.AddLine(RemoteDB.netshop_stock.FieldByName('product_quantity').AsString,
                      RemoteDB.netshop_stock.FieldByName('product_price_stock').AsString, RemoteDB.netshop_stock.FieldByName('product_name').AsString,
                      'Articles restitus');
                  end;

                  if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
                  begin
                    TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
                    TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);
                  end;

                  if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
                    TicketToPrint.PrintOpos
                  else
                    TicketToPrint.Print;
                finally
                  TicketToPrint.Free;
                end;
              end; // Fin ticket

              if True then
              begin
                { Sortie Du Dacal }

                with RemoteDB.netshop_stock do
                begin

                  RemoteDB.Products.Locate('products_model', RemoteDB.netshop_stock.FieldByName('product_model').Text, []);

                  // Calcul fidlit dpt ngative
                  RemoteDB.customers.Edit;
                  RemoteDB.customers.FieldByName('customers_loyalty').AsInteger := RemoteDB.customers.FieldByName('customers_loyalty').AsInteger
                  - ((Trunc(RemoteDB.netshop_stock.FieldByName('product_price_stock').AsFloat) Div 5)+1) * 2;
                  RemoteDB.customers.Post;


                  if (self.Parameter['MiscCDLibUse'] = 'TRUE') then
                  begin
                    if RemoteDB.Caroussel.Locate('model;customer_nbr;IsRoot',
                      Vararrayof([RemoteDB.netshop_stock.FieldByName('product_model').Text, RemoteDB.netshop_stock.FieldByName('product_owner_id').Text, True]
                      ), []) then
                    begin
                      if (((RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger < 100000) and
                        (RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger >= 100000)) or
                        (RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger >= 100000)) then
                      begin
                        ExitLib := TFormExitLibrary.Create(self);
                        if ExitLib.Enter(RemoteDB.netshop_stock.FieldByName('product_owner_id').Text, RemoteDB.netshop_stock.FieldByName('product_model').Text)
                          = mrOK then
                        begin
                          ReturnStock;
                        end;
                        ExitLib.Free;
                      end;
                    end else begin
                      ReturnStock;
                    end;
                  end;

                  if ((self.Parameter['MiscCDLibUse'] = 'FALSE') and (((RemoteDB.netshop_stock.FieldByName('product_owner_id').AsInteger < 100000) and
                    (RemoteDB.netshop_stock.FieldByName('product_supplier_id').AsInteger >= 100000)) or (RemoteDB.netshop_stock.FieldByName('product_owner_id')
                    .AsInteger >= 100000))) then
                  begin
                    ReturnStock;
                  end;
                end;

              end;

            end; // Fin Block execut mme sans imprimante

          finally
            // Self.Enabled:=True;
              TryApplyChangesToDB();
          end
        else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
        end;
      end;

      procedure TMainForm.BitBtnCustomerDepositStatusClick(Sender: TObject);
      var
        Total: Real;
        TicketToPrint: TTicketJob;
        Data: WideString;
        Num, LineSpacing: Integer;
      begin
        ///
        /// IMPRESSION DU RECU ETAT
        ///
        if RemoteDB.Customers.FieldByName('customers_nbr').Value >= 100000 then
          try
            // Self.Enabled:=False;
            Total := 0;
            if not(self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
              if messagedlg('Imprimante  tickets non active ! Voulez-vous continuer ?', mtwarning, [mbyes, mbno], 0) = mrno then
                exit;
            begin
              TicketToPrint := TTicketJob.Create(nil);
              try
                TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
                TicketToPrint.Logo     := PrintLogo;
                TicketToPrint.URL      := WEBURL;
                if ShopdataList <> nil then begin
                  TicketToPrint.ShopData := ShopdataList;
                end else begin
                  ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
                end;
                if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
                  TicketToPrint.Model := TmContinuous;

                RemoteDB.netshop_stock.First;
                if not RemoteDB.netshop_stock.Eof then
                begin
                  TicketToPrint.AddBox('Articles non vendus', True, bsProd);
                  while not RemoteDB.netshop_stock.Eof do
                  begin
                    TicketToPrint.AddLine(RemoteDB.netshop_stock.FieldByName('product_quantity').AsString,
                      RemoteDB.netshop_stock.FieldByName('product_price_stock').AsString, RemoteDB.netshop_stock.FieldByName('product_name').AsString,
                      'Articles non vendus');
                    RemoteDB.netshop_stock.Next;
                  end;
                end;

                ActionCustomerDepositnonrefunded.Execute;
                RemoteDB.netshop_items_sold.First;
                if not RemoteDB.netshop_items_sold.Eof then
                begin
                  TicketToPrint.AddBox('Articles vendus en attente', True, bsProd);
                  while not RemoteDB.netshop_items_sold.Eof do
                  begin
                    TicketToPrint.AddLine(RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').AsString,
                      RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsString, RemoteDB.netshop_items_sold.FieldByName('items_sold_name')
                      .AsString, 'Articles vendus en attente');
                    Total := Total + RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity').Value *
                      RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat;
                    RemoteDB.netshop_items_sold.Next;
                  end;
                end;

                if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
                begin
                  TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
                  TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);
                  TicketToPrint.AddCustomerLine('Crdit :', RemoteDB.CustomersCustomers_credit.Text);
                  TicketToPrint.AddCustomerLine('Points :', RemoteDB.Customers.FieldByName('customers_loyalty').Text);
                end;

                if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
                  TicketToPrint.PrintOpos
                else
                  TicketToPrint.Print;
              finally
                TicketToPrint.Free;
              end;
            end; // Fin ticket
          finally
            // Self.Enabled:=True;
          end
        else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
        end;

      end;

      procedure TMainForm.BitBtnCustomerDepositToVoucherClick(Sender: TObject);
      begin
        ///
        /// IMPRESSION DU RECU Bon Achat
        ///
        if RemoteDB.Customers.FieldByName('customers_nbr').Value >= 100000 then
          try
            // Self.Enabled:=False;
            ActionCustomerDepositnonrefunded.Execute;
            // if Not (ParamTree.Parameter['PrintersTicketEnabled']='TRUE') then if Messagedlg('Imprimante  tickets non active ! Voulez-vous continuer ?',mtwarning,[mbyes,mbno],0) = mrNo then Exit;
            begin
              RemoteDB.netshop_items_sold.First;
              while not RemoteDB.netshop_items_sold.Eof do
              begin
                if RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').Value = RemoteDB.Customers.FieldByName('customers_nbr').Value then
                begin
                  RemoteDB.Customers.Edit;
                  RemoteDB.CustomersCustomers_credit.AsFloat := RemoteDB.CustomersCustomers_credit.AsFloat +
                    (RemoteDB.netshop_items_sold.FieldByName('items_sold_price_stock').AsFloat * RemoteDB.netshop_items_sold.FieldByName('items_sold_quantity')
                    .AsInteger * (MarginDepositVoucher / 100));
                  RemoteDB.Customers.Post;
                end;
                RemoteDB.netshop_items_sold.Next;
              end;

              RemoteDB.netshop_items_sold.First;
              while not RemoteDB.netshop_items_sold.Eof do
              begin
                if RemoteDB.netshop_items_sold.FieldByName('items_sold_owner_id').AsInteger = RemoteDB.Customers.FieldByName('customers_nbr').AsInteger then
                begin
                  RemoteDB.netshop_items_sold.Edit;
                  RemoteDB.netshop_items_sold.FieldByName('items_refunded').Value := 1;
                  RemoteDB.netshop_items_sold.Post;
                end;
                // RemoteDB.Items_Sold.Next; NE PAS COMMENTER SINON SORTIE DU FILTRE ET ELEMENTS SAUTES
              end;
            end; // Fin block execut mme sans imprimante
          finally
            // Self.Enabled:=True;
            TryApplyChangesToDB();
          end
        else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
        end;
      end;

      procedure TMainForm.BitBtnCustomereMailClick(Sender: TObject);
      var
        Body: TStringList;
        aSendEmail: TSmartSendEmail;
      begin
        aSendEmail := TSmartSendEmail.Create(ShopData1.Text, ShopData5.Text, RemoteDB.Customerscustomers_email_address.AsString, MessageSubject.Text, '',
          MessageBody.Lines);
      end;

      procedure TMainForm.BitBtnCustomerInvoiceCloseClick(Sender: TObject);
      begin
        if RemoteDB.netshop_invoices.FieldByName('invoices_closed').Value = 1 then
        begin
          messagedlg('Facture dj cloture', mtwarning, [mbok], 0);
          exit;
        end;
        if messagedlg('Confirmez la cloture de la facture, toute modification ultrieure est impossible', mtwarning, [mbok, mbCancel], 0) = mrOK then
        begin
          RemoteDB.netshop_invoices.Edit;
          RemoteDB.netshop_invoices.FieldByName('invoices_closed').Value := 1;
          RemoteDB.netshop_invoices.FieldByName('invoices_date_time').Value := Now;
          RemoteDB.netshop_invoices.Post;
            TryApplyChangesToDB();
        end;
      end;

      procedure TMainForm.BitBtnCustomerInvoicePrintClick(Sender: TObject);
      var
        Pindex: Integer;
        i: Integer;
      begin
        ChDir(ExtractFilePath(ParamStr(0)));
        Pindex := Printer.Printers.IndexOf((self.Parameter['PrintersRapportPrinter']));
        RemoteDB.Shops.FindKey([ConnectedShop]);
        ReportModule.RvProject.Open;
        ReportModule.RvProject.SelectReport('ReportInvoice', True);
        ReportModule.RvProject.SetParam('TVA6', FloatToStr(RemoteDB.CalcInvoiceTVA(6)));
        ReportModule.RvProject.SetParam('TVA21', FloatToStr(RemoteDB.CalcInvoiceTVA(21)));
        ReportModule.RvProject.SetParam('BASE6', FloatToStr(RemoteDB.CalcInvoiceTVABASE(6)));
        ReportModule.RvProject.SetParam('BASE21', FloatToStr(RemoteDB.CalcInvoiceTVABASE(21)));
        Randomize;
        i := trunc(Random(RemoteDB.Tips.RecordCount));
        RemoteDB.Tips.First;
        if not RemoteDB.Tips.Eof then
        begin
          while i <> 0 do
          begin
            RemoteDB.Tips.Next;
            i := i - 1;
          end;
          ReportModule.RvProject.SetParam('Conditions', RemoteDB.TipsTipsText.AsString);
        end
        else
          ReportModule.RvProject.SetParam('Conditions', '');

        if RemoteDB.netshop_invoices.FieldByName('invoices_paid_proton').AsFloat > 0 then
        begin
          ReportModule.RvProject.SetParam('URL', 'COMMUNICATION : SMARTFACT*' + RemoteDB.netshop_invoices.FieldByName('invoices_customer_id').AsString + '*' +
            RemoteDB.netshop_invoices.FieldByName('invoices_location').AsString + '-' + RemoteDB.netshop_invoices.FieldByName('invoices_id').AsString);
        end else begin
          ReportModule.RvProject.SetParam('URL', WEBURL);
        end;

        ReportModule.RvSystem.DefaultDest := rdPrinter;
        // ReportModule.RvSystem.DoNativeOutput := true;
        ReportModule.RvSystem.SystemSetups := ReportModule.RvSystem.SystemSetups + [ssAllowSetup];
        // ReportModule.RvSystem.Execute;
        ReportModule.RvNDRWriter.PrinterIndex         := Pindex;
        ReportModule.RvSystem.SystemPreview.FormState := wsMaximized;
        ReportModule.RvProject.Execute;
        ReportModule.RvProject.Close;

        { if Not MainForm.A4PrinterEnabled.Checked then if Messagedlg('Imprimante  factures non active ! Voulez-vous continuer ?',mtwarning,[mbyes,mbno],0) = mrNo then Exit;
          begin
          TicketToPrint:=TTicketJob.Create;
          try
          TicketToPrint.Printer:=(Mainform.self.Parameter['PrintersRapportPrinter']);
          TicketToPrint.Logo:=PrintLogo;
          TicketToPrint.Url:=WEBURL;
          TicketToPrint.ShopData:=ShopDataList;
          TicketToPrint.DateTime:=RemoteDB.invoices.FieldByName('invoices_date_time.Value;
          TicketToPrint.Model:=TmFinished;

          BoxName:='Client # '+RemoteDB.CustomersCustomers_nbr.Text;
          TicketToPrint.AddBox(BoxName,True,bsCust);
          if RemoteDB.CustomersCustomers_nbr.Value > 100 then begin
          TicketToPrint.AddLine('Nom / Socit :','',RemoteDB.CustomersCustomers_lastname.Text,Boxname);
          if RemoteDB.CustomersCustomers_TVA.Text<>'' then begin
          TicketToPrint.AddLine('TVA :','',RemoteDB.CustomersCustomers_TVA.Text,Boxname);
          end;
          if RemoteDB.CustomersCustomers_firstname.Text<>'' then begin
          TicketToPrint.AddLine('Prnom :','',RemoteDB.CustomersCustomers_firstname.Text,Boxname);
          end;
          TicketToPrint.AddLine('Rue :','',RemoteDB.Address_Bookentry_street_address.Text,Boxname);
          TicketToPrint.AddLine('CP Ville :','',RemoteDB.Address_Bookentry_postcode.Text+' '+RemoteDB.Address_Bookentry_city.Text,Boxname);
          end;




          BoxName:='Facture N '+inttostr(RemoteDB.invoices.FieldByName('invoices_location.Value)+ '-' +inttostr(RemoteDB.invoices.FieldByName('invoices_id.Value)+ ' du ' + Formatdatetime('DD/MM/YYYY',RemoteDB.invoices.FieldByName('invoices_date_time.Value);
          TicketToPrint.AddBox(BoxName,True,bsProd);
          RemoteDB.invoices_items.First;
          TicketToPrint.AddHeader(Gridline,BoxName);
          While Not RemoteDB.invoices_items.Eof do begin
          TicketToPrint.AddLine(
          RemoteDB.Invoices_itemsinvoices_items_quantity.Text,
          RemoteDB.Invoices_itemsinvoices_items_price_stock.Text,
          RemoteDB.invoices_itemsinvoices_items_name.Text,BoxName);
          RemoteDB.invoices_items.Next;
          end;

          // RemoteDB.Invoices_Items.IndexFieldNames:='invoices_items_tva_rate';
          RemoteDB.Invoices_items.First;
          LastRate:=-1;
          While not RemoteDB.Invoices_items.Eof do begin
          if LastRate <> RemoteDB.Invoices_items.FieldByName('invoices_items_tva_rate').Value then begin
          if LastRate <>-1 then begin
          TicketToPrint.AddInTVA(LastRate,Base,Tax);
          end;
          LastRate:=RemoteDB.Invoices_items.FieldByName('invoices_items_tva_rate').Value;
          Base:=0;
          Tax:=0;
          end;
          Base:=Base+RemoteDB.Invoices_items.FieldByName('invoices_items_price_stock').Value-RemoteDB.Invoices_items.FieldByName('invoices_items_price_tva').Value;
          Tax:=Tax+RemoteDB.Invoices_items.FieldByName('invoices_items_price_tva').Value;
          RemoteDB.Invoices_items.Next;
          end;
          TicketToPrint.AddInTVA(LastRate,Base,Tax);

          //      TicketToPrint.AddFinancialLine('Total HT :',RemoteDB.invoices.FieldByName('invoices_paid_TotalTTC.Value/1.21);
          //      TicketToPrint.AddFinancialLine('TVA 21% :',RemoteDB.invoices.FieldByName('invoices_paid_TotalTTC.Value-RemoteDB.invoices.FieldByName('invoices_paid_TotalTTC.Value/1.21);
          TicketToPrint.AddFinancialLine('Total TTC :',RemoteDB.invoices.FieldByName('invoices_paid_TotalTTC.Value);


          if RemoteDB.invoices.FieldByName('invoices_paid_cash.Value>0 then begin
          TicketToPrint.AddFinancialLine('Liquide :',RemoteDB.invoices.FieldByName('invoices_paid_cash.Value);
          end;
          if RemoteDB.invoices.FieldByName('invoices_paid_BCT.Value>0 then begin
          TicketToPrint.AddFinancialLine('Carte de banque :',RemoteDB.invoices.FieldByName('invoices_paid_BCT.Value);
          end;
          if RemoteDB.invoices.FieldByName('invoices_paid_Visa.Value>0 then begin
          TicketToPrint.AddFinancialLine('Carte de crdit :',RemoteDB.invoices.FieldByName('invoices_paid_Visa.Value);
          end;
          if RemoteDB.invoices.FieldByName('invoices_paid_Proton.Value>0 then begin
          TicketToPrint.AddFinancialLine('Porte monnaie :',RemoteDB.invoices.FieldByName('invoices_paid_Proton.Value);
          end;
          if RemoteDB.invoices.FieldByName('invoices_paid_Voucher.Value>0 then begin
          TicketToPrint.AddFinancialLine('Bon achat :',RemoteDB.invoices.FieldByName('invoices_paid_Voucher.Value);
          end;

          TicketToPrint.Print;
          finally
          TicketToPrint.Free;
          end;
          end; }
      end;

      procedure TMainForm.BitBtnCustomerRepairCreateClick(Sender: TObject);
      var
        TicketToPrint: TTicketJob;
        Data: WideString;
        Num, LineSpacing, i: Integer;
        aRepairNewForm: TRepairNewForm;
      begin
        try
          if RemoteDB.Customers.FieldByName('customers_nbr').Value >= 100000 then
          begin
            RemoteDB.IsUpdating := True;
            RemoteDB.netshop_repair.Append;
            aRepairNewForm := TRepairNewForm.Create(self);
            try
              if aRepairNewForm.ShowModal = mrOK then
              begin
                RemoteDB.netshop_repair.Post;
                try
                  ActionCustomerRepairAll.Execute;
                  if not(self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
                    if messagedlg('Imprimante  tickets non active ! Voulez-vous continuer ?', mtwarning, [mbyes, mbno], 0) = mrno then
                      exit;
                  begin
                    TicketToPrint := TTicketJob.Create(nil);
                    try
                      TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
                      TicketToPrint.Logo     := PrintLogo;
                      TicketToPrint.URL      := WEBURL;
                      if ShopdataList <> nil then begin
                        TicketToPrint.ShopData := ShopdataList;
                      end else begin
                        ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
                      end;
                      if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
                        TicketToPrint.Model := TmContinuous;
                      TicketToPrint.AddBox('Bon rparation', True, bsProd);
                      TicketToPrint.AddLine('1', '0', RemoteDB.netshop_repair.FieldByName('repair_products_name').Value, 'Bon rparation');

                      if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
                      begin
                        TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
                        TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);
                        if RemoteDB.Customerscustomers_telephone.Text <> '' then
                          TicketToPrint.AddCustomerLine('Tel :', RemoteDB.Customerscustomers_telephone.Text);
                        if RemoteDB.Customerscustomers_fax.Text <> '' then
                          TicketToPrint.AddCustomerLine('GSM :', RemoteDB.Customerscustomers_fax.Text);
                        TicketToPrint.AddCustomerLine('N de srie :', RemoteDB.netshop_repair.FieldByName('repair_products_serial').Value);
                        TicketToPrint.AddCustomerLine('Panne :', RemoteDB.netshop_repair.FieldByName('repair_products_problem').Value);
                        TicketToPrint.Comment := 'Attention !' + chr(10) + chr(13) + '';
                        TicketToPrint.Comment := TicketToPrint.Comment + DepositWarning;

                      end;

                      if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
                        TicketToPrint.PrintOpos
                      else
                        TicketToPrint.Print;
                    finally
                      TicketToPrint.Free;
                    end;
                  end; // Fin ticket
                finally
                end;
              end else begin
                RemoteDB.netshop_repair.Cancel;
              end;
            finally
              aRepairNewForm.Free;
              TryApplyChangesToDB();
            end;
          end else begin
            messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
          end;
        finally
          RemoteDB.IsUpdating := False;
        end;
      end;

      procedure TMainForm.BitBtnCustomerRepairExecuteClick(Sender: TObject);
      var
        aRepairFixForm: TRepairFixForm;
      begin
        RemoteDB.IsUpdating := True;
        try
          ActionCustomerRepairAll.Execute;
          if not(RemoteDB.netshop_repair.Eof and RemoteDB.netshop_repair.Bof) then
          begin
            if RemoteDB.Customers.FieldByName('customers_nbr').AsInteger >= 100000 then
            begin
              aRepairFixForm := TRepairFixForm.Create(self);
              try
                if RemoteDB.netshop_repair.FieldByName('Repair_Fixed').Value = 'false' then
                begin
                  RemoteDB.netshop_repair.Edit;

                  if aRepairFixForm.ShowModal = mrOK then
                  begin
                    ///
                    /// Inscription rparation dans la DB
                    ///

                    RemoteDB.netshop_repair.FieldByName('repair_fixed').Value := 'true';
                    RemoteDB.netshop_repair.FieldByName('repair_date_fixed').Value := Now;
                  end;
                  RemoteDB.netshop_repair.Post;
                end else begin
                  if messagedlg('Article dj rpar voulez-vous continuer', mtwarning, [mbyes, mbno], 0) = mryes then
                  begin
                    RemoteDB.netshop_repair.Edit;
                    if RepairFixForm.ShowModal = mrOK then
                    begin
                      ///
                      /// Inscription modification rparation dans la DB
                      ///
                      RemoteDB.netshop_repair.FieldByName('repair_fixed').Value := 'true';
                      RemoteDB.netshop_repair.FieldByName('repair_date_fixed').Value := Now;
                    end;
                    RemoteDB.netshop_repair.Post;
                  end;
                end;
              finally
                aRepairFixForm.Free;
                  TryApplyChangesToDB();
              end;
            end else begin
              messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
            end;
          end else begin
            messagedlg('Aucun article en rparation', mtwarning, [mbok], 0);
          end;
        finally
          RemoteDB.IsUpdating := False;
        end;
      end;

      procedure TMainForm.BitBtnCustomerRepairReturnClick(Sender: TObject);
      var
        Nowrow, i, j, Index, page: Integer;
        aRepairReturnForm: TRepairReturnForm;
      begin
        try
          RemoteDB.IsUpdating := True;
          if not(RemoteDB.netshop_repair.Eof and RemoteDB.netshop_repair.Bof) then
          begin
            if RemoteDB.Customers.FieldByName('customers_nbr').AsInteger >= 100000 then
            begin
              aRepairReturnForm := TRepairReturnForm.Create(nil);
              try
                if RemoteDB.netshop_repair.FieldByName('Repair_Fixed').Value = 'true' then
                begin
                  if aRepairReturnForm.ShowModal = mrOK then
                  begin
                    ///
                    /// Restitution Article rpar
                    ///
                    // Find Customer Caddy
                    page  := -1;
                    for i := 0 to self.PageControlSalesCaddy.PageCount - 1 do
                    begin
                      for j := 0 to TAdvTabSheet(self.PageControlSalesCaddy.Pages[i]).ControlCount - 1 do
                      begin
                        if self.PageControlSalesCaddy.Pages[i].Controls[j].Tag = 100 then
                        begin
                          if TEdit(self.PageControlSalesCaddy.Pages[i].Controls[j]).Text = RemoteDB.CustomersCustomers_nbr.AsString then
                          begin
                            page := i;
                          end;
                        end;
                      end;
                    end;

                    // Create New caddy if not found
                    if page = -1 then
                    begin
                      SBNewSalesCaddyClick(self);
                      page := self.PageControlSalesCaddy.ActivePageIndex;
                    end;

                    for i := 0 to TAdvTabSheet(self.PageControlSalesCaddy.Pages[page]).ControlCount - 1 do
                    begin
                      if TAdvTabSheet(MainForm.PageControlSalesCaddy.Pages[page]).Controls[i].ClassType = TAdvStringGrid then
                      begin
                        index := i;
                      end;
                    end;
                    with TAdvStringGrid(TAdvTabSheet(MainForm.PageControlSalesCaddy.Pages[page]).Controls[index]) do
                    begin
                      Nowrow           := RowCount - 1;
                      Cells[0, Nowrow] := 'REPA';
                      Cells[1, Nowrow] := 'Rparation : ' + RemoteDB.netshop_repair.FieldByName('repair_products_problem').AsString;
                      Cells[2, Nowrow] := '1';
                      Cells[3, Nowrow] := RemoteDB.netshop_repair.FieldByName('repair_price').AsString;
                      Cells[4, Nowrow] := RemoteDB.netshop_repair.FieldByName('repair_price').AsString;
                      Cells[5, Nowrow] := '0';
                      Cells[6, Nowrow] := VCLToOSCDate(RemoteDB.netshop_repair.FieldByName('repair_date_in_display').AsDateTime);
                      Cells[7, Nowrow] := inttostr(ConnectedShop);
                      Cells[8, Nowrow] := '0';
                      RowCount         := Nowrow + 2;
                    end;
                    RemoteDB.netshop_repair.Edit;
                    RemoteDB.netshop_repair.FieldByName('repair_returned').Value := 'true';
                    RemoteDB.netshop_repair.FieldByName('repair_date_out').Value := Now;
                    RemoteDB.netshop_repair.Post;
                  end;
                end else begin
                  if messagedlg('Article non rpar voulez-vous continuer', mtwarning, [mbyes, mbno], 0) = mryes then
                  begin
                    if aRepairReturnForm.ShowModal = mrOK then
                    begin
                      ///
                      /// Restitution Article non rpar
                      ///
                      RemoteDB.netshop_repair.Edit;
                      RemoteDB.netshop_repair.FieldByName('repair_returned').Value := 'true';
                      RemoteDB.netshop_repair.FieldByName('repair_date_out').Value := Now;
                      RemoteDB.netshop_repair.Post;
                    end;
                  end;
                end;
              finally
                aRepairReturnForm.Free;
                  TryApplyChangesToDB();
              end;
            end else begin
              messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
            end;
          end else begin
            messagedlg('Aucun article  restituer', mtwarning, [mbok], 0);
          end;
        finally
          RemoteDB.IsUpdating := False;
        end;
      end;

      procedure TMainForm.BitBtnCustomerRepairStatusClick(Sender: TObject);
      var
        TicketToPrint: TTicketJob;
        Data: WideString;
        Num, LineSpacing, i: Integer;
      begin
        if RemoteDB.Customers.FieldByName('customers_nbr').AsInteger >= 100000 then
        begin
          try
            // Self.Enabled:=False;
            if not(self.Parameter['PrintersTicketEnabled'] = 'TRUE') then
              if messagedlg('Imprimante  tickets non active ! Voulez-vous continuer ?', mtwarning, [mbyes, mbno], 0) = mrno then
                exit;
            begin // Non Opos Procedure
              TicketToPrint := TTicketJob.Create(nil);
              try
                TicketToPrint.Printer  := (self.Parameter['PrintersTicketPrinter']);
                TicketToPrint.Logo     := PrintLogo;
                TicketToPrint.URL      := WEBURL;
                if ShopdataList <> nil then begin
                    TicketToPrint.ShopData := ShopdataList;
                end else begin
                  ShowMessage('Les donnes tickets du magasin ne sont pas correctes');
                end;
                if (self.Parameter['PrintersTicketContinuous'] = 'TRUE') then
                  TicketToPrint.Model := TmContinuous;
                TicketToPrint.AddBox('Bon rparation', True, bsProd);
                RemoteDB.netshop_repair.First;
                while not RemoteDB.netshop_repair.Eof do
                begin
                  TicketToPrint.AddLine('1', '0', RemoteDB.netshop_repair.FieldByName('repair_products_name').Value, 'Bon rparation');
                  RemoteDB.netshop_repair.Next;
                end;
                if RemoteDB.CustomersCustomers_nbr.Value >= 100000 then
                begin
                  TicketToPrint.AddCustomerLine('Client # :', RemoteDB.CustomersCustomers_nbr.Text);
                  TicketToPrint.AddCustomerLine('Nom :', RemoteDB.CustomersCustomers_Lastname.Text);
                  if RemoteDB.Customerscustomers_telephone.Text <> '' then
                    TicketToPrint.AddCustomerLine('Tel :', RemoteDB.Customerscustomers_telephone.Text);
                  if RemoteDB.Customerscustomers_fax.Text <> '' then
                    TicketToPrint.AddCustomerLine('GSM :', RemoteDB.Customerscustomers_fax.Text);
                  TicketToPrint.AddCustomerLine('N de srie :', RemoteDB.netshop_repair.FieldByName('repair_products_serial').Value);
                  TicketToPrint.AddCustomerLine('Panne :', RemoteDB.netshop_repair.FieldByName('repair_products_problem').Value);
                  TicketToPrint.AddCustomerLine('Prix :', RemoteDB.netshop_repair.FieldByName('repair_price').Value);
                  TicketToPrint.Comment := 'Attention !' + chr(10) + chr(13) + '';
                  TicketToPrint.Comment := TicketToPrint.Comment +  DepositWarning;
                end;

                if self.Parameter['PrintersTicketOpos'] = 'TRUE' then
                  TicketToPrint.PrintOpos
                else
                  TicketToPrint.Print;
              finally
                TicketToPrint.Free;
              end;
            end; // Fin ticket
          finally
            Enabled := True;
          end;
        end else begin
          messagedlg('Entrez un N de client valide', mtwarning, [mbok], 0);
        end;
      end;

      procedure TMainForm.BitBtnCustomerSMSClick(Sender: TObject);
      var
        Text: string;
      begin
        if MessageBody.Text = '' then
        begin
          messagedlg('Message Vide !', mtwarning, [mbok], 0);
          exit;
        end;

        Text := Trim(StringReplace(MessageBody.Text, #13#10, ' ', [rfReplaceAll, rfIgnoreCase]));

        if (Length(Text) > 3) then
        begin
          RemoteDB.netshop_customers_alerts.Append;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_model').AsString := 'MICRO';
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_products_name').AsString := 'SMS Message';
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString := RemoteDB.Customers.FieldByName('customers_nbr').AsString;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').Value := 1;
          RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_message').AsString := Text;
          RemoteDB.netshop_customers_alerts.Post;
        end else begin
          ShowMessage('Contenu du message trop court, min 4 caractres');
        end;
      end;

      procedure TMainForm.PrintPriceTag(quantity, description, price, owner, supplier: string);
      var
        Labelstoprint: Tlabeljob;
        i: Integer;
      begin
        if (self.Parameter['PrintersLabelEnabled'] = 'TRUE') then
        begin
          Labelstoprint := Tlabeljob.Create;
          try
            Labelstoprint.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
            if (StrtoInt(owner) < 100000) and (StrtoInt(supplier) < 100000) then begin
              Labelstoprint.Style := lsNew;
              Labelstoprint.Logo    := PrintLogo;
            end;

            if (StrtoInt(owner) < 100000) and (StrtoInt(supplier) >= 100000) then
            begin
              Labelstoprint.Style := lsSH;
              Labelstoprint.owner := ConnectedShop;
              Labelstoprint.Logo    := SHLogo;
            end;
            // Deposit
            if (StrtoInt(owner) >= 100000) then
            begin
              Labelstoprint.Style := lsDP;
              Labelstoprint.owner := StrtoInt(owner);
            end;
            Labelstoprint.URL := WEBURL;
            if (self.Parameter['PrintersLabelContinuous'] = 'TRUE') then
              Labelstoprint.Model := LmContinuous;

            if (self.Parameter['PrintersLabelMulti'] = 'TRUE') then
            begin
              for i := 1 to StrtoInt(quantity) do
              begin { plusieurs exemplaires }
                Labelstoprint.Addlabel(StrToFloat(price), description);
              end;
            end else begin
              Labelstoprint.Addlabel(StrToFloat(price), description);
            end;
            Labelstoprint.Print(StrToBool(self.Parameter['PrintersLabelDialog']));
          finally
            Labelstoprint.Free;
          end;
        end
        else
          messagedlg('Imprimante  tiquettes non active', mtwarning, [mbok], 0);
      end;

      procedure TMainForm.ProcessAlert(product_model, product_price_stock, product_owner_id, product_supplier_id, product_quantity: string);
      var
        ANotifyServer: TNotifyServer;
        AlertMessage: string;
        ADlgSmsSend: TDlgSmsSend;
        i, j: Integer;
        aLabelAddress: TLabelAddress;
        Address: Tstrings;
        IsNew: Boolean;
      begin

        if (StrtoInt(product_owner_id) >= 100000) or (StrtoInt(product_supplier_id) >= 100000) then
        begin
          IsNew := False;
        end
        else
          IsNew := True;

        RemoteDB.Products.IndexName := 'ProductsIXModel';
        if RemoteDB.Products.FindKey([product_model]) then
        begin
          if (RemoteDB.Products.FieldByName('products_stock_managed').Text = 'True') then
          begin
            if UserType = 1 then
            begin
              ANotifyServer := TNotifyServer.Create('stockalert', RemoteDB.Products.FieldByName('products_id').AsString, '', NOTIFYURL);
            end;

            if IsNew then
            begin
              RemoteDB.netshop_customers_alerts.Filter := '((customers_alerts_products_model=' + QuotedStr(product_model) +
                ') and (customers_alerts_used=0) and  (customers_alerts_status=0) )';
            end else begin
              RemoteDB.netshop_customers_alerts.Filter := '((customers_alerts_products_model = ' + QuotedStr(product_model) +
                ') and ((customers_alerts_used >= ' + inttostr(Round(StrToFloat(product_price_stock))) +
                ') or (customers_alerts_used=0)) and  (customers_alerts_status=0) )';
            end;
            RemoteDB.netshop_customers_alerts.Filtered := True;

            if RemoteDB.netshop_customers_alerts.Locate('customers_alerts_products_model', RemoteDB.Productsproducts_model.AsString, [locaseinsensitive]) then
            begin

              if IsNew then
              begin
                AlertMessage := 'Le produit ' + RemoteDB.Products.FieldByName('products_intername').Text + ' est dispo a ' +
                  RemoteDB.Productsproducts_price_allin.AsString + ' Eur chez ' + RemoteDB.Shops.FieldByName('shops_title').AsString + ' ' +
                  RemoteDB.Shops.FieldByName('shops_adress_one').AsString + '. Tel: ' + RemoteDB.Shops.FieldByName('shops_phone').AsString;
              end else begin
                AlertMessage := 'Le produit ' + RemoteDB.Products.FieldByName('products_intername').Text + ' est dispo a ' + product_price_stock + ' Eur chez '
                  + RemoteDB.Shops.FieldByName('shops_title').AsString + ' ' + RemoteDB.Shops.FieldByName('shops_adress_one').AsString + '. Tel: ' +
                  RemoteDB.Shops.FieldByName('shops_phone').AsString;
              end;

              ADlgSmsSend := TDlgSmsSend.Create(self);
              try
                RemoteDB.netshop_customers_alerts.First;
                ADlgSmsSend.Reserved := 0;
                while not RemoteDB.netshop_customers_alerts.Eof do
                begin
                  ADlgSmsSend.Reserved := ADlgSmsSend.Reserved + RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger;
                  RemoteDB.netshop_customers_alerts.Next;
                end;

                ADlgSmsSend.MemoSmsText.Text          := AlertMessage;
                ADlgSmsSend.LabelSmsToSend.Caption    := inttostr(ADlgSmsSend.Reserved);
                ADlgSmsSend.LabelSmsAvailable.Caption := product_quantity;

                if ADlgSmsSend.ShowModal = mrOK then
                begin
                  AlertMessage := ADlgSmsSend.MemoSmsText.Text;
                  RemoteDB.netshop_customers_alerts.IndexFieldNames := 'customers_alerts_date';
                  RemoteDB.netshop_customers_alerts.First;
                  try

                    j := 0;
                    RemoteDB.netshop_customers_alerts.First;
                    while ((not RemoteDB.netshop_customers_alerts.Eof) and (j < StrtoInt(ADlgSmsSend.LabelSmsToSend.Caption))) do
                    begin
                      RemoteDB.Customers.Locate('customers_nbr', RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_customers_nbr').AsString,
                        [locaseinsensitive]);

                      //
                      // Print Sticker
                      //
                      aLabelAddress := TLabelAddress.Create;
                      Address       := TStringList.Create;
                      try
                        aLabelAddress.LabelPrinter := (self.Parameter['PrintersLabelPrinter']);
                        Address.Add('Client # ' + RemoteDB.CustomersCustomers_nbr.AsString);
                        Address.Add(RemoteDB.Customerscustomers_firstname.AsString + ' ' + RemoteDB.CustomersCustomers_Lastname.AsString);
                        Address.Add(RemoteDB.Products.FieldByName('products_intername').Text + ' ' + RemoteDB.Productsproducts_root_category_name.Value);
                        Address.Add('SMS: ' + DateToStr(Now));
                        for i := 1 to RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger do
                          aLabelAddress.Print(Address, (StrToBool(self.Parameter['PrintersLabelDialog'])));
                      finally
                        aLabelAddress.Free;
                        Address.Free;
                      end;

                      RemoteDB.netshop_customers_alerts.Edit;
                      RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_message').AsString := AlertMessage;
                      RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_status').Value := 1;
                      RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_date_notified').AsFloat := Now;
                      if not IsNew then
                      begin
                        RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_used').Value := Round(StrToFloat(product_price_stock));
                      end;
                      RemoteDB.netshop_customers_alerts.Post;

                      j := j + RemoteDB.netshop_customers_alerts.FieldByName('customers_alerts_quantity').AsInteger;
                    end;
                  finally

                  end;
                end;
              finally
                ADlgSmsSend.Free;
              end;
            end; // End if product in alerts
            RemoteDB.netshop_customers_alerts.Filter   := '';
            RemoteDB.netshop_customers_alerts.Filtered := False;
          end; // if stock managed
        end; // if product found
      end;

end.
